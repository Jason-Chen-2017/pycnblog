
作者：禅与计算机程序设计艺术                    

# 1.简介
  

大家好，我是郭超，现任微信支付平台架构组CTO，对微信支付、商户支付、POS机支付等相关领域的技术有深入的理解和实践经验。之前在中科院计算所读研究生，之后进入南京大学计算机科学技术系攻读博士，并于2020年加入微信支付平台团队，目前主要负责微信支付后台服务、交易系统设计和开发。本文将从支付场景出发，逐步阐述微信支付交易系统的实现方案以及关键技术点。本文为微信支付平台系列文章第1篇。
# 2.背景介绍
## 2.1 为什么需要微信支付？
支付是一个电子商务领域非常重要的一环。但是由于各地区法律政策不统一导致很难开展线上线下支付业务，影响了消费者的体验，并且存在支付欺诈、网络安全等风险隐患。因此，移动互联网蓬勃发展、应用场景多样化、技术创新加速，使得线上线下支付成为一种新的必需品，用户对于支付方式的依赖越来越强。

随着支付场景的日益复杂化，微信支付则作为一种“小而美”的支付解决方案，成为首选，成为数十亿用户首选的支付选项。通过微信支付，用户可以更便捷、安全、可靠地完成支付需求。

## 2.2 支付场景简介
### 2.2.1 用户与商户间的支付场景

一般情况下，付款方（用户）会选择向收款方（商户）发送一段文字或链接信息，请求进行付款。收款方确认后，会在微信客户端或手机微信内打开支付宝或微信扫码支付界面，扫描二维码或输入收款账户，进行付款。支付完成后，双方会收到交易成功的通知。

在这种场景下，支付的整个流程是用户选择商户、商户确认用户信息、确认支付金额、进行支付、收款确认等一系列操作。支付过程中涉及的角色主要包括商户、用户、支付渠道提供商（如微信支付、支付宝等）。

### 2.2.2 商户与微信后台间的支付场景

商户在调用微信支付接口时，会传入订单信息，包括商品描述、订单金额、用户标识等数据。微信支付后台首先会校验订单数据的合法性，然后生成对应的预支付交易单，同时返回给商户相应的数据（如prepayid、noncestr、sign等），用于前端调起支付。

用户在微信端或手机微信客户端点击“去支付”，则会调起微信客户端内置的支付框架，根据微信商户平台配置好的支付参数，调用微信支付SDK进行支付。支付过程中的关键节点是用户扫码、确认支付、查询交易结果等，支付完成后，微信支付平台会接收到回调消息，根据状态更新订单状态。

在此场景下，支付的整个流程是商户调用微信支付接口、微信支付后台处理请求、生成预支付交易单、返还给商户支付数据、用户在微信端或手机微信客户端进行支付、微信支付平台接收回调消息、更新订单状态等一系列操作。支付过程中涉及的角色主要包括商户、用户、微信支付后台。

### 2.2.3 微信POS设备与微信后台间的支付场景

在微信POS机端，用户安装微信POS客户端，打开程序后点击“付款”，即可进行支付。支付过程中，微信后台只作为中间媒介，不会接触用户的银行卡信息。微信后台接收到POS机端发出的指令后，生成预支付交易单，将信息下发至微信POS机端，再由微信POS机端发起支付。

微信POS设备支持的支付方式主要有微信、支付宝、银联卡、招行信用卡、借记卡、手机钱包等。微信支付后台和微信POS机端之间的数据交换采用HTTP协议，数据加密传输。POS机端上不会安装各种支付APP，支付指令下发到微信后台，再由微信后台下发到微信POS机端。

在此场景下，支付的整个流程是用户在微信POS设备进行支付、微信后台与微信POS设备进行通信、生成预支付交易单、下发支付指令、微信POS设备支付等一系列操作。支付过程中涉及的角色主要包括用户、微信支付后台、微信POS设备。

### 2.2.4 微信支付场景总结
基于以上四种支付场景，我们发现微信支付既有商户支付场景，也有微信后台支付场景，还有微信POS设备支付场景。基于微信支付的支付场景覆盖了移动支付市场的绝大部分，其支付流程和接口都高度标准化，降低了支付开发的难度，提升了用户体验和支付场景的易用性。