
作者：禅与计算机程序设计艺术                    

# 1.背景介绍


随着互联网公司数据量的不断增长、应用场景的变化和数据库的日益复杂化，如何高效地存储和处理大量的数据，成为了企业面临的重要课题之一。其中最有效的办法就是对数据进行水平拆分和垂直拆分，分别称为“分库”和“分表”。

所谓“分库”，即将一个数据库按照业务逻辑或功能划分为多个库。比如，对于电商网站来说，可以把用户相关的信息、订单信息、商品信息等划分到不同的库中。这样做能够方便不同部门或业务线之间数据的隔离，提升了数据安全性。

所谓“分表”，即将一个大表根据规则拆分为多个小表。比如，对于一个订单表，可以按订单号、顾客ID等维度拆分为多张子表。这样做能够减少单表数据量过大的问题，进而提升查询性能。

从实现上看，“分库”可以通过分布式集群实现，使得每一个库的数据被散列到不同的服务器上；而“分表”则需要通过SQL语句的优化和切分工具来实现，保证数据访问效率和统一性。但无论采用何种分片策略，都需要根据实际情况制定相应的方案并进行验证。本文将会简要介绍一下数据库分库与分表策略的基本理念和一些常用方法。


# 2.核心概念与联系
## 分库（Database Sharding）
所谓“分库”，简单理解就是将一个数据库中的数据平均分配到多个库中，每个库保存相同的数据集合。如下图所示，一个数据库被划分为三个库：DB1、DB2 和 DB3，各自保存相同的表结构。这三个库共同组成了一个逻辑上的完整的数据库。这种方式能够让数据库横向扩展，解决单个数据库容量过大的瓶颈。由于数据分布在不同的库中，因此跨库查询时需要通过网络传输，相比于跨表查询速度慢很多。


## 分表（Table Partitioning）
所谓“分表”，也称为“行拆分”或者“列拆分”，是将一个大表按照业务逻辑或某些特征进行切割，然后再分别存放到不同的物理表格中，即将一张表拆分为多个小表。如下图所示，一个订单表被切割成五张子表，分别用于存储不同时间段的订单记录：2019年订单、2020年订单、2021年订单等。分表的目的主要是为了解决单张表数据量太大的问题，进而提升查询性能。


### 数据切分方式

按照数据范围进行分区和分表

例如，按年份进行分区，每个年份建立一个库，且在每个库中建立相同的表结构。 

按月份进行分区，每个月份建立一个表。 

按照产品类型、渠道、地域、版本进行分区，每个维度建立一个表。 

按照事务特性进行分区，例如按订单号、顾客ID等维度，或者按登录IP地址进行分区。 

按照数据大小及其分布进行切分。 

### 垂直拆分

也称为数据表优化，将比较冷门和独立的字段放入一张表中，其他的放在另一张表中。

例如，一个电商网站的用户信息包括姓名、生日、邮箱、手机号码等，这些信息比较固定不经常变动，可以放入一个用户表中，其他信息放入另一个表中。

### 水平拆分

也称为分库分表，将同一个库中的数据按照某个字段或某种规则拆分到不同的数据库或表中，从而降低单库或单表的容量限制。

例如，对于电商网站，按照用户所在区域的不同划分为不同的库，或者按照订单创建时间的日期划分为不同的表，可以有效减轻单库或单表的压力。同时，也可以使用读写分离和分库分表中间件实现负载均衡。 

### 混合型拆分

将某些关系密集型的字段和不经常更新的字段放在一起存储，将不常用的字段放入另外的库或表中。

例如，对于电商网站，有些字段可能经常被访问，例如订单状态、支付状态、收货人地址等；而有些字段可能只被用到一次，例如用户积分、会员级别等；可以将这两类字段存放在一个库的表中，其他字段存放在另一个库的表中，减少库和表之间的耦合。