
作者：禅与计算机程序设计艺术                    

# 1.背景介绍


“MySQL性能优化”作为一种常用技能，已经成为IT行业中的一门重要技能。随着互联网公司网站流量的不断上升、业务数据量的扩大、数据库负载的提高，传统的单体结构模式已无法满足需求。于是在性能优化方面，多种架构设计策略被提出，如分库分表、读写分离、缓存等。但是对于一般的SQL语句执行计划相关的知识却很少有系统性的教程或手册，这极大的阻碍了开发人员对数据库性能调优的理解与应用。本文将从实践出发，介绍MySQL的执行计划，并且以其内部的机制进行详细介绍。
# 2.核心概念与联系
## 2.1 执行计划（Execution Plan）
执行计划是一个记录了SQL语句在MySQL中查询的详细信息，包括查询涉及到的表、索引、数据扫描顺序等，它可以帮助DBA或开发人员分析、优化查询的效率、并发现查询过程中的一些潜在问题。它的作用包括：
- 提高查询效率：通过减少磁盘I/O，提高查询速度；
- 避免出现错误：检查执行计划是否存在问题，如索引失效等；
- 排查慢查询：了解查询的执行情况，便于定位慢查询的问题点；

## 2.2 查询执行流程
当客户端向服务器发送一条SQL语句后，服务器收到请求后会进行以下几步操作：
- SQL语法解析：首先解析SQL语句，确认其语法正确无误；
- 查找处理需要访问的表：根据查询语句查找需要访问的表以及其对应的索引；
- 创建执行计划：生成执行计划，决定哪些索引适合参与查询，索引的选择类型（主键或普通索引），使用的连接方式（全表扫描或索引扫描），排序方式等；
- 优化器执行查询：按照生成的执行计划进行查询优化，尝试找到一个最优的执行路径；
- 获取结果集：通过优化器执行后的查询结果，返回给客户端；

## 2.3 不同版本MySQL执行计划的区别
由于MySQL的版本更新迭代频繁，不同版本的执行计划的输出可能略有差异，因此我们下面只介绍MySQL5.7版本的执行计划。
### 2.3.1 简单查询
例如：SELECT * FROM table_name WHERE id=10;

#### mysql 5.7.26 查询计划示例
```mysql
mysql> EXPLAIN SELECT * FROM test.table_name WHERE id = 10;
+----+-------------+-------+------------+------+---------------+---------+---------+--------------------------+
| id | select_type | table | partitions | type | possible_keys | key     | key_len | ref                     |
+----+-------------+-------+------------+------+---------------+---------+---------+--------------------------+
|  1 | SIMPLE      | test.table_name | NULL | const | PRIMARY       | PRIMARY | 4       | test.table_name.id = 10 |
+----+-------------+-------+------------+------+---------------+---------+---------+--------------------------+
1 row in set (0.00 sec)
``` 

#### explain 命令的输出字段含义
- id：表示SELECT编号，每个SELECT都会对应一个唯一的ID；
- select_type：表示查询类型，如SIMPLE，PRIMARY或者DERIVED，分别表示简单的查询、最外层的查询或者导出查询；
- table：表示查询涉及的表名；
- partitions：表示查询涉及的分区信息；
- type：表示查询方式，比如ALL，index，range等；
- possible_keys：表示查询时可能使用的索引；
- key：表示实际使用的索引；
- key_len：表示索引长度；
- ref：表示索引被引用的列；

#### mysql 5.7.26 查询计划详解
- ID：该查询语句对应的ID为1；
- Select Type：该查询语句的类型为SIMPLE，即普通的查询语句；
- Table：查询涉及的表为test.table_name；
- Partitions：该查询语句没有涉及分区；
- Type：查询方式为const，因为查询语句里有WHERE条件，且id的值恒定为10；
- Possible Keys：可能使用的索引为空；
- Key：实际使用的索引为主键索引，即PRIMARY；
- Key Len：主键索引的长度为4；
- Ref：ref指的是该表的某个字段被用来搜索某条记录；

### 2.3.2 join查询
例如：SELECT t1.*, t2.name FROM table1 t1 INNER JOIN table2 t2 ON t1.id = t2.id WHERE t1.num > 10 AND t2.age < 20;

#### mysql 5.7.26 查询计划示例
```mysql
mysql> EXPLAIN SELECT t1.*, t2.name FROM test.table1 t1 INNER JOIN test.table2 t2 ON t1.id = t2.id WHERE t1.num > 10 AND t2.age < 20;
+----+-------------+-------+------------+------+---------------+--------------+---------+-------------------------------------------------+
| id | select_type | table | partitions | type | possible_keys | key          | key_len | ref                                             |
+----+-------------+-------+------------+------+---------------+--------------+---------+-------------------------------------------------+
|  1 | SIMPLE      | test.table1    | NULL         | ALL              | NULL        | NULL     | NULL                                           |
|  1 | SIMPLE      | test.table2    | NULL         | eq_ref           | PRIMARY     | 4             | test.table2.id                                  |
+----+-------------+-------+------------+------+---------------+--------------+---------+-------------------------------------------------+
2 rows in set (0.00 sec)
```

#### explain 命令的输出字段含义
- id：表示SELECT编号，每个SELECT都会对应一个唯一的ID；
- select_type：表示查询类型，如SIMPLE，PRIMARY或者DERIVED，分别表示简单的查询、最外层的查询或者导出查询；
- table：表示查询涉及的表名；
- partitions：表示查询涉及的分区信息；
- type：表示查询方式，比如ALL，index，range等；
- possible_keys：表示查询时可能使用的索引；
- key：表示实际使用的索引；
- key_len：表示索引长度；
- ref：表示索引被引用的列；

#### mysql 5.7.26 查询计划详解
- ID：该查询语句对应的ID为1；
- Select Type：该查询语句的类型为SIMPLE，即普通的查询语句；
- Tables：该查询语句涉及的表为test.table1 和 test.table2；
- Type：查询方式为all，即全表扫描；
- Possible Keys：该查询语句可能使用的索引为空；
- Key：表示实际使用的索引为空；
- Key Len：该项为空；
- Ref：表示该项为空；