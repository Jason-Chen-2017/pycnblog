
作者：禅与计算机程序设计艺术                    

# 1.简介
  

InnoDB是一个开源的关系型数据库管理系统，它被设计用来处理巨大的传统数据集（例如事务型应用），基于非锁定读取、原子提交等特性，实现高并发访问。其自带集群功能可以实现自动故障切换，并通过手工方式或者自动化工具进行主备切换。对于MySQL 5.7版本来说，InnoDB支持基于GTID的复制。本文档主要介绍InnoDB在MySQL中如何部署，以及怎样才能让InnoDB集群在生产环境中运行稳定可靠。

2.InnoDB集群架构
InnoDB集群由三个角色组成：
- 物理层节点：实际运行InnoDB服务器，负责存储数据的物理位置分配、磁盘IO请求调度、性能优化和数据持久性维护；
- 中心节点（也称作监控节点）：用于监控集群状态、执行主备切换和主从延迟检测等工作，监控信息由监控存储节点或集群控制节点采集。集群控制节点为物理层节点提供统一的管理接口，并且还可以将集群信息同步到其他节点以便于协助管理；
- 客户端：即使不直接使用MySQL命令行工具也可以访问InnoDB集群。一般情况下，应用服务器或DBA都可以使用MySQL工具连接到InnoDB集群。

一个典型的InnoDB集群由3个或5个节点构成。在分布式数据库领域，通常会选择基于MySQL Group Replication插件或者Percona XtraDB Cluster插件来搭建InnoDB集群。下图展示了InnoDB集群的整体架构。


图中，三个角色分别为：

- 一组物理节点。其中，每个物理节点上运行着多个InnoDB服务器。这些服务器共享相同的数据存储空间。
- 一个中心节点，它负责管理整个集群，包括监控集群状态，执行主备切换，以及对不同节点上的服务器做主从延迟检测等工作。该节点有两种模式，在可用的情况下，都应该同时启用。一旦某个节点发生故障，另一个节点就会接管这个故障节点的工作，成为新的物理节点上的唯一服务器。
- 若干客户端，它们需要访问InnoDB集群中的数据。应用服务器和数据库管理员可以通过不同的方式访问InnoDB集群，比如：直接查询SQL语句或者使用MySQL官方客户端工具。

3.InnoDB集群配置
配置InnoDB集群涉及到以下几个方面：

- 设置innodb_buffer_pool_size：表示共享内存池的大小，也是InnoDB所有线程共享的资源。默认值是128M。设置得越大，单个服务器的吞吐量就越高，但是消耗的系统内存就越多。建议在生产环境中根据业务需要合理设置。
- 设置innodb_log_file_size：表示日志文件的大小，默认为5M。设置得越大，事务提交后留下的记录就越多，建议值为1GB。
- 设置innodb_flush_log_at_trx_commit：表示事务提交时写入日志文件还是直接写入磁盘。设置为1时，表示每次提交时都会立即写入日志文件。设置为0时，表示一次性写入磁盘。建议设置为0。
- 设置innodb_thread_concurrency：表示后台线程的数量。默认为10。建议根据机器的硬件配置和负载情况设置。
- 设置innodb_read_io_threads 和 innodb_write_io_threads：表示后台读写IO线程的数量。默认为4。建议根据机器的硬件配置和负载情况设置。
- 设置innodb_file_per_table：表示是否为每个表创建一个独立的文件。设置为ON时，表示每个表的数据放在一个独立的文件里，这样就可以方便地用基于文件的工具查看数据。设置为OFF时，表示所有表的数据都放在同一个文件里。建议设置为ON。
- 设置innodb_open_files：表示允许打开的文件描述符数量。默认为1000，一般情况下不需要调整。
- 设置innodb_max_dirty_pages_pct：表示脏页百分比阈值。当脏页占InnoDB缓存池总容量的百分比达到阈值时，InnoDB才会启动刷新线程写入磁盘。默认值为90%。建议设置为30%~50%之间。
- 设置innodb_lock_wait_timeout：表示最大等待时间，如果事务持续超过指定的时间还不能获取所需的锁，则放弃获取锁。默认值为50秒。建议设置为适当的值。
- 设置innodb_stats_on_metadata：表示是否对表元数据统计信息进行收集。设置为ON时，收集到的信息可以帮助优化器更好地生成查询计划。设置为OFF时，不会收集统计信息。建议设置为ON。
- 设置binlog_format：表示二进制日志的格式。建议设置为ROW，因为这种格式能够提供更好的性能。
- 设置sync_binlog：表示在事务提交时是否立即写入日志文件，还是等待操作系统刷新到磁盘。设置为1时，表示等待。设置为0时，表示立即写入。建议设置为0。
- 设置innodb_autoinc_lock_mode：表示自增长列使用的锁模式。设置为2时，表示使用自动增长列锁，只针对INSERT语句。设置为0时，表示禁止使用自动增长列锁，所有的INSERT语句均使用普通的ROW级别锁。建议设置为2。

4.在生产环境中运行InnoDB集群
配置完InnoDB集群之后，就可以在生产环境中运行了。首先，检查服务器的硬件配置是否满足最低要求，如CPU核数、内存大小、磁盘空间等。然后，开启服务器时务必把集群所有节点都启动起来，并且在配置完成后立即运行sysbench测试脚本进行压力测试。确保测试结果符合预期。最后，按照标准流程设置MySQL白名单，并配置集群的负载均衡策略。至此，InnoDB集群就正常运行了。