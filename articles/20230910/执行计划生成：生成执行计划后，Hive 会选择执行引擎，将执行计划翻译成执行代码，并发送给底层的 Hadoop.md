
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 概述

执行计划是 Hadoop 中重要的组成部分之一，它描述了 Hive 查询如何处理数据，优化查询性能、减少网络传输等。通常来说，当一个 Hive 查询被提交到集群中时，会自动生成相应的执行计划。但有时候由于业务复杂度高、数据量大、查询语句不规范，导致生成的执行计划存在一些缺陷或失误，这将影响查询的性能和效率。因此，对于 Hive 来说，执行计划生成器负责从查询语句或者物理计划中提取出有效的执行计划。在实际的执行过程中，不同的执行引擎对执行计划进行解析，并实现相应的查询功能。其中，基于 MapReduce 的 Tez 和 SparkSQL 是最为流行的两个执行引擎，它们分别具有优秀的查询性能和稳定的运行效率。因此，本文将主要分析基于 Spark SQL 执行计划生成器的过程。

## 前置知识

本文涉及到的相关概念与技术包括：

1. Apache Hive: Hadoop 上的数据仓库工具。
2. Hadoop YARN: Hadoop 的资源管理器。
3. Apache Spark SQL: 用于 Big Data 数据分析的开源项目。
4. Apache Tez: Hadoop 下基于 MapReduce 的统一计算框架。
5. HDFS: Hadoop 的分布式文件系统。
6. HiveQL: Hive 内部使用的 SQL 语言。
7. SQL: Structured Query Language（结构化查询语言）。
8. 图解：图片形式的可视化语言。
9. 执行计划图：由节点和边组成的有向图，描述了 HiveQL 语句或物理计划在数据仓库中对应的运算过程。

# 2.基本概念术语说明
## 2.1、什么是执行计划？

执行计划是一个抽象的、用于表示查询处理逻辑和查询所需资源的一个计划图。它显示了查询语句或物理计划在数据仓库中的真实映射关系，并标注出每个操作耗费的时间、消耗的内存等信息。它使得管理员能够洞察到查询执行的瓶颈点，进而优化查询和调整配置参数。

## 2.2、执行计划生成器分类

一般地，执行计划生成器可以分为以下四种类型：

1. 编译器执行计划生成器：编译器执行计划生成器是指 HiveQL 语句经过编译器编译后，生成相应的物理计划，然后执行计划生成器将其转换为执行计划。例如：Apache Tez 将解析后的 HiveQL 语句转换成执行计划；SparkSql 将 HiveQl 语句解析成逻辑计划之后，调用 Spark 内核生成物理计划；Presto 将 SQL 查询解析成执行计划。
2. 操作执行计划生成器：操作执行计划生成器则直接获取元数据信息或通过查询优化器对 HiveQL 语句进行改写，将查询逻辑转换成物理计划。例如：LLAP 将 HiveQL 语句转换成 LLAP 查询；Tez 将 HiveQL 语句转换成 Tez DAG 任务；SparkSql 使用 Spark 内核将 HiveQl 语句解析成逻辑计划；Presto 将 SQL 查询解析成 Presto 查询计划。
3. 离线执行计划生成器：离线执行计划生成器需要先对查询计划进行分析，然后生成相应的执行计划。例如：Hive Metastore 接收到查询请求后，查询优化器选择最合适的索引，并生成查询计划；Tez 将查询计划解析成 Tez DAG 任务，并交由 Yarn 提交至集群运行；SparkSQL 通过 Catalyst 生成执行计划。
4. 在线执行计划生成器：在线执行计划生成器不需要生成整个查询计划，而只需要根据运行情况补充执行计划的信息。例如：Tez 根据 LLAP 缓存和 Tez AM 的状态生成执行计划。

本文将主要分析基于 Spark SQL 执行计划生成器的过程。Spark SQL 有一个详细的执行计划，包括数据源、算子和数据输出等，并且支持多种类型的算子，如基于 RDD 的基础算子和基于 Dataset/DataFrame 的增强算子。基于这些算子构建的更高级的算子也被称为复杂算子。为了生成高效且正确的执行计划，Spark SQL 需要知道查询中所有数据的特性，如大小、分布、顺序等。除此之外，还需要考虑诸如是否有 Join 、聚合函数、排序、分区、广播变量等特点。另外，由于执行计划依赖于数据规模、集群规模、任务调度策略等多种因素，所以正确生成执行计划十分困难。