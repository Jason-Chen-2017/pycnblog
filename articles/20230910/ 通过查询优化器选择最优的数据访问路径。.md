
作者：禅与计算机程序设计艺术                    

# 1.简介
  

数据访问路径是指数据库系统在处理用户请求时所要采取的一系列数据的存储顺序、查找方法及相互之间的联系。查询优化器的任务就是通过分析查询语句并对其进行优化，将尽可能少的时间用于数据的搜索，从而提升整个数据库系统的运行速度。因此，了解查询优化器选择数据访问路径的过程以及工作原理对于查询优化器的理解、调优和应用都至关重要。本文将以最优数据访问路径（Optimal Data Access Path，ODAP）为研究对象，基于相关知识，阐述查询优化器如何选择和生成最优数据访问路径。
# 2.数据访问路径
数据访问路径由两部分组成：物理存储结构和访问路径。物理存储结构包括数据库中的磁盘文件组织形式和索引文件的组织形式等；访问路径则指根据查询计划对数据集合进行搜索时所采用的访问方式。查询优化器的目标就是找到一个合适的查询计划，使得查询尽可能地快速地检索到需要的数据，同时还要考虑数据访问的效率。一般来说，查询优化器会综合考虑物理存储结构和访问路径两个因素。
## 物理存储结构
物理存储结构通常可以分为三层：硬盘、缓存和内存。硬盘用来存放数据库中所有的数据文件，缓存用来存放频繁访问的数据块，内存用来存放临时数据和执行过程中产生的中间结果。为了达到良好的性能，查询优化器必须充分利用这一层级的存储结构。例如，如果查询只涉及少量的数据，那就可以将这些数据直接加载到内存中；如果查询涉及大量的不经常访问的数据，那么就需要将这些数据预读入缓冲区。
## 访问路径
访问路径的形式各异，常见的包括顺序扫描、索引扫描、联合索引扫描、嵌套循环连接、全表扫描、外部合并排序等。不同类型的访问路径往往对应着不同的查询计划。查询优化器根据各种考虑因素生成不同的查询计划，然后再根据索引统计信息、查询条件、查询本身以及其他系统约束等因素选择其中最优的查询计划。这里，我们重点讨论最优数据访问路径ODAP。
### ODAP
ODAP是一种基于统计模型和机器学习的方法，能够自动生成数据访问路径。ODAP是一个自顶向下的数据访问优化过程，首先将查询转换成一个搜索树，再从中找出一个数据访问顺序，最后转化成实际的磁盘IO指令序列。ODAP采用了模型驱动的数据访问优化技术，能够自动发现高效的数据访问路径，并且能兼顾性能与成本的平衡。具体地说，ODAP的模型包括访问模式（Access Pattern）、查询概括（Query Abstraction）、索引选择（Index Selection）和代价估算（Cost Estimation）。
#### 查询概括
ODAP首先将查询转换成一个搜索树，搜索树是对查询计划的一个抽象表示。搜索树是一种树形结构，它以查询计划中的每个节点表示。根节点代表原始查询计划，叶子节点代表数据源，中间节点代表运算符。ODAP引入的概念是查询概括，它表示将一组查询计划统一的描述形式。
#### 访问模式
ODAP通过访问模式对搜索树进行建模。访问模式记录了查询在不同情况下的行为特性。例如，访问模式可以记录索引扫描、顺序扫描、连接条件、外链接等。每个节点上标记着对应的访问模式。
#### 索引选择
ODAP认为索引可以加快搜索的速度。索引选择即决定哪些列要建立索引，哪些列不能建立索引，哪些索引应该覆盖更多的查询列等。ODAP基于启发式规则进行索引选择，包括基数、大小、分布、稀疏性、重复值、冗余度等多种因素。
#### 代价估算
ODAP通过计算访问路径的代价估算来判断其优劣。代价估算包括读取开销、存储开销、索引开销、计算开销等。ODAP用模型和统计数据来估计各种代价。例如，读取开销的估计可以基于磁盘上的数据分布，读取的字节数可以作为一个预测值提供给模型；索引开销的估计可以考虑不同类型的索引，也可以从统计数据中获得；等等。
ODAP采用两步的方法对搜索树进行优化：第一步，局部优化，就是针对每一个节点，根据代价估算进行局部调整，减小或避免代价较大的分支；第二步，全局优化，就是对整个搜索树进行整体的调整，比如合并、交换、压缩等，以减小或避免代价过高的路径。

ODAP的核心思想就是通过统计学习的方法，找到最有效的查询计划。通过分析搜索树和代价模型，ODAP能够为用户提供高效的数据访问路径，并且在满足一定成本限制的前提下，也能保证性能。