
作者：禅与计算机程序设计艺术                    

# 1.背景介绍


Kubernetes作为云原生容器编排领域的先驱者和标杆，其提供的基于容器化部署应用的容器集群管理工具也越来越受到广泛关注。为了更好地适应Kubernetes生态圈，Kubevirt项目在社区中逐渐走向成熟，成为Kubernetes的本地虚拟化方案之一。Kubevirt虽然提供了比较完整的功能集，但仍然面临着存储方面的不足。本文将会从以下几个方面进行分析介绍Kubevirt存储的选取和配置方法:

1、宿主机磁盘选择
宿主机磁盘是最基础的存储设备，Kubevirt对宿主机磁盘的需求并没有什么限制，只需要满足基本的磁盘性能需求即可。因此宿主机磁盘的类型和数量通常会根据不同的业务场景而定。比如对于开发测试环境，可以选择比较便宜的SSD硬盘，对于生产环境则应该选择高速网络存储，如SAN或NAS等。宿主机磁盘需要满足两个条件：

①存储空间大小：对于生产级别的应用来说，存储空间往往要大于等于实际应用所需容量的1.5倍左右，否则可能导致空间不足，甚至存储IO过载影响应用性能。

②存储IO效率：Kubevirt在创建VM时，实际上是在宿主机上运行了一个Guest OS。因此对于磁盘的IO效率非常重要。如果宿主机磁盘的IO效率较低，那么就会严重影响到Kubevirt的VM IO性能。所以，对于需要高IO效率的业务，建议选择能提供较高IO性能的磁盘。

2、Kubevirt的存储目录
当创建一个新的Kubevirt虚拟机时，Kubevirt会自动创建一个目录用于存放虚拟机相关的文件，包括磁盘文件，启动配置文件等。这个目录的位置可以通过设置StorageClassName来指定，也可以由Kubevirt自动分配。但是，Kubevirt存储目录也是必须指定的一个参数，它直接关系到Kubevirt的存储调度策略，也就是Kubevirt是如何确定VM所使用的哪些宿主机磁盘来存储它的磁盘文件的。Kubevirt通过PVC（Persistent Volume Claim）来指定存储目录，并且Kubevirt支持多种类型的PVC，具体如下图所示:

其中，Filesystem持久卷声明（PersistentVolumeClaim）指定了所需的存储大小及访问模式。在Kubevirt的实现里，Filesystem持久卷声明跟宿主机上的目录挂载路径绑定，即Kubevirt的存储目录需要事先手动创建好，然后再通过对应的PersistentVolumeClaim对象引用到该目录。Kubevirt提供两种存储目录的实现方式：

1. 共享磁盘：这种情况下，所有的VM都共用同一个磁盘。创建新的VM时，Kubevirt只是简单地使用已有的存储目录，即使该目录已经被其他的VM占据。

2. 分离磁盘：这种情况下，每一个VM都会拥有一个自己的存储目录，且这些目录不会共享。即使两个不同的VM拥有相同的磁盘文件，它们也拥有各自独立的存储目录。

一般来说，建议采用分离磁盘的方式，这样可以有效防止多个VM之间数据互相干扰。但由于每个VM的磁盘文件都不是共享的，所以会产生额外的资源消耗。因此，如果资源允许，可以考虑采用共享磁盘的方式。当然，这里也涉及到Kubevirt的存储调度策略的问题，后续再详细阐述。

3、Kubevirt的存储类别
Kubevirt使用存储类（StorageClass）来定义各种类型的存储，包括SSD、NVMe SSD等。不同类型的存储对存储性能、存储延迟、可用性等方面有很大的影响，因此需要根据应用场景和业务需求进行选择。比如对于开发测试环境，可以选择Ephemeral（临时）类型；对于生产环境，可以选择例如SAS、SATA、SCSI等高性能类型。Kubevirt的存储类别定义在KubeVirt CRD中，如下图所示：

除了磁盘的类型，还有很多其他的参数值得关注，如：

* fsType: 指定文件的系统类型，目前支持xfs, ext4, vfat, nfs, glusterfs, cephfs等。

* accessModes: 支持ReadWriteOnce, ReadOnlyMany和ReadWriteMany三种访问模式。

* reclaimPolicy: 设置垃圾回收机制，支持Delete和Retain两种选项。Delete表示删除该存储类时，VM的数据也一并删除；Retain表示保留该存储类中的数据，供之后使用。

* volumeMode: 定义PV的使用模式，支持Filesystem、Block和None三种模式。Filesystem模式下，PV的底层存储介质上只能是文件系统；Block模式下，PV的底层存储介质上只能是块设备；None模式下，就不需要底层存储介质了。

综合以上信息，了解Kubevirt的存储机制和调度策略后，就可以进一步决定Kubevirt的存储类型和配置策略。下面会详细介绍针对宿主机磁盘的配置和针对Kubevirt存储目录的配置，分别对应上面所说的两个配置选项。