
作者：禅与计算机程序设计艺术                    

# 1.简介
  

在MySQL数据库中，float数据类型通常被用来表示小数、科学记数法等。它可以存储整数和小数部分。由于它的特殊性，float类型的存储与计算也更加复杂。本文将从浮点数的存储方式、浮点数的计算规则、浮点数的精度控制、浮点数的错误类型、浮点数四舍五入规则、float与double的区别、相关扩展知识（四舍六入五成双）等方面详细阐述。
# 2.基本概念术语说明
## 2.1 浮点数概览
浮点数是指数学中的一个概念，是一种比整数更大的数字。一般来说，整数只能表示无限多个值（例如：1、2、3、4......），而浮点数可以表示无限多种真实数值，也就是说，它可以表示不完整的数值，因此可以近似地代表某一真实数值。浮点数分为单精度浮点数（float）和双精度浮点数（double）。
## 2.2 float数据类型
float数据类型由四个字段组成：符号位、指数部、尾数部、浮点类型标识符（0x1P+exp-bias）；符号位是一个bit位，当该位置为1时，则为负数；尾数部是指数位(exponent)、小数位(fraction)。指数部用于表现值的大小，尾数部用于表现值的精度。当浮点数的指数部值等于或大于2^127，或者等于或小于-2^128时，会发生溢出或下溢现象。另外，由于浮点数的运算过程不是严格意义上的复数，所以不适合做诸如三维空间等高维计算。
## 2.3 浮点数计算规则
浮点数的运算规则主要依赖于IEEE 754标准。在该标准中，定义了四种不同形式的浮点数：single、double、extended、quadruple。float 和 double 是最常用的形式，分别占用32位和64位的内存。
### 2.3.1 对阶算法
对阶算法又称为尾数规约算法（Fraction Reduction Algorithm）。是一种快速计算浮点数值的算法。其原理是在进行浮点数运算之前，先把小数点移到右边界，然后再进行运算。这种算法有效地避免了浮点数的精度损失。
### 2.3.2 数值转化
当两个浮点数相加时，计算机首先把它们转换为相同形式，然后按照标准的四则运算规则进行运算。但如果其中之一为NaN（Not a Number），那么结果也是NaN。另外，正零、负零、正无穷、负无穷这些特殊值也会产生一些有趣的现象。
### 2.3.3 浮点数比较
两个浮点数比较时，首先要判断是否属于同一个数值形式（single、double、extended、quadruple），然后才比较数值。当且仅当两个数值形式相同，并且相等的情况下，才认为相等。否则，一定不能相等。
### 2.3.4 浮点数四舍五入规则
一般情况下，当两个浮点数进行算术运算或者浮点数比较后，它们的值会根据算术运算或者比较的规则得到四舍五入的结果。四舍五入规则就是指，如果两个浮点数进行算术运算或者比较后，结果值不属于任何一个可接受的浮点数形式，那么就按以下规则进行舍入：

1. 如果结果值是无穷大（positive or negative infinity），则返回该值。
2. 如果结果值是NaN（Not a Number），则返回该值。
3. 如果被除数或除数为0，则返回NaN。
4. 如果结果值小于0，则向下取整。
5. 如果结果值大于0，则向上取整。
6. 根据所采用的舍入模式（round to nearest、truncate、round up/down），选择最近的可接受结果。
### 2.3.5 关于浮点数精度控制
在实际应用中，由于硬件限制、磁盘容量的限制等因素，数据库往往需要在内存中对浮点数进行存储。当float数值需要保存到磁盘文件时，会被转化成二进制编码，然后再写入到磁盘文件中。二进制编码时，可能会丢失掉一些精度。为了解决这一问题，一般有两种方法：
#### 方法一：取舍策略
采用取舍策略，即通过设置最大可容忍误差，来控制float数据的精度。比如，假设我们只允许float值的最大精度为0.01，那么就可以截断尾数部多余的部分，使得尾数部的有效数字个数达到0.01倍。这样就可以保证在内存中存储的浮点数精度不超过指定的值。
#### 方法二：浮点数编码算法
另一种方法是采用浮点数编码算法，将float数值编码为定长字节数组。不同的编码算法有不同的优缺点，这里重点讨论一下无损编码算法，即采用无损压缩的方法来对浮点数进行编码。
##### 不可靠的小数编码
不可靠的小数编码是指对于浮点数的尾数部来说，并非所有十进制位都能够被完全准确地保留下来。举例来说，对于0.3456789123...这样的一个小数，计算机可以获得这个小数的近似值。但是，由于计算机浮点数的存储机制，可能会导致尾数部被截断掉。如下图所示：
图中浅色框内表示尾数部，黄色虚线表示有效数字。
##### 可靠的小数编码
为了提升计算机浮点数存储的准确率，一些数据库系统采用了可靠的小数编码算法。这种算法的基本思想是把一个非常接近的无穷小数转换为两个固定长度的整数，然后再将这两个整数进行编码。在解码时，还原出原始的小数。
###### 分块压缩
分块压缩（block compression）方法是可靠的小数编码算法的一种，它把一个数值拆分为多个块，每个块对应一组整数，然后再重新组合。例如，把一个小数0.3456789123...转换为三个整数：[0,3456789,123]。
在这个例子里，第1块的范围为[0,999999]，第2块的范围为[1000000,999999999]，第3块的范围为[1000000000,Inf]。通过这样的方式，可以大幅度降低小数尾数部的损失，并减少内存需求。
###### 小数固定点数表示
小数固定点数表示（fixed-point decimal representation）方法是可靠的小数编码算法的另一种。它的基本思路是把一个小数乘以一个固定精度的倍数，再对整数部分和小数部分进行处理。例如，把一个小数0.3456789123...乘以1000转换为两个整数：[3456,7891]。
在这个例子里，整数部分表示为3456，小数部分表示为0.7891。通过这样的方式，可以更好地保持尾数部的精度。
##### 小结
可靠的小数编码算法可以提供很好的浮点数精度控制。它可以减少存储浮点数值时的损失，而且可以有效地避免丢失值带来的精度影响。