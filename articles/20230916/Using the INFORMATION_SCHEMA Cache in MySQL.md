
作者：禅与计算机程序设计艺术                    

# 1.简介
  

MySQL数据库提供了INFORMATION_SCHEMA系统表用于查看数据库信息，但INFORMATION_SCHEMA中存储的数据都是动态获取的，每次访问都需要从硬盘读取。为了提升查询效率，数据库系统设计者可以将信息缓存到内存中，称之为INFORMATION_SCHEMA CACHE。本文对INFORMATION_SCHEMA CACHE的作用进行探索并阐述其工作原理。
# 2.什么是INFORMATION_SCHEMA？
INFORMATION_SCHEMA（英文名：information schema）是一个用于描述数据库结构、数据类型及其他数据库对象信息的数据库系统表集合，在MySQL中，它的命名空间实际上是mysql。该表集合包括了几十个表，用来提供关于数据列的定义，索引等元数据信息。通过查询这些表中的数据，可以了解到数据库对象的创建时间、使用的引擎、索引的位置、默认值、表的行数等详细信息。
# 3.INFORMATION_SCHEMA缓存作用
INFORMATION_SCHEMA缓存就是将从硬盘读取的信息缓存在内存中，再从内存中取出而不是直接从硬盘读取。这样做可以提高数据库查询效率，减少磁盘IO操作，节省系统资源。
根据官方文档，INFORMATION_SCHEMA缓存的优点如下：
- 提升数据库查询效率：由于一次性加载所有元数据信息，INFORMATION_SCHEMA缓存能够显著地提升数据库查询效率。
- 降低网络I/O消耗：由于元数据信息的缓存，数据库服务器不再需要花费额外的时间和CPU资源来处理数据请求，这也使得数据库服务器的网络I/O总流量减小，优化了数据库的性能。
- 提升服务器的负载均衡能力：由于元数据信息的缓存，数据库服务器只需要向客户端返回缓存的元数据信息，而不是每个请求都要向数据库服务器进行一次元数据的查找，因此，可以在不影响线上的服务的情况下实现数据库服务器集群的负载均衡。
- 降低数据库服务器的内存占用：缓存能够有效地减少数据库服务器的内存占用，例如，如果没有缓存机制，对于每一个正在运行的查询进程来说，它都需要打开相应的表文件才能获取相关的元数据信息，这会占用很大的内存资源。而使用INFORMATION_SCHEMA缓存后，数据库服务器只需要保存一份元数据信息，就可以供整个数据库服务所共享，无需重复打开文件。
但是，INFORMATION_SCHEMA缓存也有缺点：
- 有时会使元数据信息的实时性降低：因为METADATA是根据数据库的实际情况实时的生成的，在一些极端场景下，可能会出现METADATA信息被缓存后已经过期的问题。此时，用户需要重新刷新缓存来更新METADATA信息。
- 若要重启数据库服务器或者使用FLUSH TABLES WITH READ LOCK命令锁定所有表后，则无法进行INFORMATION_SCHEMA缓存操作。
综上，INFORMATION_SCHEMA缓存对于提升数据库查询效率、降低系统资源占用、提升负载均衡能力等有着积极意义。
# 4.信息缓存的原理
数据库服务器把获取到的所有信息都缓存起来，避免重复访问磁盘，这样就提高了查询效率，减少了磁盘IO操作，同时也解决了当系统发生故障或数据库服务器宕机后，查询速度变慢的问题。
## 4.1 INFORMATION_SCHEMA CACHE工作原理
INFORMATION_SCHEMA CACHE主要由两个组件构成：
- 查询解析器(Query Parser)：将客户端发送过来的SELECT语句解析成内部执行计划。
- 结果集缓存：存储查询结果，缓存住的查询结果只有在缓存过期之前才会失效。
### 4.1.1 查询解析器
当客户端发送一个SELECT语句给数据库服务器，查询解析器会解析这个语句，并生成对应的执行计划。解析器主要做的事情有：
- 检查语法错误；
- 检查是否有权限访问相关表；
- 为SELECT语句寻找最佳的查询方法；
- 将SELECT语句转换成操作系统可以执行的指令。
生成好的执行计划会送入查询优化器，然后查询优化器对执行计划进行优化，按照最优的顺序遍历执行计划中的节点，生成查询结果。
### 4.1.2 执行计划缓存
执行计划缓存又叫做优化器缓存，查询优化器会先检查内存中是否有可用的执行计划缓存，如果有的话，就会直接从缓存中获取执行计划。否则，就需要重新解析SQL语句生成新的执行计划。执行计划缓存一般比查询缓存长存时间更久，并且当数据库更新时，缓存会自动失效。
### 4.1.3 结果集缓存
查询优化器经过优化后的执行计划，就会送回给查询执行器，查询执行器会根据执行计划依次执行节点，生成结果集。结果集缓存就是为了保存查询结果，减少后续相同查询的执行开销。
### 4.2 INFORMATION_SCHEMA CACHE相关表的作用
INFORMATION_SCHEMA包含很多表，主要用来获取数据库的各种信息，如：
- COLUMNS - 获取表的列信息。
- KEY_COLUMN_USAGE - 获取表索引列的相关信息。
- TABLE_CONSTRAINTS - 获取表约束信息。
- STATISTICS - 获取表统计信息。
- INNODB_SYS_TABLES - 获取InnoDB相关的表信息。
- SCHEMATA - 获取数据库模式信息。
- TABLES - 获取数据库中所有的表名称。
除了以上几个表，还有INNODB_TRX，INNODB_LOCKS等表也涉及到元数据信息。这些表的内容主要是来自于MySQL的引擎InnoDB，其中INNODB_SYS_TABLES表就是来自于Innodb引擎中的一个系统表。
## 4.3 使用INFORMATION_SCHEMA CACHE的好处
1. 减少磁盘IO操作：INFORMATION_SCHEMA缓存能够减少一次磁盘IO操作，把从硬盘读取的信息缓存在内存中，再从内存中取出而不是直接从硬盘读取。
2. 提升数据库查询效率：由于一次性加载所有元数据信息，INFORMATION_SCHEMA缓存能够显著地提升数据库查询效率。
3. 降低网络I/O消耗：由于元数据信息的缓存，数据库服务器不再需要花费额外的时间和CPU资源来处理数据请求，这也使得数据库服务器的网络I/O总流量减小，优化了数据库的性能。
4. 提升服务器的负载均衡能力：由于元数据信息的缓存，数据库服务器只需要向客户端返回缓存的元数据信息，而不是每个请求都要向数据库服务器进行一次元数据的查找，因此，可以在不影响线上的服务的情况下实现数据库服务器集群的负载均衡。
5. 降低数据库服务器的内存占用：缓存能够有效地减少数据库服务器的内存占用，例如，如果没有缓存机制，对于每一个正在运行的查询进程来说，它都需要打开相应的表文件才能获取相关的元数据信息，这会占用很大的内存资源。而使用INFORMATION_SCHEMA缓存后，数据库服务器只需要保存一份元数据信息，就可以供整个数据库服务所共享，无需重复打开文件。
# 5. 如何开启INFORMATION_SCHEMA缓存
可以通过SET GLOBAL变量命令设置information_schema_stats_expiry参数的值，单位为秒，表示每隔多久清除一次元数据信息缓存。也可以通过命令行中的--flush-cache选项手动刷新缓存。
```mysql
-- 设置全局缓存超时时间为半小时。
set global information_schema_stats_expiry = 1800;

-- 查看当前设置。
show variables like 'information_schema_stats%';
```
# 6. 缓存失效问题排查方法
在配置完INFORMATION_SCHEMA CACHE后，如何检查是否存在缓存失效问题呢？下面我们来看一下常见的问题排查方法。
## 6.1 没有看到最新元数据信息
查询元数据信息时发现查询的结果不是最新的，这可能是因为元数据信息的缓存已经过期了。可以使用SHOW STATUS命令查看到期信息的缓存数量：
```mysql
show status like '%Metadata%';
```
如果Metadata_stat_expiry的值为非零，表示元数据信息的缓存已启用，过期信息数量等于刷新间隔/过期时间。如果Metadata_stat_expired的值为零，表示元数据信息的缓存尚未启用，过期信息数量为零。
## 6.2 SHOW VARIABLES或SHOW GLOBAL VARIABLES报“Variable doesn't exist”错误
这可能是因为还未设置information_schema_stats_expiry参数导致。可以使用SET GLOBAL或配置文件修改该参数的值，重启数据库服务即可生效。