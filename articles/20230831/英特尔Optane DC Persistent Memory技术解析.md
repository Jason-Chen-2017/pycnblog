
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## Optane DC Persistent Memory是什么？
Optane DC Persistent Memory（OPTANE）是英特尔公司于2017年推出的一种新型非易失性内存，其具有高性能、低延迟和极低电压成本等特征，能够为多种行业领域提供高效且持久的数据存储方案。如今，已经成为很多计算机、存储设备和移动应用的标配技术，它由硬件部件及驱动程序组成，是一种高端内存类别，与传统闪存、SSD等相比，具有更大的容量、吞吐率、时延和功耗。在性能上，Optane DC Persistent Memory相较于传统闪存等有着明显优势，其数据访问速率达到了每秒数百万次，同时系统能耗只有1-2%。在价格方面，Optane DC Persistent Memory价格便宜、便携，甚至可以与闪存、SSD、RAM等相同配置的产品媲美。但另一方面，作为存储技术，其安全性仍然依赖于固态硬盘等介质，尚处于起步阶段，难免会受到各种安全威胁和攻击。
## 为何需要Optane DC Persistent Memory？
过去几年里，随着云计算和容器技术的发展，服务器的性能提升和硬件性能要求不断提升，传统硬盘已经无法满足需求。云厂商和开源社区都致力于寻找新的存储解决方案，以应对这一需求。业界主要关注三类解决方案：超级快盘、块存储、文件存储。但是，由于存储性能、成本等诸多因素综合考虑，除超快盘之外，其他两种解决方案也不是完全没有市场。

超快盘的性能已经远远超过普通硬盘，但在设计上却有一定的局限性。首先，超快盘的容量和带宽都是静态的，即使扩容也需要将整个设备替换；其次，超快盘的特性使得它只能用于冷存储场景，无法实现热数据缓存和分析等高性能用途，不能用于计算密集型工作负载。另外，超快盘的寿命一般不会太长，而且造价偏高，很难接受。

块存储通常采用裸设备，将多个磁盘连接起来，提供一致的I/O接口。这种方式虽然简单可靠，但性能很差，无法支撑海量数据的处理。文件存储则是基于分布式文件系统，提供了统一的文件接口，支持多种编程语言和操作系统。但是，由于其分布式设计和复杂的网络拓扑结构，性能也不一定能达到同样的水平。

经过这么多年的发展，除了超快盘和块存储之外，目前还没有一个完美的存储解决方案。有些公司正在努力研发新的存储解决方案，比如阿里云的OCS、腾讯云的Cloud Disks，等等。这些新方案或许能在某些特定场景下取得不错的效果，但绝大部分情况下还是受制于设计上的限制和性能瓶颈。Optane DC Persistent Memory正好填补了这个空缺。
## OPTANE是如何工作的？
Optane DC Persistent Memory最核心的技术是基于闪存颗粒的存储架构。该架构将闪存颗粒直接嵌入在IC中，并利用闪存内部的编程技术实现非易失性存储，无需接触用户可见的底层Flash芯片。这样做既避免了潜在的物理损坏风险，又能节省大量的运营成本。OPTANE DC Persistent Memory的核心组件是**PDMA存储器模块**，该模块由主存与PCIe存储接口两部分构成，可以对外提供统一的存储接口。如下图所示，Optane DC Persistent Memory包括三个关键部分：
1. PMem堆：这是Optane DC Persistent Memory真正的存储空间，采用非易失性闪存颗粒，能提供高效且持久的存储能力。
2. DRAM缓存：用来存放最近读写数据的快速缓存。通过预取机制，能够减少延迟。
3. SSD缓存：为了保证数据的一致性，OPTANE DC Persistent Memory内置了一款SSD闪存作为冷数据缓冲区，用来临时保存写入的热数据。SSD的特性决定了其速度要远远高于DRAM缓存。

PMem堆存储空间分为三个区域：**Pool（共享池）、AppDirect（应用独占）、File（文件系统）**。

1. Pool：共享池中可以划分出多个大小不同的空间，每个空间称为一页（Page）。PMem堆中的所有Page都共享一个全局映射表（Global Mapping Table，GPT），该表记录了所有Page的地址信息。当应用程序请求访问某个Page时，都会通过GPT找到对应的物理地址，并完成访问。
    * 使用共享池分配空间时，申请到的空间都是连续的，适合于需要大批量数据存储的场景，比如数据库、文件服务器等。
    * 在共享池中分配的空间都是闪存颗粒大小的整数倍，因此需要注意对齐和分配策略，才能确保各个页之间能够被覆盖。

2. AppDirect：应用独占空间主要用于针对特殊应用场景的内存分配，类似于TmpFS。AppDirect中的内存是不可分页的，也就是说，应用程序不能把它换出到磁盘，只能留在AppDirect空间中，这对于一些要求高效处理、临时存放数据的应用非常有用。
    * AppDirect中分配的空间也是闪存颗粒大小的整数倍，但它的作用范围是单个应用程序，各个进程之间是隔离的。
    * 可以通过调用POSIX API mmap()，将文件或者其它形式的存储设备映射到内存中，以获取高效、灵活的随机访问能力。

3. File：文件系统部分用于存放文件系统元数据、日志、快照等，并且使用DRAM缓存优化其访问性能。File是动态扩展的，当应用程序写入的数据超过当前文件的剩余可用空间时，就自动创建新的文件进行存储，直到满了为止。

总体来说，Optane DC Persistent Memory的存储架构与传统的DRAM缓存、SSD缓存不同，它将闪存颗粒直接嵌入在IC中，有效降低了闪存的成本和耐用性，提升了存储的速度、效率和成本。相比于传统的闪存，其数据访问速率可以达到每秒数百万次，性能比传统SSD高出几个数量级，而且不需要频繁刷新，适合高性能的关键任务和大容量数据分析场景。