                 

# 1.背景介绍


InnoDB存储引擎是一个高性能的事务型存储引擎，由Oracle公司开发。其支持外键完整性约束、事务ACID特性、行级锁定和外键索引等。MySQL版本从5.5开始支持InnoDB存储引擎，并设为默认存储引擎。

2.核心概念与联系
## InnoDB存储引擎概述
InnoDB存储引擎支持热插拔：可以对InnoDB表进行增加字段、修改表结构、表碎片整理等操作而不影响数据完整性。InnoDB存储引擎也支持通过快照隔离级别来实现多版本并发控制（MVCC），即读操作不会阻塞写操作，写操作只会等待读操作完成后才能执行。

InnoDB存储引擎具有四大特性：
- 支持事物 ACID：InnoDB支持ACID特性，包括事务提交、回滚、崩溃恢复和持久化等操作。
- 行级锁定：InnoDB采用了行级锁定策略，即每次仅对需要锁定的行加锁，而不是整个表加锁，从而提升了数据库并发处理能力。
- 自适应Hash索引：InnoDB存储引擎支持自适应Hash索引，即在执行条件查询时，会自动生成哈希索引；也可以手动指定索引列进行范围扫描。
- 聚集索引：InnoDB的聚集索引和非聚集索引都存在，其中主键索引就是聚集索引，其他索引都是非聚集索引。

InnoDB存储引擎的主要优点：
- 数据以索引组织方式存放，从而加速数据的检索。
- 使用异步的方式处理INSERT、UPDATE和DELETE语句，保证数据安全。
- 提供对数据库运行情况的监控和统计信息。
- 支持事物和行级锁，保证数据的一致性。

## 表空间与页
InnoDB存储引擎中所有的表都是逻辑上分割成多个页组成的段(extent)文件来存储的。这些页大小是可配置的，通常默认为16KB到64KB之间。每个页头部包含page header、undo记录、槽位等信息。其中page header包括页号、页面类型、页面状态等信息，该信息用于维护页的正确性和完整性。InnoDB存储引擎将一个表的数据保存在若干个连续的磁盘页中。每个页中都包含了若干条记录，每条记录保存着用户插入或删除的数据。页中的数据按照主键顺序排列。每个区（extent）由一个或多个连续的磁盘页组成，一个表对应一个或者多个区。不同区的物理顺序是任意的，但是逻辑上相邻的区物理地址是连续的。因此，InnoDB存储引擎通过物理位置把表中的数据划分成不同的段，每个段中的数据可以根据需求进行缓存和读取。

## 数据页组织
InnoDB存储引擎的存储结构是页组织的，一个页通常为64KB，里面可以存储多个数据记录，但是页内的数据不能跨页。所以InnoDB存储引擎的一个大页可以存放很多数据记录。如果一条数据记录占用多个页的话，InnoDB会将它切分成几个物理页来存储。这样做的目的是为了满足一些查询需求，比如：当一条数据记录较大时，可以直接从对应的物理页开始读取；又比如：可以避免因数据量太大导致的内存占用过高的问题。

InnoDB存储引擎的数据页分为三种：索引页、数据页和 undo页。
- 索引页：InnoDB存储引擎的主索引树和辅助索引树中的节点都是放在索引页中，每个索引页可以存放多个B+树的节点。每张表都有一个隐藏的自增长的ID，也就是聚集索引，记录了当前记录在表中的顺序，每个数据页可以存放一个聚集索引，不过这个索引不是数据本身所拥有的，而是隐藏的。
- 数据页：存储真正的数据记录。在InnoDB中，所有的数据记录都会先写入数据页中。数据页的大小是可配置的，默认为16KB到1MB。如果一条数据记录超过16KB，则会被切分成多个物理页来存储。
- Undo页：用来存放ROLLBACK操作产生的回滚日志。Undo页的大小也是可配置的，默认为16KB到512KB。如果一条事务涉及的行比较多，可能会产生很多的回滚日志，就会占用大量的Undo页资源。

## 插入缓冲机制
InnoDB存储引擎引入了插入缓冲机制，使得每当向表插入新的记录时，数据首先会被缓存到一个地方，称为插入缓冲区(Insert Buffer)。每当插入缓冲区满的时候，才会一次性将缓冲区中的数据插入到数据页中，这就确保了插入操作的原子性，保证数据一致性。同时，由于插入缓冲区只是缓冲新插入的数据，所以即使数据库发生宕机等故障也只会丢失最近未落盘的事务。

对于MyISAM表来说，由于没有插入缓冲机制，所以每当向表插入一条记录时，就要立即将数据页写入磁盘，这就有可能降低插入操作的效率。InnoDB存储引擎的插入操作都不会直接落盘，而是先写入插入缓冲区，然后再定期合并插入缓冲区中的数据到数据页中。

## 日志模块
InnoDB存储引擎提供了一个完善的日志模块，可以跟踪数据的修改，并且可以用来进行错误恢复和数据安全性的保证。每当对数据库进行更新操作时，InnoDB存储引擎都会记录这些更新操作的Redo日志。Redo日志的内容包括数据页的修改、删除和创建，以及其他与数据页相关的操作，如创建、打开、关闭等。Redo日志与数据页是分开存储的，所以即使数据库发生异常崩溃，也可以从Redo日志中恢复出最新的正常状态。

由于 redo log 的存在，InnoDB存储引擎在崩溃时，在Recovery阶段能够很好的保持数据一致性。在Redo日志写入磁盘之前，InnoDB存储引擎会先将redo log buffer 中的日志刷新到磁盘上，这样可以在崩溃时恢复数据。

## 自适应哈希索引
InnoDB存储引擎在执行条件查询时，如果发现一个索引不能够满足查询条件，那么InnoDB存储引擎会尝试自己生成一个哈希索引来执行查询。在创建哈希索引时，InnoDB存储引擎会根据估算结果，分配合适的哈希桶数量，以尽可能减少哈希冲突。除此之外，InnoDB存储引擎还会维护一个候选池，用来临时存储需要生成哈希索引的列值。

自适应哈希索引的使用方式如下：
1. 设置参数innodb_online_alter_log_max_size的值为1G，以便于维护插入缓冲区，避免在ALTER TABLE过程中出现大量的日志。
2. 在业务高峰期，使用ALTER TABLE语法对主索引列添加索引，如ALTER TABLE table_name ADD INDEX (column_name);
3. 通过查询SHOW INDEX FROM table_name命令查看新增的索引是否生效。