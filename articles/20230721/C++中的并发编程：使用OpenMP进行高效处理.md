
作者：禅与计算机程序设计艺术                    
                
                
多核CPU（英语: Multicore CPU），又称超线程CPU，是一种特殊的计算机系统，它由多个物理CPU单元组成，每个CPU单元可同时执行多个指令。而现代操作系统均提供了对多核CPU的支持，使得同一个应用程序可以并行地运行在不同的CPU上。多核CPU的出现使得CPU的计算能力得到了显著提升，并且CPU的利用率也越来越高。但是由于并发执行的特点，导致不同CPU单元之间频繁切换，使得程序性能较低。为了充分发挥多核CPU的处理能力，需要充分利用并行性。在C++语言中，可以使用OpenMP(Open Multi-Processing)库进行并发编程。本文通过学习OpenMP中的原理、关键词和语句等知识点，阐述OpenMP提供的并发编程模型，以及如何在实际项目中进行OpenMP编程。
# 2.基本概念术语说明
## 2.1 OpenMP简介
OpenMP，全称Open Multi-Processing，是一组标准化的编译器指令，它允许用户指定共享内存并行代码区域。该指令集被设计用于共享内存的多处理器系统上，能够支持复杂的并行编程模式，包括单核、多核、分布式系统上的并行计算。OpenMP规范定义了一系列的预处理器指令，供开发者使用，这些指令用来指示编译器生成并行代码，并将其映射到多个线程或处理器上。该规范还定义了数据共享、同步机制和一些环境变量，这些特性可以帮助开发者构建高度优化的并行程序。
## 2.2 OpenMP的编程模型
OpenMP的编程模型基于共享内存模型，即所有线程都具有相同的全局内存空间。每个线程都有自己的私有数据空间，但可以访问其他线程的私有数据空间。共享内存模型提供了简单、有效的并行编程模型，可以充分利用多核CPU资源。OpenMP提供了三种并行编程模型：
- 数据并行(Data Parallelism): 把任务的数据划分为多个部分并行执行。例如，对一个数组元素进行求和运算，可以把这个数组切割成多个小数组，分别计算每个小数组的元素之和，再合并结果。
- 任务并行(Task Parallelism): 对任务进行细粒度的并行。例如，假设有一个任务要完成n个步骤，可以把这n个步骤分配给n个线程，让每一个线程独立完成一步。
- 向量化并行(Vectorization Parallellism): 使用向量指令，在一条指令序列上并行执行多个数据项。例如，一条指令可以对两个浮点数进行加法操作，当两个浮点数都是向量形式时，就可以并行执行两个浮点数的加法。
## 2.3 OpenMP中的关键词
### 2.3.1 共享变量
OpenMP提供了两种方式来声明共享变量：
- threadprivate: 以threadprivate修饰符修饰局部变量，表明该变量在每个线程的作用域内只初始化一次。这样做可以节省资源开销，因为每个线程仅需存取自己线程私有的本地副本即可。
- shared: 以shared修饰符修饰全局变量，表明该变量可以在所有线程间共享。可以通过互斥锁来同步对此变量的读/写操作。
### 2.3.2 工作sharing
OpenMP使用parallel构造来定义并行块。parallel块是一个并行区域，里面的代码将在多个线程上执行。parallel构造接受三个参数，它们用逗号隔开：
- num_threads: 指定线程数量。如果不指定，则默认创建与CPU核心数相同的线程数量。
- if (condition): 只有满足条件表达式才执行并行块。
- private(list): 指定需要共享的局部变量列表，如无此项则默认共享所有的局部变量。
### 2.3.3 同步
OpenMP提供了以下几种同步机制：
- barrier: 使所有线程等待至barrier处。
- critical: 创建一个临界区，使得同一时间只允许一个线程进入临界区的代码段。
- atomic: 可以保证被atomic修饰的语句是原子操作，从而防止数据竞争和死锁发生。
- flush: 将缓存中的数据刷新到主存中。
### 2.3.4 并行构造
- for 循环：可以并行化for循环。
- sections 分割：可以对代码块进行分割，并行执行各个分割出的代码块。
- single：可以将指定的代码块作为单独的工作单元并行执行。
- task：可以将一个工作分派给一个新的线程去执行。
## 2.4 OpenMP中的语句
### 2.4.1 任务分派
parallel for语句用来将循环分派给多个线程。语法如下：
```c++
#pragma omp parallel for [clause[[,] clause]...] new-line
    for-loop
```
其中clause表示OpenMP子句。new-line是换行符，表示在其后紧跟着新的代码行。for-loop是使用OpenMP进行并行化的循环结构。

除了parallel for，OpenMP还提供了parallel语句。parallel语句用来将循环分派给多个线程，并行执行循环体。语法如下：
```c++
#pragma omp parallel [clause[[,] clause]...] new-line
   structured-block
```
structured-block是被并行化的代码块，可以有若干语句和语句块。

task语句用来将一个工作分派给一个新的线程去执行。语法如下：
```c++
#pragma omp task [[[,] clause]... ] new-line
   statement
```
statement表示要被执行的语句。

taskwait语句用来等待之前创建的所有任务都完成之后再继续下一步的执行。语法如下：
```c++
#pragma omp taskwait
```
### 2.4.2 合并
nowait语句用来声明在屏障前不应该一直等待，以便其它线程可以先执行。语法如下：
```c++
#pragma omp nowait
```
mergeable语句用来声明该部分代码可以进行合并。语法如下：
```c++
#pragma omp mergeable
```

