
作者：禅与计算机程序设计艺术                    

# 1.简介
  

边界路由（Border Gateway Protocol，BGP）是Internet协议族中用于互联网exchange路由信息的应用层协议。在实际运用中，由于网络设备数量庞大且复杂多变，导致BGP路由表信息存在大量冗余，各个ISP之间交换路由信息时也容易出现错误。在BGP安全问题日益凸显的当下，如何保障边界路由器的安全和功能正常运行至关重要。 

此外，边界路由还承担着数据中心网管和骨干路由器的角色，因此其安全可靠性在整个网络系统中具有重要作用。然而，边界路由存在着两个难点：

- BGP伪造攻击：边界路由由于距离比较远，可以直接接受来自多个出口的路由汇报，使得它可以产生有效的路由选择结果；并且由于路由信息的冗余，任何一个路由器都可以获得相同的路由，从而可能出现多个ISP共用一条有效路径的情况。因此，要保障边界路由的有效性和准确性，需要对BGP路由的验证机制进行有效的管理和控制。

- BGP路由陷阱：目前，很多防火墙产品都提供了基于BGP的入侵检测和防御能力，但这些产品都仅局限于简单的DDoS攻击场景，缺乏针对复杂BGP路由陷阱攻击的有效保护措施。比如，一些家用路由器会通过修改默认路由，绕过系统路由限制，让流量经过某个非法目的地，甚至可以导致网络拥塞甚至网络瘫痪。

本文将详细介绍这两个BGP安全性的难点，并提出相应的解决方法。

# 2.基本概念术语说明

## 2.1 BGP协议

### 2.1.1 BGP是什么？

边界网关协议（Border Gateway Protocol，BGP）是一个互联网边界网关路由协议，用于互联网上的内部网关（router）之间传递路由信息，其所涉及到的知识网络包括AS（Autonomous System，自治域）、BGP路由、BGP路由表、BGP Next Hop、IBGP、EBGP等，BGP协议由RFC1771定义，目的是为了减少Internet上网络拓扑中的路由环路，及减少路由信息的传输，提高网络的可靠性和可用性。

### 2.1.2 BGP工作流程

- 建立连接（建立BGP连接时，各个BGP peers首先会先协商连接，然后发起OPEN消息，用于建立BGP连接。）
- 发出初始路由请求（每个BGP peer会周期性地向相邻peer发送UPDATE消息，获取到整个路由信息表（routing information base）。）
- 检查并更新路由表（当各个BGP peers收到路由信息后，会对路由信息进行检查，如果存在问题或错误，则会生成NOTIFICATION消息通知对方。）
- 更新邻居（当某些路由发生变化时，一些BGP peers可能不会主动发出UPDATE消息，因此需要定期向邻居发送KEEPALIVE消息，用于保持TCP连接状态。）

### 2.1.3 BGP路由类型

- IBGP：同一个AS内的所有路由器都知道彼此的路由信息。
- EBGP：不同AS之间的路由器之间通过BGP协议通信，但是两者间不共享路由信息。

## 2.2 BGP路由表

在BGP路由过程中，有一个路由表用来保存所有可达的路由。每一个BGP路由表由多个路由条目组成，每条路由条目都包括三个部分：

1. Network Prefix：IP地址或子网掩码，即目的IP范围
2. Next Hop IP Address：下一跳路由器的IP地址
3. AS Path：描述了到达目的地址的AS的序列，以确定经过哪些路由器。

路由表具有以下特性：

1. BGP路由表可以随时间动态变化，因为BGP使用的方法是客户机服务器模式，BGP peers之间会定时交换路由信息。
2. 每个AS的路由表是独立的，不存在任何竞争关系。
3. BGP路由表大小没有限制，但是在正常情况下，BGP路由表不会太大。
4. 通常，路由表的有效生命周期比BGP peers的生命周期长得多。

## 2.3 伪造路由攻击（BGP Route Hijacking Attacks）

伪造路由攻击就是利用BGP协议中一些安全漏洞，诱导路由流量通过中间的路由节点，最终将流量引导到无权限的目标网络。一般来说，伪造路由攻击分为两种：

1. Asymmetric Traffic Flow Attack：即欺骗路由器的转发行为，让其认为发出的流量应该直接到达某些特定目的地址，然后再转发给其他网络。这种类型的攻击方法较为特殊，需要攻击方拥有足够的资源和时间。
2. Multiple Route Injection Attack：即在BGP路由表中引入多个相同的路由条目，模拟多个路径的路由流量，直到路由通过某一路由节点时，将流量引导到假想的受害者网络。这种类型的攻击方法更加隐蔽，常见于流量劫持和中间人攻击。

## 2.4 BGP拒绝服务攻击（BGP Denial of Service Attacks）

BGP拒绝服务攻击是在路由器端或在BGP peer之间，使用“黑客”的手段或行为，通过利用路由器的资源，消耗其处理路由消息的能力，甚至致使路由器崩溃或停止运行。有以下几种形式：

1. Open Connection Flooding Attack：即耗尽远程系统的TCP连接资源，触发拒绝服务攻击。
2. UPDATE Message Flooding Attack：即向远程BGP peer发送大量的UPDATE消息，触发拒绝服务攻击。
3. Memory Exhaustion Attack：即耗尽内存资源，触发拒绝服务攻击。

## 2.5 边界路由防火墙

边界路由器提供的服务主要包括动态路由、策略路由、访问控制、QoS保证、静态路由等。而防火墙作为网络运营商在边界路由器与用户、其它网络之间的连接，保障边界路由器的正常运行及提供必要的服务质量保证。

防火墙具备的功能包括入侵检测、入侵防御、流量控制和内容过滤，提供多种规则配置方式，如基于IP、MAC地址、协议、端口、URL和应用等，满足不同业务场景下的防火墙需求。

## 2.6 ISP代理路由器

ISP代理路由器（Proxy Router），即私有电信接入运营商的网络设备，位于边界路由和本地网络之间，主要用于统一管理公网的路由。它的特点是部署在ISP的办公室内，性能和带宽较高，可以为多个用户提供服务。

# 3.BGP安全性的难点

## 3.1 BGP拒绝服务攻击

BGP拒绝服务攻击一般是指通过大量发送不合法的UPDATE消息或发送过多UPDATE消息，消耗远程BGP peer的系统资源，导致其崩溃或停止运行。由于更新过程占用网络资源，其危害程度极其严重，因此影响广泛。

最常见的BGP拒绝服务攻击方式有以下几种：

1. 消耗内存攻击：因对BGP进行了恶意攻击，而导致内存耗尽或溢出，进而使系统卡死或崩溃。
2. 发送UPDATE过多攻击：攻击者将大量不正确的UPDATE消息发送到远程BGP peer，甚至导致TCP连接被关闭。
3. DOS攻击：在一段时间内大量发送不合法的TCP SYN包，导致远程主机连接超时或无法正常工作。
4. Ping of Death攻击：攻击者使用大量的ICMP ping包，消耗CPU资源，导致系统卡死或停止运行。

目前，由于企业级防火墙的发展，路由器及Isp代理路由器的性能及处理能力有所提升，同时也需要采取一些有效的应急预案，才能应付BGP拒绝服务攻击。

## 3.2 BGP伪造路由攻击

BGP伪造路由攻击又称为BGP路由陷阱攻击，攻击者通过欺骗中间路由器的转发行为，把流量引导到虚假的目的网络。最常见的攻击模式如下：

1. 默认路由绕过：攻击者会修改默认路由的目的地址，使得流量经过某台非法的网络，然后转发给其他网络。
2. 数据包注入攻击：攻击者会在路由流量中加入病毒或木马，迫使流量被传输到一个无效的目的地址。
3. BGP聚合攻击：攻击者会通过修改BGP路由聚合的方式，让流量通过多个路径，最终流向一个非法的目的地址。

目前，防火墙产品和技术已有进一步的改进，可以通过分析攻击流量特征、阻断攻击源头、设置安全策略等措施，降低BGP伪造路由攻击的威胁。

# 4.解决方案

## 4.1 对BGP路由做校验

BGP路由校验是通过判断更新的路由是否有效、可靠，如果路由不可靠，则丢弃该路由。校验的方法有多种，最常用的有以下几种：

1. Peer属性校验：根据对方BGP peer的AS号，AS前缀，可用性，运营商类型等进行校验。
2. Originator属性校验：当路由来源于某一个AS时，判断其是否为可靠的BGP发起者。
3. Metric属性校验：判断路由的路径长度、费用、丢包率等参数，确保其合理性。
4. Community属性校验：判断路由是否已经被标记，可用于标记异常路由。

## 4.2 多播隔离

在运营商提供的服务中，存在着大量的用户共享同一个公网IP地址。因此，ISP为了保证服务质量，会在其本地区域部署多播路由器。

多播路由器会对接收到的多播流量进行分类，将符合条件的多播流量送往指定目的地。由于不同的用户可能在使用同一份路由表，使得共享公网IP的用户之间存在路由歧义，从而可能发生流量的混乱。

因此，在运营商本地部署多播路由器时，需要考虑采用多播隔离策略。多播隔离策略是通过在多播路由器上建立子网，实现同一IP地址的用户使用不同的子网，从而避免出现路由歧义。

## 4.3 配置默认路由策略

对于默认路由，BGP默认使用最长匹配规则，即查找距离目的网络最近的路由，这种规则可以保证一定程度的路径可靠性。

然而，对于一些特定的目的网络，比如路由器所在的LAN网段、公共网络等，ISP需要对默认路由进行限制，只允许流量通过特定的路由，这样可以避免因路由冲突，导致流量无法正常传输。

除此之外，还可以对ISP路由器进行配置，只允许流量通过特定的路由器，或者禁止通过某些特定的网段。这样可以进一步保障ISP路由器的安全。

## 4.4 使用VPN加密数据

VPN（Virtual Private Network，虚拟专用网络）是一种加密的数据通道，可以在公网中建立安全的数据隧道，即在公网中，使用VPN加密数据的传输，就像使用加密通信一样。

通过VPN加密数据，可以帮助运营商保障数据的私密性、安全性和完整性。但是，使用VPN会增加公网的负载，也可能会引起公网堵塞，因此，如果能够控制流量的进入和离开，那么VPN就会成为运营商的一项强有力的手段。