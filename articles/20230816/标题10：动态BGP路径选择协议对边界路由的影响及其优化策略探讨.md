
作者：禅与计算机程序设计艺术                    

# 1.简介
  

随着网络规模的不断扩张，Internet逐渐成为世界范围内的一个重要交换节点，对于流量管理而言，如何有效地把源地址路由到目的地址，是网络运营者在面临成千上万个IP地址时制订路由策略的一个基本要素。而由于Internet是一个巨大的分布式系统，使得路由信息的收发和快速更新变得十分困难，不同区域间甚至国家间存在大量路由冲突，这些都导致了网络中存在大量的冗余路由。

基于当前网络的特点，边界网关协议（Border Gateway Protocol, BGP）是最主要的路由选择协议之一。BGP协议作为一种开放标准，已经被IETF和一些Internet服务提供商所采用，它负责在互联网上传递、路由和交换路由信息。BGP通过控制AS之间的互相交换路由信息，帮助网络实现端到端的连接，提高了Internet的可靠性和可用性。

BGP的运行模式是一个中心化的、动态的、基于策略的路由选择协议。与传统的静态路由协议相比，BGP可以根据网络的运行情况实时调整路由表，并且能够向分布在各地、存在路由聚合、分配策略等多种因素的边缘路由器发送路由更新消息。因此，BGP是一种具备灵活性、弹性的路由选择协议，可以实现较为精确的路由选择。但是，由于BGP是一种动态路由协议，也存在一些特有的影响边界路由问题，如网络拥塞、网络拥挤、负载均衡、延迟抖动等。本文将会对BGP路径选择协议对边界路由的影响及其优化策略进行详细的阐述和分析。

# 2.边界路由概述
边界路由是指利用BGP动态路由功能实现自治域内部主机的路由选择，即边界路由器只配置相关自治域内的路由目标，实现自动路由选择功能，并直接将路由信息传播到相邻自治域的边界路由器。边界路由具有以下几个优点：

1. 提升边界路由器的灵活性：边界路由器仅需配置相关自治域内的路由目标，就可以实现自动路由选择，从而实现自治域内部主机的选择性连通，降低边界路由器的路由压力；
2. 减少路由信息的过度传递：边界路由器仅接收相关自治域内的路由目标，可以避免因无用路由信息的过度传递造成的网络性能下降，节约网络带宽资源；
3. 增加边界路由器的可靠性：边界路由器可以根据本地自治域的网络环境、本地路由状况等条件实时调整路由策略，增加自治域内的可靠性，防止路由失败引起的网络异常；
4. 降低公共网络带宽压力：边界路由器可以将自治域内的路由目标收敛到相邻自治域，通过中继的方式减小自治域间的路由信息流量，缓解公共网络带宽压力；
5. 提升自治域内部流量调度能力：边界路由器在自治域内部实现了专用的流量调度功能，可以实现对流量的精准调度，提高自治域内部的用户体验。

虽然边界路由在网络运维中具有非常重要的作用，但同时也存在一些潜在的问题。例如，由于边界路由器的静态路由配置，容易引入静态路由环路，给路由系统带来严重的效率问题。另外，在处理分组传输过程中，边界路由器可能会受到拥塞控制的干扰，从而导致部分流量无法正常传输，甚至出现分组丢失或者拥塞反弹现象。为了解决以上问题，边界路由的设计者们在优化策略上也做了很多工作。 

# 3.BGP路径选择协议
## 3.1 BGP基本功能和属性
BGP是一个高度可扩展的动态路由选择协议，支持的网络类型包括以太网、VPN、ATM、其他三层网络以及多种类型的网络设备。在运行过程中，BGP协议会首先确定自己与邻居的距离，然后根据距离向邻居宣告哪些路由可达，并通知它们，邻居也会同样向自身宣告路由，最终建立起整个BGP路由表，这个过程称为BGP学习过程。

在本质上，BGP是一个自动路由选择协议。在学习完路由后，BGP协议会比较两个路由的属性（即路径属性），选出一个更好的路由，并通过各种手段通知所有相邻的路由器，使得变化得到传播。BGP还支持多种策略，可以自定义是否生成、使用或接受路由，允许定义路由回退的优先级，以及管理密钥和路由密钥认证方案，可以增强BGP的安全性。

## 3.2 BGP动态路由协议
在了解了BGP的基本属性之后，下面我们就来看一下BGP的动态路由协议。

### 3.2.1 对等动态路由协议(RIB)
BGP使用的是对等动态路由协议，其中每个节点都维护一个Routing Information Base (RIB)，用于存储路由信息，并通过向相邻节点发送定期更新的信息来交换路由信息。每个节点的RIB记录了自身所看到的所有路由，并可以依据路由的路径属性和所在位置生成、修改和删除路由。

在BGP协议中，有两种类型的数据包需要通过TCP或UDP端口来传输，分别是BGP报文和BGP更新报文。BGP报文是一条路由，其中包含目的IP地址、下一跳的IP地址、下一跳接口以及其他一些数据，比如首部标记、生命周期、标签等；BGP更新报文则是在路由发生改变时，发送给BGP speaker的报文，用于通知相邻BGP speaker有路由信息发生变化，并建议speaker修改本BGP speaker中的相应路由条目。

BGP每隔一定时间就会发送一次BGP更新报文，用于通知邻居有哪些路由发生了变化。当A向B发送BGP报文时，B首先将该报文加入自己的RIB，然后根据路径属性、所在位置和配置的策略生成或修改相应的路由条目，并向B的相邻BGP speaker广播该报文，B的邻居知道有新路由，然后更新自己的RIB。

### 3.2.2 外部动态路由协议(EBGP)和内部动态路由协议(IBGP)
BGP还支持外部BGP和内部BGP，外部BGP用于连接多个AS之间的路由器，内部BGP用于连接单个AS中的路由器。两个路由器之间通过iBGP互相连接，而两个AS之间通过eBGP互相连接。

在iBGP中，两个路由器彼此直接交换路由信息，不存在不同AS之间的路由信息。通常来说，iBGP是用户网络和内部网络之间交换路由信息的主力协议。iBGP可以使用密码认证或者数字签名等方式来保障通信的安全。

在eBGP中，两个路由器彼此相互交换路由信息，所有AS之间的路由信息都经过这种方法交换。通常情况下，AS内部的路由器使用iBGP协议，AS之间的路由器之间使用eBGP协议。eBGP可以通过TCP/IP或其他标准的方法加密或验证数据包。

### 3.2.3 Route Reflection和Route Refresh
BGP除了交换路由信息之外，还有一种机制叫做Route Reflection，即路由反射。当AS中的某个路由器收到来自另一个路由器发出的关于它的路由信息时，如果没有这个路由器的私钥，那么它不会转发这个信息。然而，对于某些路由器来说，可能是因为各种原因才没有安装私钥，而这种情况下，就需要用一种机制来让另一端的路由器自己获取路由信息。

BGP使用Route Reflector的概念来实现Route Reflection。在iBGP中，每个路由器都会向其邻居的一半发送路由，这种机制称为Full-Mesh。当某路由器接收到来自邻居的关于某个路由的信息时，它会重新向所有邻居发送该信息。这样，所有路由器都能收到关于某个路由的信息，而不是只有部分路由器能收到。这种机制可以防止路由的环路。

除了Route Reflection，BGP还支持Route Refresh机制，用于触发邻居的路由信息刷新。当某个路由器接收到来自邻居的关于其路由的刷新请求时，它会在一定时间内发送相应的路由信息。这可以用来减少路由表的陈旧程度，提高路由的正确性。

### 3.2.4 BGP Path Selection
BGP的路由选择策略包括三个方面：Local Preference、AS Path Length Penalty、MED Attribute。

Local Preference是BGP报文中用于表示路由优先级的参数。Local Preference的值越大，优先级越高，路由的生成和安装就更可能发生。

AS Path Length Penalty是在AS路径长度上的惩罚。AS PATH Length Penalty是一个计算出来的参数，它依赖于AS PATH中每个AS的位置，表示了AS间路由的不对称程度。一个较短的AS PATH长度的路由相对于一个较长的AS PATH长度的路由，会获得更小的AS PATH LENGTH PENALTY值。

MED Attribute是多路径优选度的一种度量方式，可以理解为路由的延迟抖动。它将路由标记成不同的服务质量级别，然后选择响应最佳服务质量的路由。

## 3.3 BGP对边界路由的影响
BGP对边界路由的影响主要体现在以下几个方面：

1. BGP动态路由协议占用大量网络资源：BGP协议动态生成的路由，不断地向邻居发送更新消息，会占用大量网络资源，尤其是路由信息的过度传递会造成严重的网络拥塞和性能问题。例如，全球四分之一的路由发生变化时，BGP协议的传播速度可以达到1Gbps。
2. 边界路由器维护不必要的路由：边界路由器往往负责自治域内部的所有路由，但是由于边界路由的部署位置，有时候会产生一些不必要的路由，浪费网络资源。例如，若路由器只需要某个自治域的路由，而不关注其他自治域的路由，那么它就不需要维护其他的路由，降低了网络资源的消耗。
3. 边界路由器中的负载均衡策略不好适应变化：随着BGP协议的不断演进，边界路由器的负载均衡策略也在不断变化，但仍然不能很好地适应网络的动态变化。例如，若某个服务器出现故障，路由器将其下线，然而由于负载均衡的关系，相同流量的流向还是发生了变化。
4. 边界路由器在一些场景下容易产生拥塞：在部分场景下，边界路由器的路由选择策略不够高效，容易导致流量的拥塞，甚至导致部分流量的丢弃。例如，在路径阻塞时，边界路由器可能希望减少传输流量，但如果传输率低于边界路由器的理想值，就可能出现拥塞，导致流量的丢弃。
5. BGP路由策略优化可以显著提升网络性能：针对上面提到的BGP协议问题，可以提出一些优化策略，如减少路由信息的传播频率，限制发送方向等，以提升网络性能。

# 4.BGP路径选择协议优化策略
目前已有的优化策略主要分为两类：一类是减少路由信息的传播频率，另一类是限制发送方向。

## 4.1 减少路由信息的传播频率
减少路由信息的传播频率可以减少BGP路由信息的传播速度，提高路由更新速度，进一步减轻网络的负担。一般的减少传播频率的方法有以下几种：

1. 使用多播技术：BGP协议支持通过多播的方式把路由信息传播到相邻的边界路由器，提高了路由信息的传播效率。多播路由信息传播方式可以在一定程度上减少网络资源的消耗，防止网络拥塞。
2. 修改默认的路由选择策略：BGP协议默认情况下会按照配置的路由选择策略来生成和选择路由，当存在多条路径可以到达目的地址时，BGP协议默认会选择路径的第一条。因此，可以修改默认的路由选择策略，比如设置一个较大的LOCAL PREFERENCE值，使得BGP生成的路由表中往往只包含一条到达目的地址的路径。
3. 修改Default MED值：bgp默认会选择MED值最小的路径，可以通过设置较小的MED值，来减少路由发生变化时的BGP消息的发送。
4. 设置时延敏感的租约：BGP协议默认使用0.7s的时延敏感租约（Time Sensitive LSA），为了更快地发现网络拓扑的变化，可以设置更短的时间敏感度租约（Time Insensitive LSA）。
5. 配置过滤机制：如果存在一些路由不应该传播到边界路由器，可以配置过滤规则，过滤掉这些路由信息。

## 4.2 限制发送方向
限制发送方向主要用于减少网络的负荷，提升网络的吞吐量。有的时候，只需要某些路由器了解某些特定的路由，其他的路由器不需要知道这些路由，可以配置不同的发送方向策略。

1. 只发送与本地路由相关的路由：即只发送与本地路由直接相连的路由，将边界路由器的资源消耗限制在一个较小的范围内。
2. 根据不同BGP speaker优先级，限制特定 BGP speaker 的发送方向：可以配置不同的优先级，不同的 BGP speaker 可以根据不同的优先级来配置自己的发送方向，尽量减少 BGP 消息的发送。
3. 通过配置对等 AS 列表，限制对等 AS 的发送方向：可以配置不同的对等 AS，不同的对等 AS 可以根据自己的需要配置自己的发送方向，也可以限制某个对等 AS 的发送方向。