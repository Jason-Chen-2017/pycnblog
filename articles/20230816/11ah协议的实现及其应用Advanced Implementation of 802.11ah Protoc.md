
作者：禅与计算机程序设计艺术                    

# 1.简介
  
Introduction
802.11ah（Advanced High-throughput Access）是在IEEE 802.11ac（高带宽发射）协议基础上的一种高速传输技术，它提供了在线视频、音频、实时通信等应用的新机会。这个工作主要由IEEE 802.11ah委员会和华为领导。根据不同的应用场景，802.11ah可以提升数据速率上限从而减少延迟，提供更佳的QoE，也可以增加对传感器和终端设备的兼容性。802.11ah协议由两层组成：MAC层和AMPDU层。下图展示了802.11ah的协议栈架构：

本文将阐述802.11ah协议的实现和应用，包括以下方面：
1. MAC层数据包封装与重组：介绍MAC层数据包封装（加速特性包（ACA Packets））与重组过程
2. AMPDU聚集：介绍AMPDU聚集的概念及其实现方法
3. 服务质量保证：介绍服务质量保证的方法（可靠交付、重传控制、队列管理）
4. 可用性改进：介绍可用性改进方案（带宽分配算法、流控算法、路径选择算法）
5. 安全机制：介绍802.11ah支持的安全机制
6. 应用案例：分享802.11ah协议在一些具体应用中的优化效果和效果评估

# 2.基本概念术语说明
## 2.1 MAC层数据包封装与重组
MAC层数据包封装指的是将底层流量打包成特定格式的数据包，并在其头部添加元数据的过程。常用的元数据如数据类型、源地址、目标地址、服务类型等。根据业务需求，可在此基础上进行加密处理。MAC层数据包封装后，会通过网络传输到目的节点。重组过程则是将多个数据包按照先后顺序重构出完整的数据流。

### 2.1.1 数据报格式
在MAC层数据包封装过程中，数据包被划分为多个“帧”或“片”，每一帧或片都包含数据或者控制信息。MAC层数据包的格式如下所示：
| 字段名 | 长度(bits) | 功能描述                                    |
| ------ | ---------- | ------------------------------------------- |
| Preamble        | 12         | 发送前导码                                  |
| SFD             |  1         | 起始符（Start Of Frame Delimiter），表示数据包的开始 |
| Address1        |  6         | 地址字段1                                   |
| Address2        |  6         | 地址字段2                                   |
| Address3        |  6         | 地址字段3                                   |
| Sequence control|  16        | 序列控制字段，记录当前数据包的序列号         |
| QoS Control     |  2         | 服务类型字段                                |
| Fragment number |  4         | 分段字段，标识属于一个完整数据包的不同分段    |
| Retry           |  1         | 是否允许重传                               |
| More data       |  1         | 表示是否还有更多数据                        |
| Power Management|  1         | 电源管理                                    |
| Acknowledgment  |  1         | ACK确认                                     |
| Data            |  N*8       | 数据字段，最多N个字节                      |
| FCS             | 4          | 梅克尔校验字段                              |
| Padding         | (4-((N+4)%4))%4 * 8| 对齐填充                                      |

其中，Preamble用于同步信道，SFD表示数据包的开始，AddressX用于指定源地址，Sequence control用于记录当前数据包的序列号，QoS Control用于确定服务类型，Fragment number用于标识属于一个完整数据包的不同分段，Retry用于设置是否允许重传，More data用于判断是否还有下一个分段，Power Management用于调节发送功率，Acknowledgment用于确认接收成功，Data用于存放实际数据，FCS用于数据检验，Padding用于保证数据包的长度是4的整数倍。

### 2.1.2 ACA数据包格式
ACA数据包是AMPDU（Aggregation Medium Access Control）的一种特殊形式。ACA数据包中包含的MPDUs（Medium Priority Data Units）具有更高优先级，它们可以同时传输，从而达到聚合更多的流量。ACA数据包封装的过程如下：

1. 把不超过MTU（Maximum Transfer Unit）大小的数据块打包成MPDUs；
2. 在每个MPDU首部插入AMPDU首部，包括片序列号、最高有效位（HE）和长度字段；
3. 添加或更新CRC校验；
4. 将MPDUs聚集到一起并计算总长度；
5. 如果聚集后的长度大于等于最小聚集单元（Min Aggregation unit，MAU），就用单播的方式发送ACA数据包，否则，继续聚集；
6. 使用AMPDU标志（Ampdu Flag）标识是否是ACA数据包。

ACA数据包的格式如下所示：

| 字段名      | 长度(bits) | 功能描述                          |
| ----------- | ---------- | ---------------------------------|
| Header      | 16         | 标志位（Flag Field）              |
| Duration ID | 2          | 描述时间间隔                      |
| RA          | 6          | 来源地址                          |
| TA          | 6          | 目的地址                          |
| SCID        | 4          | 片序列号                          |
| HE          | 1          | 最高有效位                        |
| Length      | 13         | 数据长度                          |
| MSDU        | MTU        | 媒体访问控制单元（Medium Access Unit）的数据内容 |
| CRC-32      | 32         | 循环冗余校验值                    |
| Pad         | 4          | 填充                              |

其中，Header是一个标志位，用来标记是否是ACA数据包，Duration ID用来表示传输时间间隔，RA和TA分别表示源地址和目的地址，SCID表示该包的片序列号，HE表示最高有效位，Length表示该包的长度（不含标志位、CRC校验码和填充），MSDU表示媒体访问控制单元的数据内容，CRC-32表示循环冗余校验值，Pad用于补全到32位的整数倍。

### 2.1.3 AC字段映射表
ACA数据包中的MPDUs，可能需要进行不同的QoS分类，比如VOIP流、视频流、音频流等。为了区别不同类型的流，AC字段在MAC层数据包中使用。AC字段的映射表如下：

| AC字段 | 流类型        | 说明                            |
| ------ | ------------- | ------------------------------- |
| 00     | BE            | 后台执行（Background Execution）|
| 01     | VI            | 视频流                          |
| 10     | VO            | 视频传真流（Voice over IP）      |
| 11     | BK            | 互动游戏流                      |


## 2.2 AMPDU聚集
AMPDU（Aggregation Medium Access Control）即聚集聚合调度单元。AMPDU是一个传输层协议，目的是为了提高网络传输效率。它能够在同一时间内把多条低优先级数据报集合并成为一组，然后再向网络层进行传输。

AMPDU聚集过程的基本步骤如下：

1. 当发送端收到一条新的MPDU时，它首先检查前一个聚集队列中是否已经满，如果满的话，就等待队列被清空，直到空闲位置后才能加入新的数据报；
2. 每条MPDU都有一个长度字段，长度过长的情况下，可以通过修改长度字段的值进行分片，并且调整MPDU之间的间隙时间以达到聚合效果；
3. 当聚集的数据报长度达到一定数量或时间间隔后，就生成AMPDU，通过设置相应的标志位和字段来描述AMPDU的内容，例如序列号、长度等；
4. 如果目的地不能接受的情况发生，AMPDU会被缓存起来，等待后续有空闲位置时再进行发送。

## 2.3 服务质量保证
### 2.3.1 可靠交付
可靠交付的目的是确保数据包最终都能正确送达目的地，即重传次数不应超过某个阈值。在实践中，可靠交付往往由重传控制算法和丢包检测算法共同完成。

#### 2.3.1.1 重传控制算法
在可靠交付过程中，需要考虑两种情况：
1. 一旦发现丢失数据包，立即重传，或放入更高优先级队列等待重传；
2. 当重传失败次数超过一定次数时，采用更复杂的手段进行处理，例如退避重传（backoff）。

#### 2.3.1.2 丢包检测算法
丢包检测算法负责监测网络上是否出现丢失的包，并对这些包进行重传。常用的丢包检测算法有定时器轮询、泛洪算法、学习算法、重排算法。

#### 2.3.1.3 服务质量保证机制
为了降低发送方发送失败率，尽最大努力使得无故障传输的概率达到1−ε，以保证发送者的可靠性。因此，要充分利用各种可靠传输机制，包括重传机制、拥塞控制、差错校验、ACK机制和流量控制。

### 2.3.2 重传队列管理
重传队列管理（Retransmission Queue Management）算法是网络层的重要子层之一，它用于控制重传队列的大小和重传超时时间，确保重传队列中的数据能按顺序到达。常用的重传队列管理算法有选择性重传、滑动窗口、块重传、速率控制、丢包超时重传、经典的拥塞控制算法。

### 2.3.3 流控算法
流控算法的主要作用是控制发送端的发送速率，避免网络过载，提高网络的利用率。流控算法常见的有限制发送速度、最小间隔传输、快重传超时（fast retransmit timeout，FRTO）、预取算法（prefetch algorithm）等。

### 2.3.4 路径选择算法
路径选择算法（Path Selection Algorithm）用于决定发送端使用的传输路线，根据路由器的负载状况，选择合适的路由算法，以便有效利用网络资源。目前比较常用的路径选择算法有最短路径优先SPF、差错纠正算法、记账法（accounting method）和公平排队（fair queueing）算法等。

## 2.4 可用性改进
### 2.4.1 带宽分配算法
带宽分配算法是计算机网络中重要的组成部分，用于动态调整网络资源，分配合适的带宽给各个用户。目前主要有基于公平共享方法的带宽分配算法，即公平分配方法、比例分配方法、按需分配方法、最大最小公平分配方法等。

### 2.4.2 流控算法
流控算法用于控制发送端的发送速率，避免网络过载，提高网络的利用率。流控算法的主要分为静态流控和动态流控。静态流控是指使用固定分配带宽，动态流控则是根据网络的拥塞程度进行自动调节。

### 2.4.3 路径选择算法
路径选择算法用于决定发送端使用的传输路线，根据路由器的负载状况，选择合适的路由算法，以便有效利用网络资源。目前比较常用的路径选择算法有最短路径优先SPF、差错纠正算法、记账法（accounting method）和公平排队（fair queueing）算法等。

## 2.5 安全机制
### 2.5.1 CCMP和TKIP密码算法
CCMP和TKIP密码算法是常用的WPA/WPA2标准的加密算法，都是用于数据加密和认证的算法，其安全性和效率均优于之前的标准算法。

### 2.5.2 PMK缓存
PMK缓存是使用密码握手机制（Pairwise Master Key）时，缓存配对密钥对的机制。缓存防止攻击者截获后，重复使用PMK值。

### 2.5.3 安全认证协议
安全认证协议（Security Authentication Protocols）是支持WPA/WPA2的认证协议，包括身份验证协议（EAP）和开放认证系统（OSEN）等。EAP是目前较常用的认证协议，其原理是将客户端和服务器之间通信通过短信、文件等方式协商，通过双向认证和密钥交换完成身份验证。

## 2.6 应用案例
### 2.6.1 VoLTE
VoLTE（Voice Over LTE）是一种新的语音通话方式，通过移动数据传输语音信号，来实现语音通信的功能。相对于基于模拟电话的语音通信，VoLTE不需要安装专门的硬件，简单易用，同时还具备较高的实时性。与其他VoIP服务一样，VoLTE也是需要在网络层进行语音信令的转换。

为了实现VoLTE，许多公司开发了多种技术。其中最著名的是由Cisco和Google联合开发的Ims（IMessaging Service）标准，定义了语音信令接口、控制消息和呼叫管理消息等。通过标准化的Ims接口，VoLTE可以在移动设备和通信网关之间建立基于UDP协议的双向连接，并对语音信令进行转换，实现语音通信。另外，系统还需要配置好相关的加密算法和安全机制，防止数据窃听、篡改、伪造等攻击。

### 2.6.2 时移回声消除
时移回声（Time Shift Doppler Effect）是由于移动设备自身的时钟漂移引起的回声现象。当声波遇到移动设备时，由于移动设备的主动跳频，会导致声音的时移，从而形成回声。若能解决时移回声的问题，就可以为日常生活带来方便、舒适，也能增强产品的可用性和用户体验。

为了消除时移回声，业界提出了很多技术，如修正卡曼滤波器（Corrected Carma Filter）、共轭梯度校正（Coherent Gradient Correction）、定向扫描技术（Direct Scan Techniques）、载频相干（Frequency Synthesis Induced Harmonics，FSIH）等。其中，修正卡曼滤波器是目前最有效的一种时移回声消除算法。

修正卡曼滤波器是指将传感器采样信号和微小跳频噪声混合起来，进行低通滤波，消除跳频噪声，得到正确的时间和频率信号，之后再经过解算器反馈到传感器中。

### 2.6.3 可扩展的实时数据中心
可扩展的实时数据中心（Scalable Real-time Data Center）是利用云计算、分布式存储、集群计算等技术来实现的一种数据中心技术。云计算是一种共享计算资源的模型，能提供高度可靠的服务。分布式存储是云计算的一个重要组成部分，能够将数据存储到不同的主机上，以实现水平扩展。集群计算是利用多个服务器共同处理任务，以提升性能和可靠性。

通过云计算、分布式存储、集群计算等技术，可扩展的实时数据中心可以有效地解决企业对实时数据的需求，同时实现高可用、灵活性、高性能。