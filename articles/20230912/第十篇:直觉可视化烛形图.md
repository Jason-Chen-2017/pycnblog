
作者：禅与计算机程序设计艺术                    

# 1.简介
  

烛形图（Candlestick chart）是一种图表类型，它用一根横着的短线段表示价格变化方向，颜色和高度则代表开盘、收盘价和最高价、最低价。从某种程度上来说，烛形图类似于股票市场中的日内交易图，但它更加详细地反映了每天发生的成交量。

2.烛形图的由来
在过去，每当我遇到财务数据需要分析时，首先会想到柱状图、条形图或饼图。柱状图最直观，也容易理解，但对于一般的金融市场而言，并不适合做行情分析。既然要做行情分析，那就应该选择那些可以直观看到数据的图表类型。

直到互联网的兴起，通过手机APP上的移动端界面可以获得大量的金融数据。虽然一些公司提供的数据可视化工具帮助用户快速掌握市场走势，但如何突出价格变化方向、聚焦于特定的时间段、看清趋势底部等细节，仍然是一个难点。因此，直觉可视化的概念应运而生，希望能够通过直观的图像将复杂的信息通过简单的方式呈现出来。

早期的直觉可视化包括雷达图、散点图、气泡图、气球图、棒图、线性图等。随着计算机的发明和计算能力的飞速发展，逐渐产生出了更多的新型可视化工具，如交互式图表、动态散点图、动画效果图等。然而，直觉可视化仍然是一种具有创意和美感的可视化手段，但其表达力有限，无法准确反映数据本身。

直觉可视化的发展史告诉我们，没有什么工具是完美无缺的。不同类型的可视化方式都有各自的优劣。因此，作为一个专业的技术人员，我们不能仅仅满足于仅有的几个可视化工具，还要根据具体的需求开发新的可视化工具。正如波普尔所说："谁能给出数据，哪怕只是一条线，他就一定能够找到自己的最佳形态"。所以，我们必须结合实际情况，制作符合自己需求的直觉可视化。

# 2.基础概念及术语
## 2.1 概念
烛形图（Candlestick Charts）是一类用横条分割的长短刻度图表，用于显示价格变动方向及其大小。该图从1970年美国华尔街金融卫士（The Wharton Financial Services Group）的<NAME>、<NAME>和<NAME>三位工程师首创，是传统的K线图、期权图、成交量图和股票图的泛称。20世纪80年代中期，由William Barlett制作而成。

它最初是为了证券交易所显示股票交易信息的一种图表。它的主要特征是，横条由两个短刻度组成，由阴影区分开，两条刻度与时间对齐，为开、收、高、低四个价格点。开盘价显示为红色，收盘价显示为绿色，阴影部分显示为白色或银色，用来反映开盘价与收盘价之间价格的涨跌。

一般情况下，烛形图描绘的时间范围较短，主要关注近期的走势。每个烛形图由很多小的烛形组成，每个烛形代表了一个特定时间点的交易量或价格变化。而颜色与烛形大小则代表不同的交易品种，如股票、期货、贵金属等。

## 2.2 术语
烛形图常用以下几个术语：
1. 烛：一个代表交易的矩形条带，可以表示一只股票的价格，也可以代表比特币、黄金或者其他的数字货币。

2. 上影线：从下方穿过顶端的一条垂直线，用来表示卖出的头寸。

3. 下影线：从上方穿过底部的一条垂直线，用来表示买入的头寸。

4. 宽度：一条线段的宽度，以百分比表示。如果宽度为1%，则表示长度为整个周期的一半。

5. 颜色：用来区别不同类型的商品，通常采用红色表示上涨的价格，绿色表示下跌的价格。

6. 滚动平均线：在滚动平均线之前，价格都是静止的；但是在滚动平均线之后，价格开始转动。滚动平均线一般采用移动平均线法计算得到。

# 3.核心算法原理和具体操作步骤
## 3.1 数据准备
烛形图的数据通常以OHLCV形式提供，即Open、High、Low、Close、Volume。数据集通常以DataFrame的形式存储，其中有六列分别表示开盘价open、最高价high、最低价low、收盘价close和交易量volume。
```python
import pandas as pd

df = pd.read_csv("data.csv") #读取数据
```
## 3.2 数据处理
1. 设置日期索引
日期索引可以方便进行时间相关操作。
```python
df.set_index(pd.DatetimeIndex(df['Date']),inplace=True)
```

2. 添加均线数据
烛形图常用滚动平均线来描述波动变化。均线由几根线段组成，是以一定时间周期内的平均值、中间值、最高值和最低值来表征时间段的价格趋势的一种图表。这里，我们采用简单算术平均数来计算均线。
```python
n = 21   # 设置均线计算参数，例如n=21则计算最近21天的平均价
ma = df['Close'].rolling(window=n).mean()  
df['MA'+str(n)] = ma 
```

## 3.3 数据可视化
### 3.3.1 Matplotlib库实现
Matplotlib是Python的一个二维绘图库，可以轻松创建各种类型的图表和图形。利用Matplotlib，我们可以很容易地画出烛形图。
```python
import matplotlib.pyplot as plt 

fig, ax = plt.subplots()    # 创建子图对象
ax.plot(df.index, df["Open"], color="red", alpha=0.7)   # 绘制开盘价折线
ax.plot(df.index, df["Close"], color="green", alpha=0.7)   # 绘制收盘价折线
ax.fill_between(df.index, df["Open"], df["Close"], where=(df["Close"] - df["Open"]) > 0, facecolor='red', interpolate=True )    # 填充红色区域
ax.fill_between(df.index, df["Open"], df["Close"], where=(df["Close"] - df["Open"]) < 0, facecolor='green', interpolate=True )    # 填充绿色区域
ax.bar(df.index, df['Volume'], width=0.3, bottom=None, hold=False, color='blue')    # 绘制交易量条形图
plt.xticks([])      # 不显示x轴刻度标签
for label in ax.xaxis.get_ticklabels():
    label.set_rotation(45)    # 旋转x轴刻度标签角度
plt.title('Stock Price Candlestick Chart')   # 设置图表标题
plt.show()     # 展示图表
```


### 3.3.2 Plotly库实现
Plotly是另一个可用于创建交互式图表的库。利用Plotly库，我们可以很容易地画出烛形图。
```python
from plotly import graph_objects as go

fig = go.Figure()
fig.add_trace(go.Candlestick(x=df.index,
                             open=df["Open"], high=df["High"], low=df["Low"], close=df["Close"]))
fig.update_layout(template="simple_white", title="Stock Price Candlestick Chart", xaxis_rangeslider_visible=False)

fig.show()
```
