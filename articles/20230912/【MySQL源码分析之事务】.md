
作者：禅与计算机程序设计艺术                    

# 1.简介
  

在关系型数据库中，事务（Transaction）是一个不可分割的工作单位，其对数据进行操作，要么都执行，要么都不执行。事务具有四个属性，原子性、一致性、隔离性、持久性。
本文将从MySQL的底层源码出发，详细剖析MySQL事务机制。通过本文你可以了解到什么是事务？事务的特性有哪些？如何保证事务的ACID属性？你还可以学会如何用代码实现事务。
# 2.基本概念及术语说明
## 2.1 事务的定义
事务是指一组SQL语句组成的一个整体，这些SQL语句作为一个整体被设计、应用和管理，事务具有4个基本属性：原子性、一致性、隔离性、持久性。
- 原子性（Atomicity）：事务是一个不可分割的工作单位，事务中的操作要么都做，要么都不做。事务的原子性确保动作是不可拆分的，事务中包括的诸操作是一个整体，由数据库管理系统完全完成或者不完成，不能只执行其中的一部分操作。
- 一致性（Consistency）：数据库总是从一个一致性状态转换到另一个一致性状态。一致性与原子性密切相关。当事务完成时，数据库就处于一致性状态。
- 隔离性（Isolation）：一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间互不影响。
- 持久性（Durability）：一个事务一旦提交，它对数据库中数据的改变就应该永久保存下来。接下来的其他操作或故障不会导致该事务的回滚。持久性也称为永久性，指的是对于事务的处理结果，如果系统遇到任何故障，数据库都能恢复到事务成功之前的状态。
## 2.2 事务控制词——BEGIN、COMMIT、ROLLBACK
事务控制词主要用来管理事务，包括BEGIN、COMMIT、ROLLBACK三个命令。
- BEGIN：开启一个新的事务；
- COMMIT：事务提交，对于InnoDB表，提交事务后，所做的改动才会永久生效；
- ROLLBACK：事务回滚，放弃所做的所有改动。
## 2.3 事务日志（ redo log 和 undo log）
事务日志又称重做日志和撤销日志，用于记录InnoDB引擎对数据修改的历史。
### Redo Log
Redo Log 是 InnoDB 存储引擎用来保证事务的持久化的关键，主要作用如下：

1.Redo Log 主要用于记录事务修改的物理地址。它主要用于实现事务的持久化。InnoDB 的 Redo Log 中只记录物理地址，而不记录数据值。

2.Redo Log 中的物理地址记录了已经提交完成的事务的最新物理地址，记录的内容可以通过回滚指针（Roll Pointer）来进行相关的恢复操作。回滚指针指向的地方，就是记录上次提交时的最新物理地址。

3.Redo Log 中的数据包含两个部分，前 22 个字节是固定格式，后面的数据则是可变长度。其中前 8 个字节是事务 ID（TID），后 19 个字节是 XID 号。另外，每个事务的 Redo Log 的大小默认是 4KB，可以使用参数 innodb_log_file_size 来设置。

```bash
+---------------------------------+-------------+--------------+---------------+-----------+------------+-----------+--------------------+---------+
| Log Type                        | Physical Pos| WritePos     | CheckPointLSN | UndoNext  | Redo  Len  |  State   | TransactionID/Xid  | Info    |
+---------------------------------+-------------+--------------+---------------+-----------+------------+-----------+--------------------+---------+
| rollback segment                |        19760|          19760|       19760:0|         0|      21808| active   |                     |         |
|                                |             |              |               |           |            |           |                     |         |
|                                |             |              |               |           |            |           |                     |         |
|                                |             |              |               |           |            |           |                     |         |
|                                |             |              |               |           |            |           |                     |         |
|                                |             |              |               |           |            |           |                     |         |
| last written lsn                |          252|            252|       252:0   |         0|          0| shutdown |                     |         |
| in memory checkpoints           |          312|            312|       312:0   |         0|     367232| shutdown |                     |         |
| (non-transactional)             |             |              |               |           |            |           |                     |         |
|                                |             |              |               |           |            |           |                     |         |
|                                |             |              |               |           |            |           |                     |         |
|                                |             |              |               |           |            |           |                     |         |
+---------------------------------+-------------+--------------+---------------+-----------+------------+-----------+--------------------+---------+
```
### Undo Log
Undo Log 是 InnoDB 存储引擎用来实现事务的回滚的重要日志，主要作用如下：

1.Undo Log 为 InnoDB 在插入、删除等操作失败时提供之前版本的数据支持。

2.Undo Log 会创建一份“当前数据”的快照，每当需要进行回滚操作时，就将当前数据与快照比较，根据不同操作类型，产生相应的差异数据，再写入 Undo Log 中。

3.Undo Log 的格式和 Redo Log 相同。但 Undo Log 只用来支持回滚操作。每次事务提交时，它会清空掉。所以，当需要回滚时，不需要读取 Undo Log 文件，直接读取 Redo Log 文件即可。

4.在 MySQL 8.0 中，Redo Log 使用的是 Aria engine，Undo Log 使用的是 InnoDB engine。Redos log 和 Undoes log 相互独立，因此它们可以分别启用或禁用，并且在启动时也可以配置大小。 


## 2.4 概念
事务是指一组SQL语句组成的一个整体，这些SQL语句作为一个整体被设计、应用和管理，事务具有四个基本属性：原子性、一致性、隔离性、持久性。
- 原子性（Atomicity）：事务是一个不可分割的工作单位，事务中的操作要么都做，要么都不做。事务的原子性确保动作是不可拆分的，事务中包括的诸操作是一个整体，由数据库管理系统完全完成或者不完成，不能只执行其中的一部分操作。
- 一致性（Consistency）：数据库总是从一个一致性状态转换到另一个一致性状态。一致性与原子性密切相关。当事务完成时，数据库就处于一致性状态。
- 隔离性（Isolation）：一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间互不影响。
- 持久性（Durability）：一个事务一旦提交，它对数据库中数据的改变就应该永久保存下来。接下来的其他操作或故障不会导致该事务的回滚。持久性也称为永久性，指的是对于事务的处理结果，如果系统遇到任何故障，数据库都能恢复到事务成功之前的状态。