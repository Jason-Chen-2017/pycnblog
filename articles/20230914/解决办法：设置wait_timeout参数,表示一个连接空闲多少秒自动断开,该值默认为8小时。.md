
作者：禅与计算机程序设计艺术                    

# 1.简介
  


## 1.1 概述
在数据库服务器上，如果出现数据库连接异常、应用系统出现卡死或其他原因导致数据库连接断开，很可能引起业务上的影响。所以，如何在保证业务正常的前提下降低数据库连接断开的频率、节省资源，保障数据库服务稳定运行是一个重要问题。

通常情况下，数据库连接超时时间的配置都需要根据业务的特性进行调整，比如某些业务要求较高的响应速度，就需要增大连接超时时间；而对于一些后台管理类的业务场景，对连接的持续性要求不高，可以适当缩短连接超时时间以减少资源消耗。

虽然MySQL提供了连接池功能来有效解决数据库连接过多的问题，但对于一些复杂的查询或者大数据量的导入导出操作，仍然会频繁产生新连接，这种情况下，就需要考虑设置连接超时时间以避免系统因连接超时而崩溃。

在MySQL中，连接超时时间是通过wait_timeout参数设置的，这个参数的值就是指定数据库服务器等待客户端请求的时间阈值，超过这个阈值则认为客户端已经失去连接，关闭数据库连接。默认情况下，MySQL的wait_timeout参数值为8小时。

## 1.2 wait_timeout 参数说明
MySQL 的 wait_timeout 参数用来设置允许客户端在没有任何活动的状态下，保持到 MySQL 服务端的连接处于打开状态的最大时间。此参数的单位为秒（s）。wait_timeout 用于控制 MySQL 在客户端连接的静默时间。如果一个客户端在 wait_timeout 指定的时间内没有任何操作，则 MySQL 将会终止这个客户端的连接。这样做是为了防止无效连接占用资源。

## 1.3 设置 wait_timeout 参数

设置方法：修改配置文件my.cnf文件，在[mysqld]段下加入以下选项

```ini
wait_timeout=1800 # 表示一个连接空闲多少秒自动断开，此处设置为30分钟
```

注：一般建议把 wait_timeout 参数设置的稍微短一些，因为客户端并不是一直处于活跃状态，即使发生了超时，也应该有其它机制来确保数据的一致性和完整性。因此，如果一个连接闲置时间比较长，建议通过优化应用和数据库的方式来尽快释放这些资源，而不是等着自动断开连接。

## 1.4 查看当前连接信息

可以通过查看全局变量 @@wait_timeout 来查看当前的连接超时时间，如下命令：

```sql
SELECT @@wait_timeout;
```

也可以通过SHOW VARIABLES LIKE 'wait_timeout'命令来查看当前的连接超时时间，如下命令：

```sql
SHOW VARIABLES LIKE 'wait_timeout';
```

## 1.5 mysql 自身的限制

mysql 内部也有一些限制，比如从库延迟复制会导致主库发生锁冲突，如果从库持续跟不上主库，就会造成主库锁表，这个时候就需要等待锁超时才行。还有就是mysql对于特别大的事务，可能会把innodb buffer pool分给不同的内存区域，让内存的利用率更高，如果一个事务过大，可能会使innodb buffer pool分裂为多个，导致主线程不能够及时分配和回收内存空间，进而导致用户执行的查询慢甚至报出"InnoDB: Memory allocation failure"错误。所以，对于大事务处理，可以选择合适的手段，比如使用缓存，或者使用临时表存储数据等方式来减少锁冲突和内存消耗。