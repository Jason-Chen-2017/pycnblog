
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 什么是数据库事务？
数据库事务（Database Transaction）是一个并发控制的方法，用于对数据库进行相关操作。数据库事务用来确保数据一致性、完整性以及运行逻辑上的有效性。数据库事务包括COMMIT、ROLLBACK、BEGIN等命令。
## 为什么要用数据库事务？
数据库事务的主要目的是确保数据的完整性、一致性和正确性。如果一个事务中的某条SQL语句失败了，则事务将自动回滚到上一个正常点，所有操作都被取消掉，数据库将返回到事务执行前的状态；而如果事务中的所有SQL语句都成功执行完毕，那么事务将提交并将变更永久保存到数据库中。因此，事务提供了一种机制，通过将一个事务的所有操作作为一个整体来实现可靠的数据库更新。
## 如何开启和结束数据库事务？
在MySQL中，默认情况下，每一条SQL语句都会作为独立的事务执行，但是也可以通过BEGIN、START TRANSACTION、COMMIT或ROLLBACK等命令显式地开启和结束一个事务。
# 2.事务的四大属性
## ACID特性
ACID全称为Atomicity、Consistency、Isolation、Durability，它代表数据库事务应具备的四个基本属性。ACID属性共同构成了事务的基本要素，并且是保证数据一致性的基础。
- Atomicity（原子性）：一个事务是一个不可分割的工作单位，事务中的操作要么全部做，要么全部不做。也就是说事务是一个不可分割的工作单位，事务中包括的诸如更新记录、插入记录等操作要么全部完成，要么全部不起作用。事务的原子性确保动作全部完成或完全不起作用，避免因交叉执行而导致数据的不一致。
- Consistency（一致性）：数据库只接受符合ACID规范的事务，那么数据库的任何时候都只能处于一致性状态。一致性意味着整个数据库中的数据都应该是符合规则的。一致性是指事务必须使得数据库从一个一致性状态变到另一个一致性状态。例如，转账系统中，A向B转账100元，这是一个事务过程，需要满足事务的ACID属性。在事务开始之前，A余额为500元，B余额为700元。事务开始之后，A扣除100元，并给B加上100元，两者账户余额皆为400元。至此，事务结束。两个账户的总余额为500+100=600元。数据库也必须保持这种状态，否则无法满足一致性要求。
- Isolation（隔离性）：多个事务并发执行时，一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不会互相干扰，各自都好像在各自事务上发生的一样。
- Durability（持久性）：一旦事务提交，其所做的改动将会永久保存到数据库中，并不会因为系统崩溃而丢失。该属性保证了事务 committed 的数据不被回滚。

除了这些属性之外，还有一些与事务管理有关的其它属性，但由于篇幅原因，这里就不再一一列举了。
## 其他属性
### 读写一致性
数据库的读写一致性一般指数据库在访问的时候，对于一个数据是否可以读到最新值或者最新的快照的问题。对于InnoDB存储引擎来说，默认支持Read Committed（RC）和Serializable（S）两种模式的读写一致性。
#### Read Committed (RC) 模式
这是InnoDB默认的隔离级别，在该模式下，所有事务都只能读取已提交的数据，未提交的变更对其他事务不可见。
#### Serializable（S）模式
这是最严格的隔离级别，在该模式下，事务间的执行顺序是串行化的，也就是说，一个事务开始后，其他事务必须等它结束才能开始。

Serializable是最慢的隔离级别，通常不建议生产环境使用，仅适合用于开发测试阶段。

### 可重复读
可重复读（Repeatable Read）是InnoDB默认的MVCC（多版本并发控制）隔离级别。在该模式下，事务可以读取到已经提交的其他事务的最新提交值，而未提交的值不受影响。但是，由于InnoDB是基于索引来实现事务的，所以当数据表结构修改时（比如增加列），无法用快照隔离级别来解决。为了解决这个问题，InnoDB提供了“聚集索引”和“辅助索引”。如果查询语句不涉及索引，InnoDB会用主键索引（聚集索引）来执行查询。如果查询语句带有条件，则InnoDB会先找到满足条件的最小范围内的最大版本号的索引记录，然后扫描并过滤出符合条件的记录。

InnoDB的MVCC机制能够确保事务读取的一致性，适用于多用户并发访问场景下的数据库。但是，MVCC也存在一些缺陷，其中一个就是“幻影读”（Phantom Reads）。幻影读是指在一个事务中，先前读到的记录可能在随后的查询中消失（比如另一个事务删除了该记录）。InnoDB通过gap lock策略来解决幻影读问题。当某个事务获得了 gap lock 时，只能访问该范围内的记录，其他事务无法插入记录，防止产生幻象。但是，使用 gap lock 也会引入性能损耗，因此 InnoDB 默认并没有启用 gap lock。