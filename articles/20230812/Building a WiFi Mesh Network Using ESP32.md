
作者：禅与计算机程序设计艺术                    

# 1.简介
  


随着物联网、智慧城市、可穿戴设备等新兴技术的发展，无线网状网络（Mesh Network）越来越受到重视。Mesh Network是一个由多台路由器组成的分布式、动态的无线网络环境，通过采用拓扑结构、路由协议及路由选择策略等技术可以有效地连接多个节点。Mesh Network的主要优点在于它具有较高的数据传输速率、灵活的网络拓扑结构、广播性强、适应性强等特点。

本文将介绍一种基于ESP32开发的Wi-Fi Mesh系统，该系统能够实现相互通信并通过广播的方式进行数据交换。为了达到较好的实时性要求，该系统采用低功耗模式运行，在不消耗大量CPU资源的同时还能提供良好的响应速度。同时，本文也会对Mesh Network的相关概念和技术要素进行介绍，方便读者理解。

# 2. Wi-Fi Mesh系统概述

## 2.1 背景介绍

Wi-Fi Mesh系统是在无线局域网中构造分布式、动态的网络环境。Mesh系统采用了分布式的拓扑结构，使得多个设备之间能够实时通信。Mesh系统能够有效解决无线路由器数量限制、信号丢失、频繁切换的难题。因此，Mesh系统的广泛应用已经成为信息通信领域的一项重要技术。

目前，Mesh系统主要用于满足如下五个方面的需求：

1. 弱网环境下数据可靠性要求高

   由于Wi-Fi技术的普及和快速增长，物联网、智慧城市、可穿戴设备等新型技术的大量出现导致移动通信网络不稳定，弱网环境下Wi-Fi Mesh系统能够提供较高的数据可靠性。此外，Mesh系统的低功耗特性使其能够在节电的情况下保持良好的实时性。

2. 大规模设备分布式管理

   在Mesh系统中，设备不再需要独立的无线路由器，而是根据自己的位置信息自动进行网络配置。这样，Mesh系统能够很好地满足大规模设备分布式管理的需求。

3. 多种设备类型间的通信

   Mesh系统能够同时支持不同类型的设备之间的通信，如终端设备、家庭音响设备、智能照明设备等。

4. 小范围设备的通信

   Mesh系统能够将小范围内的设备组织成一个网络，从而实现小范围设备之间的通信。例如，智能照明设备通常处于户外，但是仍然能够与其邻居的设备进行通信，实现自动化照明。

5. 业务连续性

   Mesh系统能够提供高可靠性的业务连续性服务，保证用户的正常使用。

## 2.2 基本概念术语说明

### 2.2.1 Wi-Fi Mesh系统

Wi-Fi Mesh系统是一个由一系列的无线路由器组成的分布式的、动态的无线网络环境，通过采用拓扑结构、路由协议及路由选择策略等技术可以有效地连接多个节点。Mesh系统是无线局域网的一种实现方式，它利用无线通信技术实现不同设备之间的通信。

Mesh系统采用分布式的拓扑结构，使得多个设备之间能够实时通信。Mesh系统能够有效解决无线路由器数量限制、信号丢失、频繁切换的难题。因此，Mesh系统的广泛应用已经成为信息通信领域的一项重要技术。

在现有的Wi-Fi Mesh系统中，通常将其分为两类：
- Centralized Mesh System(CENTRALIZED MESH SYSTEM)

  中心化Mesh系统由一台或多台中心控制器控制的无线路由器组成，所有的节点都直接连接到中心控制器上。

- Distributed Mesh System(DISTRIBUTED MESH SYSTEM)

  分布式Mesh系统中的节点没有中心控制器，每个节点都有其自身的无线路由器。

### 2.2.2 Mesh Network拓扑结构

Mesh Network中的每个结点包括一个Wi-Fi路由器、一块网卡和一套指令集。Mesh网络中的路由器可分为以下两种类型：
- 接入路由器(Access Router)：用来连接终端设备、家庭音响设备等与Mesh网络的边缘直接相连的设备，只负责与外部设备通信。
- 中继路由器(Relay Router)：用来在Mesh网络中建立起各个路由器之间通信的枢纽。

### 2.2.3 路由协议

路由协议决定了Mesh网络中各个结点之间如何进行通信。常用的路由协议包括距离向量路由协议（RPL）和链路状态路由协议（LSR）。

距离向量路由协议（RPL）是一种基于开放最短路径优先（OLSP）算法的路由协议，通过计算源路由树和目标路由树之间的距离和延迟，基于一定算法选取一条最佳路径进行路由转发。

链路状态路由协议（LSR）是一种基于节点之间的链路性能及资源情况，动态生成路由表的路由协议。LSA（Link State Advertisement，链路状态通告）是LSR协议中使用的一种消息，用于描述网络中每两个相邻节点的关系。通过接收到的LSA，LSR协议可以计算出整个网络中的节点之间的路由表。

### 2.2.4 拓扑变化及动态路由协议

当一个结点加入或离开Mesh网络时，其他结点需要进行相应的路由表更新，以保证路由信息的准确性。

为了解决这一问题，Mesh网络中的路由器需要采用一些特殊的路由协议，即动态路由协议。动态路由协议包括等价路由协议和链路中继协议。

等价路由协议（EPR）是一种中心化的路由协议，它将所有路由协议功能集成到一个单独的路由模块中，每个结点只需要发送周期性的Hello包，并接收其它结点发送的Hello包，即可确定自己所属的区域。

链路中继协议（LLA）是另一种中心化的路由协议，它通过将多条同质链路伪装成一条双向链路来进行网络连通，并提供链路质量监测及纠错机制。链路中继协议的一个优点是不需要担心网络拓扑的变化，因为它可以将不同的路径组合起来，实现了网络连通。

### 2.2.5 安全机制

Mesh系统的安全机制是Mesh系统的基础，也是Mesh系统部署的关键环节之一。Mesh系统具备敏感数据的保密性、完整性和可用性，因此其安全机制至关重要。Mesh系统的安全机制一般包括加密、认证、访问控制、流量控制等。

Mesh系统的加密方法包括基于IEEE802.11w的强制加密、基于TLS/IP的加密以及自行定义的加密方案。Mesh系统的认证方法有基于身份验证的MAC、基于密钥共享的密钥协商、基于动态秘钥的秘钥管理、以及基于令牌的授权模型等。Mesh系统的访问控制方法包括白名单、黑名单、可信任列表及有效时间控制等。Mesh系统的流量控制方法则包括基于速率的限流、基于带宽的限速、QoS等。

# 3. Wi-Fi Mesh系统基本原理

## 3.1 Wi-Fi Mesh系统拓扑生成算法

Mesh系统的拓扑生成算法通过路由协议、物理网络等手段进行。Mesh系统中，路由器根据自己的位置信息自动地生成拓扑结构。

Mesh系统的拓扑生成算法包括以下几种：
1. 普通传统的方法：传统方法生成Mesh系统的拓扑结构都是手动设置的方式，这种方法无法满足复杂的物理网络环境的要求。
2. 基于Wi-Fi天线的定位算法：Wi-Fi天线能够根据无线射频信号强度的大小以及距离远近，识别对应的Wi-Fi接入点。通过Wi-Fi信号的强度分析，Mesh系统可以更加精确的知道终端设备所在的位置，从而生成拓扑结构。
3. 蜂群算法：蜂群算法是一个经典的随机算法，通过随机散布一批节点，然后通过检测距离关系，把相似距离内的节点进行合并，生成最终的拓扑结构。

## 3.2 数据传输算法

Mesh系统的数据传输算法是Mesh系统实现通信的基础。Mesh系统的通信过程主要依赖于数据包的传输和路由。

在实际应用中，Mesh系统中的数据传输算法可以分为以下四种：
1. 直接传输：当数据源与目的地址不在同一路由器的覆盖范围时，Mesh系统采用直接传输模式。
2. 单跳传输：当数据源与目的地址在同一路由器的覆盖范围时，Mesh系统采用单跳传输模式。
3. 多跳传输：当源地址与目的地址不在同一网络中时，Mesh系统采用多跳传输模式。
4. 广播传输：当数据源与目的地址在不同的网络中时，Mesh系统采用广播传输模式。

## 3.3 时隙同步机制

时隙同步机制是Mesh系统实现快速、可靠的数据传输的基础。时隙同步机制包括接收时隙和发送时隙，接收时隙用于检测是否收到了上层数据，发送时隙用于传输数据。时隙同步机制的作用就是尽可能的将接收到的数据提前传输给应用程序。

Mesh系统的时隙同步机制可以通过两种方式来实现：
1. Slot同步机制：Slot同步机制指的是按固定周期（称为Slot），每个Slot都会传输一次数据。当某个节点收到了上层数据后，会判断一下当前的时间是否与Slot的时间一致，如果一致就立刻发送数据。
2. Acknowledgment机制：Acknowledgment机制指的是结点之间建立一个确认链，各个结点按照顺序进行数据传输，当一个结点接收到上层数据后，就会给出一个确认响应，确认响应的数据中包含上层数据传输成功的信息。然后等待确认响应返回。当确认响应超时或者丢失时，重新传输上层数据。

## 3.4 应急处理机制

应急处理机制是Mesh系统实现出错后的恢复的基础。应急处理机制的目的是使Mesh系统在发生意料之外的错误时，能够及时的进行错误诊断、错误恢复和设备重启等操作。

Mesh系统的应急处理机制包括以下几个方面：
1. Error Detction Mechanism：Error Detection Mechanism用于检测Mesh系统中是否存在错误。当某个结点检测到自己处理的某个数据帧发生错误时，它会通知其它结点，其它结点会发现错误并且向错误源结点发送确认报文，错误源结点可以采取相应的措施。
2. Failure Recovery Mechanism：Failure Recovery Mechanism用于处理发生错误的结点。当某个结点发生错误时，它会通知它的邻居结点，邻居结点通过信道通知其它结点，让它们知道发生了错误。其它结点检测到错误之后，会做出相应的措施，包括清除缓存数据，重建网络等。
3. Device Restart Mechanism：Device Restart Mechanism用于处理掉电的问题。当某个结点掉电时，其它结点会检测到结点掉电，并且向该结点请求重启。结点通过自检的方式来判断自己的状态，结点通过重启成功标志来确认结点的启动。

# 4. Wi-Fi Mesh系统代码实例

## 4.1 ESP32 Wi-Fi Mesh系统初始化

下面，我们将介绍如何使用ESP-IDF编程框架，用C语言初始化一个基于ESP32的Wi-Fi Mesh系统。

首先，创建一个新的ESP-IDF项目，并将example_esp_wifi_mesh文件夹下的所有内容复制到新建的工程目录中。

然后，在菜单config-->Example Configuration-->WiFi mesh-->Example程选框中勾选例程，保存。


最后，编译烧写程序。

## 4.2 基本流程及相关API介绍

初始化完成之后，我们进入主函数main()中，首先调用esp_netif_create_default_wifi_mesh_netif()函数创建默认的Wi-Fi Mesh网卡。

```
extern esp_err_t esp_netif_create_default_wifi_mesh_netif(void);

...

esp_netif_create_default_wifi_mesh_netif(); // 创建默认Wi-Fi Mesh网卡
```

创建默认的Wi-Fi Mesh网卡之后，就可以创建MESH对象，并设置相关属性。

```
extern mesh_addr_t esp_mesh_get_my_id(void);

typedef struct {
    mesh_addr_t addr;    /*!< Address of the device */
} wifi_init_config_t;

wifi_init_config_t config = {.addr = esp_mesh_get_my_id()}; 

extern esp_err_t esp_mesh_set_config(const wifi_init_config_t *config);

esp_mesh_set_config(&config);      // 设置MESH对象的属性
```

设置MESH对象的属性之后，就可以开启MESH功能。

```
extern void esp_mesh_start(void);

esp_mesh_start();     // 开启MESH功能
```

开启MESH功能之后，就可以进行正常的Wi-Fi Mesh通信。

# 5. Wi-Fi Mesh系统未来发展

基于ESP32开发的Wi-Fi Mesh系统正在蓬勃发展的当下。随着物联网、智慧城市、可穿戴设备等新兴技术的发展，无线网状网络（Mesh Network）越来越受到重视。随着Mesh Network的普及和应用，各行各业都希望能够实现其在不同行业的落地。

当前，Mesh系统主要用于满足如下五个方面的需求：

1. 弱网环境下数据可靠性要求高

   - 支持多跳传输
   - 提供数据重发机制
    
2. 大规模设备分布式管理

   - 支持自动网络配置
   - 兼容并包支持
     
3. 多种设备类型间的通信

   - 提供终端设备之间的数据通信
   - 支持多种业务场景
     
4. 小范围设备的通信

   - 通过MAC层广播实现小范围设备通信
     
5. 业务连续性

   - 提供高可靠性的业务连续性服务

未来，我们期待着更多基于ESP32的Wi-Fi Mesh系统的创新，充分实现这些需求。