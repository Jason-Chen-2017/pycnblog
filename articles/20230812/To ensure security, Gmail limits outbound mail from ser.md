
作者：禅与计算机程序设计艺术                    

# 1.简介
         

在现代社会中，电子邮件已经成为一种很重要的信息传递方式。从最初的信件到现在的网页邮件，无论是私人还是公司内部的通信，都离不开电子邮件系统。
随着互联网的快速发展，越来越多的人开始使用基于云端的Gmail邮箱服务。由于云端的Gmail本质上是一个服务器，所以为了保障用户数据的安全性，云端的Gmail邮箱必须限制外域（非组织机构）的发送邮件请求。这是为了防止数据泄露、违规运营等安全风险。
因此，我们今天要讨论的文章就是关于云端Gmail的安全机制以及相关配置信息。
# 2.基本概念
## 2.1 Email server
Email server 是指Email传输的基础设施，用于存储、处理并提供Email通信服务。一般情况下，邮件服务器是指安装有邮件收发组件和支持的应用程序的计算机网络或设备。该服务器可以运行各种Email协议，包括SMTP、POP3、IMAP等，并可将邮件转发给其他邮件服务器或第三方服务。服务器通常会有许多功能模块组成，如接收邮件、保存邮件、过滤垃圾邮件、自动回复、邮件通知等。
## 2.2 Outbound Mail:
Outbound Mail 是指由Gmail服务器向外部（非组织机构）发送的电子邮件。比如说，当您在Gmail客户端上创建新邮件时，它实际上是在向外部（非组织机构）的邮件服务器发送邮件。这样做可以确保您在创建新邮件时拥有足够的保护，因为您的私人信息不会被外部邮件服务器获取。但是，发送邮件给外部的另一个原因是要获取该邮件的备份。
## 2.3 SPF(Sender Policy Framework)
SPF(Sender Policy Framework)是一种域名认证机制，用来验证来自邮件发送服务器的IP地址是否属于合法发件人。通过SPF，如果发送服务器的IP地址没有经过授权，则将无法发送来自该服务器的邮件。SPF可以在Gmail邮箱设置中启用/禁用。如果关闭SPF，任何IP地址都可以发送电子邮件，使得邮件容易受到攻击。建议开启SPF，并使用专用的发送服务器来确保用户数据的安全性。
## 2.4 DMARC(Domain-based Message Authentication, Reporting and Conformance)
DMARC (Domain-based Message Authentication, Reporting and Conformance)，是一种基于域名的邮件认证、报告和符合性标准。使用此标准可以确保邮箱的所有者接收到来自其域内有效发件人的邮件。如果某个域名的邮件被认为是垃圾邮件，或者出现了违反邮件政策的问题，则该域名的管理员可以向监督机构报告该情况。Gmail邮箱可以实现DMARC，但目前默认情况下是关闭状态。
## 2.5 DKIM(DomainKeys Identified Mail):
DKIM(DomainKeys Identified Mail)是一种加密方案，可以帮助邮件服务器验证发件人的身份。通过加密签名，DKIM可以验证邮件的完整性、发送服务器的真实性以及邮件的最终目的地是否匹配。Gmail的DKIM验证也可以开启/禁用。
# 3.原理
## 3.1 SPF
SPF(Sender Policy Framework)是一种域名认证机制，用来验证来自邮件发送服务器的IP地址是否属于合法发件人。通过SPF，如果发送服务器的IP地址没有经过授权，则将无法发送来自该服务器的邮件。以下是SPF的工作原理：

1.邮件客户端向MX记录查询SMTP服务器的IP地址。
2.MX记录返回的SMTP服务器IP地址会送往SPF DNS解析器进行验证。
3.DNS解析器查找SPF TXT记录。
4.SPF TXT记录的内容表示哪些IP地址或网段可以使用发件人邮件服务器发送邮件。
5.如果SMTP服务器的IP地址不在SPF记录允许的范围内，则邮件将无法发送。
SPF的缺点主要是易受缓存攻击。如果缓存时间较短，则发件人可能会绕过SPF检查。另外，修改SPF策略可能需要一些时间才能生效。
## 3.2 DMARC
DMARC(Domain-based Message Authentication, Reporting and Conformance)，是一种基于域名的邮件认证、报告和符合性标准。使用此标准可以确保邮箱的所有者接收到来自其域内有效发件人的邮件。以下是DMARC的工作原理：

1.邮件客户端发送邮件时，首先在DNS记录中查询DMARC TXT记录。
2.如果不存在DMARC TXT记录，则采用默认策略，即不管发件人的邮件是否被认为是垃圾邮件，都将其放入收件箱。
3.如果存在DMARC TXT记录，则将判断依据包括发件人邮箱、接收者邮箱及整个域名。如果判断结果为“QUARANTINE”，则将邮件移至隔离区；如果为“REJECT”，则拒绝发送该邮件；如果为“NONE”或“NOTIMELIMITED”，则只需等待默认规则即可。
4.如果发送失败，则会向邮箱所有者发送DMARC reports。
5.收件人邮箱可以查看邮件的审核结果，并做出相应的操作。
## 3.3 DKIM
DKIM(DomainKeys Identified Mail)是一种加密方案，可以帮助邮件服务器验证发件人的身份。通过加密签名，DKIM可以验证邮件的完整性、发送服务器的真实性以及邮件的最终目的地是否匹配。以下是DKIM的工作原理：

1.邮件客户端生成一个随机字符串作为邮件的DKIM Signature值。
2.将DKIM Signature和邮件一起传送给邮件服务器。
3.邮件服务器对邮件进行加密，同时计算DKIM Signature的哈希值。
4.邮件服务器将DKIM Signature和邮件一起传送回发件人。
5.发件人验证DKIM Signature是否与邮件中的哈希值匹配。
DKIM的缺点是需要收件人和发件人之间共享密钥，不能保证全文的安全性。另外，修改DKIM策略可能需要重新签名邮件。
# 4.操作步骤
## 4.1 SPF 设置方法
### 配置域名解析
首先，登录Gmail邮箱，点击左侧导航栏中的设置->账户与导入->域名管理，进入域名管理页面。然后，点击添加域名，填写域名名称，点击下一步，选择已有的域名或手动输入新建域名。点击下一步后，复制出一条TXT记录，将其添加到域名管理的DNS配置中，记录类型选择TXT，保存。如下图所示：
### 在MX记录中添加SPF Record
第二步，打开域名管理的MX配置页面，找到对应域名的MX记录。然后，将SPF Record 添加到MX记录中，并保存。如下图所示：
### 保存设置
最后，点击右下角保存按钮，完成SPF设置。
### 测试SPF设置
测试SPF设置的方法也很简单，在发送邮件时，打开被认为“垃圾邮件”的邮箱服务器的SMTP日志，看一下发送失败的原因。通常来说，失败原因的含义如下：

1.SPF record not found：SPF记录未找到。这个问题比较普遍，可能的原因有两个：一是SPF记录不存在，二是DNS配置错误导致解析失败。
2.SPF header failure：SPF认证失败。发件人IP地址未列入授权发送列表。这种情况通常发生在域名或IP地址已被列入黑名单，但还未及时清除，或网络故障导致SPF记录失效。解决办法是检查域名和IP地址是否已经列入SPF白名单。
3.SPF fail reason：其它原因导致SPF认证失败。常见的原因有“Invalid domain name”、“unknown mechanism”等。
## 4.2 DMARC 设置方法
### 配置域名解析
首先，登录Gmail邮箱，点击左侧导航栏中的设置->账户与导入->域名管理，进入域名管理页面。然后，点击添加域名，填写域名名称，点击下一步，选择已有的域名或手动输入新建域名。点击下一步后，复制出一条CNAME记录和两条TXT记录，分别添加到域名管理的DNS配置中，记录类型选择CNAME和TXT，保存。如下图所示：
### CNAME设置
第一次，将邮件认证相关记录添加到域名管理的DNS配置中。打开域名管理的CNAME配置页面，将_dmarc.xxxxx.com添加到CNAME记录中，并保存。第二次，将SPF相关记录添加到域名管理的DNS配置中。打开域名管理的SPF配置页面，将v=spf1 xxx ip4:xxx include:_spf.google.com ~all添加到TXT记录中，并保存。如下图所示：
### DMARC设置
第二次，将DMARC相关记录添加到域名管理的DNS配置中。打开域名管理的DMARC配置页面，将_dmarc.xxxxx.com. IN TXT "v=DMARC1; p=quarantine; sp=none; adkim=s; aspf=s"添加到TXT记录中，并保存。如下图所示：
### DMARC设置选项说明
p 表示处理结果，可以取的值有quarantine(隔离区)、reject(拒绝)、none(仅限本地)，adkim 表示是否提供差错检测服务，aspf 表示是否提供随申报的投诉机制。
sp 表示根据邮件的严重程度，选取不同的通知方式，取值为none(仅限本地)、low(低频率)、medium(中频率)、high(高频率)。
pct 表示所覆盖的百分比，默认为100。
rua 表示反馈URI，用于反馈消息的接收地址。
三个参数必填，adkim和aspf不能省略。
### 测试DMARC设置
测试DMARC设置的方法也很简单，在发送邮件时，打开被认为“垃圾邮件”的邮箱服务器的SMTP日志，看一下邮件审核结果。通常来说，审核结果的含义如下：

1.Pass：审核通过。此时意味着邮件满足了DMARC的要求，将正常进入收件箱。
2.Quarantine：邮件进入隔离区。此时意味着邮件未满足DMARC的要求，会被移动到隔离区，等待审查。如果某些垃圾邮件发送者滥用了SPF策略，可能会导致这些邮件被误判。
3.Reject：邮件被拒绝。此时意味着邮件未满足DMARC的要求，将被拦截，无法进入收件箱。如果某些邮件发送者滥用了SPF策略，可能会导致这些邮件被误判。
4.No report：无报告。此时意味着DMARC审计暂停或域名无DMARC记录，审计结果不可知。