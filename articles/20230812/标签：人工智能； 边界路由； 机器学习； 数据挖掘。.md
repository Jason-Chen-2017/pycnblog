
作者：禅与计算机程序设计艺术                    

# 1.简介
  

随着智能手机、平板电脑等智能设备的普及，人们逐渐关注如何在异地间有效通信的问题。最简单的方法就是通过无线局域网，即Wi-Fi或者蜂窝网络。但是在现实世界中，由于各种原因（如高楼大厦、山路、城市繁忙等）导致设备距离不同，往返延迟增加，使得即使采用无线局域网，也无法实现快速有效的通信。因此，人们需要在现有的无线局域网基础上，增加一种新的通信方式——边界路由（Border Gateway Protocol, BGP）。BGP的作用主要是提供一种在不同的ISP之间路由选择的手段，让网络通信更加高效，同时减少因因特网拥塞带来的影响。本文将介绍边界路由的原理、工作流程以及具体应用场景。

# 2.核心概念
## 2.1.边界路由器
边界路由器一般称作边界网关协议（Border Gateway Protocol，BGP）路由器。它的功能类似于公共交换机，用于连接多个互联网。它主要负责两个方面的任务：

1. 维护互联网上的路由信息，包括IP地址和下一跳路由器的信息。

2. 根据策略，向相邻的其他路由器传播其所知道的路由信息，从而使各个路由器能够建立连接，形成一个互联网。

边界路由器是连接两个或更多的互联网之间唯一的路由器。它通常直接连接到Internet，但也可以通过另一个边界路由器连接到另一个ISP。通常情况下，一个ISP会有一个或多个边界路由器，并且边界路由器和其他类型的路由器一样，也是要安装在数据中心内。

## 2.2.自治系统（Autonomous System，AS）
自治系统（Autonomous System，AS）是一个由一组路由器、区域汇聚点、路由标识符和管理机构组成的自组织网络。每个AS都有自己的自治系统编号（ASN），该编号由Internet Assigned Numbers Authority (IANA)分配，每年变化一次。

## 2.3.ISP（Internet Service Provider，网络服务提供商）
互联网服务提供商（Internet Service Provider，ISP）是指向用户提供网络接入服务的公司。ISP通过其供应商网关路由器（又称“ASBR”）连接到互联网，并为客户提供专属于他们的连接速度、质量、价格以及客户服务等级保障。ISP根据客户需求提供不同的服务，如连接到互联网，提供远程访问和路由服务，提供虚拟专用服务器，也有提供内容分发网络等。

## 2.4.可达性（Reachability）
自治系统之间的路由可以看做是网络中某一节点到所有其他节点的最短路径。如果某个AS中的一个路由器可以到达另一个AS中的另一个路由器，那么两者之间就可以建立直接的连接。

## 2.5.路径矢量路由（Path Vector Routing）
路径矢量路由（Path Vector Routing）是一种动态路由协议，利用有向图模型计算出各个路由器之间的路由关系，并根据此模型为用户选择一条最佳路由。路径矢量路由协议中，路由信息经过一系列路由器传递，这些路由器将路径矢量传播给相邻路由器，从而使得整个互联网的路由信息始终处于最新状态。

## 2.6.BGP过程
BGP协议运行过程如下：

1. ISP A启动BGP进程，向边界网关路由器发送OPEN报文，等待对方确认后发送KEEPALIVE报文。

2. 当边界网关路由器收到第一条消息时，会生成一个会话ID，通过向远端BGP speaker发送UPDATE消息。

3. 如果该BGP speaker具有多个可用的路径，则它会发送多个PATH ATTR报文，同时更新相应的转发表项。

4. 一旦获得足够多的PATH ATTR报文，边界网关路由器便可以决定选择一条最优路径，并向UPDATE消息中发送PATH_CHOOSE报文。

5. 如果路径发生变化，则边界网关路由器再次向UPDATE消息中发送PATH_CHOOSE报文。

6. 如果某个边界网关路由器长时间没有收到来自任何可达的BGP speaker的任何报文，则会超时并开始一个新的会话。

7. 如果两个BGP speaker之间的连接出现故障，则发生的事件包括拒绝连接（Connect Rejected），连接重置（Connection Reset），关闭连接（Closed Connection）。在这种情况下，路由器会重新启动TCP会话，尝试重新建立连接。