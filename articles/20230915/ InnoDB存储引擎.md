
作者：禅与计算机程序设计艺术                    

# 1.简介
  

InnoDB存储引擎是MySQL的默认数据库引擎。它支持ACID事务、行级锁定、外键约束、非阻塞读写、热备份等功能，具备高可用性和高性能。本文主要介绍InnoDB存储引擎相关的一些概念和机制。
## 1.1 InnoDB引擎特性
### ACID原则
ACID是指原子性(Atomicity)、一致性(Consistency)、隔离性(Isolation)、持久性(Durability)。这四个属性确保了数据库的强一致性和数据完整性。
#### Atomicity原子性
一个事务是一个不可分割的工作单位，事务中包括对数据库的读写操作，要么全部成功，要么全部失败，不会存在中间状态。
#### Consistency一致性
一致性指事务前后的数据状态必须符合逻辑关系，即一个事务的操作应该影响数据库中的所有其他数据的操作，反之亦然。例如，删除一条记录后，该记录所占用的存储空间应当立即释放。
#### Isolation隔离性
隔离性又称为独立性，它使得并发事务之间不会互相干扰，每个事务都感受到其他事务的隔离性影响。即一个事务内部的操作及使用的数据对并发的其他事务都不可见。
#### Durability持久性
持久性保证事务提交后，其对数据库的修改被持久化保存到磁盘上。如果系统发生崩溃，那么在重新启动之后所有的更改都将丢失。
### 脏页
在MySQL数据库中，InnoDB存储引擎把数据保存在磁盘上的两个地方：表空间（表空间+索引）、数据文件（ibdata1）。表空间用于存储表结构信息和数据，数据文件用于存放表中的数据。由于innodb使用日志日志（undo log），所以数据修改其实是在数据文件上进行的，修改完成后并不立即更新表空间上的文件，而是先写入日志中，然后再根据配置决定什么时候将日志写入表空间。此时，可以认为数据还没有真正被持久化，因此称为“脏页”。
### redo log日志
redo log是InnoDB引擎特有的日志，作用是保证事务的持久性。当事务开始执行时，InnoDB存储引擎会先写入redo log中。如果事务执行过程中遇到错误或者crash掉了，可以利用redo log里的内容进行恢复。
## 1.2 运行模式
InnoDB存储引擎的运行模式包括三种：
- 普通模式：普通模式下，一次只能执行一条语句，效率较低；
- 插入缓冲区模式：插入缓冲区在事务提交之前，会先缓存数据到内存，从而提升性能；
- 事务提交及预写日志模式：对于高并发场景下的写入频繁，开启了事务提交及预写日志模式，能够有效减少日志文件的数量，提升性能。
## 1.3 InnoDB锁机制
InnoDB存储引擎提供了各种锁机制，防止数据库因并发访问而出现错误。这里介绍InnoDB存储引擎的锁机制。
### 共享锁
共享锁是多个事务可以同时持有，但任何事务都不能写入数据，直到所有事务都释放了锁。共享锁只用于读操作。
### 排他锁
排他锁是独占的，只有拥有该锁的事务才能对数据进行读写。其它事务若想要获得相同资源的排他锁，需要等待该事务释放锁。排他锁只用于写操作。
### 行级锁
InnoDB存储引擎采用行级锁，通过给索引加锁实现。它的工作原理是每张表中创建一个锁树（lock tree），树的叶节点对应于表的行，而每一个索引键值也对应一个节点，树中的每个节点代表着不同的锁状态。
### 意向锁
意向锁是InnoDB存储引擎为了支持多粒度锁设计的。意向锁是指，事务在某个数据行上想要获得某种锁类型时，在准备获取这个锁之前，InnoDB存储引擎会尝试先获取相应的意向锁。比如，如果有一个事务想要对数据行A加X锁，它会首先申请意向锁IX。如果 IX 锁没有被其他事务占用，那么InnoDB存储引擎就会给数据行 A 加 X 锁。
### Next-Key Locks
Next-Key Locks 是行锁的一个变种。除了在同一索引下的记录之间的间隙才会相互锁定，Next-Key Locks 会锁住索引范围内的所有记录。这是为了避免幻影读取的问题。
## 1.4 数据页组织
InnoDB存储引擎把数据存储在表空间中，表空间由一个或多个数据页组成。数据页大小一般为16KB，一页可以存放最多65536条记录。数据页组织方式可以是聚集索引组织形式、堆组织形式或复合索引组织形式。下面介绍一下InnoDB存储引擎的几种组织形式。
### 聚集索引组织形式
聚集索引组织形式就是把数据存储在主键索引的叶子节点上，并且数据是按照顺序存放在一起的，这种形式简单且高效。但是对于大量随机查询的情况来说，这样的组织形式效率低下，因为聚集索引将随机查询的效率降到了O(N)，而堆组织形式或复合索引组织形式则可以更好的支持随机查询。
### 堆组织形式
堆组织形式就是把数据全部堆起来存放在一起，但是每个数据项不是按照主键排序的。不过，通过隐藏的主键索引，可以快速找到对应的数据项。对于一般的OLTP业务场景，这种组织形式很容易扩展容量。
### 复合索引组织形式
复合索引组织形式是聚集索引的一种变体，索引可以包含多个列，每个列都可以分别建立索引。不同的是，复合索引还是按照主键排序的。这种组织形式也称为索引组织形式。
## 1.5 文件空间管理
InnoDB存储引擎在磁盘上划分了一块区域作为数据文件，通过页分区的方式来管理数据页。默认情况下，一个数据文件包含1GB的存储空间。每个数据文件包含多个表空间，每个表空间包含一个或多个分区，分区中包含一系列数据页。一个数据文件通常包含16个表空间，每个表空间可以存放最大约700万个数据页。下面是InnoDB存储引擎的文件组织图：