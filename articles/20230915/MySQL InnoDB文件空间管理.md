
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 1.1 什么是InnoDB？
InnoDB 是MySQL的默认存储引擎，它支持事务处理，外键完整性约束等功能，InnoDB 支持行级锁定，并通过聚集索引和辅助索引实现高效查询。InnoDB 使用聚集索引组织数据，在内存中按需分配表空间和缓存块，利用缓冲池对热点数据进行预读和缓存。InnoDB 提供了 ACID 事务性保证，通过 redo log 和 undo log 实现事务的恢复和数据安全。

## 1.2 文件结构
InnoDB 按照页（page）的大小为每个表空间分配连续的磁盘空间。一个页可以容纳多个记录，当一个页的数据达到一定的比例时，将该页的数据刷新到磁盘。一个页的大小是可配置的，默认情况下，InnoDB 的页大小为 16KB。InnoDB 会把一个表分成若干个区（extent），一个区中可以有多个页，不同的数据放在不同的区中。


## 1.3 数据位置索引（Data Position Index，DPI）
InnoDB 存储数据时会把每个页中的数据都记录在一个地方，以便快速找到指定主键的值对应的页。为了加速定位，InnoDB 将每张表的数据记录都按照主键排序存放，并为每条记录建立相应的索引，称之为聚集索引。对于非聚集索引的查询，InnoDB 还需要先通过聚集索引定位到主键所在的页，然后再根据其他索引定位到具体的值。

DPI 使用的是一种变种的二叉树结构，在叶子节点处保存着所有的数据页的指针。对于一个数据页来说，由于数据排列的原因，其下属的数据页会分散到各个角落，而 DPI 可以利用这些角落的数据页指针，快速准确地找到所有的数据页。


## 1.4 数据页结构
InnoDB 中，一个数据页由以下几个部分组成：
1. File header: 页面头部，占用固定长度的字节，用于标识页面的类型、页号、事务 ID、回滚指针等信息；
2. Page Directory: 数据页目录，记录本页中保存的记录的相对地址；
3. Infimum and Supremum records: 伪记录，起始标记和结束标记，指向左右两侧的最大最小值；
4. User Records: 用户记录，就是真正存储的数据内容；
5. Free Space: 空闲空间，存储本页剩余的可用空间；


## 1.5 文件空间管理
InnoDB 通过页的管理、数据的插入、删除和更新等操作，来实现对数据库中数据的维护。但是随着数据的不断增长，会导致系统中的页过多，占用过多的文件空间，所以 InnoDB 需要对文件空间进行管理。

### 1.5.1 删除数据时，释放磁盘上的页
删除数据时，如果该数据不再被任何其他数据引用，则可以直接将其所在的页从磁盘上释放掉。InnoDB 会把页的数据及相关的索引删除，但不会立即将页从磁盘上物理删除。而是把页设置成空闲状态，等待后续写入新的数据。这样就可以避免频繁的磁盘 I/O 操作，提升效率。

### 1.5.2 分裂数据页
当向数据页中插入数据导致其所占用的磁盘空间超过当前页的剩余空间时，就会发生页分裂。InnoDB 在数据页分裂时，首先将当前页右半部分的数据拷贝到新的页中，将当前页的剩余空间清零，然后再修改旧页的页面头部，指向新页。如图所示：


### 1.5.3 合并数据页
当两个相邻的数据页因为删除或更新操作而释放出相同的空间时，InnoDB 就会进行页合并。InnoDB 在合并页时，会从磁盘读取两个相邻的数据页的内容，将其中任一页的数据拷贝到另一边的页中，再将两页删除，同时修改合并后的页面头部，指向正确的页。如图所示：
