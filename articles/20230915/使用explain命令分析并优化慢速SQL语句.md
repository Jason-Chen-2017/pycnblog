
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 为什么需要使用explain命令？
在实际生产环境中，数据库慢查询是日常运维工作中的一个常见问题。通常，通过日志文件、监控系统或者客户端工具等方式发现慢查询，然后根据日志、监控系统或者客户端工具给出的执行计划进行优化，从而提升整体数据库性能。但当遇到复杂查询时（例如包含多表关联、子查询等）就很难通过以上方式单步调试解决。因此，我们需要借助于explain命令来对慢速SQL语句进行分析和优化。explain命令可以提供SQL执行效率的详细信息，帮助我们更好地理解执行计划，找到瓶颈所在，进一步优化数据库性能。
## explain命令用途
explain 命令作用主要包括以下几个方面:

1.查看sql执行计划,用于查看mysql数据库sql的执行过程及花费时间。

2.索引失效情况排查，用来检查某个sql是否使用了错误的索引或不合适的索引类型导致查询速度变慢。

3.对于select count(*)这样的简单sql执行计划比较直观。

4.对于insert/update/delete等更新类sql的执行计划，看待优化前后的执行计划之间的不同。

5.对于复杂的查询，可以通过explain的结果分析其内部的执行顺序和数据访问，帮助我们分析出问题根源。

6.其他一些用途，由于篇幅原因这里不一一列举。

## 执行explain命令原理
explain 命令是一个mysql提供的内置命令，它可以在服务器端打印SQL的执行计划，其原理如下:

1.首先mysql会对查询的SQL语句进行语法检查，确认语法正确无误；

2.然后mysql根据不同的存储引擎，调用对应的处理逻辑，生成执行计划。对于mysql这种基于成本评估的执行方式，其内部也是通过一定的规则来选择合适的执行方案的。

3.生成完毕后，mysql将执行计划输出给客户端，客户端接收到执行计划后，就可以根据执行计划进行相应的优化工作了。

## explain命令输出格式

一般情况下，explain命令的执行结果集如下图所示:


其中，id 表示查询序列号，表示的是SELECT、UPDATE或者DELETE语句被执行的次序，越小表示优先级越高；rows 表示该语句要扫描的数据行数，这个值就是SELECT COUNT(*)返回的结果；Extra 表示额外的信息，在慢查询分析中经常出现以下几种信息:

1.Using index : 使用了覆盖索引，直接匹配主键或索引，不需要再回表查询数据，查询速度快。

2.Using where : 在读取记录时，增加了where条件，减少了查询范围，加快了查询速度。

3.Using filesort : MySQL需要额外排序，不能通过索引顺序达到排序效果，这个时候MySQL需要额外排序操作，查询效率可能受影响。

4.Using temporary : 查询中创建了一张临时表来存储结果集，避免了内存的开销。

5.Using join buffer : 使用了连接缓存，保存中间查询结果，避免了重新打开表，加快了查询速度。

6.Impossible WHERE condition : where子句里包含了 impossible条件(永假条件)，会导致全表扫描，查询效率会极低。

除了上面这些指标之外，explain命令还会输出表之间的关系和数据存储结构。但是由于篇幅限制，这里不做过多介绍。

## analyze命令如何跟踪查询性能？
analyze命令可以跟踪查询性能，分析出更详细的执行计划，展示查询时间线，找出慢查询的热点，显示最慢的查询等等功能，能够分析出数据库的运行状况和调优指标。

使用analyze命令的基本流程如下:

1.mysql> set global optimizer_trace='enabled=on'; //开启系统变量，开启explain的优化器跟踪模式，并写入日志。

2.mysql> select * from t; //执行sql语句，会触发优化器的跟踪和收集分析数据。

3.mysql> show variables like 'optimizer_trace%'; //查看系统变量，查询当前状态，是否已开启优化器跟踪模式。

4.mysql> set global optimizer_trace=''; //关闭系统变量，停止收集分析数据。

5.mysql> show engine innodb status \G; //查看系统状态，获取分析的相关信息，如慢查询分析列表、top slow queries等等。