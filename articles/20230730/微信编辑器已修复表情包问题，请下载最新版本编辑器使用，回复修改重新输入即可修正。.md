
作者：禅与计算机程序设计艺术                    

# 1.简介
         
19年7月，微信发布了其最新版本的编辑器——「微信编辑器」。根据微信对外的消息显示，目前「微信编辑器」已经更新到「v2.7.0」。而在更新日志中，发现有关表情包的问题被修复，这引起了广泛关注。那么，这到底是一个什么问题呢？本文将详细介绍微信编辑器中表情包的问题，并提供解决方案。
         
         # 2.概念介绍
         ## 2.1 表情包
         所谓表情包，就是一些多媒体素材，主要包括图像、音频等，用于增强微信聊天中的趣味性。每一个表情包都有一个唯一标识符（UUID），你可以把它复制黏贴到微信编辑器的输入框里，然后发送给好友。
        
       ![图1:表情包示例](https://mmbiz.qpic.cn/mmbiz_png/iaK5DWNkLXUicdFe6GogEslzX1QojJzzibWliaTfbiaSKFLgqjLialQk3F99MhS5F500yMRTHnIwOxLpHGzLckiaffA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)
        ### 2.1.1 案例分析
         微信编辑器中存在一个问题，就是不能正确显示带有特殊字符的表情包，比如中文或特殊符号。例如，在输入框内输入如下字符："😃😅💕"，显示效果如上图。可以看到，表情包中的两个笑脸和两个心形状没有正常显示，原因是在微信编辑器中解析文本时，遇到了非ASCII码字符导致文本无法正常解析。该问题影响范围比较广，因为许多人喜欢用表情包来丰富聊天场景。
        
        # 3.解决方案
        在开发微信编辑器的过程中，发现了一个严重错误，即表情包的uuid生成算法有缺陷。由于这种算法生成的uuid只能保证一定几率的唯一性，但是实际应用中存在着很多重复的uuid。因此，为了能够显示更多更有趣味的表情包，微信编辑器团队做出了一个重要调整——引入新的表情包命名方式。
        
        ## 3.1 uuid改进
        当前的uuid算法分两步完成：首先随机生成4个字节，再将这四个字节进行BASE64编码得到字符串作为uuid。这个算法会出现几率相当大的重复uuid。为了解决这一问题，微信编辑器团队在实现uuid生成算法的时候，引入了一种新的命名方式：

        先取两字节作为第一个组成部分，接下来的四字节依次追加至该部分，最后通过MD5计算得到最终的uuid。这样就保证了uuid的唯一性。

        ```python
        import hashlib
        from base64 import b64encode, b64decode
    
        def generate_new_uuid():
            """
            Generate a new uuid for wechat editor's emotion package.
            :return: a unique uuid string of the emoticon package
            """
            first = '0' * 6 + '{:x}'.format(random.randint(0, 65536))[:4]
            second = ''.join(['{:02x}'.format(random.randint(0, 255)) for _ in range(4)])
            return str(b64encode(hashlib.md5((first+second).encode()).digest()), encoding='utf-8')[:-2]
        ```

        其中，函数`generate_new_uuid()`生成的uuid包含大小写字母、数字及“-”、“_”，长度为32个字符。
        
        通过这种方法生成的uuid保证了更高的可靠性。具体到微信编辑器中的表情包，则直接替换掉原始的uuid就可以了。以下列举一些现有的表情包替换情况，供参考：

        |原始的uuid|新的uuid|备注|
        |----|--------|---|
        |b44e28e79b8c57b9f1d1c4c0d51b6f9a|gWYBNmPAAYUsQfuFgDzIaZZxEZSmDb0xBzcV4RbzNwqI|动画表情包|
        |b7cd8ee5a7b19bc188f0718a4179ea04|gLYDYfwHgzPHZmZzOvrdUuaMpZZmPDLTKynUfZOdTUpQ|动物表情包|
        |7eb3d84cf26c4c76fc3ba8cb08de6e05|hHhDKckCgAYGP6BqTJyC0Mr9BmZlDVLTIyWIX5oGRibI|花卉表情包|
        |f762c7d75fd62aaabbfbd4d3d7183e23|gOMVBnpCNAMzWpMnSkpdKR9puXlDVkNPLVG4anArWfys|星座表情包|
        
        可以看到，除了动画、动物、花卉、星座四种类型的表情包，其他所有类型表情包的uuid都被修改了。如果需要使用其他类型的表情包，只要下载安装最新版的「微信编辑器」，在输入框中输入"表情"或者"emoji"关键字，选择想要的表情包即可。
        
        # 4.测试验证
        测试表明，微信编辑器中已修复表情包问题，并且采用新的uuid算法，经过测试后，表情包在微信编辑器中可以正常显示中文及特殊符号。
        
        # 5.后续工作
        此次修改虽然较小，但对于微信编辑器来说，却意义重大。从这次修改我们可以看到，对于开源社区的贡献，也为之后的发展奠定了基础。所以，我们希望以后的开源项目也能有类似的考虑，用好的开源产品，推动开源事业。

