
作者：禅与计算机程序设计艺术                    

# 1.简介
  

数据库系统中常用的存储引擎有两种：MyISAM 和InnoDB 。然而，这两种引擎之间有什么区别？又有哪些需要注意的细节？为了帮助读者理解这两者之间的差异，作者将从以下几个方面对MyISAM 和InnoDB 的特性进行介绍：

1.概述及其优缺点: MyISAM、InnoDB 是MySQL中的两个主要的存储引擎之一。MyISAM 在性能方面更胜一筹，它支持全文索引、压缩表空间等功能。但 MyISAM 不支持事务，不支持外键，也不能承受高并发访问场景下的压力。在选择存储引擎时应根据应用的特点进行选择，根据不同场景的需求选择合适的存储引擎，比如大量的写操作可以选择 MyISAM，而对于查询操作则应该选择 InnoDB。

2.数据页结构：MyISAM 以 B+Tree 结构组织数据文件，每张表的数据文件即一个.MYD 文件，该文件由若干个固定大小的分块组成。MyISAM 索引文件也是一样的结构。每个数据页或索引页的大小为 16K ，当页所存放的数据超过 16K 时，会自动申请下一个页。

3.锁机制：MyISAM 支持表级锁(table-level locking)，但是不支持行级锁（row-level locking）。如果要实现更细粒度的锁定，可以使用间隙锁(gap locking)。间隙锁可以加快行的插入速度，同时避免幻读和不可重复读。InnoDB 支持行级锁，通过给予多个并发事务互斥的读写锁实现。

4.内存缓存和磁盘I/O：MyISAM 会将最近访问的页面缓存在内存中，命中率高；InnoDB 不会缓存任何数据，所有的读取都直接在硬盘上进行，这样会增加硬盘I/O操作，提升了整体性能。

5.其它特性：MyISAM 支持崩溃后恢复，可以在崩溃后的某一时刻快速启动，可以使用 CHECKSUM 或者 DELAY_KEY_WRITE 参数保证数据完整性，可以手动或者自动备份数据。InnoDB 支持事务，支持崩溃后的一致性回滚（Crash-Consistent Rollback），即使在异常关闭之后事务也能成功提交。

6.总结：综上所述，MyISAM 是一个非常优秀的存储引擎，它支持全文搜索、压缩表空间等特性，但并不支持事务和外键等功能。而 InnoDB 则提供了丰富的功能，包括支持 ACID 事务、支持对行级锁和间隙锁的支持。所以，在不同的业务场景下，应该选取最合适的存储引擎，通过合理配置，提升 MySQL 的性能。

# 2.1 概括及其优缺点
## 2.1.1 InnoDB 特性
InnoDB 是一个基于 MySQL 分支的开源关系型数据库引擎，主要提供了具有提交、回滚和崩溃一致性的事务支持，并且还提供了行锁和外键约束。InnoDB 具有众多特性，如：

1. 行锁：InnoDB 使用的是两阶段锁协议，其中第一阶段加全局读锁防止其他事务修改当前记录，第二阶段再对涉及到更新的记录加排他锁确保数据正确性。行锁能保证数据的完整性，即数据库修改操作都是原子化的，因此也就可以保证并发控制的安全性。
2. 事务支持：InnoDB 提供事务支持，支持事务的提交、回滚、崩溃修复能力。用户可以通过设置隔离级别，实现不同的隔离级别。
3. 支持外键：InnoDB 支持外键，但不像 MyISAM 那样在查询时会锁住整个表。
4. 插入缓冲区：InnoDB 引入了一个插入缓冲区，将多次更新聚集在一起批量提交，可以提升效率。
5. 自适应哈希索引：InnoDB 可以根据统计信息自动创建哈希索引，也可以手工指定哈希索引列。

## 2.1.2 MyISAM 特性
MyISAM 是一个被广泛使用的、开源的关系型数据库管理系统，它的设计目标就是快速处理大容量的数据。由于其简单性、高性能、以及良好的存储性能，已经成为许多网站的后台数据库。例如 WordPress 博客系统中的评论数据库就是使用 MyISAM 来存储数据的。MyISAM 的一些特性如下：

1. 性能优于 InnoDB：MyISAM 比 InnoDB 更快，因为它的数据文件只有一个.MYD 文件，而 InnoDB 有三个.MYD、.MYI、.frm 文件。
2. 只读方式打开：MyISAM 可以以只读的方式打开，但不能锁定表，所以在执行复制或删除操作时可能会遇到问题。
3. 支持全文检索：MyISAM 可以支持全文索引，能够对文本字段进行模糊搜索。
4. 支持压缩表空间：MyISAM 支持压缩表空间，可以减少磁盘占用。
5. 无内置死锁检测器：MyISAM 不提供死锁检测器，需要开发人员自己编写程序来解决死锁。

# 2.2 数据页结构
## 2.2.1 数据页结构
在 MyISAM 中，一个数据页（page）的大小为 16KB，即 16384 bytes。一个数据页包含 2040 个字节的数据和 270 个字节的页目录。其中前 2040 个字节用于存储数据，而后面的页目录则用于快速定位数据位置。如果没有设置主键或者非唯一索引，那么 InnoDB 每个数据页都会单独维护一个隐藏的聚集索引。此外，InnoDB 会把数据分成相应的段，并按顺序物理写入磁盘。一个段的大小为 1GB，因此一个 InnoDB 表可以有多个数据文件。

InnoDB 数据页的结构也类似，但它会多出 7 个字段来实现辅助索引：

-  undo log：用于事务的回滚。
-  重做日志（redo log）：InnoDB 用于持久化存储引擎内部操作日志。
-  文件标识符：表示数据页属于哪个文件。
-  页面编号：用于标识数据页在文件中的相对位置。
-  修改标记位：指示页面是否被修改过。
-  头部校验和：用于校验页面完整性。
-  奇偶校验位：用于确定页面是否有误。

## 2.2.2 索引页结构
MyISAM 和 InnoDB 中的索引页结构并不相同。MyISAM 的索引页（.IDX）结构很简单：页面大小为 16 KB，包含一个索引节点，指向真正的数据位置。InnoDB 的索引页（.IBT）结构复杂一些，主要包含三个部分：

-  Page Header：80 bytes，包含一个 PAGE_TYPE 字段来标识页面类型（INODE_PAGE 或 INDEX_PAGE）、一个 PAGE_LSN 字段来标识页面最近一次修改的 LSN 号、一个 PAGE_NEXT 字段用来连接邻接索引页。
-  File Header：56 bytes，包含一个 FILE_PAGE_NUM 字段来标识页属于的文件编号、一个 PAGE_DIRECTION 字段用于判断扫描索引方向。
-  Index Data：最多可以存放 7916 bytes，且不保证连续。用来存储相关联的主键值及数据指针。

# 2.3 锁机制
## 2.3.1 表级锁
MyISAM 默认支持表级锁，其锁定粒度是表级，每次锁定都将整个表上的所有资源锁定。由于锁定粒度太大，所以开销比较大，同时也降低了并发度。一般情况下，对于读多写少的应用来说，可以使用表级锁。

## 2.3.2 行级锁
InnoDB 默认采用行级锁，其锁定粒度是行级，每次锁定只锁定对应行的数据。行级锁能大大提升数据库的并发度，但是带来了锁的开销。因此，在写操作较多，但读操作远远小于写操作的场景下，建议使用 InnoDB 的行级锁。

# 2.4 内存缓存和磁盘I/O
InnoDB 不会对数据进行缓存，所有的数据读写都需要磁盘 I/O。相比于 MyISAM，其内存使用情况更低，但是速度快很多。

# 2.5 其它特性
## 2.5.1 支持崩溃恢复
MyISAM 支持崩溃恢复，其利用 redo log 技术进行事务的恢复。但是 MyISAM 在一些操作过程中可能频繁地调用 fsync() 函数，这会导致数据库的性能下降，甚至导致数据损坏。

InnoDB 通过检查并发事务来保证数据完整性，同时通过事务的隔离性、一致性和持久性来保障数据的完整性。InnoDB 支持主从复制，支持崩溃恢复，能够自动恢复临时中断的工作，从而保证数据安全。

## 2.5.2 支持事务
MyISAM 不支持事务，对于一些要求事务支持的场景，建议使用 InnoDB 引擎。

InnoDB 支持事务，支持事务的提交、回滚、崩溃修复能力。用户可以通过设置隔离级别，实现不同的隔离级别，使数据库在满足应用的完整性、一致性、隔离性要求的前提下，提供最大程度的并发处理能力。

## 2.5.3 支持外键
MyISAM 不支持外键。而 InnoDB 支持外键，但 InnoDB 在执行 UPDATE 操作时，会自动将符合 FOREIGN KEY 约束条件的子表也锁住，直到整个操作完成。

# 2.6 总结
综上所述，MyISAM 和 InnoDB 都是 MySQL 中经典的关系型数据库引擎，都各有其优势。在某些要求事务支持、要求较强完整性的场景中，建议使用 InnoDB，InnoDB 具有更好的并发处理能力、更好的性能、更好的完整性。