
作者：禅与计算机程序设计艺术                    

# 1.简介
         

         ## 一、为什么要写这个主题
         
         在过去的几年里，Ethereum的社区发展极其迅速，创新产品层出不穷。对于开发者来说，无论是使用语言还是工具，EVM字节码都是他们熟悉的编程语言，通过智能合约可以实现各种复杂的逻辑。而升级功能也是Ethereum开发的热门话题。越来越多的项目开始选择使用上述技术，希望能够更好地管理智能合约的生命周期。
          
         6月份在以太坊中文社区上发布了Solidity ABI和库（Library）的RFC文档，以及OpenZeppelin 2.0更新中的升级功能。这两项技术都对智能合约的可组合性、模块化和升级提供了更加细致的支持。因此，这篇文章将详细阐述如何利用这些特性来编写可扩展的、可升级的智能合约。
         
         ## 二、什么是Upgradeable Contracts? 和 Upgradeable Libraries？

         ### **什么是Upgradeable Contracts?**

         智能合约的升级机制允许智能合约作者可以在部署之后向合约添加新的功能或改变已有的功能，而不需要部署全新的合约。这样做的目的是为了提高智能合约的灵活性和可用性，同时也降低了维护成本。如今，很多应用程序都是由多个智能合约构成的。例如，一个典型的去中心化交易所由委托订单生成器、交易引擎和撮合器三种智能合约组成。每当市场变化时，交易所都会重新部署所有的合约。如果可以实现智能合约的升级，那么就可以减少或避免这些重复的部署过程。此外，升级机制还可以帮助合约作者更好地管理智能合币生命周期。

         虽然升级可能是一个复杂的过程，但还是有一些简单的规则可以帮助智能合约作者轻松地实现升级功能。首先，智能合约的版本号应当作为一个状态变量存储在合约中，每次修改完合约的代码后需要递增版本号。然后，在编译合约的时候，编译器会自动生成升级代码，它可以让用户可以迁移到最新版本的合约。升级代码通常只需要进行很少的更改，而且可以自动调用旧版本合约的所有接口函数。最后，升级系统应该有一个监控组件，它定期检查是否有新的版本的合约可用，并自动执行合约的迁移。

         

         ### **什么是Upgradeable Libraries?**

         以太坊智能合约库（Library）允许智能合约开发者创建一些功能模块，然后将它们导入到其它智能合约中。这些模块可以被其他智能合约所共享，从而使得合约的可读性更好、可维护性更强，也方便合约的升级。一般情况下，库由以下几个部分组成：

         - 函数接口定义；
         - 函数实现代码；
         - 对外提供的合约接口。

         库的升级机制与智能合约类似。库的版本号应当作为状态变量存储在库的实现代码中，并且每次修改完成代码后，库的版本号应当递增。编译器在编译库的实现代码时，会生成适用于该库的升级代码。升级代码通常只需要进行很少的更改，而且可以自动调用旧版本库的所有接口函数。

         

         ## 三、为什么要用Composable Smart Contracts？

         现在，已经有许多团队开始探索智能合约的可组合性。可组合性意味着两个智能合约之间可以相互引用。例如，一个智能合约可以调用另一个智能合约，也可以把自己当作参数传给另一个合约。这种能力可以让智能合约变得更加灵活、可重用。另外，可组合性还可以将不同的功能拆分成多个小的组件，这样就可以更好地控制程序的复杂性和安全性。例如，一个去中心化的贸易平台可以由不同的智能合约组成，包括供应链管理系统、订单管理系统、结算系统等。不同合约可以分别负责不同的职能，并且可以自由组合起来。

         

         ## 四、Composable Smart Contracts中的关键技术

         有两种主要的方法可以实现可组合的智能合约：

         - **Upgradeable Contracts** 是一种智能合约级的升级方法，它允许部署者向合约添加新功能或者修改现有功能，而不需要部署全新的合约。这种方式有助于降低维护成本，并提升智能合约的可用性。
         - **Upgradeable Libraries** 是一种智能合约级的库，它的版本号跟随着库的实现代码的版本号，因此可以轻松地实现智能合约间的版本控制。这些库可以被其它智能合约所依赖，也可以在运行过程中被动态加载。

         本文将首先介绍如何实现Upgradeable Contracts，再进一步介绍如何利用Upgradeable Libraries来构建可组合的智能合约。

         

         ## 五、Upgradeable Contracts原理及实践

         ### **实现原理**

         在Ethereum中，智能合约是一段不可更改的代码，由合约部署者完全控制。由于合约是根据编译后的字节码运行的，所以任何修改后重新部署的合约都将覆盖之前的版本。然而，很多时候，我们想通过修改已有的合约来扩展其功能，而不影响之前版本的合约。这就需要升级功能。

         EVM是一个基于栈的虚拟机，智能合约编写者可以直接在编译器中调用EVM指令，实现智能合约的功能。当需要修改已有合约时，可以使用升级功能来保持与之前版本兼容。

         使用Solidity的ABI（Application Binary Interface）接口标准，可以定义智能合约的外部接口，并生成相应的二进制编码。一旦编译成功，智能合约的源代码就不能修改，否则会导致签名失败。不过，可以通过新增、删除、修改函数签名来实现功能的增减。

         可以通过创建一个继承自旧合约的新合约来实现新功能，然后调用旧合约的接口来保持与之前版本兼容。这种方式比较简单，但是对于复杂的合约结构来说，仍然存在一定的难度。

         Upgradeable Contracts的实现原理如下图所示：


         在图中，Alice和Bob都是合约的部署者，他们各自拥有自己的账户。现在，他们想要升级一个已有的合约。首先，他们在本地编写了一个新版本的合约，并测试通过。然后，他们选择一个旧版本的合约，并将其二进制编码与新版本合约相关联。如果是ABI更改，则需要手动修改部署脚本。接下来，Alice用Alice的账户在Etherscan或其他可信任的平台上发布新版本的合约。当合约的交易生效后，Bob可以用自己的账户调用合约的新功能。如果Bob发现有漏洞，他可以用自己的账户调用旧版本的合约。



         ### **实践示例**

         在实践应用中，我们可以看到Upgradeable Contracts的真正价值。举例来说，假设有一个去中心化的游戏，游戏有几个模块，比如角色扮演类游戏、回合制策略类游戏、建筑类游戏等等。每个模块都有自己的生命周期，需要跟踪的合约也不同。例如，在角色扮演类游戏中，角色合约需要跟踪角色信息，技能系统需要跟踪技能信息。如果需要升级某个模块，则可以创建一个继承自旧模块的新模块，并通过接口调用来实现模块的平滑迁移。

         除了角色扮演类游戏外，还有其他类型的游戏需要跟踪合约的生命周期。比如，建筑类游戏的位置合约需要跟踪城市布局信息，供应链管理系统需要跟踪商品订单等等。在这种场景下，Upgradeable Contracts都可以派上用场。

         

         ## 六、Upgradeable Libraries原理及实践

         ### **实现原理**

         Libraries是智能合约的共享资源。它们可以帮助开发者重用代码，提升智能合约的复用性和可维护性。库的版本控制可以有效地管理智能合约的生命周期。

         在Ethereum中，Libraries的实现方式和智能合约一样，也是采用编译后的字节码实现。当智能合约需要调用库时，实际上是在调用编译后的二进制代码。也就是说，当智能合约需要调用某个库时，编译器会生成对应版本的二进制代码，并插入智能合约的二进制代码中。所以，Libraries的版本控制跟智能合约一样，只需将版本号记录在库的代码中即可。

         可以将Libraries视为智能合约，只是它们没有状态变量。也就是说，他们不会占据ETH，并且无法发送ETH，只能接受外部消息。这一点对于库的设计者来说非常重要。

         

         ### **实践示例**

         同样，在实践应用中，我们也可以看到Upgradeable Libraries的作用。举例来说，假设有一个智能合约管理游戏数据，其中包含了一系列的游戏实体，比如角色、物品等等。这些实体的数据往往要存放在不同的数据库中。为了降低耦合性，可以将这些实体抽象成Libraries，然后再在智能合约中引用它们。智能合约与数据库之间的连接可以定义为接口，这样就可以在不同时间引入不同的数据库实现。当智能合约需要调用库时，它会调用最新的实现版本，而不是特定版本的库。



         ## 七、可组合的智能合约优势

         通过升级合约，我们可以实现智能合约的可组合性。对于大型项目，升级功能可以简化开发流程，并降低维护成本。另外，在智能合约中使用库可以减少重复代码，并提高代码的可读性。这些都可以提高开发效率，缩短开发周期，降低项目风险。总之，可组合的智能合约有助于降低项目的复杂性，提升开发效率，促进合作共赢。