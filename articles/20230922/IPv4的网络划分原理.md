
作者：禅与计算机程序设计艺术                    

# 1.简介
  

IPv4协议是一个因特网协议，它规定了互联网通信的规则、地址分配方法等。在IPv4协议中，一个IP地址通常由四个八位二进制数字表示，如192.168.1.1；而每个IP地址都对应着唯一的网络地址，它标识网络上的计算机或设备，相当于MAC地址（Media Access Control Address）。

IP地址的作用就是定位到互联网上某台计算机或设备所在的网络。在互联网上，每台计算机都需要有一个独一无二的IP地址，通过这个地址可以将数据包发送给目的地。但对于大型互联网来说，不可能为每台计算机都分配一个独一无二的IP地址。因此，IPv4协议采用一种结构化的网络划分方案，把整个互联网分成不同子网，并在子网内部再用子网掩码进行进一步细分。

IPv4的网络划分方案主要基于两个原则：一个是使得IP地址空间尽量充分利用，另一个是网络管理容易、简单。下面我们就要讨论一下IPv4的网络划分原理。

# 2.IPv4网络划分原理
## 2.1 IP地址与网络地址
IPv4协议的基本单位是IP地址，每个IP地址由32位二进制数组成。IP地址从“0.0.0.0”到“255.255.255.255”，共有四十亿五千万多种不同的IP地址。而每个IP地址又可分为两部分，前面三部分表示网络ID，后面部分表示主机ID。

例如，“192.168.1.1”的网络ID是“192.168.1”，主机ID是“1”。也就是说，“192.168.1.1”所属的网络范围是“192.168.1.0 ~ 192.168.1.255”，而且只有这个IP地址才是“192.168.1”这个网络的成员。

同样地，“172.16.1.1”的网络ID是“172.16.0.0/12”，主机ID是“1”。因为“172.16.0.0”~“172.31.255.255”是私有地址，一般不会直接向外网公开，所以该网络的成员都被隐藏起来了。

## 2.2 子网划分和子网掩码
为了更好地利用IP地址，IPv4协议支持子网划分。子网划分就是把一个大的IP地址空间切割成若干小的子网，这样可以降低IP地址资源的消耗，提高互联网的可靠性、有效性及性能。子网划分同时还简化了路由配置、子网间通信、网络管理等工作。

子网划分时，对IP地址的二进制表示形式作如下划分：先确定子网的大小，然后将IP地址的网络部分和子网部分分别取相同长度的前缀。这里的前缀长度就是子网掩码。

例如，假设IP地址为“192.168.0.1”，子网划分之后得到子网号为“192.168.0.0/24”，其中子网掩码是“255.255.255.0”。这意味着，“192.168.0.0”~“192.168.0.255”这些地址构成了一个子网，而且只有那些IP地址中的最后一部分不同。因此，可以通过子网掩码来判断一个IP地址是否属于某个子网。

实际应用中，根据需要，往往会为各个子网指定对应的网关地址，使得不同子网之间能够建立连通。这些地址在子网中是固定的，不需要配置在每个计算机上，减少配置项的复杂度。

## 2.3 CIDR与VLSM
CIDR（Classless Inter-Domain Routing）是一种灵活的网络划分方案。它的基本思想是，允许用户自定义子网划分策略，而不需要事先定义好网络的总体大小。具体做法是在IP地址的第一个字节中加入子网标识符（subnet identifier），即子网掩码的反码（invert mask）。这样就可以让IP地址的前缀长度用于指示子网大小，而子网掩码剩余部分则作为子网内IP地址的网络部分。

例如，“192.168.0.1/24”的子网掩码部分是“255.255.255.0”，因此IP地址的第一字节可以用来表示子网的大小。如果希望子网大小增加，可以在IP地址的第二字节处添加更多子网标识符，以此类推。这称之为VLSM（Variable Length Subnet Masks，可变长子网掩码）。

CIDR还有其他优点，包括：

1. 更容易管理网络；
2. 灵活调整子网划分策略；
3. 提升路由表查找效率；
4. 可以避免因子网过大导致的网络效应；
5. 对IPv6适用。

## 2.4 双栈网络
IPv4协议有两种通信模式：一种是“单播”模式，即所有的数据包只送给一个目标地址；另一种是“多播”模式，即将数据包广播到多个目标地址。但由于历史原因，多播使用的是单播地址，即目标地址为“172.16.31.10”。

为了兼容老版本的应用程序，IPv4协议支持双栈网络。双栈网络就是指具有两种网络层协议的网络。在这种网络下，TCP/IP协议族既可以使用IPv4，也可以使用IPv6。举例来说，Windows系统中的双栈网络，即可以同时支持IPv4和IPv6协议。

# 3.IPv4地址分配方案
## 3.1 类A、B、C地址
IPv4协议的地址分为三个类型：类A、B、C类地址。它们分别对应着8、16、24位的网络号。类A地址的网络号的最高位为“0”，第二个字节的最高位为“10”，第四个字节的最高位为“0”。类B地址的网络号的最高位为“10”，第四个字节的最高位为“0”。类C地址的网络号的最高位为“110”。

类A地址的首部长度固定为24个字节，类B地址的首部长度固定为16个字节，类C地址的首部长度固定为8个字节。这三种类型的地址都没有实际意义，仅供系统管理员分配合法IP地址。

## 3.2 自动配置
为了方便网络管理员管理网络，并减少重复劳动，IEEE制定了自动配置的IP地址分配策略。自动配置策略的基本思想是，自动产生符合标准格式的IP地址，并且这些地址应该具有稳定的网络标识符（network ID）。自动配置策略可以根据路由器的位置、链路速度、当前分配的IP地址数量等信息生成相应的IP地址。目前，有以下几种自动配置策略：

1. 静态地址分配。这是最简单的自动配置策略。管理员事先确定IP地址的分配情况，然后根据需要手动配置IP地址。

2. 动态地址分配。动态地址分配策略可以根据流量负载情况及路由表配置自动调整IP地址。

3. 手工分配。在静态地址分配失败的时候，可以采用手工分配策略，即由管理员指定IP地址及相关参数，并将其输入网络控制器。

4. 聚集地址分配。在有许多用户同时连接到Internet的时候，可以采用聚集地址分配策略。这是一种特殊的自动配置策略，它要求网络管理员必须配置网关地址，并将其加入到路由表中。