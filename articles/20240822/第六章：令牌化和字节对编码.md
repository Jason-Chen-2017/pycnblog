                 

# 第六章：令牌化和字节对编码

> 关键词：令牌化,字节对编码,预处理,自然语言处理(NLP),深度学习,BERT

## 1. 背景介绍

在自然语言处理(NLP)领域，预处理是数据流式进入模型之前的关键步骤。数据经过预处理后，可以更好地适应模型的输入要求，提高模型的运行效率和准确度。令牌化和字节对编码是两种常见的预处理技术，广泛应用于NLP中的各类模型，如BERT、GPT等。

本章节将详细介绍令牌化和字节对编码的基本概念、算法原理以及具体应用。

## 2. 核心概念与联系

### 2.1 核心概念概述

令牌化是将文本转换为模型能够接受的格式，即将文本分割为一个个独立的词语或子词。令牌化是NLP中的一种重要预处理技术，可以将不同长度的文本转化为长度一致的数据，方便模型处理。

字节对编码是一种特殊的编码方式，用于将文本转换为模型能够理解的向量形式。字节对编码可以保留更多的语言特征信息，提高模型对文本的语义理解能力。

令牌化和字节对编码是两种常用的文本预处理技术，它们在保持文本结构的同时，减少了数据处理的复杂度，提高了模型的训练和推理效率。

### 2.2 核心概念原理和架构的 Mermaid 流程图

```mermaid
graph LR
A[输入文本] --> B[令牌化]
B --> C[模型输入]
C --> D[字节对编码]
D --> E[模型理解]
```

上图中，输入文本通过令牌化后转换为模型能够接受的格式，然后经过字节对编码转换为模型理解的向量形式，最终输入到模型中进行处理。

## 3. 核心算法原理 & 具体操作步骤

### 3.1 算法原理概述

令牌化是将文本转换为模型能够接受的格式，即将文本分割为一个个独立的词语或子词。常用的令牌化方法包括BPE、WordPiece、SentencePiece等。

字节对编码是一种特殊的编码方式，用于将文本转换为模型能够理解的向量形式。字节对编码可以保留更多的语言特征信息，提高模型对文本的语义理解能力。

### 3.2 算法步骤详解

#### 3.2.1 令牌化算法步骤

1. 分词：将输入文本进行分词处理，得到一个词语列表。
2. 构建词汇表：将分词结果中的所有词语构建一个词汇表。
3. 令牌化：将输入文本中的每个词语转换为一个或多个令牌，每个令牌表示一个单独的词语或子词。

#### 3.2.2 字节对编码算法步骤

1. 分词：将输入文本进行分词处理，得到一个词语列表。
2. 构建字符集：将分词结果中的所有字符构建一个字符集。
3. 编码：将输入文本中的每个字符转换为一个或多个字节对，每个字节对表示一个单独的字符。

### 3.3 算法优缺点

#### 3.3.1 令牌化的优缺点

- 优点：令牌化能够将不同长度的文本转换为相同长度的数据，方便模型处理。同时，令牌化还可以在词表中进行嵌入，提高模型的表达能力。
- 缺点：令牌化可能会导致某些词语被拆分成多个子词，增加了计算量和存储成本。

#### 3.3.2 字节对编码的优缺点

- 优点：字节对编码可以保留更多的语言特征信息，提高模型对文本的语义理解能力。同时，字节对编码不需要额外的词表构建过程，提高了预处理效率。
- 缺点：字节对编码的编码长度较长，增加了计算量和存储成本。同时，字节对编码可能会导致某些字符被拆分成多个字节对，增加了计算量和存储成本。

### 3.4 算法应用领域

令牌化和字节对编码广泛应用于NLP中的各类模型，如BERT、GPT等。它们可以提高模型的训练和推理效率，提升模型的表达能力和理解能力。

## 4. 数学模型和公式 & 详细讲解 & 举例说明

### 4.1 数学模型构建

令牌化和字节对编码的数学模型主要涉及分词和编码两部分。

#### 4.1.1 令牌化数学模型

令牌化可以看作是一个映射函数，将输入文本中的每个词语映射为一个或多个令牌。令牌化后的结果可以用一个向量来表示，其中每个元素表示一个令牌。令牌化后的向量长度为n，表示输入文本中的n个令牌。

令牌化的数学模型可以表示为：

$$
f(x) = \{t_1, t_2, ..., t_n\}
$$

其中，x表示输入文本，f表示令牌化函数，t_i表示令牌化后的第i个令牌。

#### 4.1.2 字节对编码数学模型

字节对编码可以看作是一个映射函数，将输入文本中的每个字符映射为一个或多个字节对。字节对编码后的结果可以用一个向量来表示，其中每个元素表示一个字节对。字节对编码后的向量长度为m，表示输入文本中的m个字节对。

字节对编码的数学模型可以表示为：

$$
g(x) = \{b_1, b_2, ..., b_m\}
$$

其中，x表示输入文本，g表示字节对编码函数，b_i表示字节对编码后的第i个字节对。

### 4.2 公式推导过程

#### 4.2.1 令牌化公式推导

令牌化可以看作是一个映射函数，将输入文本中的每个词语映射为一个或多个令牌。令牌化后的结果可以用一个向量来表示，其中每个元素表示一个令牌。令牌化后的向量长度为n，表示输入文本中的n个令牌。令牌化的公式可以表示为：

$$
f(x) = \{t_1, t_2, ..., t_n\}
$$

其中，x表示输入文本，f表示令牌化函数，t_i表示令牌化后的第i个令牌。令牌化后的向量长度为n，表示输入文本中的n个令牌。

#### 4.2.2 字节对编码公式推导

字节对编码可以看作是一个映射函数，将输入文本中的每个字符映射为一个或多个字节对。字节对编码后的结果可以用一个向量来表示，其中每个元素表示一个字节对。字节对编码后的向量长度为m，表示输入文本中的m个字节对。字节对编码的公式可以表示为：

$$
g(x) = \{b_1, b_2, ..., b_m\}
$$

其中，x表示输入文本，g表示字节对编码函数，b_i表示字节对编码后的第i个字节对。字节对编码后的向量长度为m，表示输入文本中的m个字节对。

### 4.3 案例分析与讲解

#### 4.3.1 令牌化案例分析

以“Hello World”为例，令牌化后的结果为：

$$
f("Hello World") = \{Hello, World\}
$$

其中，Hello和World表示令牌化后的两个令牌。

#### 4.3.2 字节对编码案例分析

以“Hello World”为例，字节对编码后的结果为：

$$
g("Hello World") = \{Hello, World\}
$$

其中，Hello和World表示字节对编码后的两个字节对。

## 5. 项目实践：代码实例和详细解释说明

### 5.1 开发环境搭建

在进行令牌化和字节对编码的实践时，需要先搭建好开发环境。以下是使用Python进行PyTorch开发的环境配置流程：

1. 安装Anaconda：从官网下载并安装Anaconda，用于创建独立的Python环境。

2. 创建并激活虚拟环境：
```bash
conda create -n pytorch-env python=3.8 
conda activate pytorch-env
```

3. 安装PyTorch：根据CUDA版本，从官网获取对应的安装命令。例如：
```bash
conda install pytorch torchvision torchaudio cudatoolkit=11.1 -c pytorch -c conda-forge
```

4. 安装Transformers库：
```bash
pip install transformers
```

5. 安装各类工具包：
```bash
pip install numpy pandas scikit-learn matplotlib tqdm jupyter notebook ipython
```

完成上述步骤后，即可在`pytorch-env`环境中开始令牌化和字节对编码的实践。

### 5.2 源代码详细实现

下面我们以BERT模型为例，给出使用Transformers库对输入文本进行令牌化和字节对编码的PyTorch代码实现。

首先，定义BERT模型：

```python
from transformers import BertTokenizer
from transformers import BertForMaskedLM
from transformers import BertTokenizerFast

model = BertForMaskedLM.from_pretrained('bert-base-cased')
tokenizer = BertTokenizerFast.from_pretrained('bert-base-cased')
```

然后，定义令牌化函数：

```python
def tokenize(text):
    tokens = tokenizer.encode_plus(text, max_length=512, padding='max_length', truncation=True, return_tensors='pt')
    return tokens['input_ids'], tokens['attention_mask']
```

接下来，定义字节对编码函数：

```python
def byte_pair_encode(text):
    text = tokenizer.encode(text, add_special_tokens=False)
    chars = []
    for i in range(len(text)):
        char = text[i]
        if char in tokenizer.char_to_id:
            chars.append(tokenizer.char_to_id[char])
    char_pair = [(chars[i], chars[i + 1]) for i in range(len(chars) - 1)]
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = list(set(char_pair))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1]))
    char_pair = [(x, y) for x, y in char_pair if x != y]
    char_pair = sorted(char_pair, key=lambda x: (x[0], x[1

