
作者：禅与计算机程序设计艺术                    

# 1.简介
  

MyISAM是MySQL的默认数据库引擎，它不支持事务处理、外键约束等功能，也不支持行级锁定和MVCC（多版本并发控制），因此，在高并发环境下，MyISAM表具有较差的性能。但是，对于一些对事务完整性要求不高或者不需要支持并发控制的应用来说，MyISAM是个不错的选择。另外，MyISAM还有其他一些特性，比如支持压缩表、空间函数等。

InnoDB是另一种 MySQL 的数据库引擎，它的设计目标就是用于实时插入和查询大量的数据。它内部使用的是聚集索引，并且所有的更新都通过独立的日志文件进行管理，从而确保数据安全、一致性和持久性。相比之下，MyISAM表虽然没有完全相同的功能，但还是拥有部分MyISAM的优点，比如快速的读写速度。

本文将结合官方文档，介绍一下MyISAM和InnoDB的区别，并阐述他们各自适用的场景。

# 2.主要知识点
## 2.1 事务处理
### 2.1.1 ACID属性
ACID是Atomicity、Consistency、Isolation、Durability的缩写，表示一个事务是一个不可分割的工作单位，事务中包括四个属性：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。如下图所示：
其中，
* Atomicity: 事务是一个不可分割的工作单位，要么全部成功，要么全部失败。
* Consistency: 执行事务前后，数据保持一致状态，事务不会破坏关系数据的完整性和一致性。例如A向B转账，事务的执行过程必须保证A的钱减少，B的钱增加，同时不能出现A的钱减少，B的钱没有变化的情况。
* Isolation: 隔离性是指一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对其他事务是隔离的，并发执行的事务之间不能互相干扰。
* Durability: 持久性是指一个事务一旦提交，它对数据库中的变更就永久保存了。即使系统崩溃，事务的执行结果也不能丢失。

InnoDB支持事务，而且提供了对并发访问的支持，其支持原子化的提交（committing）或回滚（rolling back）事务，并通过行级锁和表级锁提供一定程度的并发访问控制。

### 2.1.2 InnoDB日志
InnoDB使用两阶段提交（two-phase commit）方式来实现事务的提交，在InnoDB的世界里，每当需要启动一个事务的时候，InnoDB都会给予其相关的数据结构 locks 和 transaction id。locks 是为了保证数据完整性和一致性，当某个事务开始时，InnoDB 会为这个事务分配一些必要资源，如内存、锁等，这些资源是由当前活跃的 session 独占的。transaction id 表示当前事务的唯一标识符，用来保证事务之间的顺序性。

当该事务需要提交时，InnoDB会将准备提交的事务记录在 redo log 文件中，然后通知所有提交事务的参与者（称为 preparer），等待它们准备好提交。preparer 将把 redo log 中的事务记录写入磁盘，并向所有参与者发送通知消息，表示可以提交事务。

如果任何一个参与者在接收到通知消息之前发生故障，那么在事务提交过程中就会出现死锁，导致一个或多个参与者无法继续进行提交操作，此时需要选择一个故障参与者，让它回滚自己的事务，释放锁和资源，然后再让其他参与者重新选举出新的领导者。最终，只有一个提交事务的参与者，其对应的线程唤醒，并完成提交过程。

redo log 用于保证事务的持久性，当发生数据库异常时，可以通过 redo log 来恢复数据。对于已经提交的事务，则直接将修改的数据写入磁盘；对于还未提交的事务，则先写入 redo log ，之后根据 redo log 进行重演，完成提交过程。

InooDB 为每个事务分配一个事务 ID，并生成 undo log 文件，用来维护已提交事务的撤销操作。当需要回滚一个事务时，则根据 undo log 进行回滚操作。undo log 中的信息包含了创建该条记录时的事务 ID，同时记录了数据库中相应的数据在某一时刻的快照，用于回滚。

## 2.2 数据页
数据页是InnoDB存储引擎用来存放实际数据的最小单位，其大小默认为16KB。InnoDB的数据页有两种类型：索引页（Index Page）和数据页（Data Page）。索引页和数据页的划分规则、物理结构和页号、页面中的主要内容等都是不同的，但是它们的存储逻辑是一致的，都是通过页号定位的。

InnoDB存储引擎以B+树作为索引组织结构，所有的索引都保存在B+树中。一个索引节点中的子女数量称为 fanout，默认情况下，一个节点可以拥有16个孩子节点，这种索引组织结构使得InnoDB可以在O(log n)时间内找到数据，这也是InnoDB索引为何能够支持高效的数据检索的关键。

数据页中主要包含两部分内容：
1. 一个或多个记录（Record）；
2. 一个页目录（Page Directory）。

数据页中的记录按主键的顺序排列，如果某个索引项正好在中间位置，则只需查找记录所在的数据页即可确定对应的记录，无需进行顺序扫描。

数据页的格式非常紧凑，仅包含真正的数据。除去记录、页目录等固定开销外，每个数据页还留有一些辅助信息，如：是否是空闲页、上次访问时间、最近一次更新的时间等。这些信息对于InnoDB的缓存、WAL（write ahead log）等机制非常重要。

## 2.3 索引
InnoDB 支持 B+Tree 索引、全文索引、空间索引，还支持哈希索引。

B+Tree 索引采用非叶子结点存放指向行记录的指针，且叶子结点直接存放对应行记录数据。通过在查询条件中使用索引可快速定位到数据，因为 B+ Tree 中存放的数据都是按范围顺序排列的，在范围内搜索会相对简单很多。InnoDB 在每个索引节点设置了一个最大元素个数，超过这个个数则自动转成上一个节点。

全文索引使用倒序索引的方式，倒序索引只能通过覆盖索引来加速查询，也就是说只能通过关键字精确匹配索引的字段值，不能使用其他方式定位到行记录。所以如果需要在文本中查找关键字，必须建立全文索引。

空间索引主要是在地理信息数据上的索引，例如 latitude longitude 这样的数据。空间索引可以用球面坐标系来索引地理位置数据，并支持各种复杂度的查询，比如距离半径、矩形区域等。

InnoDB 支持哈希索引，对每一行记录的第一个字段计算一个 hash 码，存入散列表中，可以快速找到符合条件的记录，适用于等值查询、排序等操作。

## 2.4 锁
InnoDB 支持行级锁、表级锁和全局锁。

InnoDB 使用两种类型的锁：共享锁（Read Lock）和排他锁（Write Lock）。对于 select 语句，默认是自动加共享锁的，同一时间可以允许多个客户端读取同一条记录，但不能删除或更新这条记录。

对于 delete、insert、update 操作，InnoDB 默认是自动添加排他锁的，同一时间只能有一个客户端操作，其他客户端不能并发执行这类语句。对于批量操作（insert into...values(),...），InnoDB 默认会自动使用单个的 insert 插入数据，不涉及冲突检测，效率最高。对于一般的操作，可以使用参数 myisam_max_lock_tables 参数限制最大使用的锁数量，防止死锁。

InnoDB 使用两个日志文件：redo log 和 undo log 来实现事务的持久性和崩溃恢复。

## 2.5 性能调优
InnoDB 提供了很多参数可以优化数据库性能，下面主要介绍几个常用的参数：

```mysql
innodb_buffer_pool_size = 128M       # 缓冲池大小，默认32M
innodb_log_file_size = 512M         # 事务日志大小，默认128M
innodb_log_buffer_size = 8M         # 事务日志缓存区大小，默认8M
innodb_flush_log_at_trx_commit = 1   # 每个事务提交后立即刷新事务日志，默认为1
innodb_thread_concurrency = 16      # 后台IO线程的数量，默认是4，推荐设置为CPU核心数
innodb_file_per_table = ON          # 是否将数据文件存放在独立的文件中，默认为ON
innodb_open_files = 512             # 当打开文件的总数达到阈值时，新来的请求将被阻塞，直到系统释放文件资源
key_buffer_size = 256M              # key缓存大小，默认是16M
query_cache_size = 64M              # 查询缓存大小，默认是16M
```