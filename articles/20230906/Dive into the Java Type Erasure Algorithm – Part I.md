
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 1.什么是类型擦除？
在Java中，类型擦除（Type Erasure）指的是编译器或运行时系统自动移除泛型类型的信息，只保留原始类型，因此JVM只知道Object，对于泛型类型也无能为力。它的主要作用是为了减少编译后的代码体积，提高代码执行效率和兼容性。类型擦除是Java泛型的一大特色，在应用层看起来像没有泛型一样简单。但是，它并不是由语言本身来实现的，而是通过编译器和字节码技术来实现的。
## 2.为什么要擦除类型信息？
相比于泛型，类型擦除可以带来一些优势，比如：
- 减少了运行时内存占用：泛型在运行时需要维护一个参数化类型表（generic type table），用于存储实际类型和泛型类型之间的映射关系；类型擦除后仅存在原始类型，避免了这种开销。
- 提升了代码执行效率：类型擦除后的代码不需要运行时维护类型相关的信息，进一步提升了执行效率。
- 支持跨平台开发：由于不同JVM实现之间可能存在类型不兼容的问题，使用类型擦除后可以降低这种影响，使得同一种泛型代码可以移植到不同的JVM上。
## 3.如何实现类型擦除？
### 3.1 编译器实现
#### 3.1.1 JVM规范定义
Java虚拟机规范（JVMS）规定，当一个类文件被加载时，应该对其中的泛型信息进行擦除处理。类型擦除后的字节码会变成类似非泛型的代码，类的名称、方法名、属性名都不会出现在字节码里，这样做的原因是因为泛型只是在编译阶段有意义，并不属于源代码的一部分。
#### 3.1.2 javac编译器实现
javac编译器负责将源码编译为class文件，其中包括将泛型信息擦除后的代码生成class文件，具体过程如下图所示：

1. 在编译阶段，javac编译器会将泛型类型替换成Object类型，并在源代码中插入一段隐式强制转换的代码，使得编译结果与未使用泛型时的结果一致。例如，Integer a = new Integer(10);就会被替换成Object a = (Integer)new Object(10)。
2. 生成的class文件仍然包含泛型类型信息，但该类型信息已经被擦除了。
3. 当运行时系统发现引用的是泛型类型时，会将其替换成Object类型。
4. 此外，还可以使用反射机制来访问擦除后的代码，不过这个过程比较复杂。
#### 3.1.3 Eclipse JDT插件实现
Eclipse JDT插件也是Java泛型的重要特色之一，它在后台也采用了类似的方法来实现类型擦除。具体流程如下图所示：

1. Eclipse JDT会将泛型类型替换成其对应的Object类型，同时也会在源代码中插入一段隐式强制转换的代码。
2. 生成的class文件仍然包含泛型类型信息，但该类型信息已经被擦除了。
3. 当运行时系统发现引用的是泛型类型时，会将其替换成Object类型。
4. 最后，JDT还会使用类型擦除后的代码来为IDE提供自动补全、跳转等功能。

总结：一般情况下，编译器或运行时系统都会采用擦除泛型类型信息的方式来实现类型擦除。
### 3.2 运行时实现
除了编译期间的类型擦除，Java SE 7及更高版本的JVM还提供了类型擦除的运行时支持。具体步骤如下：

1. 当JVM加载某个类型的时候，如果这个类型声明或者某个超类或者接口的类型参数是一个类型变量，那么JVM就在运行时擦除这些信息。
2. 擦除后，所有的类型信息都会从元数据中去掉。也就是说，类型擦除后，JVM只认识到原始类型。
3. 当某个类型实例化的时候，如果构造器的参数类型是一个擦除类型，则会把这个类型转化为对应擦除类型对应的原始类型，之后才会调用构造器。
4. 如果某个方法的返回值类型是一个擦除类型，则会把这个类型转化为对应擦除类型对应的原始类型。
5. 类型擦除最主要的应用场景就是JDK集合框架中的泛型。例如List<String> list = new ArrayList<>();在编译时已经替换成了ArrayList<Object>。

总结：类型擦除的运行时支持是Java SE 7及更高版本的JVM中的一项重要特性。