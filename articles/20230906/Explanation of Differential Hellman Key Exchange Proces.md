
作者：禅与计算机程序设计艺术                    

# 1.简介
  

在通信网络中，为了保证传输过程中的安全性，需要使用公钥加密方法对数据进行加密。最简单的公钥加密方法是非对称加密算法，其中一种常用算法是Diffie-Hellman密钥交换协议（简称DH）。

DH协议的基本思想是，双方首先随机选择一个素数p，然后计算出两个不同大的整数a、b，其中a不等于0且b不等于p-1，那么它们的乘积ab也就等于p-1。


双方共享公开参数p、g，并且协商出私有参数x。公钥A=g^a mod p，私钥X=g^x mod p。

双方各自发送自己的公钥B给对方，并通过密文发送协商好的私钥X。

经过两方协商确认后，双方可计算出共享秘钥K=B^x mod p，其中B为接收方发送来的公钥。

由于p是一个质数，那么K一定不是由随机数生成的，因此，如果攻击者可以任意截获双方的数据包，那么他很难从这些数据包中推断出共享秘钥。

针对此种弱点，发明了基于离散对数的DH密钥交换协议——基于椭圆曲线的Diffie-Hellman密钥交换协议。

该协议的基本思想是在椭圆曲线上建立密钥交换，即在椭圆曲线上选取两个点P和Q，点Q必须满足条件Q=g^x(mod p)，P=g^y(mod p)。

其中，g为固定的基点，根据曲线上的两个点的关系可以得到方程：

P=(gx,gy), Q=(gy,g^(x+1))

满足以上两个方程的曲线就成为椭圆曲线E：


把椭圆曲线E上任意一点的坐标(px,py)用两个不同大的整数x和y表示，则

xy^2 = px^3 + py^3

也就是说，所谓的椭圆曲线E就是一条曲线方程，它是一个定义域为有限区间[0,p-1]上的多项式曲线，并非任何一般曲线都可以作为其模型。

对于椭圆曲线，它的阶为p-1，因为曲线上的每个点都对应着一个唯一的x值。设曲线的中心为O，在O处的切线为d；以O为焦点，绕着d旋转的方向为直线k。则有

d:OP=k:(O,p).

这条线通常被称为椭圆曲线的焦点倾角。椭圆曲线的一个重要特点是，每条曲线可以由一个点P和一个位于椭圆与P相切的一条线d，以及一组参数a和b来描述，这组参数唯一确定了曲线。

如果知道曲线上某个点P的坐标(px,py)，就可以求出其对应的x和y值。如果知道曲线的曲率半径r，就可以求出椭圆曲线上的所有点。

基于椭圆曲线的Diffie-Hellman密钥交换协议使用了椭圆曲线的这一优势，而无需生成素数，因此可以更加安全地进行密钥交换。

基于椭圆曲线的Diffie-Hellman密钥交换协议分为三个阶段：

1）选定椭圆曲线E，确定基点g及相应参数a、b等；

2）双方各自选择私钥x，计算出公钥B=g^b mod p，并将B发送给对方；

3）对方接收到B后，计算出K=B^xa mod p，并通过加密方式发送K给对方。

这里只介绍了 DH 和 ECDH 的关键原理，未深入到具体的代码实现细节，如能详细描述完整的代码流程和机制，对于理解DH和ECDH至关重要。