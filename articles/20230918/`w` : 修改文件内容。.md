
作者：禅与计算机程序设计艺术                    

# 1.简介
  


修改文件内容，是linux命令中的一个重要功能。由于工作需要，通常会遇到需要对文本文件进行修改的情况。通常都是将已有的文件复制一份出来，然后用编辑器打开进行修改。

而在一些场景下，我们希望能够快速、方便地完成文件的修改，例如批量更新某些字段的值、批量添加/删除某些行等。

所以，了解一下`sed`，`awk`，`perl`，这些工具或编程语言，对于修改文件内容来说，是非常必要的。

本文从头开始详细的介绍了三个命令工具：`sed`，`awk`，`perl`。通过实际案例和介绍，让读者能够理解并掌握这三个命令的使用方法及其适应范围。

# 2. sed

## 2.1. 基本语法

sed(stream editor)是一种流编辑器，它可以在读取输入的同时处理或转换文本。

它的命令格式如下:

```
sed [-options] 'command' file(s)
```

其中，`-options`表示可选参数，比如`-n` 表示只打印出经过sed命令处理后的那一行，而不输出原有的行；`'command'`表示一条或者多条sed命令，可以进行替换、查找、删除等操作；`file(s)`表示要被处理的文件列表。

sed命令是文本处理中最基础也是最常用的命令。通过各种命令选项和动作，可以实现如替换、删除、分割、拼接等功能。

## 2.2. 命令选项

sed的命令选项包括以下几种：

1. -a  
   在命令模式上追加（add）动作，允许多个命令模式组合执行。
2. -e script-file 
   从脚本文件中读取sed命令，该文件中可以包含多个sed命令。
3. -f script-file 
   和`-e`类似，但是以单引号括起来的命令，可读性更强。
4. -i[SUFFIX]    
   直接修改源文件，而不是产生副本，SUFFIX表示备份文件的后缀名。
5. -l N   
   只列出处理第一N个匹配的行。
6. -n     
   只打印出经过sed命令处理后的那一行，而不输出原有的行。
7. -r     
   将正则表达式扩展为ERE(扩展型正则表达式)，ERE模式支持更多的匹配方式。
8. -v      
   对脚本中的字符引用，也就是转义字符，进行逐次替换。
9. --help 
   显示帮助信息。
   
## 2.3. 基本示例

### 替换字符串

替换字符串的命令为 `s`:

```
$ echo "hello world" | sed's/world/everyone/'
hello everyone
```

这里，`s`命令表示替换，第一个`/`后的`world`表示需要被替换的字符串，第二个`/`后的`everyone`表示用于替换的新字符串。由于原句子中只有一次出现“world”这个词，因此替换之后仅仅有一个“everyone”。

### 删除字符串

删除字符串的命令为 `d`:

```
$ echo "hello world" | sed's/world//g'
hello 
```

这里，`d`命令表示删除，并且全局匹配模式（`g`）。所以，所有的“world”都被删除掉了。

### 插入文本

插入文本的命令为 `i` 或 `a`:

```
echo "hello world" | sed's/world/everybody/i'  
hello everybody world
```

和替换命令一样，这里也是用 `/` 来表示被替换的目标字符串，并用 `i` 来表示把它插在当前位置之前。

如果想把它插在当前位置之后，就用 `a` 命令:

```
echo "hello world" | sed's/world/everybody/a'
hello world everybody
```

和 `i` 命令不同的是，`a` 命令把新文本加在最后面。

### 分割字符串

分割字符串的命令为 `y/x/y`:

```
echo "hello world" | sed 'y/lwor/xbyp/' 
hebbr_o xvolr_
```

这里，`y` 命令用来执行“映射”操作，即将字符串中的一些字符映射成另外一些字符。`/lwor/` 表示将 `l`、`w`、`o` 中的每一个字母都替换为 `x`。

因此，原句子中的 `l` 被替换成了 `x`，`w` 变成了 `b`，`o` 变成了 `y`。

同样也可以进行反向映射，即将新的字符串映射回原始字符串:

```
echo "hebbr_o xvolr_" | sed 'y/xbyp/lwor/' 
hello world
```

### 打印指定行

打印指定行的命令为 `=`:

```
echo "hello\nworldd\neverybody" | sed '=' 
hello
worldd
```

这里，`=` 表示打印匹配行号，这里仅打印出第一行和第三行。如果没有指定参数，默认打印所有行。

### 搜索特定字符串

搜索特定字符串的命令为 `/{pattern}/:`

```
echo "hello world" | sed '/worl/p'  
world
```

这里，`/{pattern}/` 表示搜索字符串，这里是搜寻“world”这一词。`p` 表示打印出匹配到的行。

## 2.4. 使用技巧

### 合并两行

使用`NR==N`指令，可以合并第N+1行和第N行的内容:

```
echo "line1\nline2\nline3\nline4" | awk '{if (NR == 1 || NR == 4){printf "%s ", $0} else {next}} END{print ""}'
line1 line2 
```

上面例子中，`NR==1 || NR==4`表示第1行和第4行，此时应该合并这两行的内容，并且输出。注意`{printf}`命令中需要加空格，否则会导致第1行和第4行的内容会重叠显示。

### 打印最后一行

使用`$`符号即可打印出最后一行:

```
echo "hello\nworld" | sed '$d;s/$/, Nice to meet you!/;/^$/q' 
hello, Nice to meet you!
```

上面例子中，先删除最后一行，再使用`q`指令退出脚本。`d`代表删除行，`$`代表最后一行。