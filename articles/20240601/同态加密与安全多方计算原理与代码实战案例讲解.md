# 同态加密与安全多方计算原理与代码实战案例讲解

## 1. 背景介绍

### 1.1 什么是同态加密

同态加密(Homomorphic Encryption, HE)是一种加密形式,它允许对加密数据进行特定的代数运算得到仍然是加密的结果,即对加密数据的任何处理都不会破坏数据的机密性。简单地说,同态加密使得人们可以在不知道原始数据是什么的情况下处理数据并得到有意义的结果。

同态加密分为部分同态加密(Partially homomorphic encryption, PHE)和全同态加密(Fully homomorphic encryption, FHE)。部分同态加密只支持加法或乘法运算中的一种,而全同态加密可以同时支持加法和乘法运算。

### 1.2 什么是安全多方计算

安全多方计算(Secure Multi-Party Computation,MPC)指的是在若干个拥有私有数据输入的参与方之间,在不泄露任何参与方私有数据的前提下,共同完成某个计算任务的过程。换句话说,安全多方计算允许多方在不共享他们的输入数据的情况下计算一个共同感兴趣的函数。

安全多方计算的目标是确保参与各方除了他们自己的输入和计算结果之外,不能获得关于其他参与方输入的任何信息。实现安全多方计算的方法主要有基于不经意传输(Oblivious Transfer)的方法、基于秘密共享(Secret Sharing)的方法、基于同态加密的方法等。

### 1.3 同态加密和安全多方计算的重要性

同态加密和安全多方计算在隐私保护、数据安全等领域具有广泛的应用前景。在大数据和云计算时代,海量数据的处理和存储给数据隐私保护带来了巨大的挑战。同态加密可以很好地解决"如何在不泄露隐私数据的前提下对数据进行处理"的问题。而安全多方计算技术可以使得多个机构在不泄露各自掌握的隐私数据的前提下开展数据融合与协同计算。

同态加密和安全多方计算在金融、医疗、电子投票、隐私保护数据挖掘等诸多领域都有重要应用。例如,利用全同态加密可以实现对加密数据的搜索和统计分析,在不泄露个人信息的前提下实现精准广告推送;利用安全多方计算技术,多家医院可以在不泄露患者隐私信息的情况下开展跨院数据融合,实现疾病的联合会诊与研究。

## 2. 核心概念与联系

### 2.1 部分同态加密

部分同态加密支持对密文进行加法或乘法运算中的一种。著名的部分同态加密方案有:

- 基于整数的Paillier加密:支持加法同态运算
- 基于有限域的ElGamal加密:支持乘法同态运算

### 2.2 全同态加密

全同态加密可以对加密数据执行任意次数的加法和乘法运算。2009年,Gentry基于理想格构造提出了第一个全同态加密方案,开创了全同态加密的新时代。此后,全同态加密技术不断发展,出现了多种不同的构造方法:

- 基于整数的全同态加密
- 基于学习误差(LWE)的全同态加密  
- 基于环学习误差(RLWE)的全同态加密

### 2.3 秘密共享

秘密共享(Secret Sharing)是一种将秘密分割成若干子秘密的方法,每个参与方持有一个或多个子秘密,当且仅当足够多的参与方聚合在一起时才能还原出原始的秘密。常见的秘密共享方案有Shamir秘密共享和Blakley秘密共享。

### 2.4 不经意传输

不经意传输(Oblivious Transfer,OT)是两方参与的安全计算协议。在不经意传输中,发送方拥有若干消息,接收方可以在不让发送方知道是哪一条消息的情况下接收其中一条消息。不经意传输是许多安全多方计算协议的重要组成部分。

### 2.5 Yao's 电路加密 

Yao's 电路加密(Yao's Garbled Circuit)是两方安全计算的经典方法。其基本思想是将计算电路"加扰",使得电路的每一个门的真值表被随机置换,从而隐藏电路的功能。参与双方通过不经意传输获得加扰电路的输入,进而可以独立计算电路而得到最终结果。

## 3. 核心算法原理具体操作步骤

### 3.1 Paillier 加密

Paillier加密是一种基于复合剩余类的概率公钥加密体制,支持加法同态。其加解密流程如下:

#### 密钥生成

1. 随机选择两个大质数 $p,q$, 计算 $n=pq, \lambda=lcm(p-1,q-1)$
2. 选择随机整数 $g$,使得 $g$ 的阶模 $n^2$ 为 $n$
3. 公钥为 $(n,g)$,私钥为 $\lambda$ 

#### 加密
对明文 $m \in \mathbb{Z}_n$,随机选择 $r \in \mathbb{Z}_n^*$,加密为:

$$
E(m,r) = g^m \cdot r^n \bmod n^2
$$

#### 解密
对密文 $c$,解密为:

$$
D(c) = \frac{(c^\lambda \bmod n^2) - 1}{n} \cdot \lambda^{-1} \bmod n
$$

#### 同态性
对于两个密文 $E(m_1), E(m_2)$,有:

$$
E(m_1) \cdot E(m_2) = E(m_1 + m_2)
$$

即Paillier加密支持密文加法同态。

### 3.2 BGV 全同态加密

BGV是基于环学习误差(RLWE)假设的全同态加密方案,以下是BGV的主要流程:

#### 密钥生成
1. 选择参数 $n$ 为2的幂次, $q$ 为模数, $t$ 为明文空间模数,定义多项式环 $R=\mathbb{Z}_q[X]/(X^n+1)$
2. 随机选择私钥 $s \leftarrow \chi$,其中 $\chi$ 为离散高斯分布
3. 选择随机多项式 $a \leftarrow R_q$,误差多项式 $e \leftarrow \chi$,计算公钥 $b=a \cdot s + t \cdot e$
4. 公钥为 $(a,b)$,私钥为 $s$
   
#### 加密
对明文多项式 $m \in R_t$,随机选择 $r,e_1,e_2 \leftarrow \chi$,加密为:

$$
Enc(m) = (c_0, c_1) = (a \cdot r + t \cdot e_1, b \cdot r + t \cdot e_2 + m)
$$

#### 解密
对密文 $(c_0,c_1)$,解密为:

$$
Dec(c_0,c_1) = (c_0 \cdot s + c_1) \bmod t
$$

#### 同态运算
- 加法:

$$
(c_0,c_1) + (c'_0,c'_1) = (c_0+c'_0, c_1+c'_1)
$$

- 乘法:

$$
(c_0,c_1) \cdot (c'_0,c'_1) = (c_0 \cdot c'_0, c_0 \cdot c'_1 + c_1 \cdot c'_0, c_1 \cdot c'_1)
$$

BGV通过密钥交换和模数转换等技术,可以支持多次同态乘法运算。

### 3.3 Shamir 秘密共享

Shamir秘密共享基于多项式插值原理,可以将一个秘密分割成 $n$ 个子秘密,其中任意 $t$ 个即可恢复原始秘密。

#### 共享阶段
1. 选定有限域 $\mathbb{F}_q$,秘密 $s \in \mathbb{F}_q$ 
2. 随机选择 $t-1$ 个系数 $a_i \in \mathbb{F}_q$,构造 $t-1$ 次多项式:

$$
f(x) = a_0 + a_1 x + \cdots + a_{t-1}x^{t-1} \bmod q
$$

其中 $a_0 = s$

3. 选择 $n$ 个不同的 $x_i$,计算 $y_i = f(x_i)$,将 $(x_i,y_i)$ 作为第 $i$ 个参与方的子秘密份额

#### 恢复阶段
收集任意 $t$ 个子秘密份额 $(x_i,y_i)$,使用Lagrange插值公式恢复秘密:

$$
s = f(0) = \sum_{i=1}^t y_i \prod_{j=1,j \neq i}^t \frac{x_j}{x_j - x_i} \bmod q
$$

### 3.4 Yao's 电路加密

Yao's电路加密用于两方安全计算一个布尔电路。假设Alice持有输入 $x$,Bob持有输入 $y$,他们想安全地计算 $f(x,y)$。

#### 电路加密
1. Alice将电路 $f$ 的每个门的真值表随机置换("加扰"),得到加扰电路 $F$
2. Alice为电路的每条线生成3个随机数作为密钥,分别对应该线路可能的值(0或1)
3. Alice使用线路对应的密钥加密真值表,得到加密的真值表
4. Alice将加扰电路 $F$ 连同加密的真值表发送给Bob

#### 输入转换
1. 对于Alice的输入线路,Alice将自己的输入比特所对应的密钥发送给Bob
2. 对于Bob的输入线路,Alice和Bob执行不经意传输协议(1-2 OT),使得Bob可以在不让Alice知道是哪一个密钥的情况下获得自己输入比特所对应的密钥

#### 电路求值
1. Bob使用获得的输入线路密钥,以及加密的真值表,对加扰电路进行逐门求值
2. 最终Bob得到输出线路的密钥,将其发送给Alice
3. Alice使用输出线路的密钥解密,得到 $f(x,y)$ 的值

## 4. 数学模型和公式详细讲解举例说明

### 4.1 Paillier 加密

Paillier加密的安全性基于复合剩余类困难问题和判定二次剩余困难问题。

复合剩余类定理指出,对于互质的正整数 $m,n$,映射:

$$
\begin{aligned}
\mathbb{Z}_{mn} &\to \mathbb{Z}_m \times \mathbb{Z}_n \\
x &\mapsto (x \bmod m, x \bmod n)
\end{aligned}
$$

是一个环同构。特别地,当 $m=pq$ 为两个质数的乘积时,我们有:

$$
\mathbb{Z}_{n^2}^* \cong \mathbb{Z}_n^* \times \mathbb{Z}_n
$$

Paillier加密正是利用了这一点。在加密时,我们将明文嵌入到 $\mathbb{Z}_n$ 中,再与 $\mathbb{Z}_n^*$ 中的随机元素相乘,得到 $\mathbb{Z}_{n^2}^*$ 中的随机元素作为密文。

解密时,我们先计算密文的 $\lambda$ 次方,其中 $\lambda$ 为 $\varphi(n)=\varphi(pq)=(p-1)(q-1)$。根据欧拉定理,这一步去除了 $\mathbb{Z}_n^*$ 部分的随机性。接下来再将结果减1除以 $n$,就得到了嵌入在 $\mathbb{Z}_n$ 中的明文。

Paillier的同态性来自于 $\mathbb{Z}_{n^2}^*$ 乘法群的性质。对于明文 $m_1,m_2 \in \mathbb{Z}_n$ 和随机数 $r_1,r_2 \in \mathbb{Z}_n^*$,有:

$$
\begin{aligned}
E(m_1,r_1) \cdot E(m_2,r_2) &= g^{m_1}r_1^n \cdot g^{m_2}r_2^n \bmod n^2 \\
                            &= g^{m_1+m_2}(r_1r_2)^n \bmod n^2 \\
                            &= E(m_1+m_2, r_1r_2)
\end{aligned}
$$

### 4.2 环上的学习误差问题(RLWE)

BGV全同态加密方案的安全性基