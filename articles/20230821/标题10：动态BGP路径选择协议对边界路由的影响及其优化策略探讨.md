
作者：禅与计算机程序设计艺术                    

# 1.简介
  

在目前的互联网中，互联网边界路由器一直是一个重要且复杂的任务。边界路由器负责将互联网内部的所有流量从一个地方（比如中国）通过互联网传到另一个地方（比如欧洲、美国等）。而边界路由器的选择对网络性能有着至关重要的影响。

由于动态路由协议BGP存在着很多种选择，这些协议会根据路由表里的记录和邻居节点提供的信息，根据不同策略进行路径选择。其中最主要的一个策略就是可选路径的数量（即multi-path routing），它可以允许多个路径同时转发，从而提高网络的吞吐率。但是，multi-path routing往往也会带来额外的开销。因此，当边界路由器的资源有限时，如何选择最优的multi-path路由策略就成为当前的难题之一。

本文旨在系统性地阐述一下BGP多路径路由对边界路由的影响，并给出一些优化的策略方案。希望能够指导读者更好地理解和掌握BGP动态路由的机制以及优化的方法。

# 2.基本概念术语说明
2.1 BGP基础知识
Border Gateway Protocol (BGP) 是一种基于TCP/IP协议的路由选择协议，被用于Internet上许多自治系统（AS）。BGP运行于TCP/IP协议族内的传输层。BGP协议采用了分布式计算的方式，所有的BGP路由选择都是通过各个AS间的交换信息完成的。每个AS都有一个独立的BGP路由器，可以是专用硬件，也可以是软件。

BGP是由RFC 1997和RFC 2368定义的标准。目前BGP版本是4，第一版发布于1997年5月1日，次版本3发布于2000年10月，第四版发布于2017年3月20日。

BGP中的AS号称世界第五大互联网服务提供商。然而，实际上由于历史遗留问题，有些ISP仍在使用旧有的数字 AS 号码作为自己的AS编号，如AS13335或AS2914.为了方便起见，本文中所有AS号都统一用244号前缀表示。

2.2 BGP多路径路由
多路径路由是指一个目的地可有多个出口，每个出口又可再进一步分支到多个下一跳。BGP支持多路径路由，通过允许多条路径共存，来达到最佳路由选择的目的。

实际上，一个目的地通常会通过不同的路由来到达。一条路径可能经过多个路由器（multihop），最终才能到达目的地。如果一个目的地有多个路径可到达，那么BGP就会根据用户指定的策略选取一条路径。

比如说，某个站点有三个可用的路径，一条路径经过A、B、C三台路由器，另外两条路径分别经过D、E、F三台路由器。用户可能只想到达该站点的一种路径，或者考虑到多条路径所耗费的开销，均衡地分配到多条路径。

BGP实现多路径路由有两种方式：简单路径与多路径。简单路径是指只有一条路径能到达目的地，例如，用户在A、B、C三个路由器之间只能选一条路线。而多路径则是允许一个目的地有多个路径，这样用户就可以选择多个路径组合起来。

为了实现多路径路由，BGP支持多条路径同时运行，也就是multi-path routing。由于实际场景中，不少站点的流量一般不会同时到达同一台路由器，因此，multi-path routing可以将同一个目的地连接到不同的地方。这样既保证了低延迟，也避免了因单条路径拥塞引起的丢包问题。

2.3 边界路由器
边界路由器是指通过互联网路由流量的设备。边界路由器通常部署在AS边界的两个网络之间，用来连接不同的网络。比如，一台边界路由器连接到了中国的网络，并负责将中国的网络上的流量通过互联网发送到欧洲、美国、日本、韩国等地方。

边界路由器的功能有四个方面：策略路由、QoS（服务质量保证）、网络防火墙（network firewall）、边缘路由。

2.4 动态路由
动态路由是指BGP协议采用中心化控制的方式，而不是像静态路由一样，通过配置文件指定路由策略。BGP协议通过交换路由信息，自动地建立和维护路由表，不需要人工干预。BGP协议实时地接收外部世界的信息，并决定最适合的路由策略，并把它们传播到整个Internet上。

动态路由的优点有：简单性、灵活性、可靠性、实时性。但是，动态路由也有它的缺点：配置复杂、同步时间长、浪费资源、性能消耗大。所以，对于边界路由器来说，如何选择最优的动态路由方法就成了一个需要解决的问题。

# 3.BGP多路径路由的影响
## 3.1 动态BGP路径选择协议对边界路由的影响
首先要强调的是，虽然边界路由器为AS之间提供了一定程度上的互联互通，但边界路由器不能完全替代中间路由器的作用。因为边界路由器仅仅局限于本地网络，并且处于网络边缘位置，因此依靠边界路由器的路径选择有利于减少因ISP带宽限制而造成的延迟波动。

由于多路径路由的存在，AS间的通信时延随着路径的增加呈线性增长，因此，边界路由器倾向于选择具有最小延迟的路径，避免因路径数增加带来的延迟抖动。因此，动态BGP路径选择协议对边界路由的影响可归结为以下四点：

1. 路由选择性质变差：动态BGP路径选择协议依赖不同交换机间的路由信息，实现多路径路由。由于路径数变多，导致路由选择不够精确。因此，AS间互联互通受到明显的限制。

2. 延迟增大：由于多路径路由，相比于直接使用单条路径进行通信，路由选择过程需要花费更多的时间。并且，BGP动态路径选择协议的执行周期较长，因此会产生较大的延迟。

3. 资源消耗增加：动态BGP路径选择协议引入了更多的处理时间和计算资源。因此，其对AS间互联互通性能的影响不可忽视。

4. 可用性降低：由于BGP协议没有对边界路由器的可用性做任何保障，使得网络不稳定、不可靠。此外，网络的边际管理能力也变弱，无法满足业务连续性要求。

综上所述，动态BGP路径选择协议对边界路由的影响实属一大挑战。因此，如何设计和部署一个有效的优化策略是提升边界路由器的重要课题之一。

## 3.2 优化BGP路径选择策略方案
因此，针对BGP路径选择的优化有很多策略，下面简要介绍一下：

1. 禁用部分路径：这是最简单也是最容易实现的策略。比如，用户可以配置路由器只选择一条路径，这条路径距离最近，并且流量负载最轻，这样就可以获得比较好的路由质量。但是这种策略也有弊端，需要用户手动选择，不便于管理。

2. 使用软性过滤器：软性过滤器是一种将某些路径权值设为很小的值的方法。通过设置软性过滤器，可以将路径排除在选取路径之外。这样可以使得不同类型的路径之间得到平滑的分配。但是，软性过滤器的设置不宜过多，否则可能会导致路由质量下降。

3. 基于状态的过滤器：基于状态的过滤器是另一种将某些路径权值设为很小的值的方法。基于状态的过滤器根据各路由器的吞吐量、丢包率等状态信息，实时计算并排除掉不好的路径。但是，这种过滤器的设置难度很高，需要根据具体的网络状况进行调整。而且，基于状态的过滤器还依赖于网络实时状态信息，可能会导致流量波动造成性能问题。

4. 设置备份路由：BGP支持路径备份功能，即通过备份路由策略在发生异常时切换到其他可用的路径。但是，备份路由策略设置不当也会导致路由质量下降。另外，当出现路径不可用的情况时，备份路由也会发生切换，势必造成短期网络拥堵。

5. 基于流量的路由选择：基于流量的路由选择则是通过改变路径的选择顺序来优化BGP路径选择算法。这种方法主要包括按流量大小排序、平均路由选择和多路径负载均衡。但是，由于各路径的收敛速度有所不同，多路径负载均衡并非完美可靠。最后，基于流量的路由选择还会导致多个路径同时发挥作用，使得网络的整体利用率降低。

综上所述，无论是从技术角度还是策略制定角度，选择一个有效的BGP路径选择策略就变得尤为重要。如果缺乏正确的技术指导，或者忽略了边界路由器的实际需求，很可能会给网络带来意想不到的影响。