
作者：禅与计算机程序设计艺术                    

# 1.简介
  
         

Raft是一种分布式共识算法，它基于领导者-跟随者模式实现了高可用性和容错能力。在Raft中，集群中的节点分为两类：领导者（Leader）和跟随者（Follower）。每个节点都可以充当领导者或者跟随者。一开始，系统只选举出一个领导者节点。如果该领导者节点失效或与其他节点通信失败，则系统会选举一个新的领导者。整个集群始终保持稳定性，即使出现网络分区或其他故障。
Raft有以下特点：

1. 只允许存在一个领导者，其余节点作为Followers，向领导者提交日志条目并复制日志到其他节点。

2. 当一个节点接收客户端请求时，将日志条目追加到自己的日志中，并转发给其他的Follower。

3. 每个Follower都承诺不让下一任领导者（Candidate）获得超过半数的票数才能当选，这样可以限制单点故障。

4. 当领导者宕机后，需要有一个过渡阶段，确保集群正常运行，不会发生脑裂现象。过渡期间可以通过选举产生新的领导者。

5. Raft提供了多个可配置选项，用于调整集群行为，提升性能和可靠性。

# 2.基本概念术语说明 

## 2.1 术语定义  

1. Leader：在Raft算法中，每台机器只能有一个Leader，只有Leader可以接受客户端请求，并在其本地生成日志条目。Leader负责将日志同步到其他Follower上，保证集群的数据一致性。Raft采用主流的二阶段提交（two phase commit）方法来确保数据安全和可靠性。

2. Candidate：在Raft算法中，每个Follower都可能变成Candidate状态。Candidate周期性地向集群中的其他节点发送RequestVote RPC 请求，并投票表决自己是否应该被选为新的领导者。Follower收到大多数同意（>n/2 + 1），就变成了Leader；若收到的投票数量小于 n/2 + 1，则回到 Follower 状态。

3. Term：Raft 用Term 来表示一个时间段。在任意时刻，每一个服务器最多只处于一个 Term ，并且所有的服务器在同一个Term内保持相同的日志信息。Term 长度通常为一段时间（比如 150ms)，在这个时间段里，如果没有收到消息，则认为当前节点已经挂掉，然后触发选举过程。Term 在Raft协议里扮演着至关重要的角色。

4. Log Entry：Raft 通过将所有对数据的修改记录到日志（Log）里面，来实现数据复制的一致性。每个日志项（LogEntry）包括一个索引值和数据。索引值唯一标识了一个日志项。日志按照索引值的大小顺序存储，日志的最大长度由日志大小限制。

5. Commit Index：在Leader 准备提交一个日志条目的时候，他会把当前的CommitIndex 加1，然后通知Follower 提交相同的日志条目，Committed Index 则指向被批准的最新日志项的索引值。

6. Pipelining：为了减少网络延迟，Raft 使用 pipelining 技术，在一个 RPC 消息中可以携带多个连续的请求。Pipelining 可以大幅度降低响应时间，而且对于网络带宽要求也较低。

7. Safety Property：Raft 算法中包含几个关键的 Safety 属性，这些属性保证了集群在任何时候都能够保持强一致性。如 Leader Completeness、State Machine Safety 和 Log Matching Properties。其中 Leader Completeness 属性保证了领导者永远是最新的。State Machine Safety 属性保证了集群中任意两个结点的状态机的输出都是相同的。Log Matching Properties 属性保证了只要两个结点在日志中的匹配位置相同，他们的状态机输出也是相同的。

8. Quorum：Raft 协议中使用的术语。在 Raft 中，为了保证可靠性，每个 Term 的 Follower 需要得到大多数 Follower 的支持才可以成为 Leader 。我们通常假设集群中有 n 个节点，那么，集群中至少需要 n/2+1个节点（例如，3 节点集群至少需要 2 个节点赞成，则有 2 个节点支持）才能完成一次事务。称这组 n/2+1 个节点为“法定人数”。又因为 Follower 不参与任何的决策过程，因此在任何情况下，可以忽略它们的存在。因此，在 Raft 算法中，一般用 Q 表示法定人数。另外，Raft 中常常会说某个节点拥有超过半数的节点的支持。这种情况下，也假设法定人数为 n/2+1。