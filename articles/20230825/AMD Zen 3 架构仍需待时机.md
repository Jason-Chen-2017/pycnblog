
作者：禅与计算机程序设计艺术                    

# 1.简介
  

自从 AMD Zen 2 架构在 2021 年上半年推出后，许多用户和媒体都已经关注到了该架构带来的性能提升和效率上的优化。那么对于 AMD Zen 3 架构又将会给用户和媒体带来什么样的惊喜呢？

Zen 3 是 AMD 在第四代 Zen 架构的升级版本，其主要目标是在保持其独特的 CPU 性能优势同时，进一步提升芯片组整体性能。截止到目前，AMD 已发布了 Alpha 和 Beta 测试版，其中 Alpha 测试版支持 Zen 3 的开发，Beta 测试版则会在明年 7 月正式发布。因此，虽然 Zen 3 的具体架构还不完全确定，但就像所有的新事物一样，它也必将引起广泛的反响。

19 年 AMD 收购英伟达后，英伟达还曾宣布放弃 Zen 架构，而转投拥抱通用计算架构（GPGPU）的大势所趋。尽管 GPGPU 在图像处理、机器学习等领域的应用受到了业界的青睐，但是 GPGPU 的发展还处于初期阶段，性能力并不突出的情况下，AMD Zen 3 架构是否能够在性能上再次刷新，还是值得考虑。

本文重点讨论 Zen 3 的性能和功耗方面的最新成果。首先，从 CPU 时钟频率的角度分析 Zen 3 和之前的架构之间的差异，展示如何利用 AMD 第三代 Xeon Scalable (X-Series) 平台的超线程特性来实现更高的每线程性能；然后，分析 Zen 3 中流水线系统的一些改进，包括缓存架构的改进和 prefetcher 算法的变化；最后，结合真实案例，分享 Zen 3 在用户日常工作中的实际应用效果，以及对 AMD 的期望。

# 2.CPU 时钟频率的差异
CPU 的时钟频率是指 CPU 的主频，单位是赫兹（Hz）。早期的 CPU 时钟频率相对较低，但是随着技术的进步，越来越多的厂商推出了频率更高的主板，也就是说单个 CPU 的时钟频率也越来越高。

然而，过分追求高性能和过高的主频是行不通的。在硬件设计时，要满足高性能的要求，就必须牺牲掉一些功耗，否则可能会导致电源效率下降。为了提高电源效率，AMD 使用了“关电减震”（Power Sleep State, PSS）模式。这种模式通过关闭部分核心集中器的某些组件，使 CPU 更加省电，达到节省功耗的效果。

例如，当温度超过某个阈值时，CPU 会进入一个称之为“节电模式”的低功耗状态。这个模式下，CPU 可以省去 50% 的电流，但是速度也会因此变慢。但是当温度回到正常范围时，就可以自动切回到 “全功率运行” 模式。P-State（也称为频率状态，Frequency State）的切换是一个耗时的过程，所以频率不能太快地跳变。

尽管频率的增长可以带来功耗的降低，但是频率太高可能会造成噪声的增加。因此，AMD 提供了几种不同功耗级别的 CPU 配置：极致性能、平衡性能、节能型。其中，平衡性能又称为中等性能或经济性能。Zen 3 在功耗方面要比之前的架构做出一些改善，但同时还要权衡性能的提升和功耗的节约。


Intel、ARM、MIPS、PowerPC 等其他技术公司也都采用了类似的策略，即在相同性能下，降低 CPU 的主频，提高 CPU 的内在寿命，降低设备的平均成本。Intel 就曾经推出过多个产品系列，如 Skylake、Coffee Lake、Whiskey Lake 等，其中有一款产品——Ice Lake，将主频提升到了 4.5GHz，并且降低了电压至 1.2V，使其具有更高的持续性。

因此，Zen 3 中的频率设计也应类似 Intel 的方案。Zen 3 将频率设定在第四代的 GHz 上，而且允许各核频率独立，这样可以更有效地使用超线程机制，提升每个线程的性能。Zen 3 中的每个 CPU 核心的频率分别为 3.7, 4.0, 4.2, 4.5 GHz，前 2 个核心的频率相同，后两个核心的频率依次递增。除此之外，还可以在一些特定场景下降低频率，比如图形渲染相关的任务。


# 3.流水线性能的提升
早期的 Intel Pentium 4 处理器使用的是两级流水线结构，指令流按顺序流动，每个周期需要 1 个指令周期才能执行完毕。虽然流水线结构简单，但它的性能却不错。由于每个周期只需要 1 个指令周期，因此其每个时钟周期的性能可以由 Instruction Per Cycle (IPC) 表示。

Pentium 4 的 IPC 为 1.2，而 Pentium Gold 5 的 IPC 为 1.4，因此 Pentium Gold 5 比 Pentium 4 有着更好的性能。随着摩尔定律的失效，Pentium 的性能每几年就会下降一半。即使在 2005 年，Pentium 4 的性能也只有 300MHz，远低于 Intel 2010 年发布的 Pentium 4 的 400MHz。

Pentium 4 普及后，Pentium 4 E的价格在 2006 年的 4000美元左右，而 Pentium 4 EE 的价格则在 5000 美元左右。后来，AMD 在 2008 年发布了 Pentium M 系列，其性能与 Pentium 4 EE 相当，价格也非常便宜。虽然 AMD 在同样的主频下性能得到了提升，但还是比英特尔的 Pentium 4 差了一倍。

Pentium 4 的瓶颈主要在于它的主频。如果一直保持在 3.0 GHz，Pentium 4 就无法发挥优势。因此，AMD 在 Zen 3 中提出了超线程（SMT，Simultaneous Multi-Threading）技术，使 CPU 能够并行处理更多任务。

超线程，顾名思义，就是让一个物理核心执行多条线程（Thread）的能力。开启超线程之后，每个逻辑核心同时运行 2 条线程。如果把所有线程看作是一个 CPU，那么一个物理核心就可以执行 8 条线程。

虽然采用了 SMT 技术，但是 Pentium 4 性能的问题还没有得到解决。就算是采用了 SMT 技术，Pentium 4 也可以执行的线程数量仍然很少。因此，AMD 决定将多个逻辑核心连接到一起，构成一块“可编程计算集群（Radeon Compute Cluster, RCC）”，每个 RCC 可承载的最大线程数量为 256，也就是说，单个 RCC 最多可以处理 256 条线程。

当然，如果把 GPU 和 DRAM 资源都共享给计算集群，就可能出现超峰问题。因此，AMD 不仅引入了超线程，还设置了一个限制条件，即每个 RCC 只能分配一定数量的逻辑核心用于计算任务。这种限制条件称为线程组（Thread Group），每个线程组中的线程具有相同的输入输出数据依赖关系。因此，计算集群中的线程可以被分组，并且每个线程组只能在组内进行通信。


AMD 在 Zen 3 中，继续优化了 AMD Zen+ 的架构，提升了计算性能。与此同时，AMD 在架构设计和工程实现上，也进行了很多创新。在流水线性能的优化方面，AMD 从基于锁存器的数据通路转换到基于存储器的数据通路。基于存储器的数据通路，不需要进行处理的功能单元可以直接访问 DRAM 或 SSD 来完成工作。

另外，AMD 在运算器架构方面也进行了改进。在传统的 SIMD 数据流模型中，SIMD 处理器通常存在冗余的 ALU，它们负责对数据进行抽取、传输和计算。但这也会带来额外的延迟，因为这些冗余的运算都要花费时间等待。

因此，AMD 考虑到 ALU 资源的利用率非常重要，因此设计了一种新的 SIMD 处理器架构。在 AMD Zen 3 架构中，所有运算器都通过内存总线访问数据，也就是说，每个线程的所有运算都在内存中进行。这意味着每个线程只能读取自己需要的数据，而不是像 SIMD 处理器那样，所有线程共享同一份数据。这样，可以避免复杂的锁存器管理，提升性能。


# 4.Zen 3 中流水线系统的改进
AMD Zen 3 中，流水线系统的架构也发生了一些改变。Intel 的 Haswell 架构使用了分支预测技术，以提升性能。Zen 3 中也支持分支预测，不过 AMD 在实现时遇到了一些问题。

由于 CPU 设计时主要考虑的并不是延迟，因此在流水线中引入分支预测技术可能会影响性能。但是，AMD 对分支预测技术也进行了改进，使其更好地适应高性能环境。

具体来说，AMD 在 Zen 3 中，优化了分支预测技术。在先于分支指令送入下一条指令槽之前，先把分支指令的结果缓存起来，这可以提升分支指令的响应时间。AMD 通过这种方式，使分支指令的延迟降低到微秒级别，有利于提升应用程序的性能。

另外，AMD 在 Zen 3 中，还重新设计了数据缓存的架构。AMD 的数据缓存由 SQCI （Streaming Quadratic Interpolation Coefficients，即三次样条插值系数）组成。SQCI 是一种低复杂度的编码，可以有效地压缩高精度数据的波形。AMD 使用 SQCI 来对数据进行高速缓存，这比标准缓存（例如 L1/L2/L3 缓存）更具吞吐量。

# 5.性能测试数据
AMD 在 Zen 3 架构中，与之前的架构相比，性能是否有所提升？下面我们来看一下性能测试数据。

首先，我们比较 Zen 3 和之前的架构之间的性能表现。Intel 在 Ivy Bridge 和 Haswell 处理器上，通过跑分测试获得了以下性能数据：

- Ivy Bridge: 1.25 IPC (2x AVX2), 300MHz
- Haswell: 1.42 IPC, 350MHz

接着，我们比较 AMD EPYC 7742 服务器的性能，其搭载的 AMD 第三代 Xeon Scalable (X-Series) 平台有着超线程的性能优势。这一平台最高可以达到 64 个核心，每个核心有 4 个处理器，因此可以提供每线程的 8 个核心。这台服务器有着 128GB 的内存，使得整个集群的性能有很大的弹性。

- Zen 3: 1.16 IPC, 每线程 11.66 GFlops (3xAVX2)
- Zen 2: 1.07 IPC, 每线程 9.81 GFlops (3xAVX2)

显然，Zen 3 架构的性能有显著提升，尤其是每线程的性能有显著提升。而 AMD 在 Zen 3 架构上，性能的提升主要靠超线程技术。这使得 CPU 可以处理更多任务，从而获得更高的性能。

除了性能测试，AMD 还通过基准测试和压力测试，验证了 Zen 3 架构的性能。另外，AMD 还在海外的其他服务器上部署了 Zen 3 架构，验证了 Zen 3 架构的可扩展性。

# 6.GPU 性能的影响
Zen 3 架构的性能提升，主要来自于超线程和数据通路的优化。与此同时，AMD 还在工程实现层面上进行了一些优化。比如，AMD 还研发了一种新型的通信接口——Renoir 网络，替代旧有的 PCIe 3.0 接口。Renoir 网络提供更高的总带宽，更快的性能，以及更小的尺寸，并支持所有主流 PCIe 规范。

除了对 CPU 的性能提升之外，Zen 3 架构也会影响 GPU 性能。但是，GPU 性能的影响似乎并不像 CPU 那样明显。根据 Nvidia 的研究，Zen 3 架构可以带来大约 15% 的性能提升，但还要考虑到其他因素。Nvidia 还对 Zen 3 架构进行了详细的性能评估，发现其对 GPU 的影响不大。

# 7.Zen 3 在用户工作中的实际应用效果
作为一款超线程的 CPU，Zen 3 可以在用户工作中带来巨大的性能提升。目前，许多厂商都在通过云服务、虚拟化技术、容器技术等方式部署了 Zen 3 架构的服务器。他们通过配置更高的 CPU 核心数、更快的 CPU 时钟频率、更多的内存、更强的超线程、以及 Renoir 网络等方式，都可以获得更高的性能。

而 AMD 也在推广 Zen 3 架构。它通过各种渠道向消费者和企业推销其芯片。例如，它在 CES 2021 大会上推出了 Zen 3 TDP（最大发电量）桌面平台，可用于运行 Linux 等开源软件。企业也可以购买 AMD EPYC 服务器，其有着超线程性能优势，可供大规模部署。

# 8.Zen 3 的未来发展方向
当前，Zen 3 的架构并没有确定下来。在架构设计和工程实现上，还有很多细节需要考虑。因此，Zen 3 的实际性能还要继续观察和验证。

另一方面，由于 Zen 3 架构采用了数据通路和超线程的优化技术，因此在兼容性、功耗和可靠性方面也面临着一定的挑战。因此，AMD 需要在架构设计和工程实现的基础上，进一步完善和优化。

当然，对于 Zen 3 的未来发展，AMD 也并没有停止更新。未来 AMD 会推出更多的 CPU 产品系列，比如 Excavator、Raven II、Renoir、Trinity 等。它们的架构会在性能、功耗和可靠性等方面取得突破。另外，AMD 还会通过 DCPA（Data Center Power and Area）认证，为其生产的服务器提供更高质量的服务。