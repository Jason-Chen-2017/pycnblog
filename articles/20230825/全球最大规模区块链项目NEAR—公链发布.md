
作者：禅与计算机程序设计艺术                    

# 1.简介
  

NEAR是由非营利性组织NEAR Foundation推出的一款开源的公链产品，支持跨链智能合约(Inter-Blockchain Communication)，是一个完全去中心化、可信任、不可篡改的新型分布式网络平台。近日，NEAR团队宣布完成NEP-171，即类似ERC-20代币的跨链标准协议，并将于本月底正式上线测试网。在此之前，NEAR已经推出过多个区块链项目，包括DEV、Crust、Flow、Solana等等。目前，NEAR已成为全球最大的区块链项目之一。

本文旨在以深入浅出的语言为读者呈现NEAR项目的架构设计及其实现细节。希望通过对项目技术设计及流程进行详细解析，帮助读者更好地理解其独特的价值观、理念以及发展方向。

# 2.基本概念术语说明

首先，需要明确一些基础的技术术语和相关概念，才能更好的理解NEAR项目。

1）EVM（Ethereum Virtual Machine）

EVM是基于区块链技术的智能合约虚拟机，是运行智能合约最核心的组件。它提供了执行字节码所需的所有指令集、栈、堆、状态变量、计数器和其他计算资源。

2）账户模型

账户模型是EVM运行环境中的关键组件。它存储了每个用户的地址、余额、nonce值、代码、存储区、调用堆栈等信息。账户模型还负责管理用户权限，通过消息调用模型向另一个账户发送交易请求。

3）账户地址

账户地址就是指代某个用户或智能合约的唯一标识符。它由两部分组成：源地址和密钥。源地址是由密钥派生而来的，而密钥则是用户控制的密钥，用来创建/签名交易，并签署转账交易或执行智能合CEPT合同。

4）交易

交易是指从一个账户向另一个账户或者合约发送的消息数据包。交易由三种类型之一组成：数字资产转账，智能合约调用或合约创建。数字资产转账通常用于支付代币或加密货币的转移；智能合约调用用于与其他合约进行交互；合约创建用于创建一个新的智能合约。

5）区块

区块是由交易构成的一个大集合，形成了一个链条。每个区块都具有区块头和区块体。区块头记录了区块哈希值、高度、时间戳、前一区块哈希值和其他元数据。区块体包含所有有效的交易和状态更新。

6）状态

状态是在某一特定区块高度上存储的数据，该数据的变化与产生该区块的交易相关联。状态通常用于存放智能合约的当前值和数据，也可能包括用户的余额、委托、认证信息等。状态可以被持久化到本地磁盘中，也可以被存储到数据库中。

7）Gas

Gas是每笔交易所消耗的资源量，是一个衡量交易费用的主要参数。Gas充当计量单位，而转账或合约调用的资源消耗量取决于消耗多少gas。Gas消耗越多，费用就越高。

8）燃料

燃料（Fuels）是系统在执行区块链交易时使用的加密资产，目前NEAR平台的燃料代币是以NEAR作为单位的FTM（Fantom Token）。燃料代币代币主要用于激励节点矿工竞争、防止双花攻击等。

9）智能合约

智能合约（Contract）是一种基于计算机的代码，它定义了执行各种任务的规则。NEAR平台上所有的合约都是公开透明的，并能够跨越不同区块链平台。这些合约通常用于存储和处理数字资产、管理交易以及根据特定条件触发事件。

# 3.核心算法原理和具体操作步骤以及数学公式讲解

接下来，通过实际代码实例和解释说明，为读者展示NEAR项目中涉及到的具体算法原理和具体操作步骤，以及相应的数学公式的展开。

1) ECDSA（椭圆曲线数字签名算法）

ECDSA是利用椭圆曲线加密算法，生成签名和验证签名的公钥私钥密码算法。椭圆曲线加密算法能够提供安全的公钥加密机制，防止中间人攻击、侧信道攻击和重放攻击等。

2) Merkle树

Merkle树是一种树形数据结构，它是一种加密散列函数，它使得任何情况下的任何文件都可以快速验证，并且无需下载整个文件即可验证完整性。

3) NEAR区块链连接方式

NEAR区块链连接方式采用两种方法：共识网络连接和拓扑网络连接。共识网络连接依赖于公共的主网，而拓扑网络连接则允许网络中的节点直接相互连接。

共识网络连接：这种连接模式适用于短期内通信频繁且受限的场景，例如IoT、移动应用或安全实验室等。这种连接模式要求用户设备有良好的带宽、稳定的网络连接以及可以正常同步的时间。

拓扑网络连接：这种连接模式适用于长期存在、互相连接的情景，例如浏览器、APP间通讯或复杂的网络拓扑结构。这种连接模式要求用户设备可以自由地连接不同的节点，并且能够快速发现它们之间的关系。

4) GhostDAG

GhostDAG是一种基于图的扩展DAG（directed acyclic graph）结构，它采用连贯的随机序列来确定父子关系。相比传统DAG，GhostDAG有以下优点：

减少矿工赌博行为：由于使用连贯的随机序列来选择父子节点，GhostDAG降低了矿工赌博行为。矿工无法作弊，因为只有被选中的交易才会进入区块，这样就避免了单个矿工贪婪地追踪其他人的交易。
高效的归属权证明：GhostDAG的结构简单，因此可以构建非常大的DAG。这意味着可以在不影响网络性能的前提下生成大型的DAG。同时，通过区块链上的工作证明（PoW），证明者可以通过计算来证明他们是否拥有某个块。这可以有效地保护DAG。

5) 状态路由协议

状态路由协议旨在通过一个单独的哈希表查找服务，让智能合约能够访问任意智能合约存储中的数据。状态路由协议也称为“治理链”。

6) 服务节点

服务节点（Validator Node）是一种特殊类型的客户端节点，它运行服务质押的主网节点。节点负责广播自己的交易，验证网络的区块并打包生成区块。除此之外，服务节点还可以为其他节点提供计算力、存储空间和带宽等资源。

7) Inter-Blockchain Communication (IBC)

IBC 是NEAR平台跨链通信的标准协议，目前处于早期阶段。IBC 允许用户跨越不同区块链平台，在两个不同的区块链上执行原生合约。

8) 智能合约反序列化和执行引擎

NEAR平台的智能合约执行引擎能够解析字节码并按照EVM规范执行。智能合约反序列化器能够解析编译后的智能合约字节码，并将其转换为相关的内部数据结构。

9) NEP-171代币跨链标准

NEP-171代币跨链标准，即Cross-Chain Token Standard (CCS)，旨在定义跨链Token 相关接口，包括管理跨链Token的过程和方法。NEP-171定义了一套标准接口，用于实现跨链Token的标准化交换协议。CCS的目标是在多个区块链之间交换token的简单、透明、标准化的方法。