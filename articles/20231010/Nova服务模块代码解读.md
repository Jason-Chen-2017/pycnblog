
作者：禅与计算机程序设计艺术                    

# 1.背景介绍


Nova 是OpenStack云计算平台中的一项基础服务模块，负责虚拟机管理、资源调配等功能，其源代码采用Python语言编写，主要完成虚拟机生命周期管理（包括创建、启动、关闭、删除）、资源调度分配（包括选择合适的主机运行虚拟机、配置网络、磁盘等资源）、健康状态检测、事件通知和报警、租户隔离及权限控制等功能。在实际生产环境中，Nova服务模块已经逐渐演变成最复杂的服务模块之一，因此对它的代码进行全面的深入分析至关重要。本文将从宏观角度、微观角度，以一种系统的方式剖析Nova服务模块的代码结构和功能实现。
# 2.核心概念与联系
## 2.1 服务模块简介
Nova 服务模块是OpenStack云计算平台中的一项基础服务模块，负责虚拟机（VM）的生命周期管理和资源调配。Nova通过提供RESTful API接口，可供外部应用调用，实现VM的生命周期管理和资源调配功能。它包括了如下四个子模块：
- API: 提供RESTful API接口，外部应用可以通过该API接口管理虚拟机。
- Scheduler: 负责虚拟机资源调配，根据集群资源情况、用户请求、可用性策略等条件选择合适的主机来运行虚拟机。
- Compute: 管理虚拟机，包括启动、停止、重启、监控等功能。
- Conductor: 协同管理模块，用于处理来自其他服务模块的请求。
## 2.2 服务模块角色
### 2.2.1 API
API是Nova服务模块的前端，主要向外部应用提供虚拟机的生命周期管理和资源调配功能。API提供的接口包括：
- 创建虚拟机：创建并启动一个新的虚拟机；
- 停止虚拟机：暂停正在运行的虚拟机；
- 启动虚拟机：恢复被暂停的虚拟机；
- 删除虚拟机：彻底删除一个虚拟机；
- 查询虚拟机列表：获取所有或特定类型的虚拟机信息；
- 修改虚拟机配置：修改已创建的虚拟机的配置参数；
- 查看虚拟机详情：获取虚拟机的详细信息；
### 2.2.2 Scheduler
Scheduler是Nova服务模块的后端，负责虚拟机资源调配，根据集群资源情况、用户请求、可用性策略等条件选择合适的主机来运行虚拟机。当用户提交新建虚拟机请求时，Scheduler根据当前集群的资源状况、可用性策略、用户指定的数据存储、网络等资源需求进行调度，选择满足条件的主机来运行该虚拟机。
### 2.2.3 Compute
Compute是Nova服务模块的主体，负责虚拟机的生命周期管理，包括启动、停止、重启等功能。当用户提交新建虚拟机请求时，Nova将调用Libvirt驱动来启动虚拟机，Libvirt驱动则通过远程过程调用接口管理虚拟机。
### 2.2.4 Conductor
Conductor是Nova服务模块的辅助模块，它主要用于处理来自其他服务模块的请求。如：当Nova中的虚拟机发生变化时，Conductor会告知Nova API和Scheduler，并且触发相关的事件处理机制。
## 2.3 模块代码结构
Nova服务模块的总体代码结构如下图所示：

其中，core目录下存放着Nova服务的主要组件。其中的compute目录下存放了实际的计算节点代码，metadata目录下存放了Metadata服务相关的代码，network目录下存放了网络服务相关的代码，image目录下存放了镜像服务相关的代码，scheduler目录下存放了调度器代码，conductor目录下存放了消息控制器代码，console目录下存放了vnc console相关的代码。

其它目录下的代码作用如下：

- bin目录下存放着Nova服务的启动脚本文件。

- etc目录下存放着Nova服务的配置文件。

- tests目录下存放着Nova单元测试用例的代码。

- tools目录下存放着Nova的工具类库和第三方库。

- api目录下存放着Nova API接口的代码，包括WSGI server和XML-RPC服务等。

- doc目录下存放着Nova的文档文件。

- locale目录下存放着Nova的国际化资源文件。

- distro目录下存放着Nova包装后的安装包，比如rpm安装包和deb安装包等。

- contrib目录下存放着第三方开源模块或者代码。

-.gitmodules文件存放着Nova所依赖的第三方库。

# 3. Nova服务模块核心算法原理
## 3.1 虚拟机生命周期管理
Nova提供了多种方式管理虚拟机，包括命令行接口、HTTP RESTful API接口、EC2兼容API接口等。这三种接口都基于相同的抽象框架，即声明式API。声明式API通过JSON、XML、YAML等数据格式定义对象，描述所需做什么事情，而非命令序列。

当外部应用调用Nova API创建虚拟机时，Nova先创建一个VM对象，然后调度器会根据一系列的算法确定这个VM应该落在哪些物理机上运行。接着，Nova将VM对象转换为一个或多个Hypervisor驱动程序可以理解的VM定义，再由这些驱动程序安装到相应的物理主机上。

当用户终止一个虚拟机时，Nova将发送一个信号给对应的VM，让它优雅地关闭自身的各种资源，并结束生命周期。

## 3.2 资源调度算法
Nova采用调度器模块来管理虚拟机资源调配，其中包括两种调度器：过滤器和权重调度器。

过滤器调度器首先检查一组规则，把那些不符合要求的虚拟机排除在外。接着，它根据某些衡量标准（例如CPU利用率、内存占用率、I/O吞吐量、网络带宽等）为排除的虚拟机排序。最后，它将排名靠前的虚拟机部署到各个物理机上，并确保物理机的资源利用率达到最大程度。

权重调度器允许管理员设置每个物理机上的虚拟机数量上限，并根据虚拟机当前的性能指标进行分配。如，如果物理机A当前虚拟机数量为10，而新提交了一个需要占用资源的虚拟机，那么它会优先部署到物理机B上去，只要物理机B的虚拟机数量没有超过限制。这种方法保证了整体资源的利用率。

# 4. 代码实践与解读
## 4.1 虚拟机生命周期管理
这里以HTTP RESTful API接口为例，详细介绍一下Nova的虚拟机生命周期管理代码流程。

1. 用户向Nova API发送新建虚拟机请求，Nova接收到请求之后，会首先创建一个VM对象，然后创建VM快照，并保存VM对象的元数据信息。

2. Nova会通知Compute服务去启动VM。

3. 当Compute服务接收到启动请求之后，它会查找存储VM快照所在的存储设备，并加载出VM定义。

4. Libvirt驱动程序负责启动VM，创建VM进程，并连接到QEMU虚拟机管理程序，将VM启动起来。

5. VM的状态由libvirt驱动程序来维护，当VM状态变为Running之后，Nova会更新数据库中的VM状态。

6. 在用户终止一个虚拟机时，Nova会通知Libvirt驱动程序去关闭VM。

7. Libvirt驱动程序会优雅地关闭VM的所有进程，并释放所有的资源。

8. 当所有的VM都关闭之后，Nova会更新数据库中VM的状态，标记为结束。

以上就是Nova的虚拟机生命周期管理流程。