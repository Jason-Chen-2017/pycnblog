
作者：禅与计算机程序设计艺术                    

# 1.简介
  

在MySQL中，并发访问数据的操作可能会导致数据不一致的问题。如果不同事务或者线程同时对同一行数据进行修改或读取，就会造成数据的不一致性。为了保证数据的一致性，引入了数据库锁机制。下面通过详细的描述，介绍MySQL中的锁机制。
# 2.锁机制
## 2.1 锁类型
InnoDB支持两种类型的锁：
- Record lock: 对索引记录加锁，防止其他事务更新、删除该记录；
- Gap lock: 对范围内没有记录的间隙加锁，防止其他事务插入到该范围内；

除此之外，MySQL还支持以下几种类型的锁：
- Table locks：对整个表加X锁，使其他用户无法执行任何DDL语句，直到本事务结束；
- Metadata Locks：对元数据（例如表结构）进行的读写锁定；
- Page locks：对页的读写锁定；
- Insert Intention Locks：用于处理INSERT...SELECT INTO操作时的死锁问题；
- Data Dictionary Locks：数据字典读锁。

## 2.2 MyISAM与InnoDB的区别
| 特性 | MyISAM  | InnoDB |
| :--------: |:--------:| :------:|
| 存储引擎   | 支持压缩表空间、索引缓存等特性，适合于OLTP业务 | 提供事务安全和崩溃恢复能力，支持外键约束等特性，适合于OLAP业务  |
| 事务支持   | 不支持事务         | 支持事务           |
| 行锁管理   | 每个查询均为表级锁     | 行锁管理更细化，允许对单条记录加锁      |
| 锁等待    | 会出现锁等待       | 不存在锁等待，系统自动解锁，保证事务的正确性        |
| 外键约束   | 支持             | 支持               |
| 崩溃恢复能力| 不支持，每次启动需要完整扫描表   | 支持，支持在线热备份           |
| 查询性能   | 很快             | 较慢                 |

## 2.3 共享锁(S锁)和排他锁(X锁)
InnoDB所有的行都是通过索引检索到的，因此锁定某个范围内的记录时，只会锁住符合条件的索引节点，而不会锁住记录对应的整行数据。所以InnoDB的锁策略也被称为next-key locking（键锁）。

对于UPDATE、DELETE和INSERT等写入操作，InnoDB都默认给涉及的数据集加上排他锁（exclusive locks），也就是写锁，直到事务提交前，其他事务都不能对这些数据集进行任何操作。

对于SELECT操作，InnoDB支持两种加锁方式：
- shared row read locks（S锁）：事务只能读某行数据，但不能改动该行数据；
- exclusive row write locks（X锁）：事务可以读写某行数据，其他事务不能再对该行加任何锁。

所谓的“读锁”就是指可以允许其他事务继续持有该锁的权限，但是不允许对该锁进行修改，所谓的“写锁”则是说事务持有该锁后，无论对其他数据集做什么操作，都不允许再对当前数据集做任何修改，直到事务提交。

## 2.4 意向锁
InnoDB还支持一种意向锁（Intention Locks）。所谓的意向锁，其实就是一个自旋锁。在InnoDB中，当一个事务想要获取一条记录的排他锁时，如果此时正有一个其它事务已经占有了该记录的排他锁或间隙锁，那么该事务将进入等待状态，直到获得资源为止。这个过程叫做“锁等待”，意向锁就是用来解决这个问题。

意向锁分为两种：
- 意向共享锁（IS锁）：事务打算给记录加共享锁，但可能被其它事务回滚并加排他锁，那么它自己就先放弃共享锁，去获取排他锁；
- 意向排他锁（IX锁）：事务打算给记录加排他锁，但可能被其它事务回滚并加共享锁或排他锁，那么它自己就先放弃排他锁，去获取共享锁。

除了索引上的锁以外，InnoDB还有一些内部使用的锁，其中最重要的是undo log（回滚日志）锁。在事务回滚时，InnoDB存储引擎需要记录之前的数据值，为了确保事务的原子性，InnoDB使用了undo log来实现事务的回滚。

对于undo log，InnoDB在回滚时，仅仅需要把数据页从磁盘读出来，然后按照undo log里的内容修改数据页即可。但是，由于多线程的原因，多个事务的rollback操作可能会同时发生，因此，InnoDB使用了互斥锁（mutex locks）来串行化rollback操作，以免造成冲突。在进行undo操作的时候，事务将持有该undo log的S和X锁，并且互斥锁。

## 2.5 小结
InnoDB锁机制包括表级锁、行级锁、意向锁、Undo Log锁。InnoDB的锁策略又叫next-key locking（键锁），使得其效率非常高。