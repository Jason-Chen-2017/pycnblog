
作者：禅与计算机程序设计艺术                    

# 1.简介
  

超算（Supercomputer）的出现是由科研和工程界高度关注的热点。随着超级计算机的不断普及，越来越多的学者、企业和学校都开始投入超算领域的研究。但是，超算系统又面临着各类不同硬件异构问题，例如不同的架构、接口、处理器等。而实际上，目前国内外很多高性能计算中心也存在异构系统的混合部署。因此，如何在异构系统中有效地利用资源和提升效率成为一个难题。
Cray公司推出的Cray XC30系列超级计算机，集成了新的并行体系结构C2B（compute-to-memory bridge），同时兼顾着其独特的编程模型CoArray Fortran，提供了极佳的运算能力和可扩展性。本文将从Cray XC30架构出发，全面剖析其架构、特征、优势、局限性，并对其未来的发展方向进行展望。
# 2.关键术语
## 2.1.Emerging Cloud Computing
云计算的概念始于2006年，它通过将大数据和计算资源分散到云端，让用户只需要关注自身业务需求，就可以快速获得所需的服务。随着互联网的发展，云计算已渗透到了生活的方方面面。近几年，云计算市场规模日益扩张，预计2020年将超过10万亿美元。
云计算的主要特点包括：
- 按需付费：用户只需按照用量付费即可，不需要长期为硬件购买或维护。
- 普通化服务：提供标准化的硬件配置和软件服务，降低了IT支持成本。
- 弹性伸缩：根据业务需求自动增加或减少硬件数量，满足用户的计算需求。
## 2.2.HPC(High Performance Computing)
高性能计算（HPC）是指利用计算机的能力进行高度复杂的计算任务，如海量数据分析、流体力学模拟、材料建模、生物学模拟等。目前，主要研究和开发的重点放在利用多核CPU并行计算的任务优化和加速上。HPC已经成为当今IT领域的一个重要发展方向。
HPC系统通常包含节点、主存、磁盘、网络等硬件设备，采用并行编程模型，通过集群的方式连接起来的设备集合。HPC系统的目标是在各种资源约束条件下，提高计算资源的利用率，从而实现高效率的计算结果。目前，高性能计算领域的一些先进技术也为HPC提供新的思路和方法。
## 2.3.MPI(Message Passing Interface)
MPI是一种并行编程模型，是一个开放源代码的消息传递接口标准，被广泛应用于HPC领域，用于编写分布式内存多进程应用。它定义了一组函数调用，允许不同的进程之间共享内存空间，并且可以通过远程过程调用方式通信。当前，MPI已成为HPC领域最主流的编程模型。
## 2.4.OpenMP(Open Multi-Processing)
OpenMP是一种并行编程模型，是一个开源的API标准，用于共享内存多线程编程。它定义了一组指令，用来描述数据并行的并行策略，包括for循环、任务、线程、工作区、同步等。当前，OpenMP已成为HPC领域最热门的并行编程模型。
## 2.5.CUDA(Compute Unified Device Architecture)
CUDA是NVIDIA公司推出的基于GPU的并行编程模型，具有良好的编程接口和性能。它允许程序员直接控制多块GPU之间的内存访问和并行性。当前，国内外许多高性能计算中心都采用了CUDA作为HPC的并行编程模型。
## 2.6.GPU(Graphics Processing Unit)
GPU是一种通过图形处理单元芯片进行高速处理的集成电路，它的主要特点是基于流处理器的矢量计算能力。GPU的并行处理能力使得它可以解决复杂的并行计算问题。当前，许多高性能计算中心都拥有自己的GPU集群，用于并行计算。
## 2.7.Xeon Phi(KNCube/KNL/KNM/K80/V100)
Xeon Phi是英特尔公司推出的一种新的多核处理器，具有高达3.0GHz的单核频率。相比于普通的CPU，Xeon Phi具有更强大的并行计算能力，能够同时执行多个核上的任务。Xeon Phi的多线程编程模型支持广泛的编程工具，如OpenCL、CUDA等。当前，美国的几个高性能计算中心也在采用Xeon Phi作为HPC的计算平台。
## 2.8.GPGPU(General Purpose Graphics Processing Unit)
通用图形处理单元（GPGPU）是一种并行编程模型，其图形处理功能可以用于数值模拟、物理模拟、渲染、动画、虚拟现实等领域。目前，国内外多家大型游戏公司、新闻媒体网站和传感器应用领域均涌现了GPGPU的创业企业。
# 3.Cray XC30架构概述
Cray XC30是一个基于Xeon Phi处理器的超级计算机，由英特尔和Cray共同研制，具有独特的并行计算特性。其架构具备以下特征：
- 统一的指令集架构ISA：采用统一的Cooper Lake架构，同时兼容AMD架构。
- 功能齐全的核心：具有三种核心，其中两个核心由英特尔Xeon Phi处理器负责，另一个核心则由Cray的神经网络处理器负责。
- 超高速缓存：每一颗英特尔Xeon Phi处理器的L1数据缓存容量为2MB，L2缓存容量为4MB。
- 混合计算：在计算任务时，系统会动态调整不同的计算模块的利用率，从而提高整体性能。
- 基于网络的数据传输：整个系统支持基于网络的数据交换。
- CoArray Fortran：Cray提供的编程语言CoArray Fortran是一种多维数组编程模型，它能够利用多块Xeon Phi计算核心并行计算。
- MPI支持：Cray提供的MPI软件包提供了高水平的并行计算支持，它能够通过网络传输数据，并通过线程级并行提高效率。
- 可靠性：Cray XC30系统具备高度可靠性，在网络、硬件设备和软件系统等方面均做了充足的准备。
下面我们详细介绍一下Cray XC30的架构和组件。
## 3.1.C2B组件（Compute-to-Memory Bridge）
C2B组件是Cray XC30架构的关键组件。它把英特尔Xeon Phi处理器的多核与Cray的神经网络处理器集成在一起，从而实现混合计算。
C2B组件的主要作用如下：
- 提供硬件共享：C2B组件能够将Xeon Phi的多核资源和神经网络处理器资源共享给应用程序。
- 提供内存共享：C2B组件能够将Xeon Phi的L1和L2缓存以及远程内存访问器（RMA）映射到神经网络处理器的显存，从而实现内存共享。
- 提供应用间内存同步：C2B组件能够确保不同应用间的内存一致性。
- 提供数据迁移：C2B组件能够在应用程序之间和内存之间进行数据迁移。
- 提供功能突破：C2B组件能够提供性能有限但功能丰富的神经网络处理器资源。
## 3.2.硬件选择
Cray XC30采用的硬件是Cooper Lake架构的服务器，其架构如下图所示。
XC30的服务器板卡是个小巧的PCIe条带卡，主要配备了四块英特尔Xeon Phi处理器，每块具有28核，分别处理图像处理、计算密集型任务、内存访问任务和网络任务。
## 3.3.软件栈
Cray XC30运行Linux操作系统，其软件栈包括Intel编译器、Intel Math Kernel Library、MPI、FFTW、BLAS、ScaLAPACK、HDF5、Python等。
- Intel编译器：英特尔发布了最新的编译器套件，命名为ICC/ICPC。它是Intel的高性能向量化、多核处理器、离线编译工具链。
- Intel Math Kernel Library：英特尔发布的Math Kernel Library，简称MKL，是专门针对高性能矩阵计算的库。
- MPI：Cray提供的MPI软件包支持多进程间通信，它能够利用多块Xeon Phi计算核心并行计算。
- FFTW：Cray提供的FFT（快速傅里叶变换）软件包支持高性能的快速傅里叶变换。
- BLAS：Basic Linear Algebra Subroutines，由ATLAS团队设计，是一个广泛使用的线性代数运算库。
- ScaLAPACK：Cray提供的并行版BLAS的软件包。
- HDF5：Cray提供的高级文件格式。
- Python：Cray提供的脚本语言。
## 3.4.资源管理机制
Cray XC30的资源管理机制依赖于两种调度算法：优先级算法和竞争模式算法。优先级算法是基于用户提交的任务优先级分配资源，而竞争模式算法则是根据系统资源的利用率分配资源。下面我们介绍一下优先级算法和竞争模式算法。
### （1）优先级算法
优先级算法是一种简单的算法，通过优先级队列来实现资源管理。系统根据任务的优先级和要求的资源情况，首先将任务提交给优先级高的作业，然后再依次处理优先级低的作业。优先级算法的优点是简单易懂，缺点是容易发生资源抢占，影响系统的稳定性。
### （2）竞争模式算法
竞争模式算法是一种复杂的算法，通过某些规则来实现资源分配。系统根据系统资源的可用性、负载等因素，将资源分配给不同的作业，从而最大程度地提高系统资源的利用率。
系统资源包括计算资源、存储资源、网络资源等。对于计算资源，系统根据任务的计算量、数据量、计算核数等信息，分配计算资源给不同的作业。对于存储资源，系统会划分出一部分存储空间给重要的作业，从而防止其他作业的资源浪费。对于网络资源，系统还会考虑到任务之间的依赖关系，分配必要的网络带宽资源。
竞争模式算法的优点是精细化的资源分配，避免了资源抢占，保证系统的稳定性；缺点是算法复杂，难以应对多变的资源要求。
## 3.5.网络架构
Cray XC30的网络架构主要分为两层，第一层连接前端与后台，第二层连接不同站点。前端层采用InfiniBand技术，其高带宽和低延迟特性，支持大量并行计算。后端层采用高速的双口光纤连接北向和南向的数据中心，在全球范围内提供低延迟的访问。
网络的另一重要特性是集成网络控制器，它通过协调和管理前端和后端的所有网络资源。在Cray XC30的系统中，网络控制器可以协调所有网络的性能和资源使用。
## 3.6.存储架构
Cray XC30的存储架构由两台控制器和七台节点组成，节点采用RAID阵列配置。每个节点有六个高度可用的SSD盘，其总容量为1.5PB。
Cray XC30的存储架构支持多种类型的存储设备，包括磁盘、SSD、闪存、网络存储、光纤存储等。其优势在于高度可靠的存储服务质量、高效的I/O吞吐量和低廉的成本。
## 3.7.超算的未来发展方向
超算目前已经成为IT产业的重要领域。在2019年全球超算订单量达到1250亿美元，占全球半导体订单量的三分之一，预计2020年全球超算订单量将超过3000亿美元。为了更好地服务于客户，Cray XC30将持续迭代。
- 采用其他架构：英特尔推出了更新的Gemini架构，并计划在2020年上市。基于这个架构，英特尔预计在2021年推出另一款超级计算机产品——Cooper Lake-P。在未来的两到三个年头，Cray XC30可能采用这一架构。
- 提升性能：英特尔计划在2021年推出Xeon Phi的升级版本，功耗提升至28.8W，综合性能提升了7倍。在未来的两到三个年头，Cray XC30的性能可能会得到提升。
- 支持更多应用：英特尔计划在2021年推出更多的超级计算机产品，如麒麟、雅凯华、露斯那、沃森、塔梵、康山等。在未来的五到十年内，Cray XC30可能支持这些产品。
- 投资硬件：除了继续发展硬件架构，英特尔还计划投资更多硬件，包括更快的主板、更高性能的处理器、更强大的内存等。在未来的五到十年内，Cray XC30可能会投资更多硬件。