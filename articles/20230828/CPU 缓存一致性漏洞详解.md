
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 概述
CPU（Central Processing Unit）是计算机体系结构中一个核心部件，它负责指令的执行、数据处理及控制运算器之间的数据传送等。它的性能直接影响着计算机的速度、能耗和功率成本。当多线程并发访问同一块内存时，由于各线程共享相同的缓存，使得各个线程读写同一块内存时出现缓存不一致的问题，即存在数据的不同步，进而导致程序运行结果异常。缓存一致性协议(Cache Coherence Protocol)就是用来解决这种同步问题的一种机制。

## 定义
缓存一致性协议是一个系统中的所有CPU都可以共同遵守的一组规则或协议，用于确保对系统中所有存储器的操作都是可见的，同时又不会引起任何不良后果。在缓存一致性协议中，主存（Main Memory）和缓存（Cache）共享同一地址空间，所以两者的内容必须保持一致。缓存一致性协议定义了以下两个方面的功能：

1. 保证数据的可见性：指保证所有CPU缓存中的数据都是最新且正确的。
2. 数据失效和更新：缓存在接受到写请求时，如果发现对应的块没有在缓存中，则必须从主存中读取该块，然后写入到缓存；反之，如果发现对应的数据块已经在缓存中但还是旧的，那么就需要刷新该块到缓存，以保证其他CPU的缓存也与其一致。 

根据缓存一致性协议，CPU通常分为两种状态：
- I（INVALID）状态：指当前缓存中不存在某个块或块的内容无效。在发生以下情况时，缓存进入I状态：
  - 当CPU接收到写请求并且无法命中缓存中的相应块时。
  - 当CPU接收到Invalidate Cache消息，要求将缓存中的某些块置为无效。
  - 当CPU从远程内存中加载数据块时。
- S（Shared）状态：指当前缓存中有一个块，而且该块的内容有效，但是可能不是最新的。在发生以下情况时，缓存进入S状态：
  - 当CPU接收到读请求并且命中缓存中的相应块，但是该块被标记为无效。
  - 当CPU接收到Flush Cache消息，要求将缓存中的某些块刷出到主存。

为了使缓存保持一致性，一些标准化工作做如下约定：

1. 在多个CPU之间，缓存一致性协议要求它们之间要实现完全的网络仲裁。因此，只有当多个CPU同时发送请求时才会进行缓存通信。
2. 对某个特定块的所有操作必须顺序地进行。例如，在写请求完成之前，不能从该块的旧值到新值。否则，可能会导致数据不同步。
3. 如果某个块处于S状态，则其他CPU必须知道该块已经失效，之后才能从主存重新加载。

## 分类
目前，主要的CPU缓存一致性协议包括MSI（Message Store Interlocking）、MESI（Modified Exclusive Shared Synchronization）、MOESI（Multicore Out-of-Order Execution Superset of the MESI Architecture）。下面分别介绍这三个协议的特点和优缺点。

### MSI (Message Store Interlocking)
MSI协议是Intel公司推出的第一代缓存一致性协议。MSI协议支持多核SMP服务器上的多线程，提供了缓存行填充协议，防止缓存击穿等问题。MSI协议具有简单易用、低延迟、高性能等特点。MSI协议由两部分组成：消息总线和缓存管理逻辑。其中，消息总线负责通知各个CPU发生变化。

MSI协议的基本思路是，所有CPU通过消息总线通知其他CPU修改缓存，其他CPU必须响应该通知。每个缓存块维护两个版本号：缓存的版本号和内存的版本号。当CPU发生写操作时，首先将写操作记录在缓存块中，并递增缓存的版本号；同时向其他CPU广播该块发生了写操作，要求他们将缓存的版本号更新到最新。当CPU发生读操作时，首先检查缓存块的缓存版本号是否比内存的版本号新，如果是的话，再从内存中读取该块的值，并更新缓存的版本号。

MSI协议最大的缺陷是消息总线的带宽开销较大，并且请求的响应时间随着消息数量的增加而变长。此外，MSI协议限制了多线程之间的并发性。MSI协议适用于多核服务器上多线程应用程序。

### MESI (Modified Exclusive Shared Synchronization)
MOESI是Intel公司推出的第二代缓存一致性协议。MOESI协议支持多核SMP服务器上的多线程，提供了缓存行填充协议，避免了MSI协议中的缓存击穿问题。MOESI协议具有更好的性能，高容错性和更强的可伸缩性。MOESI协议由三种消息类型构成：Modified（M）、Exclusive（E）、Shared（S）、Invalidated（I）。

MOESI协议的基本思想是，通过缓存行填充协议来减少缓存内冲突的发生，提高缓存利用率。对于每条指令的执行，有不同的操作需要进行。对于写操作，先将数据缓存到缓存行中，再通知其他CPU对应的缓存行修改。对于读操作，先从缓存行中获取数据，再通知其他CPU刷新对应的缓存行，确保其他CPU缓存的副本与内存的副本一致。当写操作结束后，相应的缓存行由M状态转化为E状态，通知其他CPU该缓存行的修改已提交。另外，如果其他CPU需要刷新缓存行，则将该缓存行设置为S状态，等待下次写入。

MOESI协议提供了更高的性能，主要原因在于降低缓存冲突的概率，减少缓存行的共享锁定开销，以及提前释放缓存锁。为了实现缓存一致性，必须保证数据在系统内传输过程中保持原子性，这是MOESI协议的另一大优势。

MOESI协议最大的缺陷是消息总线的带宽开销很大，尤其是在多线程情况下，带宽成为瓶颈。此外，MOESI协议限制了多线程之间的并发性。MOESI协议适合于多核服务器上多线程应用程序。

### MOESI (Multicore Out-of-Order Execution Superset of the MESI Architecture)
MOSES是英特尔公司在第四代Xeon处理器上推出的第三代缓存一致性协议。MOSES协议兼顾MSI和MESI协议的优点，采用了不同的消息总线和缓存管理逻辑。同时还支持多线程的并发执行。MOSES协议能够显著降低缓存一致性协议的延迟，提高缓存利用率，并提供更高的容错能力。

MOSES协议相比于MSI/MESI协议有三个明显的改进：

1. 支持超标量的执行，也就是指令乱序执行。这意味着指令按照不同的执行路径顺序执行，即使有依赖关系也是如此。

2. 提供了更多的消息类型，包括Request（R）、Response（RP）、Upgrade（U）、Downgrade（DP）等。其中，Request消息表示希望获得缓存行，其他CPU应当响应该请求。

3. 使用版本号来判断缓存行的有效性，而不是使用块锁定。

MOSES协议的基本思路是，在编译器层面引入超标量技术，同时通过消息总线管理缓存一致性，同时，引入版本号机制来判断缓存行的有效性，从而减少缓存锁定开销。

MOSES协议具有高性能、高可靠性和可伸缩性，同时兼顾了MSI/MESI协议的优点。但是，它最大的缺陷是增加了编译器的复杂性和编译时间。MOSES协议适合于高性能计算领域。