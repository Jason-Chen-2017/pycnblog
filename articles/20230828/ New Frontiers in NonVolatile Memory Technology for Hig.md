
作者：禅与计算机程序设计艺术                    

# 1.简介
  

相对于传统的基于磁盘的内存存储技术，近年来无论是硬件还是软件方面都在大力探索新型的非易失性（Non-volatile memory，NVM）存储技术。相较于传统的SSD、HDD等固定介质，NVM具有以下五个显著特征:

1. 高速访问时间（Access time）。主要表现在随机读取速度快，甚至可以达到每秒千次以上；而顺序读取则要慢很多。
2. 可编程的擦除与编程接口。能够在不需要擦除整个扇区的情况下对特定数据页进行修改或擦除。使得NVM技术具备了定制化的擦除策略，并且能提供编程接口，给予应用高度灵活性。例如，一个数据库系统可以使用NVM作为主存来提升其性能。
3. 价格便宜。市面上已有相当多的NVM存储设备，各类NVM产品价格一般都在几十元到上百元之间。
4. 大容量。NVM能够比传统存储设备的容量大10倍到100倍不等。
5. 低功耗。由于电压降低到2.7V，而无需以太网传输协议，所以不需要额外的电源来供应存储器，并可在移动设备上使用。因此，NVM技术更适合用于手机、穿戴设备等低功耗场景。

除了这些特点外，NVM还存在着一些关键问题需要解决。例如，如何在成本和性能之间取得平衡？如何确保NVM存储设备的可靠性？如何有效地利用NVM存储设备？NVM一直处于蓬勃发展的阶段，且迎接着越来越多的应用需求和挑战。下面，我们将一起研究一下NVM技术目前的最新进展，探讨NVM技术将如何应用在高性能计算领域。
# 2.核心概念和术语
首先，让我们回顾一下NVM的核心概念和术语。

1. NAND Flash。NAND Flash是一种集成电路芯片，它使用半导体存储单元（SOIC封装），通过内部集成电路处理器控制命令信号。NAND Flash的带宽大约是5~10Gbps。NAND Flash的特性使其可用于高速缓冲存储器、快速访问（每秒读取数百万次）以及容错能力强。

2. Solid State Drive (SSD)。SSD是将闪存（Flash）作为主存储器的磁盘阵列。SSD使用固态闪存芯片（MTLC）作为主存，可以实现与传统硬盘一样的随机访问延迟，能够在一定的写入延迟下持续保持较高的性能。但由于SSD是闪存芯片组成，其容量比较小。

3. Non-volatile memory technologies。根据NVM技术的不同，又可以分为如下三类：

   - Write through non-volatile memories (WT-NVMs)：写穿型非易失性存储器。仅当数据被写入NVM后才会更新数据所在的存储单元。读操作时需先从硬盘中读取，然后再返回结果。
   - Write back non-volatile memories (WB-NVMs)：写回型非易失性存储器。每次写操作都会同时更新数据所在的存储单元和缓存中的数据。
   - Tri-level non-volatile memories (TLC-NVMs)：三级非易失性存储器。由多个闪存颗粒组成，其中最靠近CPU的颗粒作为L0层，中间的颗粒作为L1层，最远离CPU的颗粒作为L2层。L1层在L0层之上，L2层在L1层之上。TLC结构优点是可利用闪存的特性，即降低了成本和能耗，并降低了延迟。此外，L0层，L1层和L2层可以独立写入或擦除，能够满足应用的随机写入，擦除要求。

4. FLASH memory controller。FLASH控制器（FMC）是一种专用处理器，主要负责控制FLASH闪存芯片。控制器通过SPI、QPI或其他接口与外部芯片通信。通过FMC，可以执行擦除/编程、地址映射、时序控制、错误恢复等功能。

5. Cache coherency protocol。缓存一致性协议（Cache Coherency Protocol，CCP）用于确保NVM存储设备上的缓存数据与实际存储器数据保持一致。CCP定义了缓存与实际存储器之间的信息共享规则。目前，CCP主要包括MSI（Modified Shared Invalidate）和MESI（Modified Exclusive Shared or Invalidated）协议。MSI协议是传统的缓存一致性协议，MESI协议是Intel推出的高端缓存一致性协议。

6. Storage area network。SAN是一种分布式网络，能够连接多个数据中心，提供跨越多个数据中心的数据访问服务。SAN采用廉价的低速存储硬件和高性能网络来实现数据的安全、快速和可靠的传输。SAN技术已经成为当前企业的数据中心的一个主要技术手段。SAN通常被部署在机房内、机架上和边缘服务器的周围，将应用服务器和存储服务器连接起来，实现数据共享、存储和计算资源的集成。

7. Remote direct memory access (RDMA)。远程直接内存访问（Remote Direct Memory Access，RDMA）是一种远程内存访问技术，允许应用程序直接读写网络通道。通过网络接口卡（NIC）的直接操作，RDMA可降低网络的开销、提高性能，同时兼顾网络的可靠性和带宽。

8. Fibre Channel over Ethernet (FCoE)。Fibre Channel over Ethernet（FCoE）是一个由英特尔、纳斯达克和思科联合开发的一套企业级光纤互连协议。其目的是通过存储网技术提供高带宽、低延迟的分布式存储环境。FCoE通常被用于部署SAN和其他高性能的分布式存储服务。

9. NVMe over Fabrics (NVMeOF)。NVMe over Fabric（NVMeOF）是Intel和微软共同推出的一套专门针对PCIe总线的NVM技术。NVMeOF结合了ISC（Internet Small Computer System Interface，因特网小型计算机系统接口）和NVMe规范，提供了一套完整的高性能NVM技术。NVMeOF可在PCIe和光纤之间提供高效率的、低延迟的数据传输。

10. Spanning Tree Protocol (STP)。STP是IEEE在1984年提出的一种局域网广播协议，用于维护网络拓扑和链路状态。STP能够检测拓扑变化、自动生成树、防止环路攻击。
# 3.算法原理和操作步骤
下面，我们讨论一下如何构建高性能的非易失性内存系统。下面，我们以NAND Flash为例，展开NVM技术的应用实践。NAND Flash支持的是块模式，而不支持字节级别的擦除和编程。但是，我们可以通过“块”的划分来减少随机编程/擦除请求的数量，来减少随机访问的时间。另外，块模式下的NAND Flash存储器也具有良好的数据局部性，可以充分发挥其性能优势。

1. 指令集设计。在块模式下，NAND Flash的指令集和磁盘相同。不同的是，需要增加新的指令来支持块级别的擦除和编程。NAND Flash一般有两种类型指令：读（READ）、写（WRITE）。每个指令均包括行地址和列地址。为了增强随机编程/擦除操作的能力，增加新的指令（ERASE_BLOCK和PROGRAM_BLOCK）用于块级别的擦除和编程。

2. 块缓存。为了提高随机访问的效率，NAND Flash的块缓存是必不可少的。块缓存会预读一定数量的块，在下一次访问的时候就不需要重新读取。块缓存可以提高随机访问效率，因为不需要频繁的寻址，只需在块缓存中查找即可。

3. 数据校验。为了保证数据安全，NAND Flash需要支持数据校验。校验信息通常会被嵌入到NAND Flash的每个数据块中。当数据块被写入时，会进行校验。校验数据和原始数据进行比较，如果不一致，说明数据被破坏，需要进行重建。重建成功后，就不会出现问题。如果校验失败，说明数据块损坏，需要采取相关措施，如重试或者替换掉该块。

4. 时序控制。时序控制是指对指令、数据、控制信号进行同步。NAND Flash的所有指令都采用异步方式发送，等待一定的时间周期后，才能执行。这样可以避免发生竞争状态，提高指令的响应速度。由于NAND Flash读写操作速度快，所以需要时序控制机制来实现随机访问的最大化。

5. 擦除/编程流程优化。擦除/编程操作的主要问题是速度慢。为了提升速度，引入了同步预擦除的方式。在擦除前，将整个存储器全部擦除，然后再写入数据。这是因为NAND Flash的擦除是无法停止的，如果采用异步擦除，可能会导致数据丢失。由于预擦除过程非常耗时，需要尽可能减少次数。另一方面，如果一次性擦除完所有块，那么缓存命中率就会降低，导致响应时间变长。为了提高效率，需要多种方式来提升擦除/编程的效率。

6. 改善缓存一致性。由于NAND Flash采用异步访问模式，所以不能依赖于缓存一致性协议（CCP）来确保缓存与实际存储器的数据一致性。因此，需要通过其它机制来确保缓存数据与实际存储器数据一致性。

7. 提高并发性。为了提高随机访问的并发性，可以在多个核心之间划分工作负载。每个核心负责随机访问指定范围的块，缓存相同的块。另外，还可以采用多核并行处理，提高整体的随机访问速度。

8. 利用SAN和RDMA。SAN能够提供快速的分布式存储，而RDMA能够提供更高的吞吐量。另外，也可以在SAN和普通的NAND Flash之间进行数据同步，提高性能。

NVM技术还有很多工作需要做，但在目前的趋势下，已经达到了新瓶颈期，NVM技术可以提供更快、更可靠、更经济的存储方案。