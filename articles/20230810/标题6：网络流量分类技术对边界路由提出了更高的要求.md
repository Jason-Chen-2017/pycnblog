
作者：禅与计算机程序设计艺术                    

# 1.简介
         

在网络边界处，传统的基于静态路由协议的路由器仅仅依据目的IP地址进行路由选择，忽略了不同方向的流量之间的关联性。因此，即使是公共云服务或边缘计算场景下，流量分类也是一个重要的技术需求。
本文将首先对“边界路由”和相关技术做一个简单介绍，然后进一步阐述流量分类的基本概念、技术特点、分类方法、分类算法等方面。
# 2.背景介绍
## 2.1 边界路由
“边界路由”，顾名思义，指的是分布在两个网络边界（或者内部网关）上的路由设备。传统的基于静态路由协议的路由器，仅考虑目的IP地址进行路由选择，忽略不同方向的流量之间的关联性。例如，如果源IP地址A发送了目的IP地址B的数据包，通常会通过路由器R1转发到另一路由器R2，但如果目标IP地址C也需要访问A，则其数据包可能被送往R3。这种情况下，由于流向不同的目的地，数据包只能分别经过两条路径，因此无法实现最优路由选择。
边界路由主要用于以下几个应用场景：
- **公共云服务**：大多数公共云服务提供商都会部署边界路由设备来优化服务质量和用户体验。比如，AWS提供了EC2-Classic（一种典型的虚拟私有云）、VPC、Internet Gateway等服务，它们在边界处部署的边界路由可以确保数据包能够正确的在Internet和用户侧进行传输。
- **边缘计算**：边缘计算的关键之处在于要连接用户和物联网设备，并且对实时响应时间有极高的要求。此类场景中，边界路由也扮演着重要角色，它不仅需要保证内部网络与外部网络的连接，还需要根据各种网络条件及数据包特性对流量进行实时分类和调度。
- **数据中心网络规划**：作为整个数据中心网络的基石，数据中心网络边界通常都需要配置成高度可靠，稳定性较强的路由设备。但是，在现代数据中心网络环境下，很多边界路由设备并不能同时承担路由和分流功能，这就导致有些边界路由成为性能瓶颈。因此，边界路由技术也面临着挑战。

## 2.2 流量分类技术特点
流量分类技术的核心思想就是，按照不同类型的数据流，采用不同的路由策略，从而最大限度地减少网络拥塞。常用的分类方法包括：按协议分类、按应用分类、按内容分类。这些方法各自都有自己的优缺点，各有千秋，具体如下：
### 2.2.1 按协议分类
按协议分类，即把网络流量划分为不同协议流量，并基于相应的协议进行处理，如TCP、UDP、ICMP、IGMP等。这样做的好处是可以将不同类型的流量分类成不同的队列，然后分配到不同速率的端口上，避免出现单个端口上拥塞的问题。但按协议分类可能会造成网络资源的浪费，因为不同的协议之间存在大量重叠。另外，也有一些协议如SSL/TLS、HTTP、SIP等会大量占用网络带宽。
### 2.2.2 按应用分类
按应用分类，则把网络流量划分为不同应用流量，并基于相应的应用进行处理。常见的应用如Web应用、数据库应用、VoIP应用等。按应用分类的优点是可以很好的控制网络资源的利用率，因为同一应用之间的流量一般不会互相影响。缺点是会产生大量的应用连接，容易出现“三光年”问题。
### 2.2.3 按内容分类
按内容分类，则把网络流量划分为不同内容流量，并根据内容关键字进行匹配，如电子邮件、视频流、社交媒体等。按内容分类的优点是可以有效防止恶意攻击或垃圾信息泛滥。缺点是需花费大量的时间精力进行复杂的匹配规则的开发。

综上所述，流量分类技术能够实现不同类型的流量具有不同的优先级，从而减少网络拥塞，提升网络整体性能。同时，流量分类技术还需要兼顾效率与效益，在满足用户要求的前提下，降低系统复杂度，尽可能地减少网络资源的浪费。

# 3.核心概念
## 3.1 网络流
网络流是指通过互联网或其他网络连接的计算机设备之间传送的信息。它由报文组成，每个报文包含源地址、目的地址、协议类型、报文长度、首部、载荷等字段。网络流可以是入站流（即主机接收到的流）、出站流（即主机发送出的流），也可以是双向流（即主机收发的流）。网络流可以在网络中自由穿行，可以通过路由器转发、交换机过滤、代理服务器缓存、负载均衡等方式进行处理。
## 3.2 网络层流量分类
网络层流量分类是指将不同方向的网络流量分类成不同的优先级，以便为每个方向提供不同的服务质量。典型的网络层流量分类技术有两种：
- **基于源地址的流量分类**：源地址表示网络流的起始点，因此可以根据源地址进行分类。常见的分类方法包括：地址掩码分类、VLAN划分等。
- **基于传输层协议的流量分类**：基于传输层协议（如TCP、UDP、SCTP等）进行分类。不同的协议类型（如TCP、UDP）对数据的可靠性、顺序性等方面有不同的要求。因此，可以根据传输层协议进行分类。分类的方法可以包括：QoS队列管理、网关限速、流量调度等。

## 3.3 边界路由器
边界路由器是指分布在两个网络边界（或内部网关）上的路由器。传统的路由器仅考虑目的IP地址进行路由选择，忽略不同方向的流量之间的关联性。因此，当不同方向的数据流量需要进行通信时，必须通过不同路由器才能实现。边界路由器正是为了解决这个问题而设计的。
边界路由器的功能主要有三个：
- **路由转发**：边界路由器能根据网络流的源地址、目的地址、传输层协议等参数进行转发，实现不同方向的流量之间的关联性。
- **流量分类**：边界路由器能根据网络流的源地址、目的地址、传输层协议等参数进行分类，实现不同类型流量之间的优先级调度。
- **高可用性和容错能力**：边界路由器的高可用性和容错能力能够保证网络的正常运行。它可以通过冗余结构和备份链路来实现高可用性，并通过连接监控、检测和故障切换等手段来保证网络的容错能力。

## 3.4 边界网关
边界网关是指安装在本地数据中心的特殊路由器，负责为数据中心内部主机、服务和第三方网络设备之间架设一条直接可达的链路。边界网关与传统的互联网边缘路由器类似，但区别在于边界网关是专门用来接入本地网络的，通常位于本地数据中心的不同区域，它不参与网络的全局路由。
边界网关的功能主要有四个：
- **身份认证和访问控制**：边界网关能识别不同设备的身份，并执行相应的访问控制策略。
- **NAT转换**：边界网关能够实现网络地址转换（NAT），从而隐藏本地网络中的内部设备的IP地址。
- **网络拓扑发现**：边界网关能够自动发现网络拓扑，并建立相应的路由表。
- **流量控制和QoS管理**：边界网关能针对不同类型流量实施不同的控制策略，如QoS、限速等。

# 4.流量分类方法
## 4.1 地址掩码分类
地址掩码分类（Address Masking Classification，AMC）是网络层流量分类技术中最简单的一种。它的工作原理是将IP地址划分成网络地址和主机地址两部分，再基于主机地址进行分类。地址掩码分类的工作流程如下图所示：


对于入站流量，源地址X经过路由器R转发到目的地址Y后，路由器R会检查目的地址Y的子网掩码M，并根据X和Y是否属于同一子网来决定流量的下一跳地址。如果源地址和目的地址都属于同一子网，则将流量分类为本地流量；否则，将流量分类为远程流量。
对于出站流量，路由器R从本地网络向外发送流量时，会根据目的地址Y确定流量的下一跳路由器。如果目的地址Y属于本地子网，则流量继续向外发送；否则，流量被发送到默认路由器或边界路由器。

地址掩码分类可以实现简单的流量分类，但由于掩码大小限制，其分类精度有限。同时，不同网络的地址掩码可能相同，这就导致不同网络之间的流量不能进行准确分类。

## 4.2 VLAN划分
虚拟LAN（Virtual Local Area Network，VLAN）技术是网络层流量分类技术中较为复杂的一种。它的工作原理是把交换机上的多个端口划分为一个虚拟局域网（VLAN），再基于VLAN进行分类。VLAN划分的工作流程如下图所示：



路由器R收到一个网络流量时，先解析出VLAN ID，然后根据VLAN ID确定流量的下一跳路由器。VLAN ID由管理员预先定义，每台交换机支持VLAN个数也有限，所以VLAN划分的分类范围受限。

VLAN划分可以灵活地调整网络流量的分类，且VLAN内的流量具有较好的隔离性。但其分类粒度较细，难以实现全面的流量分类。

## 4.3 QoS队列管理
队列管理（Queue Management）是网络层流量分类技术中常用的一种方法。它的工作原理是利用排队规则、队列长度和调度算法来控制网络流量的进入和排出。

队列管理包括三个主要组件：分类规则、队列长度、调度算法。分类规则确定网络流量的优先级。队列长度定义了不同优先级的流量在队列中的排队策略。调度算法根据分类规则和队列长度分配优先级队列中的流量到适当的端口。

QoS队列管理可以实现不同类型流量的优先级调度，并可以根据网络的负载状况实时调整队列长度。然而，QoS队列管理又容易产生“尾部 drops”问题，即某些优先级队列的流量饱和，致使其丢弃，影响到其他优先级队列的流量调度。

## 4.4 网关限速
网关限速（Gateway Throttling）是网络层流量分类技术中较为复杂的一种方法。它的工作原理是利用网关的存储空间、带宽、处理速度等资源，通过设置限速策略来控制网络流量的进入和流速。

网关限速包括四个主要组件：存储空间、带宽、处理速度、流量控制算法。存储空间定义了网关可以存储的报文数量，带宽定义了网关的发送速率。处理速度定义了网关的处理能力。流量控制算法根据带宽、存储空间和处理速度限制流量的发送速率。

网关限速能够实现对不同类型的流量实施不同的速率限制，从而最大程度地减少网络拥塞。但网关限速的流量调度能力有限，无法实时调整速率。

## 4.5 流量调度
流量调度（Traffic Shaping）是网络层流量分类技术中最常用的一种方法。它的工作原理是基于队列长度和排队规则来动态调整网络流量的发送速率。

流量调度包括三个主要组件：流量阀值、调度窗口和调度算法。流量阀值定义了网络流量进入某种优先级队列的速率限制。调度窗口定义了调度算法检查流量的频率。调度算法根据流量阀值和调度窗口对网络流量进行调度。

流量调度能够实时调整网络流量的发送速率，通过调节队列长度和排队规则，可以有效地抑制拥塞。流量调度可以实时修改网络流量的优先级，还可以根据网络的负载状况实时调节队列长度。但流量调度对不同类型的流量实现统一的速率限制，对某些场景可能无法实现较为精细的控制。

## 4.6 混合分类方法
除了上面介绍的几种流量分类方法，还有其他一些混合分类方法可以实现更加复杂的流量分类。其中，通过混合使用多个分类方法可以形成一个组合分类方法，比如，可以使用混合分类法结合QoS队列管理、流量调度等方法。