
作者：禅与计算机程序设计艺术                    

# 1.简介
  

域名系统（Domain Name System，DNS）是一个基于TCP/IP协议的应用层协议，用于域名到IP地址映射、分布式数据库记录管理和邮件服务传输等功能。DNSSEC是一种通过使用非对称加密技术将数据报文签名的方法，用于确保域名服务器交换的数据安全、完整和真实。DNSSEC还引入了其它安全机制，包括证明权威性、过期时间戳和NSEC记录等。
在边界路由器中部署DNSSEC，可以有效防止数据泄露、篡改和伪造，并增强网络的可靠性和隐私性。DNSSEC部署难度低，且安全机制能够有效减少攻击面。
本文介绍的是边界路由器如何部署DNSSEC，涉及到的关键知识点有：

1. DNSSEC中的主域密钥（KSK）和辅助域密钥（ZSK）生成方式及其区别。

2. KSK和ZSK的作用及不同密钥类型之间的关系。

3. DNSKEY资源记录中的一些关键字段含义。

4. 如何在边界路由器上配置BIND9作为主DNS服务器，并启用DNSSEC。

5. 如何在边界路由器上配置Unbound作为辅助DNS服务器，并启用DNSSEC。

6. BIND9中如何设置KSK和ZSK密钥生成策略。

7. Unbound中如何设置KSK和ZSK密钥轮转策略。

8. 使用OpenSSL工具如何生成KSK和ZSK密钥。

作者简介：孙浩然，云计算/网络工程师，曾就职于腾讯，创业公司Tecent，担任高级工程师、联合创始人、CTO。拥有丰富的互联网开发经验，精通Python、Java、JavaScript语言。主要从事信息安全方向研究和项目管理工作。
# 2.基本概念术语说明
## 2.1 DNS
域名系统（Domain Name System，DNS）是Internet使用的名字解析系统。它把主机名转换成相应的IP地址，这样用户就可以访问互联网上的各种网络服务，而无需记住繁琐的IP地址或电子邮箱地址。DNS提供的查询服务主要有两种，即“传统”DNS和“递归”DNS。传统DNS采用一套中心服务器集中存储所有域名与IP地址映射关系，由客户机向中心服务器提出请求，得到响应；递归DNS则是客户机直接向域名服务器发送请求，不再需要向中心服务器查询，获得响应信息。互联网域名空间的规模越来越庞大，DNS服务器也逐渐向分布式结构转型，但仍然依赖于中心服务器进行高可用部署。为了应对这一局限性，在1996年IETF发布的RFC 1034中定义的DNS客户机-服务器模型被广泛采纳，并引入了DNS缓存服务器以加快域名解析效率。2008年8月，互联网名称与数字分配机构（ICANN）颁布的新版域名法增加了DNSSEC相关规范，引入了域名认证中心（DC）来进行域名安全证明。
## 2.2 DNSSEC
DNSSEC（Domain Name System Security Extensions，域名安全扩展）是一组标准，旨在为DNS添加一种新的安全层。DNSSEC通过证书签名验证技术，使得DNS记录在传输过程中受到保护。它可以验证收到的数据是否未被修改，并且源自已知的授权服务器。DNSSEC支持两种密钥类型，主密钥（KSK）和辅助密钥（ZSK）。主密钥用来创建和发布DNSKEY资源记录，用来验证其他DNSKEY记录的签名，ZSK用来对DNS数据进行签名，并发布DS资源记录。主密钥由一个或多个密钥共同控制，而且容易备份和恢复。当主密钥失效时，可以由另一个密钥来接管，避免单点故障。
## 2.3 非对称加密算法
非对称加密算法是指通过不同的密钥算法，即公钥和私钥，来实现数据的加密和解密过程。公钥与私钥之间只能进行加密运算，不能反向运算，因此公钥用于加密数据，私钥用于解密数据。目前最流行的非对称加密算法是椭圆曲线加密算法。RSA算法就是用这种算法实现的。
## 2.4 ELLIPTIC CURVE cryptography (ECC)
椭圆曲线加密算法是一种公钥加密算法，它利用椭圆曲线对公钥和私钥进行运算，满足公钥加密、私钥签名、公钥验证三个特性。椭圆曲线密码术已经在许多场合被应用，如电子支付系统、密码学货币、数字签名、共享密钥等。
## 2.5 ECDSA (Elliptic Curve Digital Signature Algorithm)
椭圆曲线数字签名算法(ECDSA)是一种椭圆曲线公钥加密算法，它利用椭圆曲LINEAR(L)对公钥和私钥进行运算，满足公钥加密、私钥签名、公钥验证三个特性。ECDSA与DSA(Digital Signature Algorithm)一样也是一种密码散列函数算法，用于确认消息的完整性，但是它的速度要快很多。
## 2.6 SPKI (Subject Public Key Info)
SPKI是一种ASN.1编码的公钥证书格式，主要用来存储公钥。SPKI的语法格式如下所示：
```
SPKI {
    algorithmIdentifier     ALGORITHM ;
    subjectPublicKey        BIT STRING ;
}
ALGORITHM ::= OBJECT IDENTIFIER ;
subjectPublicKey   OCTET STRING ; //public key is encoded as an octet string
```
## 2.7 Authoritative Server
权威服务器（Authoritative Server）是指负责为客户机提供解析结果的服务器。所有的DNS查询都首先被发送至权威服务器，然后再返回给客户机。权威服务器具有超级权限，所以它们可以直接修改DNS数据。但是，由于拥有强大的权限，所以这些服务器通常会向第三方隐藏自己的真实 IP 地址，这就需要 DNS 的部署者进行额外的配置才能使用 DNSSEC 进行部署。
# 3.核心算法原理和具体操作步骤以及数学公式讲解
## 3.1 KSK和ZSK的生成
### 3.1.1 ZSK
ZSK（Zone Signing Key，区域签名密钥），又称为单个签名密钥或者KSK。它是一种密钥对，用于对待签名的Zone文件进行签名。ZSK分为正向和反向两个密钥，一个是用于生成RRSIG记录的正向签名，另一个是用于生成DNSKEY记录的反向签名。Zone文件是一系列的DNS资源记录（Resource Record，RR）。
如图1所示，ZSK分为两种，一是用于生成RRSIG记录的正向签名密钥，二是用于生成DNSKEY记录的反向签名密钥。当Zone文件由DNS服务器签名时，正向签名密钥被用来生成RRSIG记录；当DNSKEY记录被签名时，反向签名密钥被用来生成DNSKEY记录。ZSK只在其持有者的服务器上使用，只有该服务器才知道它。
### 3.1.2 KSK
KSK（Key Signing Key，密钥签名密钥），又称为主密钥。它是一组密钥对，用于对所有ZSK进行签名，并发布到DNS根区域（Root Zone）。KSK分为正向和反向两个密钥，一个是用于生成ZSK的正向签名，另一个是用于生成KSK的反向签名。KSK用来对所有的ZSK进行签名，从而建立起整个DNS根区域的信任基础。
如图2所示，KSK分为两种，一是用于生成ZSK的正向签名密钥，二是用于生成KSK的反向签名密钥。KSK被用来对所有ZSK进行签名，并发布到DNS根区域（Root Zone），整个DNS根区域信任基础建立起来。KSK由几个ZSK组成，当其中任何一个ZSK失效时，可以由另外的ZSK来取代。主DNS服务器可以使用KSK来生成所有Zone文件的签名。
## 3.2 DNSKEY资源记录
### 3.2.1 文件头
DNSKEY资源记录包含DNS密钥相关的信息，其中包括公钥、类型、密钥长度、标志值和协议。文件头由以下字段构成：
* Flags: 标识DNSKEY资源记录的某些特性。目前定义的标识值为：
  * Key type flags: 标识DNSKEY资源记录的密钥类型，共三种类型：
    - KSK: 主密钥，用于对ZSK进行签名，并发布到DNS根区域（Root Zone）。
    - ZSK: 区域密钥，用于对Zone文件进行签名。
    - CERT：证书密钥，用于验证证书签名。
  * Protocol Field: 指定使用的协议。
  * Algorithm field: 指定签名/验证算法。
  * Publish flag: 如果设置，表示此DNSKEY资源记录可以发布到父域中。如果没有设置，表示此DNSKEY资源记录不可以发布到父域中。
* Protocol: 指定密钥的协议类型。目前定义的协议类型包括：
  - 0: DNSSEC
  - 1: 实施正在进行的规划中的DNSSEC更新。
* Algorithm: 指定密钥的算法类型。目前定义的算法类型包括：
  - RSA: 公钥加密算法。
  - DSA: 数字签名算法。
  - ECDSAP256SHA256: 椭圆曲线数字签名算法，采用NIST P-256 曲线和SHA-256哈希函数。
  - ECDSAP384SHA384: 椭圆曲线数字签名算法，采用NIST P-384 曲线和SHA-384哈希函数。
* Public Key: 密钥对的公钥，采用Base64编码。
### 3.2.2 使用OpenSSL工具生成KSK和ZSK密钥
假设要在边界路由器上安装并运行BIND9，并开启DNSSEC。第一步是在EDNS0扩展里添加DO标志位，这样我们的域名服务器就会回复一个包括DNSKEY资源记录的文件。第二步是生成KSK和ZSK密钥。下面通过OpenSSL命令生成RSA类型的KSK和ZSK密钥，并用base64编码保存到文件中。
```bash
# Generate a new RSA private key for the root zone signing key (KSK).
openssl genrsa -out ksk.key 2048

# Convert the RSA private key to PEM format with header and footer.
openssl rsa -in ksk.key -outform PEM -RSAPublicKey_out -out kspempub.pem 

# Export the public part of the RSA private key in DER format.
openssl rsa -in ksk.key -pubout -outform DER -out ksderpub.der 

# Import the DER formatted public key into OpenSSL so it can be used later.
openssl asn1parse -inform der -i -in ksderpub.der > pubinfo.txt

# Extract the exponent value from the output file generated by openssl asn1parse command.
grep INTEGER ksderpub.der | cut -d: -f2 | tr -d '[:space:]' | xxd -r -p > exp.bin
hexdump -e '/1 "%02x" "\n"' < exp.bin > hexexp.txt
echo "Exponent:" $(cat hexexp.txt | sed's/\(.\{4\}\)/0x&,/g; s/,$//' | bc)

# Create a binary blob that contains both parts of the RSA private key (modulus + exponent).
echo -ne '\xff\xff\xff\xff\x00\x0b\x00\x02\x01\x00\x01\x00\x00\x00\x0a\x00\x00\x00\x01\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00' >> mod_exp_blob.bin
xxd -p < ksk.key >> mod_exp_blob.bin

# Encode the binary data using base64 encoding.
cat mod_exp_blob.bin | base64 > b64mod_exp_blob.txt

# Remove the temp files we created earlier.
rm ksk.key ksderpub.der hexexp.txt exp.bin mod_exp_blob.bin
```
这个脚本生成了一组新的RSA类型的KSK和ZSK密钥，并导出了公钥的PEM格式。同时也输出了公钥的指数值（十六进制格式）。
## 3.3 配置BIND9
### 3.3.1 安装配置BIND9
为了配置BIND9，需要先安装它。你可以选择从源码编译安装，也可以下载编译好的版本。
```bash
apt-get install bind9 dnsutils bind9utils
```
配置BIND9主要涉及到三个配置文件：named.conf、named.conf.local、named.conf.options。
#### named.conf
named.conf是主配置文件，包含全局的配置选项，比如文件和日志位置、通用设置等。它应该存放在/etc/bind目录下。
#### named.conf.local
named.conf.local是一个本地配置文件，包含对特定的区域的配置，包括对该区域的DNS服务器的设置、所用的认证策略等。每个区域都对应一个文件。这些配置文件应该存放在/var/lib/bind/目录下。
#### named.conf.options
named.conf.options是全局配置选项文件，包含一些与安全相关的设置。
### 3.3.2 允许递归查询
为了让域名解析器正常运行，需要允许递归查询。可以在named.conf.options文件里添加以下内容：
```
recursion yes; # Allow recursive queries
allow-query { any; }; # Allow all queries
```
### 3.3.3 配置DNSSEC
要启用DNSSEC，我们需要在区域配置文件（*.conf）里添加zone语句的dnssec-enable参数。例如，对于域名example.com，我们可以在区域文件example.com.conf里添加如下语句：
```
zone "example.com" IN {
   type master;
   file "/path/to/your/zonefile";
   dnssec-enable yes;
};
```
在dnssec-enable yes之后，BIND9会自动生成KSK和ZSK密钥，并用它们来对Zone文件进行签名并发布。如果出现错误，可以检查/var/log/syslog文件看是否有报错信息。

如果需要关闭某个区域的DNSSEC功能，可以通过设置dnssec-validation no。