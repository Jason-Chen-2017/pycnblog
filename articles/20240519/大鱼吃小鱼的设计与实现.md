# 大鱼吃小鱼的设计与实现

作者：禅与计算机程序设计艺术

## 1. 背景介绍

### 1.1 游戏概述
大鱼吃小鱼是一款经典的休闲游戏，玩家通过控制一条小鱼在海洋中进食和成长，同时要躲避比自己大的鱼的攻击。游戏简单易上手，老少皆宜，深受玩家喜爱。

### 1.2 游戏规则
- 玩家控制一条小鱼在海洋中自由游动
- 吃掉比自己小的鱼可以获得分数和经验值，鱼会随着经验值的增加而成长
- 被比自己大的鱼吃掉会失去一条生命，生命耗尽游戏结束
- 游戏目标是尽可能获得更高的分数

### 1.3 开发目标
本文将介绍如何使用Unity引擎开发一款2D版本的大鱼吃小鱼游戏，重点关注游戏的架构设计、核心算法、数学模型以及代码实现。通过本文的学习，读者可以掌握开发一款完整休闲游戏的完整流程和技术要点。

## 2. 核心概念与联系

### 2.1 游戏对象(GameObject)
游戏中所有实体都是游戏对象，包括鱼、食物、障碍物等。每个游戏对象都有一个Transform组件用于控制其位置、旋转和缩放。

### 2.2 精灵(Sprite) 
精灵是2D游戏中表示游戏对象外观的图片。Unity提供Sprite类来加载和渲染精灵图片。

### 2.3 刚体(Rigidbody2D)
刚体组件让游戏对象拥有物理属性，受力的作用，可以模拟真实世界中的运动。Unity的物理引擎可以自动处理碰撞检测和力的计算。

### 2.4 碰撞器(Collider2D) 
碰撞器定义了游戏对象的碰撞形状，用于进行碰撞检测。常见的2D碰撞器有BoxCollider2D（矩形）和CircleCollider2D（圆形）。

### 2.5 脚本(Script)
游戏逻辑通过脚本组件来实现，脚本是附加到游戏对象上的一段代码，可以访问和控制游戏对象及其他组件。Unity支持C#和JavaScript语言编写脚本。

## 3. 核心算法原理具体操作步骤

### 3.1 鱼的游动控制
1. 在鱼的GameObject上添加Rigidbody2D组件
2. 在Update()方法中获取用户输入
3. 根据用户输入对Rigidbody2D施加力，控制鱼的游动方向
4. 根据鱼的游动方向改变鱼的精灵朝向

```csharp
void Update()
{
    float moveHorizontal = Input.GetAxis("Horizontal");
    float moveVertical = Input.GetAxis("Vertical");
    
    Vector2 movement = new Vector2(moveHorizontal, moveVertical);
    rb2d.AddForce(movement * speed);
    
    if (moveHorizontal > 0)
        transform.localScale = new Vector3(1, 1, 1);
    else if (moveHorizontal < 0)
        transform.localScale = new Vector3(-1, 1, 1);
}
```

### 3.2 摄像机跟随
1. 在场景中创建一个空的GameObject作为摄像机的目标
2. 将目标对象设为鱼的子对象，并调整偏移量
3. 在摄像机上添加脚本，在LateUpdate()中将摄像机的位置平滑过渡到目标位置

```csharp
public class CameraFollow : MonoBehaviour
{
    public Transform target;
    public float smoothSpeed = 0.125f;
    
    void LateUpdate()
    {
        Vector3 desiredPosition = target.position;
        Vector3 smoothedPosition = Vector3.Lerp(transform.position, desiredPosition, smoothSpeed);
        transform.position = smoothedPosition;
    }
}
```

### 3.3 鱼的碰撞检测
1. 在鱼和食物的Prefab上添加CircleCollider2D组件，并设置isTrigger属性为true
2. 在鱼的脚本中实现OnTriggerEnter2D()方法
3. 判断碰撞对象的标签，如果是食物则销毁食物，增加分数和经验值
4. 如果碰撞的是比自己大的鱼，则减少生命值

```csharp
void OnTriggerEnter2D(Collider2D other)
{
    if (other.CompareTag("Food"))
    {
        Destroy(other.gameObject);
        score += 10;
        exp++;
        if (exp >= expToLevelUp)
            LevelUp();
    }
    else if (other.CompareTag("Enemy"))
    {
        Fish enemyFish = other.GetComponent<Fish>();
        if (enemyFish.level > level)
        {
            life--;
            if (life <= 0)
                GameOver();
        }
    }
}
```

### 3.4 鱼的生长系统
1. 定义鱼的等级level和经验值exp变量
2. 每吃一个食物增加固定经验值
3. 当经验值达到升级所需经验值时，提升等级
4. 根据等级调整鱼的精灵大小

```csharp
void LevelUp()
{
    level++;
    exp = 0;
    expToLevelUp *= 2;
    transform.localScale *= 1.2f;
}
```

### 3.5 游戏管理
1. 创建GameManager脚本作为游戏的总管理器
2. 在GameManager中存储游戏状态，如分数、生命值等
3. 提供RestartGame()和GameOver()方法供其他脚本调用
4. 在GameOver时保存最高分并显示游戏结束界面

```csharp
public class GameManager : MonoBehaviour
{
    public static GameManager instance;
    public int score = 0;
    public int bestScore = 0;
    public int life = 3;
    
    void Awake()
    {
        instance = this;
    }
    
    public void GameOver()
    {
        bestScore = Mathf.Max(score, bestScore);
        PlayerPrefs.SetInt("BestScore", bestScore);
        // 显示游戏结束界面
    }
    
    public void RestartGame()
    {
        score = 0;
        life = 3;
        // 重新加载场景
    }
}
```

## 4. 数学模型和公式详细讲解举例说明

### 4.1 鱼的运动模型
鱼的运动可以看作是2D平面内的质点运动，受到玩家输入的力的作用。根据牛顿第二定律，鱼的加速度与所受合力成正比，方向与合力方向一致。

设鱼的质量为$m$，在$x$和$y$方向上的受力分别为$F_x$和$F_y$，则有加速度：

$$a_x = \frac{F_x}{m}, a_y = \frac{F_y}{m}$$

由加速度可以得到速度和位移的变化：

$$v_x = v_{x0} + a_xt, v_y = v_{y0} + a_yt$$
$$\Delta x = v_{x0}t + \frac{1}{2}a_xt^2, \Delta y = v_{y0}t + \frac{1}{2}a_yt^2$$

其中$v_{x0}$和$v_{y0}$为初速度，$t$为时间。Unity的物理引擎会自动计算这些物理量的变化，我们只需要给刚体一个合适的力即可。

### 4.2 摄像机平滑跟随模型
摄像机跟随目标移动时，为了避免摄像机位置突变，可以使用插值平滑算法，即每一帧将摄像机位置向目标位置线性插值一小段距离。

设摄像机当前位置为$P_0$，目标位置为$P_1$，插值系数为$\alpha \in [0,1]$，则摄像机新位置$P$为：

$$P = (1-\alpha)P_0 + \alpha P_1$$

$\alpha$的值越大，摄像机跟随越快，在Unity中可以用Lerp函数计算线性插值：

```csharp
Vector3 smoothedPosition = Vector3.Lerp(transform.position, desiredPosition, smoothSpeed);
```

其中smoothSpeed就是插值系数，取值在0到1之间。

### 4.3 鱼的碰撞检测模型
Unity使用分离轴定理（Separating Axis Theorem）来进行2D碰撞检测。对于两个凸多边形A和B，如果存在一个轴使得A和B在该轴上的投影不重叠，则A和B不相交。

对于圆形碰撞器，只需要判断两个圆心的距离是否小于半径之和即可。设两个圆的圆心坐标为$(x_1, y_1)$和$(x_2, y_2)$，半径分别为$r_1$和$r_2$，则两圆相交的条件为：

$$\sqrt{(x_1-x_2)^2 + (y_1-y_2)^2} < r_1 + r_2$$

Unity的物理引擎会自动进行碰撞检测，我们只需要在回调函数中处理碰撞事件即可。

### 4.4 经验值和等级模型
经验值（EXP）和等级（Level）的关系可以用一个数学模型来描述。常见的有线性模型和指数模型两种。

线性模型：每升一级需要的经验值是固定的，即

$$EXP_n = n \times EXP_1$$

其中$EXP_n$表示升到第$n$级所需的总经验值，$EXP_1$为升一级所需经验值。

指数模型：每升一级需要的经验值是上一级的固定倍数，即

$$EXP_n = EXP_1 \times q^{n-1}$$

其中$q$为经验值增长系数，通常取2到3之间的值。

在游戏中我们采用指数模型，每升一级经验值要求翻倍：

```csharp
int expToLevelUp = 10;

void LevelUp()
{
    level++;
    exp = 0;
    expToLevelUp *= 2;
}
```

## 5. 项目实践：代码实例和详细解释说明

下面给出游戏的核心代码实例，并进行详细解释。

### 5.1 鱼的控制脚本FishController.cs

```csharp
using UnityEngine;

public class FishController : MonoBehaviour
{
    public float speed = 10f;
    public int level = 1;
    public int exp = 0;
    public int expToLevelUp = 10;
    
    private Rigidbody2D rb2d;
    
    void Start()
    {
        rb2d = GetComponent<Rigidbody2D>();    
    }
    
    void Update()
    {
        float moveHorizontal = Input.GetAxis("Horizontal");
        float moveVertical = Input.GetAxis("Vertical");
        
        Vector2 movement = new Vector2(moveHorizontal, moveVertical);
        rb2d.AddForce(movement * speed);
        
        if (moveHorizontal > 0)
            transform.localScale = new Vector3(1, 1, 1);
        else if (moveHorizontal < 0)
            transform.localScale = new Vector3(-1, 1, 1);
    }
    
    void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Food"))
        {
            Destroy(other.gameObject);
            GameManager.instance.score += 10;
            exp++;
            if (exp >= expToLevelUp)
                LevelUp();
        }
        else if (other.CompareTag("Enemy"))
        {
            FishController enemyFish = other.GetComponent<FishController>();
            if (enemyFish.level > level)
            {
                GameManager.instance.life--;
                if (GameManager.instance.life <= 0)
                    GameManager.instance.GameOver();
            }
        }
    }
    
    void LevelUp()
    {
        level++;
        exp = 0;
        expToLevelUp *= 2;
        transform.localScale *= 1.2f;
    }
}
```

这个脚本挂在鱼的GameObject上，控制鱼的移动、碰撞检测和升级系统。

- Start()方法获取鱼的Rigidbody2D组件，用于物理运动
- Update()方法获取玩家输入，并对刚体施加力，同时控制鱼的朝向
- OnTriggerEnter2D()方法处理鱼的碰撞事件，吃食物会增加分数和经验值，碰到比自己大的鱼会减少生命值
- LevelUp()方法处理鱼的升级，提高等级并扩大鱼的尺寸

### 5.2 摄像机跟随脚本CameraFollow.cs

```csharp
using UnityEngine;

public class CameraFollow : MonoBehaviour
{
    public Transform target;
    public float smoothSpeed = 0.125f;
    
    void LateUpdate()
    {
        Vector3 desiredPosition = target.position;
        Vector3 smoothedPosition = Vector3.Lerp(transform.position, desiredPosition, smoothSpeed);
        transform.position = smoothedPosition;
    }
}
```

这