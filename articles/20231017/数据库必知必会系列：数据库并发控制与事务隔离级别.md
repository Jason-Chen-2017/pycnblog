
作者：禅与计算机程序设计艺术                    

# 1.背景介绍


随着互联网的快速发展和普及，网站访问量的日益增长已经引起了数据库的日渐关注。对于数据库的性能、可靠性、数据完整性和安全性，越来越多的人开始关心这个问题。比如互联网公司在应对高并发时需要考虑如何提升数据库的处理能力、数据库读写分离、主从复制等技术手段；银行、保险等金融机构在承受高并发请求时也要进行数据库的优化和事务隔离等措施来提升系统的处理能力和并发量。本系列文章将介绍数据库并发控制与事务隔离级别相关的知识和技术。
# 2.核心概念与联系
## 2.1 什么是并发控制
并发控制（Concurrency Control）是指通过对多个用户、任务或操作共享资源并发地访问数据库，并保证数据的一致性和正确性，确保系统运行正常的机制。并发控制是解决数据库系统中同时发生多个事务访问同一个资源时的相互影响的问题。并发控制可以分成两大类：
    * 强制性并发控制：即使没有并发访问，数据库也能保证数据的完整性和一致性，从而保证系统的稳定性；
    * 灵活性并发控制：当存在并发访问时，系统可以自动调整资源分配策略，提升系统整体的并发能力。
## 2.2 事务隔离级别
事务隔离（Transaction Isolation）是并发控制的一个重要方面，它定义了一个事务对数据库所作的修改，不被其他事务干扰的方式。数据库管理系统提供不同的事务隔离级别，按照隔离程度不同，数据库将提供不同的并发控制策略。
### 2.2.1 读已提交
最低的隔离级别，它确保一个事务只能看到该事务启动后产生的最新值，也就是该事务提交前的那个快照，隔离性最好，发生回滚、更新丢失的概率最小。但是读取时不能反映其他并发事务的执行结果，除非本身就是排他锁定的事务。所以，此级别的隔离性是"弱"的。
#### 脏读
一种现象：事务A读取到事务B还没有提交的数据，这称之为脏读。原因如下：
* 在事务A的读操作发生之前，事务B可能已经提交，导致事务A读取到的是旧的数据；
* 如果事务B回滚了，事务A依然认为自己读取到了“脏”数据，因为实际上它根本没读到；
* 脏读问题的严重程度取决于读操作和其他事务之间的关系。如果其他事务都只读操作，那么脏读问题不会出现；但如果存在其他事务的更新操作，则脏读可能带来一些隐患。
#### 不可重复读
一种现象：事务A在两次读取中看到的数据不一样，这称之为不可重复读。原因如下：
* 这是一个幻觉现象，事务A第一次读取到了某一行的数据；
* 然后事务B修改了这一行数据并提交；
* 接着事务A再次读取相同的数据，但却读到了另一组数据；
* 这是由于在两次读取过程中，事务B修改了同一条记录造成的。
#### 幻影读
一种现象：事务A在同一个事物内先后两次查询某些记录，第二次查询发现新的、没有在第一个查询中看到的数据，这称之为幻影读。原因如下：
* 这是由于MVCC(Multi-Version Concurrency Control)机制导致的一种现象，MVCC可以帮助事务在读取历史版本的数据。
* 当某行记录被更新时，旧的版本还是保留在数据库里，而新版本的数据只有在事务提交的时候才会清理掉。
* 如果多个事务在同一时刻查询同样的数据集，可能得到不一样的结果，这时就会产生幻影读。
### 2.2.2 可重复读
它的目的是防止同一事务的两次查询返回不同数据，即一个事务开始执行到提交前，其他事务不能插入、删除或修改该事务已经SELECT出的行。为了实现可重复读，数据库基于每行数据添加三个字段：
    * 悲观锁(Pessimistic Locking): 最悲观的一种锁机制，即在执行SQL语句前就给涉及的数据加锁，直到事务结束才释放锁。
    * 轻度锁(Lightweight Locking): 只锁定查询语句涉及的表，对查询结果没有任何影响。
    * 共享锁(Share Locks): 对查询结果有影响，允许多个事务同时读取同一份数据，但不能修改。
    * 排他锁(Exclusive Locks): 要求获得排他锁才能读取或修改数据。
这种锁机制能够避免并发事务对数据修改的冲突。读已提交和可重复读之间的区别是：读已提交隔离级别下，已提交事务中的其他事务的更新在本事务内都是可见的，而未提交的事务中的更新在本事务内是不可见的；而可重复读隔离级别下，已提交事务中的其他事务的更新在本事务内是不可见的，但未提交事务中的更新在本事务内是可见的。
#### Phantom Read
一种现象：事务A根据条件查询出来的结果集不是静态的，在第二次查询时记录增加或者删除，这称之为幻读。原因如下：
* 幻读的原因是多版本并发控制机制(MVCC)的限制，MVCC可以避免对同一份数据的并发访问，但是也可能会造成幻读现象。
* 比如事务A查询某个范围内的数据，结果集中的某条记录的事务标识符为1；
* 事务B向表中插入一行数据并指定事务ID为2；
* 事务A再次执行相同的查询，结果集变为2行；
* 此时，由于MVCC机制的限制，事务A只能看见自己的视图，因此看到新增的记录，并且不能再读出之前的记录。
#### 插入读
一种现象：一个事务在同一个事物内先后两次插入一条数据，第二次插入成功。原因如下：
* 插入读是指如果两个事务T1和T2分别插入一条记录R，并且都不提交，这样T2的插入便成功了。
* T1重新启动后，会以为插入操作失败，所以就会回滚掉之前的插入操作，导致T1的记录数据没有插入到数据库中。