
作者：禅与计算机程序设计艺术                    

# 1.简介
  

ZooKeeper是一个开源的分布式协调服务框架，它是Apache Hadoop项目的一个子模块，用于统一管理集群中节点信息、配置信息、域名映射等。ZooKeeper具有如下特性：

1. 分布式协调服务：它是一个基于主从模式的系统，任何一个服务器都可以参与协调工作。通过ZooKeeper，客户端应用程序能够对集群进行投票、配置维护或地址发现。
2. 可靠性保证：高可用、无单点故障、动态分配资源、限流熔断。
3. 顺序一致性：ZooKeeper 严格遵循“一次写入、多次读”原则，每个更新操作都会被复制到所有服务器，然后一次性通知所有客户端。同时，ZooKeeper 也支持会话特性，通过在客户端和服务器之间维持状态，可以让客户端更容易地实现相互依赖的功能。
4. 数据同步保证：提供数据发布/订阅机制，允许集群中的各个节点同时获取事件通知，增强集群内部的通信。
5. ACL权限控制：提供ACL（Access Control Lists）授权访问控制列表，用于控制对ZooKeeper集群中数据的访问权限。
6. 性能优化：针对读写请求进行了特别的优化，减少延迟、提升吞吐量、避免网络拥塞等。

# 2.基本概念术语说明
## 2.1 服务端角色
1. Follower（跟随者）：接受客户端请求，将写请求转发给 Leader。Follower 不参与决策，但是响应客户端请求。
2. Candidate（候选者）：在选举期间接收来自其他 Server 的投票。若获得过半数选票，则成为 Leader；否则继续竞选。
3. Leader（领导者）：主节点，负责处理客户端请求，向 Follower 服务器发送心跳包，参与投票。当 Leader 服务器出现问题时，可以由其他 Follower 服务器切换成新一轮的 Leader。
4. Observer（观察者）：不能直接参与投票过程，只响应客户端的请求，是一种低延迟的服务器角色。
## 2.2 会话
ZooKeeper 使用长连接，采用心跳检测与超时重连机制保证会话的有效性。Session 超时后，Client 与 Server 失去联系，需要重新连接才能继续使用。ZooKeeper 允许客户端设置 sessionTimeout 参数，来指定一个 session 过期时间。如果 Client 在指定的时间内没有任何操作，就会收到会话过期的消息，然后重新连接上次建立的 Session。
## 2.3 结点（znode）
ZooKeeper 使用数据模型来存储数据并管理节点。数据模型的最小单元是 znode，即“节点”。每个 znode 都包含数据，ACL 权限控制列表，时间戳和版本号。每个 znode 都有一个路径名，标识该节点在 ZooKeeper 中的位置。例如，/zk 标识 ZooKeeper 服务所在的根目录，/zk/foo 表示一个名字叫做 foo 的 znode 。路径名的语法非常简单，斜杠 (/) 是根目录的标识符，其它字符都是普通名称。
## 2.4 Watcher
Watcher 是 ZooKeeper 中用于监听通知的机制。客户端可以在指定节点上注册 Watcher，当该节点的数据发生变化或者ACL 权限被修改时， ZooKeeper 服务器会将事件通知到感兴趣的客户端。一个 Watcher 可以对特定路径下的子树或者节点进行设置，也可以对全局性事件进行监听，如连接状态的改变。
## 2.5 临时结点（ephemeral znode）
临时结点是一个短暂存在的 znode，在客户端与服务器的连接断开或者会话超时后，该 znode 也会自动删除。临时结点主要用于临时数据，比如会话对象，事件回调，临时锁等。临时结点无法创建子结点，只能通过父结点来进行寻址。
## 2.6 序列结点（sequential znode）
序列结点是一个带有唯一标志符的数据结构，其路径名末尾由一个数字标识。当创建一个新的结点时，ZooKeeper 会在其路径名末尾加上一个 10 进制的整数。这个整数是按照节点被创建的顺序生成的，不管路径名本身是否已经存在。这种结点类型可以用来构建有序集合。
## 2.7 版本（version）
ZooKeeper 支持数据版本化，对每次数据更新都会记录下版本号。版本号通过乐观并发控制（OCC）的方式进行检查，确保数据的完整性。每个 znode 有两个版本号，分别记录当前数据版本和最新数据版本。当客户端更新数据时，必须提供自己的版本号，如果和服务器保存的版本号不同，则更新失败。
## 2.8 临时顺序结点（ephemeral-sequential znode）
临时顺序结点是一个带有唯一标志符且和临时结点一起使用的 znode。路径名末尾同样由一个 10 进制的整数标识，该整数也是按照节点被创建的顺序生成的。这种结点类型的应用场景和临时结点类似，但要求每个 znode 的路径名都不同。
## 2.9 ACL 权限控制列表
ZooKeeper 提供了 ACL 机制来实现权限控制。每个 znode 都有自己的 ACL 列表，只有符合 ACL 规则的用户才可以对 znode 执行相关操作。默认情况下，ZooKeeper 为每个 znode 创建一个 ACL 列表，其中包括一个预设的管理员权限。除了管理员，还有三个预定义的权限模式可供选择：READ（读取），WRITE（写入），CREATE（创建）。可以针对不同的路径给予不同的 ACL 策略。
## 2.10 Quorum
Quorum（法定人数）是指能够容忍宕机或异常的服务器数量。对于一个一般的 ZooKeeper 集群而言，其节点数目至少应该是奇数个，这样可以使得多数派得到确认。例如，对于五台服务器的集群来说，最少需要 3 个服务器，才能形成一个可用的 Quorum。之所以规定是奇数个服务器，是因为每台服务器都有可能挂掉，因此需要取一个中间值，使得大多数的服务器能够正常工作。对于一个严格的 ZooKeeper 安装来说，建议安装奇数个服务器，从而实现容错能力。
## 2.11 Fault Tolerance（容错能力）
容错能力（Fault Tolerance）是指在遇到计算机、网络、设备等各种故障的时候仍然保持服务的能力。ZooKeeper 在设计之初就考虑到了容错能力的需求。为了保证高可用，ZooKeeper 在设计之初就把数据分片，多个服务器构成一个集群来共同对外提供服务。每个分片中都保存着相同的数据副本，这样当某个分片出现故障的时候，另外的分片依旧能够提供服务。并且，ZooKeeper 本身具备容错能力，无论是磁盘损坏、服务器崩溃还是网络问题等都会立刻发现并恢复服务。