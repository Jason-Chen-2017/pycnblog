
作者：禅与计算机程序设计艺术                    
                
                
## 概述
近几年随着无人驾驶汽车、机器人和图形学领域的爆炸式增长，GPU（Graphics Processing Unit）计算能力的显著提升已经成为行业热点。但是，目前很多针对GPU硬件的优化工作都集中在CPU端，导致芯片结构不够灵活、指令集架构（ISA）过于封闭、无法充分发挥芯片上的优势。而基于ASIC的GPU硬件，则可以完全重构架构，实现更高的计算效率和功耗比，提供更强大的功能特性。
同时，由于应用场景对功耗要求的高低，ASIC芯片通常面临着多种不同功耗模式下的优化，如静态电压放大器（Static Power-Up-Time）、动态电压放大器（Dynamic Power-Up-Time）、静止功率（Standby Power）等，它们对功耗的影响也会相应变化。因此，基于ASIC的GPU芯片的设计必然涉及到功耗模型、性能模型、体系结构模型和调度方法等方面的综合考虑。
本文将从以下四个方面进行阐述：
## 一、芯片架构
### 多核处理器架构
目前，多核处理器架构在ASIC上得到广泛应用。它通过将功能复杂的多核处理器拆分成多个小型的功能块并连接起来，形成一个整体的处理系统。这种架构的优点主要有：
- 提高了处理任务的并行性；
- 通过使每个核心模块的功能相对独立，降低了复杂度和资源利用率；
- 可以有效地解决性能瓶颈问题。
而缺点也很明显：
- 固态电路的制造难度较高；
- 需要更多的晶圆和元器件，增加了芯片面积和重量。
因此，在当前ASIC芯片尺寸和成本限制下，多核处理器架构仍是GPU芯片的首选。
### 矢量架构
矢量架构也称为向量处理架构，它将数据存储空间和计算资源分布到多个处理单元中，共同完成运算任务。矢量架构的特点是：
- 每个处理单元同时执行许多操作，形成矢量化的运算任务；
- 每个处理单元可以并行地运算各项任务，并共享数据；
- 使用较少的元素并具有更好的局部性，提升了运算效率。
不过，它的缺点也是很明显的：
- 矢量处理需要对指令集进行修改，增加了兼容性和开发难度；
- 不适用于对称矩阵乘法（Symmetric Matrix Multiplication），即使矩阵对称也不能获得较好的性能。
### 立方体架构
立方体架构是一种新型的三维处理架构，它将数据空间分布到一个体积较小的立方体中，通过数学变换实现数据的快速移动和计算。立方体架构的特点是：
- 每个处理单元都以坐标的方式与周围的处理单元进行通信，实现了全局的数据依赖关系；
- 能够有效地解决数据依赖问题，提升数据局部性和并行性；
- 可以进行超大规模的数据计算，有效应对多维数组和数据流处理。
但立方体架构也存在一些问题：
- 立方体内处理速度受限，无法充分发挥芯片的处理性能；
- 数据局部性不足，造成计算时延增加，且不能充分利用缓存，降低访存带宽。
### 混合架构
混合架构是一种既融合了多核处理器又融合了矢量架构和立方体架构的架构。它通过多种计算方式结合起来，提高芯片的处理性能。目前，比较流行的混合架构有GPU加速芯片，其基本结构包括支持多核的CMOS微电子架构、定制化的布线结构以及采用矢量和立方体架构的处理单元。虽然这种架构能够有效地提高计算性能，但同时也引入了新的问题。
## 二、功耗模型
### 静态电压放大器（SPUT）
静态电压放大器（Static Power-Up Time）是指ASIC芯片进入运行状态后，所需的时间，主要包括两部分：功耗供给时间（Power-up time）和资源供给时间（Resource-up time）。其中，资源供给时间是指用于初始化各种硬件资源所需的时间，如初始化晶圆电极、配置片上内存等；功耗供给时间是指芯片启动后的功耗激励时间，主要由外部功率放大器产生的“动力”负荷驱动芯片运行，如开关电源或者RF遥控信号。
静态电压放大器一般采用双稳态直流电源和电压放大器的组合形式。静态电压放大器的组成包括：功率管、负载管、内部网络、外部网络和电压放大器。其中，功率管是电源引出端直流电路，负载管是负责传输、传导、处理或放大信号的电路；内部网络是负责把信号转移到指定电路中的逻辑控制逻辑；外部网络是负责检测功率消耗情况和控制功率放大器的输出电压，如当功率消耗过高时关闭电源输出；电压放大器是电源引出端高压电路，通过适当的电压控制电路输出电压，达到功率放大效果。
静态电压放大器作为ASIC芯片的起始过程，只占用了芯片少数的硬件资源，且初始功耗较低。因此，它的功耗控制是非常简单和直接的。
### 动态电压放大器（DUPT）
动态电压放大器（Dynamic Power-Up Time）是指ASIC芯ptime芯片进入运行状态后，保持常规功耗状态所需的时间。动态电压放大器的组成包括：功率放大器、驱动电路和放大电路。功率放大器是电源引出端高压电路，通过功率感应器和PWM控制功率放大倍数；驱动电路接收电压放大器的PWM信号，驱动电压放大器转动和工作，达到功率放大目的。
动态电压放大器的优势在于不需要维护静止功耗，可根据需求调整功率放大器的输出功率，进一步降低静止功耗，降低了ASIC芯片的整体成本。但动态电压放大器的关键是其电压放大环节。
动态电压放大器的电压放大环节包括三个阶段：“安定期”、“波峰期”和“波谷期”。在“安定期”，电压放大器持续工作至输出稳定，完成电压控制器的工作；在“波峰期”，电压放大器持续工作，在给定的输出电压范围内发生最大的转矩，达到最大电压峰值；在“波谷期”，电压放大器停止工作，电压输出小于给定的输出电压范围，达到最小电压谷值。
动态电压放大器通过在“安定期”、“波峰期”和“波谷期”中调节电压输出范围，进一步降低功耗。但是，其频繁切换工作模式可能会增加电压放大器的计算复杂度。此外，如果芯片自身遇到突发事件导致功率耗尽，动态电压放大器可能无法自行恢复，而需要靠用户手动介入恢复。因此，动态电压放大器仍处于探索阶段。
### 静止功耗（STP）
静止功耗（Standby Power）是指芯片处于非活动状态时所消耗的电量。它是典型的动态电流功耗模型，由几个动态电流模型的叠加组成，具体包括：静态静止功耗模型、动态静止功耗模型、空载静止功耗模型和测试静止功耗模型。静态静止功耗模型指指示灯在闪烁时所消耗的功率，如CRT显示屏在不断刷新时所耗电力；动态静止功cosXf和测试静止功耗模型指ASIC设备每秒钟的运行功耗，如微波炉每秒反复加热所消耗的能量。
静止功耗模型的假设是，芯片在一个稳态的运行状态，静态静止功耗、动态静止功耗和测试静止功耗都是通过电压表测量得到。动态电流模型假设了电流的两种角色：短时电流，表示芯片的固定电流；长时电流，表示芯片在运行过程中通过各种信号或运算产生的电流。静止功耗模型的目标是确定静止功耗模型中的参数，这些参数可以用来估计整个芯片的停机功耗。
静态静止功耗模型的参数只有一个，即“闪烁时所耗电流”，单位为mA。静态静止功耗模型的误差范围约为±0.5%。动态静止功耗模型的模型参数有两个，分别是“一次长时电流”和“短时电流”。短时电流单位为mA，一次长时电流单位为uA。测试静止功耗模型中也只有一个参数“测试时长”，表示测试结束后芯片保持运行的时间，单位为s。静止功耗模型的精度通常为±0.2%左右。
静止功耗模型的优点是能准确估计静止功耗，但其缺点在于不太能估计长时电流。另外，静止功耗模型不适用于ASIC设备长期待机状态，因为它们的运行时间往往超过一天。
### 浮动功耗（FP）
浮动功耗（Floating Power）是指芯片任意时刻均匀且不平衡地工作，但总体上保持某个状态的功耗，这个状态可以定义为“充电”或者“待机”。浮动功耗模型通过统计和分析动态功耗、交流电流、电压、温度等数据来估计浮动功耗，并将其切入到功耗模型的静态、动态、静止和测试静止功耗模型之中。
浮动功耗模型的统计方法一般有两种：脉冲响应曲线法和计数法。脉冲响应曲线法利用FFT（Fast Fourier Transform）或相关方法，将电压、电流、温度等信号的变化与所谓的脉冲谐波的频率成正比拟合成一张功耗图，并通过拟合出的曲线估计静止功耗。计数法通过计数脉冲响应出现的时间、长度和次数，估计每秒钟总体脉冲数量，然后结合电流和电压平均值来计算静止功耗。计数法的优点在于能够估计长时电流，但缺点是计算量大。
在ASIC设计中，浮动功耗模型可以直接影响功耗估算结果，例如设计误差、泄露电流、缺陷电阻等。因此，除非仔细设计芯片，避免浮动功耗模型带来的影响，否则需要格外注意。
## 三、性能模型
### 基准性能模型
基准性能模型（Baseline Performance Model）是评价计算机性能的一种重要模型。它对CPU性能的测量方法主要包括：单线程性能，多线程性能，GPU性能和并行计算性能。
单线程性能是在最简单的条件下，通过程序单步执行的吞吐量、响应时间、指令周期等性能指标，测量单个处理器的运行性能。多线程性能是在多核CPU上，通过多个线程并发执行程序的吞吐量、响应时间、指令周期等性能指标，测量多核CPU的运行性能。GPU性能则是在GPU上，通过像素处理，计算能力和资源利用率等性能指标，测量GPU的运行性能。并行计算性能则是通过并行执行多个任务的吞吐量、响应时间等性能指标，评价系统在多个处理器间的并行计算性能。
基准性能模型可以帮助我们理解计算机处理能力的演变。早期的单核处理器运行在慢速的微处理器上，只能执行诸如单指令、流水线指令和微指令等简单指令，无法处理大量数据。到90年代初，有些CPU厂商开始投资多核处理器，并采用多核处理器的方案对性能进行改进。到了2000年代初，多核处理器的发展已经较为成熟，在计算能力上逐渐超过单核处理器。但是，多核处理器依旧无法提供高计算能力。2010年代，一些公司推出了GPU，基于矢量、立方体或其他架构的计算芯片，由于无需等待而能实时响应用户的请求，因此逐渐取代CPU成为主流的计算平台。
### 计时模型
计时模型（Timing Model）是对系统硬件和软件的系统性能进行测量的方法。它通过仿真、实验、测量和分析等方式，对系统在各种环境和负载下的性能进行评测。计时模型的主要目的是捕捉系统的处理时间、流水线饱和度、时钟周期、数据通路利用率、核心流水线利用率、时延等关键性能指标。
计时模型的关键指标有：处理时间、流水线饱和度、时钟周期、数据通路利用率、核心流水线利用率、时延等。这些指标是基于系统的处理、数据处理和计算的综合评测。处理时间是指系统完成指令的总时间，包括指令队列的等待时间、指令的发送时间、指令的执行时间等。流水线饱和度是指在一个时钟周期内，能同时在流水线中执行的指令数量。时钟周期是指计算机内部时钟信号的周期。数据通路利用率是指在一段时间内，处理器所需的总数据流的比例。核心流水线利用率是指计算核所使用的核心流水线数量的占比。时延是指系统中各个时序单元之间的延迟。
计时模型的主要弊端是无法预测或改善性能。所以，要将真实系统与计时模型进行比较，才能够洞察系统的性能瓶颈所在，并制定正确的优化措施。
### 模型比较
两种不同的性能模型，它们之间是否存在联系？它们各自适用于哪些方面？在何种情况下应该采用哪种性能模型？

