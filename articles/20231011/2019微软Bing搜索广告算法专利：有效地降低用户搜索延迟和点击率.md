
作者：禅与计算机程序设计艺术                    

# 1.背景介绍


## 概述
微软于2016年推出了面向用户的搜索引擎Bing，并推出了面向企业的Azure Marketplace，其中包括用于为客户提供商业应用和服务的免费应用库。为了帮助客户快速发现和使用这些商业应用程序，微软的广告业务部门投入了大量的人力和财力，开发了多种广告投放方法来吸引目标受众，其中的一个主要方法就是通过Bing搜索结果页进行广告投放。然而，随着时间的推移，广告效果也越来越差。因此，Bing搜索广告业务部门要加强对其广告算法的管理，提升用户体验，并改善广告效益。为了提升用户体验，Bing搜索广告业务部门需要根据用户当前的搜索行为、历史搜索记录及相关竞品数据等因素实时调整广告投放策略，使得广告主在尽可能短的时间内获得高质量的广告投放。此外，Bing搜索广告业务部门还需要优化广告内容，利用户收到更符合其需求的广告，增加用户黏性，提升用户满意度。综上所述，微软Bing搜索广告算法专利（WP24021-2019）的目的就是为了通过设计有效的算法来降低用户搜索延迟和点击率。

## Bing搜索广告算法原理
Bing搜索广告的核心目的是为了在最短的时间内给用户返回精准和有效的信息，所以Bing搜索广告算法的关键就是在不中断用户正常的搜索习惯情况下快速找到相关信息。目前Bing搜索的推荐结果是由两种不同的方式组合而成，一是基于搜索词、位置信息、设备类型、搜索历史等的相关性模型，二是基于用户喜好、偏好、行为习惯、消费习惯等的个性化模型。两个模型各自占据不同的优势，相关性模型能够较快找到相似或相关的内容，但它的缺陷是容易失去用户的兴趣。而个性化模型能够满足用户的个性化需求，但是因为无法捕获用户的长期喜好，往往导致广告被传播的太广泛。Bing搜索广告算法的基本思路可以概括为：在不改变用户搜索习惯的前提下，通过对广告的精准投放来实现最高的点击率。算法的核心可以分为两步：第一步，对候选广告进行排序，确保用户可以快速看到有价值的内容；第二步，对于每个用户的搜索行为及浏览记录，优化广告的投放策略，确保每个人都能从中得到最佳的广告效果。
### 一、关联性模型
关联性模型以用户的搜索词、位置信息、设备类型、搜索历史、网页标题等作为输入变量，将它们与用户的相关性做匹配。关联性模型首先会将用户的查询词与广告库里已有的广告词进行相似度计算，找出最相似的广告。然后，模型还会考虑用户所在城市、网络类型、设备类型等信息，进一步筛选适合用户的广告。这种方式的优点是可以快速找到相关的内容，但缺点是广告的推荐太过局限。例如，如果用户搜索“iphone”，却只能看到苹果公司的广告，这就无异于是在忽视其他品牌的广告。
### 二、个性化模型
个性化模型是Bing搜索广告中另一种重要模型，它以用户的喜好、偏好、行为习惯、消费习惯等方面的数据作为输入，通过分析用户的搜索行为、浏览记录、购买习惯等，找到相应的广告。它首先会收集用户的搜索记录、查看的网页、停留时间、访问频次、喜爱的内容、喜欢的品牌等数据，然后利用这些数据进行训练，建立用户画像模型。之后，当用户进行新的搜索时，系统会根据用户画像模型进行广告推荐。这种方式的优点是能够更好地满足用户的个性化需求，但同时也引入了新的算法复杂度。由于用户画像模型涉及隐私问题，Bing搜索广告业务部门需要保证用户的隐私权，并且要求广告主遵守相关法律法规。

# 2.核心概念与联系
## 广告位（Ad Positions）
广告位就是将广告展示的位置。通常是显示在搜索结果页面的不同位置，比如顶部、侧边栏等。在搜索结果页面，一般会存在多个广告位，用来展示不同类型的广告。如图1所示，Bing搜索结果页面一般有12个广告位。
图1 Bing搜索结果页面广告位布局示意图
## 搜索事件（Search Events）
搜索事件指的是用户执行搜索时的行为，包括搜索词、搜索日期、设备类型、IP地址、搜索区域等。搜索事件通过观察用户的行为模式，以及与其他广告主、竞品进行比较，获取用户的搜索习惯，结合Bing的推荐算法进行推荐。
## 用户画像（User Profiles）
用户画像是指基于用户的搜索、浏览、购买、交流行为等数据，通过分析历史数据和现有数据，生成用户画像。用户画像包含了很多特征，如用户年龄、职业、爱好、居住城市、消费水平等。
## 召回算法（Recall Algorithms）
召回算法是指用来给用户推荐广告的算法。它从用户的搜索记录、感兴趣领域、上下文环境、搜索设备等数据中抽取有用信息，生成用户的兴趣列表。然后，召回算法基于用户的兴趣列表，找到与其最相关的广告。一般来说，召回算法分为精准召回（Exact Recall）和近似召回（Approximate Recall）。精准召回是指通过关键字、地理位置等各种条件进行精确查找，只推荐那些可以完全覆盖用户兴趣的广告；近似召回则是对用户的兴趣进行建模，使用基于规则的、机器学习的方法推荐可靠的广告。
## 排序算法（Rank Algorithms）
排序算法是指决定推荐哪些广告给用户的算法。排序算法首先会评估用户与每个广告的相似度，然后选择最合适的广告进行展示。排序算法的重要目的是确定每个广告的展示顺序，使用户可以在最短的时间内获得最优的广告。一般来说，排序算法可以分为精确排名（Exact Ranking）和近似排名（Approximate Ranking）。精确排名通过对用户的搜索和行为进行细粒度的监控，计算用户与每个广告的相似度，给出推荐结果；近似排名则通过规则、机器学习的方法来估计用户与广告的相似度，给出推荐结果。
# 3.核心算法原理和具体操作步骤以及数学模型公式详细讲解
## （一）关联性模型
### 1.准备工作
关联性模型的输入变量如下：

1. Query：搜索词；

2. Location：用户所在的城市；

3. Device Type：用户使用的设备类型；

4. Search History：用户最近的十条搜索记录；

5. Ad Title：广告标题。

6. Ad Text：广告文本。

先对用户的Query进行分词处理，即将搜索词转换为一系列的单词。再读取广告库，从中选择相关性最高的广告。将广告的Title和Text拼接起来，然后使用编辑距离算法计算Title和Query之间的距离和Text和Query之间的距离，找出最小的距离作为相似度。过滤掉广告的长度、标志性词等。将用户的Location、Device Type、Search History等信息进行合并，最后计算用户的平均相似度。
### 2.模型公式

计算Query的相似度：设Q为Query的分词表示，A为广告的标题、文本分词表示，则编辑距离距离d(Q, A)定义为：

d(Q, A)=min( |len(Q)-len(A)|, min{ i: q_i \neq a_i } )

模型的目标是求解Q与广告库中所有广告的相似度，也就是求min_{A} d(Q, A)。根据定义，我们可以把问题转化成了一个序列距离问题。设AD为广告库，A=ad(j), j = 1, 2,..., m。对每个广告A，我们都可以计算出Q与A的距离，也就是d(Q, AD_j)，并把它们按从小到大的顺序排列。对第k(k<m)个元素，我们可以计算出第k个元素与其他元素的距离，设D(i, k)=d(ad_i, ad_k)。于是，对于每个广告A，可以计算出Q与该广告的相似度sim(A, Q):

sim(A, Q)=1/(1+max{i=1}^{|AD|-1}(D(i, j)/m)^2), for all ads j in AD. 

其中，|AD|=m表示广告库中的广告个数。sim(A, Q)是一个介于0~1之间的数，表示Q与A的相似度，值越大表示Q与A越相似，相反则说明相似度越低。最终，我们选择相似度最高的广告作为候选广告。

对于多余的广告库广告，直接跳过即可。

计算Query与Location、Device Type、Search History等特征的相似度：先把它们合并，然后计算合并后的特征的相似度。由于不同搜索历史对应不同的用户兴趣，因此合并的过程可能会丢失用户真正感兴趣的内容。因此，Bing搜索广告业务部门建议只采用词汇特征和位置特征。
### 3.问题
#### 3.1.广告库广告数量少，模型效果如何？
关联性模型很难用于广告库广告数量少的情况，原因有以下几点：

1. 广告库广告数量少，模型的性能表现可能会比较差；

2. 模型的特征维度较低，不能够捕捉到广告的一些特定的信息，比如广告的样式和主题；

3. 查询词本身对广告的影响也是不可忽略的。

#### 3.2.用户的喜好、偏好、行为习惯、消费习惯是怎么影响广告效果的？
与个性化模型类似，用户的喜好、偏好、行为习惯、消费习惯也是影响广告效果的重要因素。个性化模型利用用户的行为习惯对广告进行推荐，可以更好的满足用户的个性化需求。但是，虽然个性化模型能够反映用户的偏好，但同时也引入了新的复杂度。广告主应该在充分了解用户偏好的情况下进行广告投放。另外，个性化模型的训练数据集也存在偏置问题，这可能导致用户的广告偏好与实际偏好之间产生误差，这可能会影响广告的效果。因此，在广告投放中，Bing搜索广告业务部门应优先考虑基于查询的广告投放，以满足用户的需求。