
作者：禅与计算机程序设计艺术                    

# 1.简介
  

在软件开发过程中，经常会出现两类设计模式：命令查询责任分离（Command-Query Responsibility Segregation）CQRS模式和创建、读取、更新、删除（Create–Read–Update–Delete）CRUD模式。那么什么时候该选择CQRS模式，什么时候该选择CRUD模式呢？这两个模式到底有什么区别？下面我们将通过一个电商系统中的例子来对CQRS和CRUD进行深入剖析。
# 2.命令查询责任分离模式（CQRS Pattern）
CQRS模式由<NAME>于2009年提出，它是一种用于实现“将数据更新请求从客户端分离”的软件设计模式。在CQRS模式下，数据处理分成两种角色：命令端和查询端。命令端负责处理所有数据更新事务，如新增订单、取消订单等；而查询端则只负责响应用户查询请求，并返回最新的结果数据。其特点是确保数据一致性，数据存储和修改操作分开。图1展示了CQRS模式的示意图。
图1 命令查询责任分离模式示意图

# 3.创建、读取、更新、删除模式（CRUD Pattern）
CRUD模式通常指的就是指一套操作数据的模型化方法论，包括四个方面：

1. Create - 创建（Create）表示向集合添加新资源（比如，创建一个订单）。
2. Read - 读取（Read）表示获取一个资源集合（比如，查询订单列表），或者获取单个资源（比如，查看某条订单详情）。
3. Update - 更新（Update）表示更新资源（比如，修改某个订单信息）。
4. Delete - 删除（Delete）表示删除资源（比如，删除某个订单）。

图2展示了CRUD模式的示意图。
图2 创建、读取、更新、删除模式示意图

# 4.案例分析
电商系统是一个非常典型的应用场景。例如淘宝，当我们想要购买商品时，需要先添加到购物车，然后再去结算确认订单。如果我们直接用这种方式，在任何一步操作失败的时候都会导致数据不一致的问题。所以在电商系统中，一般都会采用CQRS模式，即命令端用来处理所有数据更新事务，查询端仅用于响应查询请求。图3展示了电商系统中的CQRS模式架构图。
图3 电商系统中的CQRS模式架构图

假设在电商系统中，命令端和查询端分别采用不同的编程语言编写，如Java和JavaScript。那么对于相同的数据，是否可以同时部署两个系统实例来提供服务呢？可以的！但是这样会导致资源的浪费，而且会给性能造成影响。因此，为了避免资源的浪费，一般情况下我们会将这两个系统部署在同一个服务器上，并通过RPC（Remote Procedure Call，远程过程调用）的方式来通信。这样就可以避免系统间的依赖，提升整体的性能。

# 5.何时该使用CQRS模式？何时该使用CRUD模式？
总的来说，CQRS模式和CRUD模式都可以实现数据的更新和查询操作，但是它们又各有优缺点。无论是哪种模式，都会涉及到以下三个方面：

## A. 数据一致性
CQRS模式在架构上划分了命令端和查询端，使得数据一致性问题得到了很好的解决。命令端的所有数据更新事务都要求一定成功或失败，如果失败了就回滚，不会产生数据不一致的情况。

## B. 数据访问方式
CRUD模式下的所有数据操作都需要访问同一张表，查询和修改都需要访问同一份数据，这让开发人员容易理解和维护。但是CQRS模式下，不同角色的数据库还是会有所差异，如果数据访问方式有差异的话，可能会引入一些复杂性。

## C. 系统复杂性
命令查询责任分离模式往往更加复杂，因为它需要额外的组件和机制来实现数据分片、分流、事务管理、事件溯源等功能。但是对于大多数应用来说，这样的额外工作其实也是可以接受的。

综上所述，在实际的应用中，二者之间需要根据具体需求进行取舍。但无论如何，无论是CQRS模式还是CRUD模式，都不能完全取代另一方。只有在不同角色具有完全独立的数据存储且资源受限的情况下，才可以使用CRUD模式。