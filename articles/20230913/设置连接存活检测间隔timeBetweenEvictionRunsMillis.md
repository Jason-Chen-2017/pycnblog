
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 什么是存活检测？
在系统设计中，为保证服务器性能稳定、可用性高效、并及时释放资源，需要设置连接存活检测（Connection Liveness Detection）。主要目的就是为了识别已经失效或者僵尸的网络连接，从而及时断开。
## 为什么要设置连接存 aliveDetectionIntervalMillis
系统设计者在设置存活检测间隔 timeBetweenEvolutionRunsMillis 时，一般可以考虑三个方面：

1. 从用户角度：用户希望能够快速发现失效连接，对系统整体的吞吐量和响应时间有影响。

2. 从系统角度：当出现大量的失效连接时，可调低该参数，减少系统内存占用，提升系统整体处理能力。

3. 从开发角度：对于某些长期运行的应用来说，每秒检查一次连接是否存活会带来巨大的资源开销，甚至可能导致系统崩溃。因此，可以通过减小该参数来优化系统资源的利用率，提升系统的并发处理能力。

## 概念术语说明
### Connection Liveness Detection（存活检测）
在计算机网络中，基于TCP协议实现的连接存活检测技术叫作Connection Liveness Detection（CLD），它通过周期性的发送探测报文（称为 Keep-Alive Packets）来监控远程主机的连接是否仍然有效。如果监测到某个连接在指定的时间段内没有收到数据包的回应，则认为该连接已断开。在CLD中，存在两种方式来实现：一种是客户端主动向服务器端发送KeepAlive Packets；另一种是服务器端定时向客户端发送请求，要求客户端返回保持连接状态。

### Keep-Alive Packets（保活报文）
Keep-Alive Packets是由HTTP/1.1规定的一个控制报文类型，用于确保HTTP/1.1连接不中断。通常情况下，KeepAlive Packets也被用于FTP等非TCP协议的连接，例如Telnet和SSH。当一个TCP连接建立后，若在一定时间内（一般是30分钟）没有任何数据传输，则会自动发送一个KeepAlive Packet，用于通知对方本端仍处于正常通信状态。接收到KeepAlive Packet之后，对端将不会立即关闭连接，而是等待一段时间（一般是240秒）后再关闭连接。

### 轮询检测策略
最简单的一种轮询检测策略是每隔一个固定时间就向远程主机发送一个请求，要求其返回保持连接状态。这种方法的缺点是频繁地发送请求会造成额外的网络流量开销。另一种更加复杂的轮询检测策略是维护一张表格，记录了所有活动连接的相关信息，包括：当前的状态（如Open或Close）、最后的活动时间戳、连接的持续时间等。这样可以实时的监控每个连接的状态，同时也可以根据连接的状态及时清除无效的连接。但维护连接状态的表格也会消耗更多的系统资源。总的来说，目前的网络连接管理技术还属于比较传统的手工方式，虽然它可以解决绝大多数的问题，但其检测过程仍然是不可避免地需要耗费一些系统资源。

### 检测间隔 timeBetweenEvictionRunsMillis
存活检测间隔 timeBetweenEvolutionRunsMillis 是指连接检测线程（Connection liveness detection thread）执行的时间间隔。如果设置为0，则表示关闭连接存活检测功能。值得注意的是，该时间间隔并不能完全做到实时检测失效连接，因为每个连接都有自己的检测超时时间。另外，当系统资源紧张的时候，检测间隔也可能设置为很短的几十毫秒。此外，即使设置了较大的检测间隔，仍然无法完全防止因网络故障或其他原因导致的连接断开，所以在实际环境中，还需结合其他手段，如重试机制、连接池等进行补充。