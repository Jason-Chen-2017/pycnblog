
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 什么是WebRTC？
WebRTC 是一种基于互联网通信技术，可在浏览器之间进行点对点（Peer-to-Peer）或多人（Multi-party）实时视频音频流的传输。可以用它建立一个视频聊天、视频会议、远程协作工具、即时通信应用等。简单来说，它是一个开发框架，用于开发能够在 Web 浏览器上进行点对点或多人实时通信的应用程序。

## 为什么要用WebRTC？
WebRTC 提供了最广泛的支持，几乎所有主流浏览器都内置了它的支持，因此，WebRTC 可以帮助开发者更容易地为用户提供实时通话功能。除此之外，WebRTC 的高效率和低延迟也使其成为现代视频会议、电子白板共享、网络游戏、直播服务、视频监控等实时通信场景的关键技术。

## WebRTC的主要特点有哪些？
* 支持多种视频编解码器：WebRTC 可以利用众多的视频编解码器来实现视频的编码与解码，从而让视频的传输更加顺畅。当前，包括 VP8、H.264/AVC、VP9、H.265/HEVC、AV1、MPEG-4 Part 2、Theora/Vorbis 和 MP3。这些编解码器均采用开放的标准协议并被多个浏览器厂商支持。

* 支持多种音频编解码器：除了视频编解码器外，WebRTC 还支持音频的编码与解码。它提供了对主流音频编解码器的支持，如 Opus、iLBC、G.711/ADPCM、MP3、GSM、AAC、AMR 和 iSAC。

* 轻量级架构：WebRTC 使用了一个轻量级的架构，这意味着它占用的内存很少，可以在移动设备上运行。同时，它也支持防火墙穿透功能，允许通过公共互联网连接到其他网站。

* 快速建立连接：WebRTC 在第一次调用时，只需要做一些简单的握手就可以建立连接，之后所有的媒体数据都是实时的。所以，不需要像传统的 P2P 技术那样耗费时间等待响应。

* 满足实时通信需求：WebRTC 可以处理各种实时通信场景，比如语音呼叫、视频会议、视频聊天、电子白板共享、网页游戏、视频监控等。WebRTC 已经成为企业、政府、媒体、互联网公司、研究机构等不同行业领域中的标准技术。

# 2.基本概念术语说明
## ICE(Interactive Connectivity Establishment)协议
ICE(Interactive Connectivity Establishment)，交互式连接建立机制，在NAT(Network Address Translation，网络地址转换)环境中，用于自动选择最佳的源IP地址。ICE协议由两部分组成：Agent、Controlling Agent。

Agent：用来收集本地网络信息并向远端Candidate发送请求报文。

Controlling Agent：负责维护通信路线，它会决定如何连接两个网络节点。Controlling Agent可以使用如下算法：

1. 优先级排序算法：首先按照优先级顺序确定候选的IP地址。

2. 利用STUN服务器查询NAT类型及映射端口。

3. 使用TURN服务器转发数据。

Candidate：收集到的本地网络信息，包括IP地址、端口号、类型（host表示主机、srflx表示服务器代理、prflx表示客户端代理）。

ICE协议工作流程：

1. Agent在接收到远端Candidate时，将该Candidate加入优先级队列。

2. Controlling Agent根据NAT类型及实际情况，向候选列表中取出符合条件的Candidate进行尝试。

3. Candidate会向Controlling Agent返回自己所支持的参数，Controlling Agent根据参数决定是否进行连接。

4. 当连接建立完成后，Controlling Agent根据往返时间RTT及时调整信令调度策略。

## SDP协议
SDP(Session Description Protocol)，会话描述协议，它定义了由会话（会话参与者的网络配置、能力、媒体特性、时序和同步约束）及内容（媒体流及各媒体流编码参数）等相关内容组成的会话视图。SDP包含以下三部分：

### 会话视图
会话视图描述了参与者之间的协商过程，即：

1. IP地址：每个参与者的IP地址。

2. 时钟同步：用于协商时钟偏差。

3. 安全性：加密密钥。

4. 媒体流：希望传送的数据，包括媒体类型、方向、持续时间、格式、帧大小等。

### 媒体流描述
媒体流描述了一段完整的音视频流，包含以下四个部分：

1. 描述信息：包含媒体类型、方向、持续时间、格式、帧大小等。

2. 控制信息：包含质量参数、压缩参数、RTP头部信息等。

3. 媒体数据：由RTP载荷组成，通常每个RTP包承载1500字节的数据。

4. RTCP报告：包括传输统计信息、丢包率信息等。

## STUN协议
STUN(Session Traversal Utilities for NAT)，用于NAT(Network Address Translation，网络地址转换)Traversal的协议，它用来在穿越NAT的情况下，获取外部IP地址，它是UDP协议。STUN协议可以为客户端发现服务端的IP地址，也可以用来测试NAT的穿越能力。

## TURN协议
TURN(Traversal Using Relay NAT)，中继NAT穿越协议，它在NAT环境下，实现了媒体数据的传输。TURN协议的工作原理是在中继服务器中转发媒体数据。TURN协议可用于解决穿越不支持STUN协议的NAT环境下的媒体流传输。

## 数据通道
WebRTC使用专门的数据通道来传输媒体流数据，目前支持两种类型的媒体流：

### 用户数据报协议 UDP
UDP协议是无连接协议，它直接将数据包发送至目标计算机，并且不保证对方是否收到或者正确处理，因此适用于实时通信场景中对延迟要求较低的场合。在实时通信中，当媒体数据量比较大时，一般使用UDP数据通道。

### 可靠传输协议 RTP
RTP(Realtime Transport Protocol)协议是专门针对视频流传输设计的协议，它通过底层传输网络对媒体数据进行打包、分割、重传等工作，确保媒体的可靠传输。RTP协议与UDP协议配合使用，以保证媒体数据的高速传输。