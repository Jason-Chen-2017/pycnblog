
作者：禅与计算机程序设计艺术                    

# 1.简介
  

Optane是英特尔（Intel）开发的一系列基于非易失性DRAM的新一代高性能存储技术。其中最主要的产品就是Intel Optane DC Persistent Memory(OPTM)系列。OPTME内存可以让用户在长时间的持续运行下降电压时不丢失数据。它是一种在不需要永久性的存储介质上保持数据的快速访问能力。OPTME通过将多个内存颗粒（3D XPoint颗粒）连接到一块主控芯片中，将它们的容量扩展至几百GB到TB级别，并实现高带宽低延迟的访问速度。另外，OPTME支持直接存取、快速擦除、可编程的校验和等功能，具有安全性、持久性、可靠性等突出特征。当前，由于众多的应用场景对OPTME内存的需求，并且发布了开源工具包如Libpmem和Pmdk来进行开发和测试，因此，越来越多的人开始关注OPTME内存相关的技术。
本文旨在通过系统地阐述OPTME内存的相关原理及其特性，让读者能够更好地理解和应用这个领域的最新技术。希望能够帮助读者正确认识和运用OPTME内存，建立对OPTME内存的正确认识。
# 2.基本概念及术语
## 2.1 优化缓存
在传统的内存体系结构中，CPU访问内存的数据会先经过一层叫做cache的数据缓存，然后再送往主存中进行获取。而随着内存的发展，新的内存设备越来越多，比如RAM、DDR3、DDR4等等，也都有类似的架构。只是这些内存设备的速度快慢有所差别。比如，主存的速度是常数级，但是通过cache的作用将内存访问的速度提升到了几十纳秒甚至微秒级。而且CPU每次执行指令都会把访问的地址和数据加载到cache里面，这样就可以避免多次访问主存，提高缓存命率。这样的设计使得CPU访问内存的速度达到了近似的常数级，但实际上由于cache大小限制，cache无法同时装载所有的内存数据。所以当需要访问的数据不在cache中时，就会导致cache miss，需要等待cache中的数据被替换掉才能继续工作。
## 2.2 DRAM
DRAM（Dynamic Random-Access Memory）是一种动态随机访问存储器，它的存储单元可以储存多个二进制位。它由可逆转的存储元件组成，每个元件都可以独立于其他单元进行读取或写入。DRAM由一个存储元素阵列和一个刷新电路组成。数组的每一个存储元素被组织成为行列式结构，同时还包括一组控制逻辑。每个存储元素有一个地址线和一组数据线，可以根据地址线来进行单独的读取或写入。主存中的所有数据都是通过这种方式访问的。DRAM存储单元的主要缺点是容易损坏、价格昂贵、功耗较高。然而，因为它的随机访问特性，DRAM能够提供良好的性能，尤其是在内存访问模式为顺序访问或随机访问时。
## 2.3 非易失性
非易失性（Volatile）意味着数据只在发生改变时才被写入磁盘。比如，一块手机上的照片只要不删除就一直存在手机内部，直到电池耗尽或手机换代，照片数据才会消失。非易失性内存通常由闪存或NVMe SSD等固态硬盘组成。随着科技的发展，越来越多的非易失性内存正在崛起。无论是极速非易失性内存（eNVM）还是闪存颗粒化存储器（SSDS），都可以提供比传统DRAM更大的容量和更快的访问速度。
## 2.4 可编程存储器
可编程存储器（Programmable Storage Device，即PSD）是一个由存储设备控制的计算机资源。一般来说，可编程存储器可以用来存储数据、执行程序和完成各种计算任务。在最近几年，随着摩尔定律逐渐趋缓，运算能力开始变得越来越强，而存储容量却始终保持在同样的数量级。那么，如果可以在计算过程中不需要太多的访问时间，而能减少整机停机时间、节省空间、缩短排队时间、提升资源利用率等效果，将会是个什么情况呢？那么，是否可以通过在存储介质上执行一些计算任务来实现这些效果呢？目前，可编程存储器仍处于实验阶段，但随着硬件技术的进步，它们的应用前景应该越来越广泛。
## 2.5 可预测访问时间
对于静态内存来说，其访问时间由外设接口的时钟频率决定。也就是说，一个固定大小的块数据只能被读取或写入一次，之后该块数据又回到空闲状态。但是对于动态内存来说，情况就不一样了。动态内存中的数据可以被重复读取或写入，且速度也非常快。为了让应用程序在任何时候都能快速访问任意位置的数据，就需要确保这些数据的访问时间是可预测的。
## 2.6 比较学习曲线
比较学习曲线（Competency Curve）是描述某一类人群接受新知识的难度和获得新知识所需的经验的时间之间的关系。其横坐标表示已经掌握的知识水平，纵坐标表示将要学习的知识的难度。在衡量学习难度的时候，就必须考虑到不同人的学习效率、错误率、记忆力等因素。常用的学习曲线如下图所示：
在这个学习曲线中，红色曲线表示刚刚开始学习新知识时的状态；蓝色曲线表示接受新知识后能很快掌握的状态；绿色曲线表示熟练掌握某项知识时的状态；黄色曲线表示长期积累的经验时的状态。在学习曲线的上下限之间，还有各种各样的学习路径可以选择，例如只想掌握最基础的内容，也可以从中选取适合自己的路径。在大多数情况下，增加新知识的难度会让学习效率下降，不过反之亦然。所以，如何平衡新知识的学习难度和已有的知识水平，是一门博弈游戏。
## 2.7 三级缓存
三级缓存（Cache）是缓存中常用的一种分层结构，其组织形式为L1 cache、L2 cache和主存。其优点是，不同的缓存可以存储不同的数据集，从而有效地分配内存访问带宽，减少冲突，并提高总线利用率。三级缓存架构的三级缓存中，L1 Cache占据了系统最重要的资源，因此在使用L1 Cache之前，应该首先确定应用程序的内存访问模式。
## 2.8 时序局部性
时序局部性（Temporal Locality）是指当CPU访问某个数据时，相邻数据也会被访问。内存中的数据按照时间序列分组，访问的时间距离也在一定范围内。按照这一特点，当CPU访问缓存中的数据时，它相邻的数据也很可能在短期内被访问。
## 2.9 写回
写回（Write-back）是缓存中常用的一种策略，它属于预写策略，即当CPU写入数据时，不会立即更新内存，而是先写入缓存。待缓存满或者满足一定条件时，才将数据更新到内存。显然，写回策略有助于减少内存访问次数，提高内存的吞吐量。
## 2.10 内存密度
内存密度（Memory Density）是指内存中可容纳的字节数或数据单元数与实际面积或体积的比值。内存密度越高，单位面积可容纳的数据单元数越多，相应的内存占用就越大。
## 2.11 管理机制
管理机制（Management Mechanism）是指管理内存的机制，包括垃圾回收、虚拟内存等。与应用程序无关，是整个计算机系统中负责管理内存的部分。
## 2.12 对称多处理器
对称多处理器（Symmetric Multiprocessors，SMP）是一种多核处理器，其多处理单元共享相同的指令、数据和存储器资源。SMP架构是目前高性能计算系统的主流技术。目前，业界常用的SMP平台有ARM Aarch64、Intel Knights Landing、IBM POWER9、Cray Exascale、National Supercomputing Center Tianhe-2等。
## 2.13 高度交叉访存
高度交叉访存（High Interconnect Crossbar）是指多处理器之间的内部通信带宽较小，导致不同核心的指令和数据无法直接传输。因此，需要引入额外的交互网络，在内部链接上进行数据传输。高度交叉访存将指令和数据传输的工作从核心内移动到外部交互网络中，将两个以上处理器之间的数据交换与数据处理解耦，提升了系统的性能。
## 2.14 超标量
超标量（Superscalar）是一种处理器架构，可以同时执行多条指令。在超标量架构中，处理器有多个执行单元，每个执行单元都有自己的寄存器文件和流水线。通过超标量处理器的并行性，可以在多个线程间同时切换，以加速程序的执行。超标量架构对标量架构的改进是采用多个处理器，并行处理指令，提高系统的吞吐量。
# 3.Intel Optane DC Persistent Memory简介
## 3.1 OPTME的特性
### 3.1.1 提升效率
Intel Optane DC Persistent Memory的全称是“Optimized and Transparent Memory”，即优化且透明的内存。其设计目标是为了将非易失性存储器（NAND Flash）的性能发挥到极致，最大限度地提升性能，进而支撑关键任务的运行。相对于传统的易失性RAM，OPTME可以降低功耗，提供持久性数据，可在不丢失数据的情况下提供比传统DRAM更高的带宽和低延迟。通过减少寻址延迟，OPTME可以有效地实现高速缓存和持久化存储的混合方案。在容量上，OPTME可达数千GB到万兆字节的存储容量，可用于各种场景，如缓存、数据库、数据分析、机器学习等。
### 3.1.2 便携性与易用性
OPTME提供了便携式设计，兼顾了性能与使用便利性两方面。OPTME的接口与传统的DRAM完全一致，用户可以像使用主存一样访问它。它具备良好的可靠性，自动检测和纠错功能，能够进行零丢失的存储，使其适合于作为长期数据保存。另外，OPTME还支持灵活的数据迁移功能，使得它既可以作为常规存储器使用，也可以用于内存迁移。此外，OPTME还拥有跨平台的兼容性，使得它可以方便地部署到各种异构系统中。
### 3.1.3 支持高速数据访问
在优化内存的上下文中，Intel Optane DC Persistent Memory与传统的DRAM的区别主要是访问速度。传统的DRAM采用的是基于动态RAM（DRAM）的动态随机访问技术，平均速度为2.4-3.3GHz。而INTEL OPTEME DC PERSISTENT MEMORY通过三种不同的方法提升了访问速度，分别是并行访问（Parallel Access），巧妙的主存分布（Strategic Allocation of Main Memory），以及使数据位于主存中（Keep Data in Main Memory）。具体详情参考表1。
### 3.1.4 安全性
Intel Optane DC Persistent Memory支持安全性功能，包括制造商标识、完整性检查、认证和远程加密功能。其中，制造商标识保证了数据的真实性，完整性检查提供了防篡改功能，认证保障数据来源可靠性，远程加密提供数据安全保护。
## 3.2 Intel Optane DC Persistent Memory架构
Intel Optane DC Persistent Memory 的架构图如下：


OPTME的核心组件是三维XPoint，每个XPoint由一系列存储颗粒（存储芯片）组成。每个XPoint由一块主控芯片、前端单元、后端单元和一组引导单元组成。前端单元负责接收请求、解析命令、合并内存块、并对其进行校验、路由请求、调度命令、发送响应信息等工作。后端单元负责在多个存储颗粒间进行数据块的复制、校验、重组、定位、转换等工作。引导单元则负责执行设备初始化和修复工作，维护数据结构和网络连接。每个XPoint连接到一根通道（Channel），通道与其他XPoint连接，形成一个三维的存储体系结构。
为了在容量、带宽、时延等性能指标上实现最佳平衡，OPTME的架构中还采用了一系列优化措施，如三级缓存、预读、写回、内存多路访问等，以提升性能。另外，OPTME还支持直接存取、快速擦除、可编程校验和、随机写入等功能，具有安全性、持久性、可靠性等突出特征。