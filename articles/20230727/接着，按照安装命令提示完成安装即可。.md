
作者：禅与计算机程序设计艺术                    

# 1.简介
         

        ## 安装前提条件
        本文假设您已具备以下条件：
        
        1. 有一台服务器或云服务器（本文采用阿里云ECS作为示范），且该服务器可以正常访问外网；
        2. 您的操作系统为CentOS/RHEL系列，并有ROOT权限（无需sudo）；
        3. 您在操作服务器上安装过docker或者Kubernetes相关组件（可选）。
        
        ## Docker环境准备
        在进行docker安装前，需要准备好docker所需的一些环境和依赖项。首先，我们更新yum源：
        
        ```
        yum update -y && \
        yum install -y yum-utils device-mapper-persistent-data lvm2 
        ```

        然后，我们配置docker仓库：

        ```
        yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
        ```

        最后，我们安装docker所需依赖：
        
        ```
        sudo yum install docker-ce --nobest -y
        ```

        如果您的机器运行了RedHat Enterprise Linux（RHEL）7.3，请使用以下命令安装docker-ce：

        ```
        sudo curl -sSL https://get.daocloud.io/docker | sh
        ```

        配置docker加速器

        ```
        sudo mkdir /etc/docker
        echo '{"registry-mirrors": ["https://YOUR_REGISTRY_MIRROR"]}' >> /etc/docker/daemon.json
        sudo systemctl daemon-reload && sudo systemctl restart docker
        ```

        ## Kubernetes环境准备
        在进行kubernetes安装前，需要准备好kubernetes所需的一些环境和依赖项。首先，我们更新yum源：
        
        ```
        yum update -y && \
        yum install -y yum-utils device-mapper-persistent-data lvm2 
        ```

        然后，我们添加kubernetes仓库：

        ```
        cat <<EOF > /etc/yum.repos.d/kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
        enabled=1
        gpgcheck=0
        repo_gpgcheck=0
        EOF
        ```

        最后，我们安装kubeadm、kubelet、kubectl：
        
        ```
        yum install kubelet kubeadm kubectl -y
        ```

        当然，为了更好的集群管理和稳定性，建议在生产环境中使用高可用方案，如多master模式、高可用etcd集群等。
        ## Docker安装与启动
        ### 安装Docker
        ```
        yum install -y yum-utils device-mapper-persistent-data lvm2 
        yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
        yum makecache fast
        sudo yum -y install docker-ce
        ```
        ### 配置Docker镜像加速器
        修改daemon.json文件，指定docker镜像地址，然后重启docker服务:
        ```
        mkdir -p /etc/docker
        tee /etc/docker/daemon.json <<-'EOF'
        {
            "registry-mirrors": ["https://hub-mirror.c.163.com"]
        }
        EOF
        systemctl daemon-reload && systemctl restart docker
        ```
        ### 设置Docker开机自启
        执行以下命令设置Docker开机自启：
        ```
        systemctl enable docker
        ```
        ### 拉取hello-world镜像
        拉取hello-world镜像测试是否成功安装Docker:
        ```
        docker pull hello-world
        ```
        ### 测试Docker是否正常运行
        执行以下命令查看docker版本信息:
        ```
        docker version
        ```
        执行以下命令测试hello-world镜像是否正常运行:
        ```
        docker run hello-world
        ```
        ## Kubernetes安装与启动
        ### 禁用SELinux
        编辑/etc/selinux/config文件，设置SELINUX=disabled：
        ```
        sed -i's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
        ```
        ### 关闭防火墙
        停止防火墙并禁止其开机自启：
        ```
        systemctl stop firewalld && systemctl disable firewalld
        ```
        ### 配置DNS
        配置主机名解析：
        ```
        hostnamectl set-hostname <your hostname>
        echo "<ip address> <your hostname>" >> /etc/hosts
        ```
        ### 配置Kubernetes Repo
        添加kubernetes软件源：
        ```
        cat <<EOF > /etc/yum.repos.d/kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
        enabled=1
        gpgcheck=0
        repo_gpgcheck=0
        EOF
        ```
        ### 安装kubelet、kubeadm、kubectl
        安装kubelet、kubeadm、kubectl：
        ```
        yum install -y kubelet kubeadm kubectl
        ```
        ### 初始化kubernetes master节点
        使用kubeadm初始化kubernetes master节点，--pod-network-cidr参数指定Pod网络地址段：
        ```
        kubeadm init --pod-network-cidr=192.168.0.0/16
        ```
        ### 设置系统环境变量
        配置kubelet的cgroup driver为systemd，并写入配置文件：
        ```
        echo KUBELET_EXTRA_ARGS=--cgroup-driver=systemd >> /etc/sysconfig/kubelet
        ```
        设置kubectl bash自动补全：
        ```
        source <(kubectl completion bash)
        alias k=kubectl
        complete -F __start_kubectl k
        ```
        ### 设置集群网络
        为flannel创建必要的配置文件：
        ```
        mkdir -p /root/.kube
        cp /etc/kubernetes/admin.conf /root/.kube/config
        kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
        ```
        ### 测试kubernetes集群
        通过测试部署nginx到kubernetes集群中：
        ```
        kubectl run nginx --image=nginx
        ```
        查看pods列表：
        ```
        kubectl get pods --all-namespaces
        ```
        复制nginx pod的名称，并执行以下命令进入容器内部：
        ```
        kubectl exec -it <nginx pod name> -- /bin/bash
        ```
        从容器外部访问nginx：
        ```
        curl localhost:80
        ```