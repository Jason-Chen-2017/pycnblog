
作者：禅与计算机程序设计艺术                    

# 1.背景介绍


TCPDump是一个用来抓取、分析网络包的命令行工具，它可以帮助我们捕获传输层（TCP/UDP）数据包并进行网络分析。在日常网络安全分析中，经常会用到tcpdump命令对网络通信进行嗅探、分析和排查。本文将结合自己的实际工作经验，介绍如何利用tcpdump命令抓取FTP和20-21端口的流量。文章主要内容如下：

1. 什么是TCPDump？

tcpdump是一个用来抓取、分析网络包的命令行工具。它能够根据指定的过滤条件捕获网络上的数据包，并将其输出到标准输出或文件保存起来。其特点是快速、灵活，功能强大。例如，我们可以通过指定过滤条件（如源IP地址、目标IP地址、协议类型、端口号等），利用tcpdump命令抓取满足这些条件的数据包。

2. 为何要抓取FTP和20-21端口的流量？

当今互联网的应用非常广泛，从电子邮件到即时通讯，都依赖于网络通信。网络通信的基础就是端口。为了保证网络的安全、稳定运行，运维人员也需要掌握一些端口的基本知识和使用技巧。其中，FTP端口和20-21端口是最常用的端口，它们分别用于文件传输和邮件收发。因此，想要了解它们的流量情况就很重要了。

3. 需要具备的基本知识

① TCP/IP协议族概述：熟悉TCP/IP协议族及其各个协议的作用。

② 端口（Port）的概念：理解计算机中的端口及其分类。

③ 使用命令行工具：了解Linux下常用的命令行工具及其使用方法。

# 2.核心概念与联系
## 2.1 相关概念
### 2.1.1 概念
1. 协议：协议是一种规范，规定了计算机之间交换数据包的方式、内容及其他信息。目前常用的协议包括TCP/IP协议族。
2. IP协议：Internet Protocol(IP)是TCP/IP协议族中的一个重要协议，用于定义互联网内部的数据传输方式。每个网络设备都必须配置有一个IP地址，通过IP地址来标识网络上的主机或者路由器。IP协议负责向目标发送数据包，同时也接收来自其它节点的数据包。
3. TCP协议：Transmission Control Protocol (TCP) 是IP协议族中的协议，提供可靠的数据传输服务。它采用三次握手建立连接，四次挥手释放连接，并且确保数据准确无误地传输。
4. UDP协议：User Datagram Protocol (UDP) 是另一种传输控制协议，与TCP不同之处是它不保证传输过程的可靠性。它只负责数据的封装和传输，但不涉及可靠性处理。
5. FTP协议：File Transfer Protocol (FTP) 是TCP/IP协议族中的一款基于客户端-服务器模式的文件传输协议。它通过用户登陆服务器，客户端将本地文件传送至服务器端，服务器再将文件传送给客户端。
6. TCPDUMP命令：tcpdump是linux下的抓包工具，用于网络调试，分析数据包。
7. 端口（Port）：端口是软件监听的入口，应用程序一般会把自己想用的端口留给操作系统，比如HTTP的默认端口80。而对于常见的网络服务，如SSH、SMTP、DNS、FTP等，则都需要指定特定的端口进行数据通信。

### 2.1.2 联系
1. FTP协议和TCP协议：FTP协议属于TCP/IP协议族，是在互联网上传输文件的协议。通过该协议，客户端（即用户）可以把本地的文件上传到远程主机（即服务器），也可以下载远程主机上的文件。但是如果没有启用FTP服务，则无法进行FTP通信。
2. TCPDUMP命令和TCP协议：TCPDUMP命令就是用于抓取网络数据包的工具，也是TCP/IP协议族的一部分。它主要用来记录网络数据包，用于后续分析和调试。
3. 端口和IP地址：每台计算机都会配置一个唯一的IP地址，这个地址被分成两个部分：网络地址和主机地址。网络地址由许多主机组成，代表整个互联网，通常以数字形式表示，如192.168.0.1；而主机地址是指在特定网络中唯一的标识符，通常以数字形式表示，如192.168.0.101。一个IP地址对应着一个物理网络接口卡，而网络接口又能对外提供各种网络服务。每一个打开的TCP/IP端口都对应着一个进程，当一个进程打开某个端口，就可以接收到来自其他计算机的请求。

## 2.2 数据包结构
TCP/IP协议族的数据包结构如下图所示：
图1 TCP/IP协议族的数据包结构

数据包由报头和载荷两部分组成。

报头部分包括固定长度的字段和可变长度的字段。固定长度的字段包括版本号、包长度、标识符、片偏移、生存时间（TTL）、协议号、首部校验和、源IP地址、目的IP地址等；可变长度的字段包括选项、数据和填充字节。

载荷部分主要包括TCP数据或UDP数据。如果是TCP数据，那么载荷还包括源端口号、目的端口号、序列号、确认序号、窗口大小、检验和、紧急指针等。

## 2.3 技术实现
1. 配置Linux环境
   ```bash
   sudo apt install tcpdump
   ```
2. 命令说明
   ```bash
    # TCPDUMP命令语法
    tcpdump [-aAbdDefhHIJKlLnNOpqStuUvxZ] [+<knob>]... interface [not] { src | dst } net [!net...]
    # 参数说明
    # interface：网络接口名称，如eth0、wlan0等。
    # not：取反匹配，表示除了匹配到的包外，其它所有包都要显示。
    # src 或 dst : 来源或目标，取决于选项的第一个字母。表示抓取哪些源或目的IP地址的数据包。
    # net : 根据IP网络或子网掩码来匹配，如192.168.0.0/24。
    # +/-：开关过滤器，加号表示开启某个过滤器，减号表示关闭某个过滤器。

    # 下面展示几个常用选项：
    # -i <接口>：指定抓取的网络接口，如eth0、wlan0等。
    # -t：设置打印时间戳的格式。
    # -nn：取消“名字解析”（显示IP地址而不是域名）。
    # -v：详细模式，打印更详细的信息。
    # -c <个数>：仅抓取前面的多少个包。
    # -n：不做DNS解析，直接使用IP地址。
    
    # 示例：
    tcpdump -i eth0 "src net 192.168.1.0/24 and port ftp" -tt -nn -c 100     # 抓取名为eth0的网络接口，来源在192.168.1.0/24网段且目的端口为ftp的前100个TCP数据包。打印时间戳、不解析域名和详细模式。

    tcpdump -i eth0 "tcp[((tcp[12:1] & 0xf0) >> 2):4] = 0x01010800"    # 用tcp协议、选项类型、源端口、目的端口、序列号和确认序号匹配FTP请求。
    
    tcpdump -i wlan0 udp "(port 53 or port 5353)"                     # 抓取名为wlan0的网络接口，UDP协议、目的端口为53或5353的数据包。
  ```