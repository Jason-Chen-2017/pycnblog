
作者：禅与计算机程序设计艺术                    

# 1.简介
  

InnoDB是一个开源关系数据库管理系统（RDBMS），其设计目标是在保证数据完整性、并发访问能力和实时性能的前提下提供高效率的数据存储方案。InnoDB利用聚集索引组织数据表，这种索引类型类似于B树索引，但它在物理层面上还是采用的是聚集索引。

按照官方文档描述，InnoDB的数据文件由7个主要部分组成：

1.页头页脚
2.数据字典（数据字典存储了数据库所有表的信息）
3.Undo日志缓冲区（用于对事物进行回滚）
4.数据文件
5.插入缓冲区（用于缓存插入的行记录）
6.自适应哈希索引（InnoDB会自动地决定是否应该创建辅助索引）
7.查询缓存（用于缓存已经检索到的结果，减少重复查询的时间）

本文主要将从第3章介绍InnoDB的数据文件结构入手，详细阐述InnoDB数据文件的各个部分的功能，并通过分析源码的方式进一步加深对InnoDB文件结构的理解。

# 2.基本概念及术语说明

## 数据文件
InnoDB的数据文件主要由三个文件构成，分别为ibd文件、frm文件、cfg文件。其中，ibd文件用来存放真正的用户数据，frm文件用来保存表的定义信息，cfg文件用于配置InnoDB参数。

## 数据字典
InnoDB数据字典主要包含两张表：SYS_COLUMNS(列信息表)和SYS_INDEXES(索引信息表)。SYS_COLUMNS表中存储表名、字段名、数据类型等列信息；SYS_INDEXES表中存储索引名称、列名称、数据类型等索引信息。

## Undo日志缓冲区
InnoDB中的Undo日志主要用来实现事务的回滚操作，即当某个事务因为某种原因需要回滚时，Undo日志能够将该事务之前的修改都撤销掉。Undo日志保存在一个称之为Undo段的环形缓冲区中。每个事务提交时，InnoDB都会把数据变化写入磁盘上的Redo日志，如果此次修改引起主备切换，则可以把Redo日志复制到备库的Undo日志缓冲区中，这样就可以保证事务的一致性。

## 插入缓冲区
InnoDB的插入缓冲区是一个固定大小的内存块，当向InnoDB插入一条数据时，首先判断该数据是否满足插入条件，若不满足条件则先暂存至插入缓冲区，然后再根据配置情况决定何时将缓冲区中的数据写入磁盘。

## 自适应哈希索引
InnoDB支持自适应哈希索引，即每次向哈希索引中插入或删除条目时都会自动调整哈希表的高度，使得平均查找长度较短的情况下哈希表的高度较低，查找效率较高。

## 查询缓存
InnoDB的查询缓存是为了提升MySQL服务器的查询响应速度而设计的一个小型缓存机制。它的工作原理就是把经常使用的SQL语句及其执行结果保存起来，当下一次相同的查询请求发生时，就直接从缓存中获取结果，避免重新生成查询结果。

# 3.数据文件结构详解

## 1.页头页脚
每一个页（page）的开头和结尾都是两个特殊的字节序列，分别称为页头（page header）和页脚（page trailer）。页头和页脚中的信息能够帮助InnoDB定位页面中的其它重要信息，例如该页面所在的位置、页面的大小、页面是否被标记为脏、页号等。

## 2.数据字典
InnoDB数据字典主要包含两张表：SYS_COLUMNS(列信息表)和SYS_INDEXES(索引信息表)。SYS_COLUMNS表中存储表名、字段名、数据类型等列信息；SYS_INDEXES表中存储索引名称、列名称、数据类型等索引信息。

SYS_COLUMNS表：

SYS_INDEXES表：

SYS_COLUMNS表和SYS_INDEXES表的存储位置都在第一个页面的后半部分，即偏移量范围为16K～24K之间。

## 3.Undo日志缓冲区
InnoDB中的Undo日志主要用来实现事务的回滚操作，即当某个事务因为某种原因需要回滚时，Undo日志能够将该事务之前的修改都撤销掉。Undo日志保存在一个称之为Undo段的环形缓冲区中。每个事务提交时，InnoDB都会把数据变化写入磁盘上的Redo日志，如果此次修改引起主备切换，则可以把Redo日志复制到备库的Undo日志缓冲区中，这样就可以保证事务的一致性。

对于一个UPDATE或DELETE类型的事务，InnoDB在提交事务之前，不会立刻将Undo日志写入磁盘，而只是将Undo日志缓冲区中的信息更新，以便出现异常时能够快速恢复事务。

Undo日志缓冲区位于共享内存区域，因此多个进程可以共用同一份Undo日志缓冲区。每一个Undo日志缓冲区有64MB大小。

## 4.数据文件
数据文件中保存着InnoDB真正的数据。InnoDB的真正数据按照表分片存储在不同的段（segment）中，一个段对应于一个磁盘文件，其中又包含若干个数据页（data page）。数据文件中的每个数据页（或者称作“页”）都有一个相对独立的物理结构，但是却共享相同的逻辑结构，包括页头页脚、记录指针以及相邻页的引用等。

InnoDB的数据文件除了包含真正的数据外，还有一些辅助文件。这些辅助文件使得InnoDB更加容易维护和扩展，它们包括：

- frm文件：保存表结构相关信息
- ibd文件：实际的数据文件，存放表的数据。
- cfg文件：存储InnoDB的参数设置。

所有的表都存放在ibd文件中，而所有的索引都存放在单独的文件中，这些索引文件统称为innodb_index.XXXXX。

InnoDB的页组织形式：


## 5.插入缓冲区
插入缓冲区是一个固定大小的内存块，当向InnoDB插入一条数据时，首先判断该数据是否满足插入条件，若不满足条件则先暂存至插入缓冲区，然后再根据配置情况决定何时将缓冲区中的数据写入磁盘。

## 6.自适应哈希索引
InnoDB支持自适应哈希索引，即每次向哈希索引中插入或删除条目时都会自动调整哈希表的高度，使得平均查找长度较短的情况下哈希表的高度较低，查找效率较高。

自适应哈希索引的自动调整，基于一个动态计算评估函数来确定哈希表的高度。InnoDB会根据当前数据集的规模、磁盘空间、CPU资源等因素，自动调整哈希表的高度。如果数据集过小、磁盘空间占用过多，那么哈希表就会较低；如果数据集过大、可用资源过少，那么哈希表就会较高。

自适应哈希索引的存储方式：

- 每个页中包含一定数量的条目；
- 当向哈希索引中插入条目时，如果该条目的页已经满了，则创建一个新页并链接到旧页中；
- 当删除哈希索引中的条目时，如果该条目所在的页的最后一个条目被删除，则合并该页与其相邻的页（如果没有相邻的页，则创建一个新的页）。

## 7.查询缓存
InnoDB的查询缓存是为了提升MySQL服务器的查询响应速度而设计的一个小型缓存机制。它的工作原理就是把经常使用的SQL语句及其执行结果保存起来，当下一次相同的查询请求发生时，就直接从缓存中获取结果，避免重新生成查询结果。

InnoDB的查询缓存分为两种模式，分别为：

1. 仅仅命中查询缓存，不命中缓存。
2. 只缓存SELECT语句的结果。

查询缓存的默认开启状态如下：

- MySQL版本>=8.0，默认启用仅仅命中查询缓存，不命中缓存；
- MySQL版本<8.0，默认关闭只缓存SELECT语句的结果；