
作者：禅与计算机程序设计艺术                    
                
                
跨站脚本攻击（Cross-Site Scripting，XSS）是一种网络安全漏洞，它允许攻击者将恶意的代码注入到正常的网页中，从而影响页面的正常访问，并可能窃取用户的信息、利用网站提供的功能等。XSS通常发生在web应用程序和浏览器上，这些应用允许用户输入一些文本数据，然后通过该数据生成动态网页，在这个过程中，如果攻击者控制了其中任一个环节，就可以执行JavaScript代码，插入到生成的网页中，造成恶意攻击。
XSS分为三种类型：

1.存储型XSS: 在存储型XSS中，攻击者将恶意代码直接存储在目标服务器的数据库中。攻击者发送恶意代码时，服务器不对其进行检查，而是将其呈现给受害者。当受害者浏览含有恶意代码的网页时，他们的浏览器会执行JavaScript代码，从而导致恶意行为。

2.反射型XSS: 反射型XSS又称非持久性XSS，攻击者通过诱导受害者点击链接或提交表单，将恶意代码提交至目标网站。由于此类攻击往往不被抓住，所以叫做反射型XSS。网站收到请求后，根据参数的值，返回不同的响应，而这些响应可能都带有恶意代码。浏览器执行这些响应中的JavaScript代码，从而导致攻击。

3.DOM-based XSS: DOM-based XSS通过篡改DOM结构来注入恶意代码。攻击者构造特殊的URL或表单，诱使受害者的浏览器运行非正常代码。例如，攻击者可以构造一串Javascript代码作为搜索栏的默认值，用户点击搜索按钮时就会自动执行这个代码，导致漏洞的发生。

本文讨论的重点是第三种XSS类型——DOM-based XSS，也就是通过篡改DOM结构来注入恶ENCE代码。
# 2.基本概念术语说明
## 2.1 DOM-based XSS
### 2.1.1 DOM
DOM(Document Object Model)是W3C组织推荐的处理可交互式网页的标准编程接口。它定义了一个树形结构，用来表示文档对象，每个节点代表文档中的元素，属性，文本等内容。DOM Level 1定义了Node接口及相关子接口，用于处理文档对象的集合；Level 2定义了Element接口，用于处理HTML元素，提供了对元素属性的修改和扩展方法；Level 3还增加了XMLHttpRequest接口，用于加载外部资源，并取得其内容。
![img](https://pic4.zhimg.com/v2-e49f7b29d3bf249fc4a1331829cfbefd_r.jpg)

### 2.1.2 HTML Sanitizer
DOM-based XSS通常利用的是HTML Sanitizer组件。HTML Sanitizer组件是一个工具库，用于过滤输入的HTML代码，阻止可能的DOM-based XSS攻击。它的工作原理是把不安全的标签替换成安全的标签，比如将`<script>`替换成`<span>`。

HTML Sanitizer组件最初由Google开发，现在由Cloudflare等服务商维护。目前，大多数主流浏览器都内置了HTML Sanitizer组件，但安全研究人员仍然需要关注其他类型的XSS漏洞。

## 2.2 浏览器的攻击方式
XSS攻击主要有两种形式：

1.Stored XSS: XSS攻击脚本存储在网站服务器上，用户访问页面的时候，浏览器将XSS攻击代码从服务器传回本地执行。这种攻击脚本被存放在网站数据库中，因此任何具有数据库管理权限的用户均可获取到攻击脚本。

2.Reflected XSS: XSS攻击脚本被包含在所有发向目标服务器的HTTP响应中。当用户打开包含攻击脚本的页面时，浏览器自身不会执行攻击脚本，而是将攻击脚本通过URL、表单或者其它用户输入的方式传入到服务器端。由于攻击脚本不经过解析和执行，服务器无法判断攻击脚本是否有效，攻击效果可以持续数小时甚至数天不左右。

## 2.3 JavaScript编码原则
在讨论XSS攻击的具体机制之前，我们先了解一下常用的JavaScript编码原则：

1.不要将不可信的数据（如用户输入）直接拼接到HTML文档中

2.避免使用eval()函数来执行字符串，除非你非常熟悉它的用法

3.确保代码安全，不要把用户输入直接用作HTML属性值或者JavaScript代码片段。

4.对用户输入进行合法性验证，确保其内容符合预期。

5.不要依赖黑客攻击者预设的输入内容。
# 3.核心算法原理和具体操作步骤以及数学公式讲解
## 3.1 概念和模式识别
DOM-based XSS一般采用以下3个阶段：

1.获取用户输入：攻击者首先要获取目标网站的用户输入，包括URL参数、表单数据、cookie、HTTP头信息等。获取用户输入之后，可以分析其内容，判断其是否包含XSS攻击代码。

2.注入恶意代码：拿到用户输入之后，可以将其内容作为恶意代码注入到网页中，比如将用户输入的内容放入HTML标签中输出。如果注入的位置没有进行过滤，攻击者可以控制整个HTML文档的结构，也可以使用某些HTML特性如iframes、objects、xmlhttprequest等加载外部脚本。

3.触发事件：当页面渲染完成后，用户可能会触发特定事件，比如表单提交、鼠标悬停、脚本执行等，这些事件可能会触发恶意代码，让攻击者在不知情的情况下控制网站。

## 3.2 操作步骤
### 3.2.1 获取用户输入
最常用的获取用户输入的方法是GET请求的参数，也可以是POST请求的表单数据。获取到的用户输入一般分为两类：

1.静态数据：如URL中的参数、cookie等，这些数据只读一次，且只有服务器知道它们的值。

2.动态数据：如表单的输入框、文本域等，这些数据可以被用户任意输入，而且可以在客户端和服务器之间传递。

为了防御XSS攻击，服务器应当对所有用户输入进行过滤和验证。常见的验证方法如下：

1.过滤：将用户输入的每一个字符进行验证，对于危险字符或脚本标记等进行转义，这样就保证了输入的正确性和安全性。

2.白名单校验：服务器事先定义一组“白名单”标签，只有这些标签才能允许出现在用户输入中。对于不在白名单中的标签，服务器将其过滤掉，这样就可以限制攻击的范围。

3.长度限制：限制用户输入的最大长度，防止攻击者提交大量数据占满服务器内存。

4.误报率检测：服务器应当设置一定的误报率阈值，如果某个请求被误认为可能包含XSS攻击，服务器应该采取相应措施，比如禁止访问，记录日志等。

5.多层过滤：除了对单个输入的过滤外，还可以通过多层过滤，即对不同输入之间的关系进行过滤。比如，如果一个标签的值是从另一个标签中获取，那么就要对这个值进行过滤。

### 3.2.2 注入恶意代码
一般来说，XSS攻击主要分为两个方面：反射型XSS和存储型XSS。

#### 反射型XSS
反射型XSS就是通过诱导用户点击链接或提交表单，将恶意代码提交至目标网站。由于反射型XSS不经过解析和执行，所以服务器无法判断攻击脚本是否有效，攻击效果可以持续数小时甚至数天不左右。

举例：

攻击者提交了一个包含恶意代码的表单，他点击提交后，表单数据会被自动提交到目标服务器。假设表单字段为name，攻击者输入的是：<script>alert('hello')</script>, 当服务器接收到表单数据后，在响应的HTML中，发现<script>标签，并且警告弹窗显示"hello"。但是，因为恶意代码是在浏览器执行的，所以攻击者其实并不能看到它。

解决办法：

最好的方式是使用HTTP头信息中的Content-Security-Policy声明哪些外部资源可以被加载和执行。另外，可以使用验证码，要求用户填完特定的验证码才能提交表单。

#### 存储型XSS
存储型XSS攻击脚本将恶意代码存储在目标服务器的数据库中。攻击者发送恶意代码时，服务器不对其进行检查，而是将其呈现给受害者。当受害者浏览含有恶意代码的网页时，他们的浏览器会执行JavaScript代码，从而导致恶意行为。

举例：

攻击者在目标网站上发布了一篇文章，文章内容中包含了一段JS代码：<script src=http://example.com/xss.js></script> 。此时，攻击者的文章已经上线，普通用户查看文章时也没有什么问题，但是某些高级用户查看时，他们的浏览器会加载攻击者提供的恶意JS脚本，导致某些隐私信息泄露或账号泄露等严重问题。

解决办法：

最佳的解决方案是尽量减少和关闭公开的CMS，防止储存型XSS攻击。还有一些其他的方法，比如使用验证码，服务器端对用户提交的数据进行签名验证等。

总结：

反射型XSS和存储型XSS都是基于用户输入和浏览器执行JavaScript代码，来实现攻击的。尽管有很多防御措施，但还是存在着很多漏洞和漏洞。综合各方面的防御方案，构建起专业的防御体系，才能够充分地保护用户的信息安全。

