
作者：禅与计算机程序设计艺术                    

# 1.简介
  

## 1.1 定时任务的介绍
定时任务(crontab)，是用来指定某个时间（或间隔）执行某项任务的工具。用户可以在规定的时间（如每天凌晨、每周日早上等），让系统自动地执行指定的命令或者脚本。在服务器上配置定时任务非常方便，可以使得很多重复性劳动自动化处理，提高效率。

## 1.2 Linux下的定时任务管理工具
linux系统中定时任务的管理工具主要有以下几种：

1. `cron`：最初期就自带的定时任务管理工具，一般安装在/etc目录下。配置文件为/etc/crontab。需要修改时，可以使用命令：`crontab -e`，直接编辑该文件进行设置。其语法较为简单，并且只有系统管理员才能使用。

2. `at`：另一种定时任务管理工具，在Linux系统中，可以使用命令`at`来创建、查看、删除定时任务。其语法与`cron`类似，但是没有权限限制。

3. `anacron`: 不可预测的定时任务，在计划任务的最后期限前的几天运行一次。其优点是在计划任务执行期间机器关闭不影响任务的执行。缺点是存在资源浪费的问题，容易造成系统崩溃或性能降低。

4. `systemd-timer`: systemd基于linux内核的开源系统，支持启动时、每次登录时、系统启动时、指定的时间等多种触发器类型。基于时间日期的管理机制，可以实现精确的定时任务调度。

5. `tianqi`: 可以使用命令行的方式对定时任务进行管理。相比于`cron`，更加灵活易用。

本文将以`cron`作为示例来介绍定时任务的相关知识和操作方法。

# 2.基础概念及术语
## 2.1 定时任务的基本配置
一个定时任务的基本配置包括以下几个方面：

- 时刻：任务被执行的时间点，通常是一个具体的时间点，也可以是一个固定时间间隔（如每隔1小时）。
- 命令：任务执行时要运行的指令或者脚本。
- 用户：任务所属的用户，用于鉴权和确定权限。

## 2.2 crontab文件的结构
每个crontab文件都包含若干条定时任务，每条定时任务占据一行。每行由六个字段组成，分别是：分钟、小时、日期、月份、星期、命令和注释。其中：

- 分钟、小时、日期：三者一起决定了任务执行的时间。
- 月份：如果设定的值为“*”，则表示匹配任意值。
- 星期：星期几，共7个值（0代表星期天），如果设定值为“*”，则表示匹配任意值。
- 命令：任务实际执行的命令或者脚本。
- 注释：是任务的描述信息，不会被执行。

除了这些字段外，还可以在命令前增加一些参数，以控制定时任务的行为。比如：

1. `&`：表示命令在后台运行，即定时任务结束后，命令依然在后台运行。

2. `>>` filename：表示将命令的输出重定向到filename文件，而不是终端显示。

3. `2>&1`：表示将命令的错误输出重定向到标准输出。

## 2.3 文件权限设置
定时任务的文件权限默认设置为`600`，即只有root用户才可以读写该文件。如果其他用户想修改定时任务，需要赋予它们相应的权限。例如：

1. 添加一条定时任务：`sudo chmod 666 /var/spool/cron/crontabs/root`

2. 修改已有定时任务：`sudo chmod u+w /var/spool/cron/crontabs/root` 或 `sudo chown user:user /var/spool/cron/crontabs/root`。注：`u+w` 表示当前用户具有写入权限；`chown` 更改文件的拥有者和群组。

# 3.定时任务的管理命令
## 3.1 cron命令
cron命令是一个比较常用的命令，可以对定时任务进行管理。它的功能包括：添加、列出、删除定时任务、更改定时任务顺序、设置新的定时任务。命令如下：

```bash
$ sudo crontab [-u username] [options]

-u username : 指定用户名，可选。

options:
-l           : 列出所有定时任务。
-r           : 删除所有定时任务。
-e           : 使用编辑器编辑定时任务。
-i           : 在删除之前询问确认。
-s script    : 执行script脚本。
```

## 3.2 at命令
at命令用来创建、查看、删除指定时间（或延迟时间）执行一次或多次的任务。它只能在当前用户拥有的时区下工作。命令如下：

```bash
$ sudo at [time]

time   : 指定的时间点，形如"HH:MM" 或 "HH:MMam/pm" 。
-M      : 静默模式，不显示详细信息。
-m      : 将命令写入crontab文件，但不立即执行。
```

## 3.3 anacron命令
anacron命令用来管理不可预测的定时任务，系统会在计划任务的最后期限前的几天运行一次。它应该只在必要时使用，否则可能导致系统崩溃或性能降低。命令如下：

```bash
$ sudo anacrontab file
file   : 是包含定时任务的文件名。
```

## 3.4 systemd-timer命令
systemd-timer命令用来管理系统定时任务，在systemd引入的多个事件源基础上支持启动时、系统启动时、定时的触发器类型。命令如下：

```bash
$ systemctl list-timers --all | grep timerName

LIST OF TIMERUNITS FOR THIS SYSTEM:
  sys-kernel-config.slice:perodic                daily      Tue 2020-04-19 04:00:00 CST—Tue 2020-04-19 05:00:00 CST; next due Mon 2020-04-25 04:00:00 CST
  update-motd.timer:oneshot                      on Wed 2020-04-20 16:25:16 CST—Wed 2020-04-20 16:25:16 CST (repeated 5 times)
  etc...

$ systemctl start|stop|enable|disable timerName
$ systemctl is-enabled|is-active timerName
```

## 3.5 tianqi命令
tianqi命令是一个命令行工具，可以使用命令行的方式对定时任务进行管理。相比于`cron`，更加灵活易用。命令如下：

```bash
$ tianqi add "command to run" every monday at 1:00 am >> logFile # 每周一早上1点运行命令，并将输出保存至日志文件logFile。
$ tianqi ls                                              # 查看所有定时任务列表。
$ tianqi rm taskID                                       # 根据taskID删除定时任务。
$ tianqi edit                                            # 使用文本编辑器编辑现有定时任务。
```

# 4.定时任务的配置
## 4.1 常用配置选项
定时任务的配置有以下几个方面：

1. 分钟：分钟可以取值从0到59之间的整数，表示任务将在每分钟、第n分钟、n分钟之后执行。例如："*/2" 表示每两分钟执行一次，"0 8,16 * * *" 表示在8点、16点执行一次。

2. 小时：小时可以取值从0到23之间的整数，表示任务将在每小时的第n小时、n小时之后执行。例如："*/2" 表示每两个小时执行一次，"0 */4 * * *" 表示每四小时执行一次。

3. 日期：日期可以取值1~31之间的整数，或一个星号“*”、一个范围“start-end”、一个列表“m1,m2,m3…”、另一个星号“*”。表示任务将在每年的特定日期（如每月的第一天、最后一天）、每年的第n个星期几、星期一到星期五执行一次。例如："1,10,20" 表示在每年的1号、10号、20号执行一次，"0 12 * * 6" 表示每周六的中午12点执行一次。

4. 月份：月份可以取值1~12之间的整数，或一个星号“*”、一个范围“start-end”、一个列表“m1,m2,m3…”、另一个星号“*”。表示任务将在特定的月份执行一次，或在特定的月份的第n个星期几、星期一到星期五执行一次。例如："*/2" 表示每两个月执行一次，"1,4,7,10" 表示在1月、4月、7月、10月执行一次，"0 8 1 * sat" 表示每年第一个星期六的八点执行一次。

5. 星期：星期可以取值0~6之间的整数（0代表星期天），或一个星号“*”、一个范围“start-end”、一个列表“m1,m2,m3…”、另一个星号“*”。表示任务将在特定的星期执行一次，或在特定的星期的第n天执行一次。例如："*/2" 表示每两周执行一次，"monday" 表示每周一执行一次，"monday@weekly" 表示每周一执行一次（与 @daily等价）。

## 4.2 配置实例
### （1）将shell脚本定时执行
```
$ echo "0 0 * * * /path/to/yourScript.sh > /dev/null 2>&1" | sudo tee /var/spool/cron/crontabs/root
```
此处，`0 0 * * *` 表示任务将在每天的0点0分执行，`> /dev/null 2>&1` 表示输出内容不记录，仅供参考。

### （2）定时发送电子邮件通知
```
$ echo "@hourly mail -s 'Task Finished' <EMAIL>" | sudo tee -a /var/spool/cron/crontabs/root
```
此处，`@hourly` 表示每小时执行一次，`-s` 设置邮件主题，`<EMAIL>` 为接收邮箱地址。

### （3）定时备份MySQL数据库
```
$ echo "0 0 * * * mysqldump -uusername -ppassword databasename > /backupfolder/$(date +%Y-%m-%d).sql" | sudo tee -a /var/spool/cron/crontabs/root
```
此处，`mysqldump` 是MySQL提供的命令，`-uusername -ppassword` 设置数据库用户名密码，`databasename` 是需要备份的数据库名称，`>/backupfolder/` 这是存放备份文件的目录，`$()` 将 `$(date +%Y-%m-%d)` 替换为年月日，得到最终备份文件路径。