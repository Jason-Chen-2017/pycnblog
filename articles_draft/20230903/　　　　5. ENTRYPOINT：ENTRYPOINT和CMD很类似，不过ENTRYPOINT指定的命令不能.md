
作者：禅与计算机程序设计艺术                    

# 1.简介
  


## 1.1 什么是ENTRYPOINT？ENTRYPOIT是Dockerfile中的指令之一，它定义了容器启动时运行的命令。每个Dockerfile中只能有一个ENTRYPOINT，如果有多个则仅最后一个有效。一般情况下，如果指定了ENTRYPOINT，CMD会作为其默认参数。可以使用`docker build`命令构建镜像，也可以直接用`docker run`命令启动容器。如果没有指定ENTRYPOINT，则会使用CMD命令启动容器。


例如：
```dockerfile
FROM alpine:latest

WORKDIR /app/bin
COPY bin/main.

ENV PATH=/app/bin:$PATH
ENTRYPOINT ["/usr/bin/dumb-init", "--"]
CMD ["./main"]
```

上面的例子中，ENTRYPOINT定义的就是需要执行的程序及参数，即`/usr/bin/dumb-init --`。此处不展示完整的Dockerfile文件，只展示ENTRYPOINT的定义。CMD命令也可以设置容器默认的运行命令。通常来说，CMD命令应该只有一个，并且是一个可执行文件或命令。

## 1.2 为什么要使用ENTRYPOINT？

一般来说，通过ENTRYPOINT可以实现以下几点功能：

1. 在Dockerfile中进行环境变量配置，并与Dockerfile中的其他指令组合使用，如上例中的设置PATH；
2. 在启动容器时自定义命令参数，如上例中的设置`/app/bin/main`为默认命令；
3. 设置执行权限，如上例中的添加`--`，使得命令能够正常执行；
4. 执行命令前后添加自己的操作，如上例中的设置`dumb-init`。

从这些功能来看，ENTRYPOINT在Dockerfile中用来定制容器的行为十分重要，它的作用域是整个Dockerfile。因此，它可以帮助我们实现Dockerfile文件和运行时环境之间的隔离，并减少容器中应用的耦合性。

## 1.3 ENTRYPOINT 和 CMD 的区别？

两者都是Dockerfile中的指令，但是它们的作用不同。

**ENTRYPOINT**

ENTRYPOINT指定的是容器启动时执行的命令，而不会被docker run命令的参数覆盖。

**CMD**

CMD命令用于指定容器默认的运行命令或者参数，可以被docker run命令的参数覆盖。CMD指定的命令可以包括可执行文件、shell脚本甚至参数。当用户启动容器时，CMD命令会覆盖之前的ENTRYPOINT指令。CMD命令可以包含多个参数，但只有最后一个参数才会生效。

## 1.4 ENTRYPOINT 和 CMD 的使用场景？

根据上面对ENTRYPOINT和CMD的介绍，可以总结一下它们的使用场景：

1. **ENTRYPOINT**：适合于容器启动时执行简单任务（如执行命令）、环境变量配置等；
2. **CMD**：适合于容器中启动应用程序或服务、接收用户输入参数；
3. **CMD vs ENTRYPOINT**：CMD在Dockerfile中设置的命令可以被`docker run`命令的参数覆盖，ENTRYPOINT指定的命令不能被覆盖。

# 2. ENTRYPOINT 使用方法

本节将给出一些常用的ENTRYPOINT使用方法。

## 2.1 执行简单命令

当ENTRYPOINT指定的命令只是简单的执行一个命令时，ENTRYPOINT可以简化Dockerfile。比如，假设我们要执行一个名为`hello_world.sh`的文件：

```bash
#!/bin/bash
echo "Hello World"
```

然后我们可以在Dockerfile中这样写：

```dockerfile
FROM busybox

WORKDIR /root
ADD hello_world.sh./

ENTRYPOINT ["/bin/sh","./hello_world.sh"]
```

这样就可以通过如下方式启动容器：

```bash
$ docker build -t helloworld.
$ docker run helloworld
Hello World
```

这种方法适用于执行简单命令，如打印文字，环境变量配置等。

## 2.2 设置环境变量

另一种ENTRYPOINT的常用方法是设置环境变量，这种方法适用于环境变量比较复杂的情况，且CMD命令也可能较长，无法方便地修改。比如，假设我们要设置一些环境变量，包括JAVA_OPTS、APP_NAME和APP_PORT：

```dockerfile
FROM java:8

ENV JAVA_OPTS="-Xmx1g" \
    APP_NAME="myapp" \
    APP_PORT=9090

EXPOSE $APP_PORT

ENTRYPOINT [ "java", "$JAVA_OPTS", "-jar", "/app/$APP_NAME.jar" ]
CMD []
```

这样就可以通过如下方式启动容器：

```bash
$ docker build -t myapp.
$ docker run myapp
```

这种方法可以灵活地设置环境变量，还可以通过CMD命令传递参数到ENTRYPOINT指令。

## 2.3 添加执行权限

在某些情况下，我们可能希望容器启动时运行的命令具有执行权限，但是Dockerfile中CMD已经提供了执行权限。为了让ENTRYPOINT指定的命令具备执行权限，我们可以利用`chmod +x`命令来执行：

```dockerfile
FROM ubuntu:latest

RUN chmod +x entrypoint.sh && ls -l entrypoint.sh # 查看执行权限是否正确设置

COPY entrypoint.sh /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
```

这样就可以通过如下方式启动容器：

```bash
$ docker build -t testimage.
$ docker run testimage
```

这种方法适用于安装软件时，希望运行的脚本具有执行权限。

## 2.4 配置环境变量和执行命令

除了以上两种方法外，我们还可以结合多种方法进行配置。比如，假设我们要配置一些环境变量、下载软件包并解压、添加配置文件、启动应用程序：

```dockerfile
FROM centos:7

ENV JAVA_HOME="/usr/lib/jvm/jre" \
    PATH=$JAVA_HOME/bin:$PATH \
    MYAPP_VERSION=v1.0

WORKDIR /opt/myapp
COPY myapp-$MYAPP_VERSION.tar.gz.
RUN tar xzf myapp-$MYAPP_VERSION.tar.gz \
  && mv myapp-$MYAPP_VERSION/*. \
  && rm -rf myapp-$MYAPP_VERSION*

COPY app.properties conf/

CMD exec java $JAVA_OPTS -Dconfig.file=conf/app.properties -jar myapp.jar
```

这样就可以通过如下方式启动容器：

```bash
$ docker build -t myapp.
$ docker run myapp
```

这种方法可以完美地完成各种任务。