
作者：禅与计算机程序设计艺术                    

# 1.简介
  

近年来，中国互联网公司都面临着数据收集、处理、分析、存储和展示等环节上的巨大挑战。对于快手这样的视频上传分享平台，用户在上传视频时，通过手机拍摄或选择相册中的照片进行上传。因此，视频上传并不仅仅局限于移动端用户，同时也受到PC端用户的广泛关注。由于移动端设备性能较高、相机的分辨率及系统的限制，因此，需要对视频上传流程做出优化。目前，快手推出了多项技术优化措施来提升视频上传速度、降低成本、提升用户体验，其中之一就是移动端视频上传优化。这也是面向新版本手机用户提供的优化策略之一。这次总结会以快手2021年结束的情况为基础，深入阐述快手平台对视频上传优化的策略、方法、实施细节，并提供下一步优化的方向建议。

        本文首先回顾快手平台历年的视频上传优化政策和技术方案，介绍视频上传优化的主要指标。然后介绍移动端视频上传优化技术路线图，以抖音为代表，介绍技术实践、效果评估等方面。最后通过多个案例研究，阐述平台优化的关键所在——运营商数据特征。本文最后给出未来的优化方向建议，为读者提供参考。

        本文适合有一定编程经验、对移动端开发有兴趣的技术人员阅读。

# 2.相关背景
## 2.1 数据采集
在互联网公司，数据采集是重中之重。数据采集可以帮助我们更好地理解用户行为，以及为产品提供更多的精准服务。数据采集的工作量一般都很大，涉及多个部门，往往需要一定的时间才能完成。而对于视频上传优化来说，这个过程特别重要。在快手，由于业务模式和核心业务特性的原因，视频上传并不是单纯的输入视频数据。它还包括手机号、视频时长、地域信息、设备信息、拍摄视频分辨率、视频编码格式等多个维度的数据。除了传统的日志记录方式外，快手还推出了企业微信数据采集工具，提供后台数据接口，方便第三方开发者和企业客户获取视频上传相关数据。这些数据的大量采集，有助于提升视频上传性能、减少成本。例如，可以更准确地识别影响视频上传性能的因素，改善平台的功能设计。
## 2.2 技术方案
### 2.2.1 视频上传优化的概念
视频上传优化（Video Upload Optimization）是指通过提升客户端的视频上传速度、降低成本、提升用户体验等方式，提升平台视频上传服务质量，提升平台整体收益。它主要包括两个部分：技术方案与管理政策。前者即将视频上传相关技术与流水线流程进行优化，以提升平台视频上传速度，降低成本；后者则围绕技术方案制定相关的管理政策，如实施计划、奖励机制、培训模型、应急预案等。

视频上传优化是基于数据驱动、多目标优化的理念，其核心价值观是“用户至上”。它的核心目标是实现视频上传的快速响应、低成本、优质体验。视频上传优化的三个维度如下：
- 速度：加快视频上传速度，达到用户最短可接受时间。
- 成本：降低视频上传成本，缩小视频创作和发布门槛。
- 用户体验：提升用户视频上传的体验，增加视频上传的愉悦感。

为了实现以上目标，视频上传优化通常由以下几个阶段组成：
- 拟合需求：分析用户行为习惯、产品特征、市场竞争等，制定优化目标。
- 定义指标：确定优化目标指标，以衡量优化效果。
- 优化设计：优化流程图，形成优化目标、优化工具、检查点和标准。
- 执行优化：实施优化项目，持续跟踪优化结果，进一步优化。

### 2.2.2 视频上传优化的技术方案
视频上传优化技术的核心是通过优化客户端上传视频的流程，提升用户上传视频的体验。目前，视频上传优化的技术路线图分为以下五个阶段：
- 网络优化：优化网络连接、传输速率、可用性。
- 硬件优化：提升主播端硬件配置，降低相机耗电、降低功耗。
- 渲染优化：压缩、调整渲染画面大小、降低帧率、提升渲染效率。
- 编码优化：优化编码参数，提升视频质量。
- 播放优化：优化视频播放器配置、降低卡顿率、提升播放质量。

虽然各个阶段可能存在不同的优化方法，但它们都可以归纳为两类：压缩优化和性能优化。压缩优化是指对视频文件进行瘦身压缩，减小文件大小；性能优化则是通过提升视频处理能力和系统资源，提升上传视频的速度、稳定性、品质。

压缩优化的方法可以分为以下几种：
- 视频压缩：将原始视频转换为更小的格式，例如AVC/H.264压缩。
- 分辨率优化：将视频重新编码，提升分辨率。
- 码率优化：采用更高码率的视频编码方式。

性能优化的方法可以分为以下几种：
- GPU加速：利用GPU资源进行视频编解码运算，提升处理效率。
- 调度优化：优化任务调度策略，减少线程切换消耗，提升视频上传速度。
- 文件系统优化：优化文件系统读写性能，提升文件缓存命中率。
- 内存优化：优化JVM堆大小和垃圾回收策略，提升GC效率，降低内存占用。

随着手机产品的迭代升级，视频上传优化技术已经成为优化视频上传服务的利器。但视频上传优化仍然是一个艰难的过程。首先，面对不同的网络环境、设备配置、处理性能等因素，视频上传的优化空间仍然很大；其次，不同场景下的优化目标也不同，平台需要针对不同的业务特点和用户群体，制定相应的优化策略。最后，当优化效果得不到满足时，需要不断优化优化目标，不断寻找新的突破口。因此，视频上传优化一直处在一个快速变化的动态环境里，并需要不断探索新的优化领域，不断更新自身的技术能力。

# 3.技术实现
## 3.1 优化网络连接
尽管无线宽带技术得到越来越普及，但它依然是国内视频上传行业的一个难题。由于网络条件的限制，导致很多用户无法快速上传视频。而由于缺乏有效的网络连接管理策略，使得用户只能等待网络状况的恢复，因此，视频上传服务的效率始终无法保证。因此，快手从2019年开始，就在技术上进行优化，推出了「测速」功能。通过用户拍摄视频、上传封面的比对，测出用户的上传速度。当用户上传视频的速度低于某个阈值时，后台会对视频进行审核。通过「测速」功能，平台能够及时发现用户上传视频的慢速程度，并及时阻止异常上传视频的行为，保障平台正常运行。在优化网络连接的过程中，快手还会按照国际通用的视频编码标准，为视频提供更好的兼容性。

另一方面，快手还在优化网络连接的策略。通过在用户上传视频的过程中，识别网络波动、弱电状态等网络信号，智能地自动调整上传策略，减少用户等待的时间。当用户网络连接出现问题时，平台会自动暂停视频上传，根据用户设备的当前状态、网络情况进行优化。如果网络连接恢复正常，平台会在一定时间内，恢复视频上传，继续上传视频。这样既能避免用户上传视频的延迟，又能保证用户的高效上传体验。

## 3.2 优化硬件配置
在快手，对于主播端硬件的配置进行了优化，减少了CPU负担，增加了RAM和存储空间。用户通过主播端拍摄视频，可以通过主播端的界面设置编码参数。例如，用户可以通过设置码率、帧率、清晰度等参数，控制视频的编码方式，达到更高的质量。另外，用户也可以在设置中开启静音模式，或者关闭摄像头，降低对硬件性能的依赖。

快手也通过多种方式提升用户上传视频的稳定性。通过运营商数据统计，了解到不同的运营商对视频上传的影响。例如，中国移动的用户较其他运营商更容易出现超时或丢包现象。因此，快手提出了在WiFi条件下，优先上传视频的策略。当用户在 WiFi 下拍摄视频时，优先上传到WIFI下的服务器，以提高视频上传的成功率。但是，由于运营商不同，WIFI的链接质量和速度可能会存在差异，所以，建议用户在拍摄视频时，尽量保持良好的网络环境，尽量避免使用蜂窝数据网络。

## 3.3 优化渲染
在快手，对渲染画面大小、帧率、码率等参数进行优化。用户可以通过手机的拍摄界面设置渲染画面大小、帧率、码率等参数。例如，用户可以通过设置渲染画面大小、帧率、码率等参数，选择最佳的渲染画面，降低视频上传所需的时间。另外，快手还通过拍摄模块的性能测试，发现部分设备存在渲染问题。因此，快手启动「抗抖动」功能，通过模拟人的行为，尽量减少用户渲染画面抖动。另外，快手还在加载渲染模块时，增加延时和缓冲提示，让用户知道视频的加载状态。

## 3.4 优化编码
在快手，通过对视频文件的编码参数进行优化，提升视频的质量。例如，用户可以在设置中选择H.265或HEVC编码，并设定码率、帧率、分辨率、码率控制策略等参数，提升视频上传的质量。此外，用户还可以在智能编辑模式中，对拍摄到的视频进行分类、标记，并对视频的播放体验进行优化。

## 3.5 优化播放
在快手，优化视频播放器的配置，以提升用户的视频播放体验。用户可以通过视频上传后的播放页面，设置播放速度、亮度、音量、画质，同时优化视频的播放体验。比如，在播放页面，用户可以通过滑动、拖动等手段，调整视频的播放进度；另外，快手还通过加载视频时的缓冲提示、失败提示、下载提示等方式，让用户更直观地看到视频的加载状态。

# 4.效果评估
## 4.1 测试对象
为了评估视频上传优化的效果，快手在内部开展了两个评估实验。第一项实验的对象是快手团队成员和对手商业合作伙伴，第二项实验的对象则是快手用户。
### 4.1.1 团队内部实验
在团队内部，快手团队成员在自己手上尝试优化视频上传的策略。他们分别对三种优化策略，进行了测试。实验结果显示，两种优化策略都取得了较好的效果。第一种策略是实时优化，即在用户上传视频的时候，智能识别网络状况、用户的当前状态，根据不同网络状态的情况，调整策略，比如优先上传到WIFI下的服务器。第二种策略则是手动优化，即用户可以在设置界面调整优化策略。两种优化策略都能显著提升视频上传的速度。但是，在实时优化策略上，需要通过智能识别信号的复杂性、不确定性等因素，引入额外的噪声，提升识别效果。

另外，快手团队还部署了「视频压缩」策略，对视频进行瘦身压缩，缩短视频文件大小，以降低网络传输的压力。该策略取得了明显的效果，平均压缩率超过70%，减少了用户等待的时间，提升了视频上传的成功率。

最后，快手团队还设置了「性能优化」策略，通过提升平台的处理能力，优化平台的上传速度。平台的处理能力主要表现在视频编码、视频编解码等环节。平台的处理性能优化方案包括调度优化、文件系统优化、内存优化等。这些优化方案能够提升用户上传视频的速度，保证平台的稳定性。

### 4.1.2 对手商业合作伙伴实验
在对手商业合作伙伴那里，快手和合作方对视频上传优化的方式进行了比较。实验结果显示，两方在优化视频上传的流程方面，均取得了明显的效果。快手采用的是实时优化、手动优化、视频压缩、性能优化四大策略。对手采用的是主动检测、子业务改造、计费补贴等策略。通过实时优化、视频压缩、性能优化等方式，快手的视频上传速度显著提升。另外，快手还将视频上传优化和商业合作的计费方式进行了协同，对合作伙伴的补贴收取情况进行评估，帮助合作伙伴降低成本。

## 4.2 监控与报告
为了实现视频上传优化的自动化、自动化、自动化，快手积累了大量的数据用于监控、分析、报告视频上传优化效果。主要的数据包括视频上传的数量、时长、质量、时延等。通过这些数据，快手能够及时掌握用户的真实反馈，反映平台上传优化的实际效果。快手还建立了实时的数据采集平台，实时汇总数据，形成全方位的视频上传优化效果报告。

# 5.未来优化方向
通过本文的叙述，我们学习到了视频上传优化的理论和技术原理。我们了解到，视频上传优化涉及用户、网络、硬件、软件等多个维度，并且需要解决众多的技术难题。我们还学习了如何通过数据采集、技术方案、效果评估、监控与报告等多重手段，实现视频上传优化的目的。接下来，我们展望一下视频上传优化的未来方向。

## 5.1 抖音优化方向
作为中国最大的短视频应用平台，抖音有大量的用户群体。作为中国版快手，抖音的视频上传优化离不开快手的技术底层支撑。抖音正在着力打造其独有的「音乐直播」业务，进一步打磨其视频上传优化能力。

**视觉优化：**抖音正在布局新的视频播放器框架，不仅支持PC端，还将逐步支持手机端。而且，抖音视频上传页面也将变得更加贴近音乐人、电影演员的审美体验，并引入AI虚拟化技术，改善用户的直观感受。

**资源优化：**抖音将利用云端存储，提升其视频上传速度、稳定性、上传质量。云端存储可大幅度提升上传速度，并自动检测、处理异常数据。同时，抖音还将利用云端资源，建设多级分发网络，通过内容分发网络，将视频分发给边缘节点，降低用户等待的时间。

**编辑优化：**抖音将构建强大的视频编辑功能，包括剪辑、修饰、特效、模板等模块，通过先进的机器学习技术，提升视频创作和发布效率。

**社交优化：**抖音将对用户上传的视频进行归类、推荐、排序，让视频以更加有意义的方式出现。这方面可以借鉴已有的公共账号推荐策略，比如热门标签、用户上传频道等。

## 5.2 B站优化方向
B站在2021年初开启了自己的全新视频上传系统，相较于之前的弹幕系统，全新系统提供了更多的功能选择。在新的系统上，用户可以自由上传自己喜欢的视频。但由于大量的新用户涌入，短视频创作者需要频繁的审核视频，短期内视频上传仍然会面临瓶颈。

**智能审核：**B站的智能审核系统将严格筛选视频内容，通过自动算法判断视频质量、安全性，并进行风险控制和监督。同时，B站将提供超高速、超高容量的云端存储空间，通过智能分布式架构，迅速部署视频审核中心。

**AI引擎优化：**B站最近推出的自研的AI引擎，能够对视频内容进行自动审核。引擎将结合大数据和人工智能技术，对内容进行智能解析、文本分析、图像分析等，精准定位视频质量的问题，并给出优化建议。

**用户体验优化：**B站将持续投入用户体验方面的优化，通过提升用户的视频浏览、上传体验，增加用户活跃度，增强用户黏性，促进视频创作。