                 

### 窗口函数：原理与应用

#### 1. 窗口函数的定义与作用

窗口函数是数据库查询中的一种特殊函数，它可以将一个有序集合划分为多个部分（窗口），并对每个部分进行聚合计算。窗口函数通常与`OVER()`子句一起使用，允许在结果集中按照行或列的顺序应用聚合函数。

窗口函数的作用主要包括：
- 对数据进行排序和分组。
- 对相邻的行或列进行聚合计算。
- 在结果中插入排名或分数。

#### 2. 窗口函数的基本语法

窗口函数的基本语法如下：

```sql
SELECT
  列名称,
  WINDOW_FUNCTION(列名称) OVER (ORDER BY 列名称)
FROM
  表名称;
```

其中，`WINDOW_FUNCTION` 可以是如下几种：
- `RANK()`：计算排名，相同值的排名会合并。
- `DENSE_RANK()`：计算排名，相同值的排名会连续。
- `ROW_NUMBER()`：计算唯一序号。
- `LEAD()`：获取相邻行的某个列值。
- `LAG()`：获取相邻前一行某个列值。
- `SUM()`、`AVG()`、`COUNT()`等：计算窗口内的聚合值。

#### 3. 窗口函数的实例讲解

##### 实例1：计算排名

假设我们有一个员工表`employees`，其中包含员工的姓名和薪资，我们想计算每个部门内员工的薪资排名。

```sql
SELECT
  employee_name,
  salary,
  DENSE_RANK() OVER (ORDER BY salary DESC) as rank
FROM
  employees;
```

在这个例子中，我们使用`DENSE_RANK()`窗口函数按照薪资的降序对员工进行排名。如果薪资相同，排名会连续。

##### 实例2：计算累计薪资

假设我们有一个销售记录表`sales`，其中包含销售日期和销售额，我们想计算每天的累计销售额。

```sql
SELECT
  sale_date,
  sale_amount,
  SUM(sale_amount) OVER (ORDER BY sale_date) as cumulative_sales
FROM
  sales;
```

在这个例子中，我们使用`SUM()`窗口函数按照销售日期的顺序对销售额进行累加，得到每天的累计销售额。

##### 实例3：获取相邻行的数据

假设我们有一个学生成绩表`scores`，其中包含学生的姓名、科目和成绩，我们想获取每个学生的下一个科目成绩。

```sql
SELECT
  student_name,
  subject,
  score,
  LEAD(score) OVER (PARTITION BY student_name ORDER BY subject) as next_score
FROM
  scores;
```

在这个例子中，我们使用`LEAD()`窗口函数获取每个学生按照科目升序排列后的下一个科目成绩。

#### 4. 窗口函数的优势与限制

**优势：**
- 窗口函数可以灵活地对数据进行行或列级别的计算。
- 可以处理复杂的数据分析任务，如排名、累计计算等。

**限制：**
- 窗口函数会增加查询的复杂度，可能影响性能。
- 使用窗口函数时需要注意`ORDER BY`子句和`PARTITION BY`子句的顺序和组合。

#### 5. 总结

窗口函数是数据库查询中的强大工具，它可以帮助我们进行复杂的数据分析和计算。通过理解窗口函数的基本原理和语法，我们可以更好地利用它们来处理各种数据处理任务。在实际应用中，需要根据具体需求选择合适的窗口函数，并注意性能和复杂度的平衡。

### 窗口函数面试题与编程题库

#### 1. 请解释窗口函数的概念及其作用？

**答案：** 窗口函数是一种特殊的聚合函数，它可以将数据集划分为多个部分（窗口），并对每个窗口中的数据进行聚合计算。窗口函数允许我们在结果集中按照行或列的顺序应用聚合函数，常用于计算排名、累计值、相邻行值等。

#### 2. 窗口函数的语法是怎样的？

**答案：** 窗口函数的基本语法为：

```sql
SELECT
  列名称,
  WINDOW_FUNCTION(列名称) OVER (ORDER BY 列名称)
FROM
  表名称;
```

其中，`WINDOW_FUNCTION` 可以是 `RANK()`、`DENSE_RANK()`、`ROW_NUMBER()`、`LEAD()`、`LAG()`、`SUM()`、`AVG()`、`COUNT()` 等。

#### 3. 请举例说明如何使用窗口函数计算排名？

**答案：** 假设有一个员工表 `employees`，包含员工姓名和薪资。使用窗口函数计算员工薪资排名：

```sql
SELECT
  employee_name,
  salary,
  DENSE_RANK() OVER (ORDER BY salary DESC) as rank
FROM
  employees;
```

在这个例子中，`DENSE_RANK()` 窗口函数按照薪资的降序计算排名。如果薪资相同，排名会连续。

#### 4. 窗口函数与普通聚合函数的区别是什么？

**答案：** 普通聚合函数对整个查询结果集进行聚合计算，而窗口函数则在结果集中对每一行数据应用聚合计算。窗口函数可以基于行或列的顺序进行计算，常用于计算排名、累计值等。

#### 5. 请解释 `RANK()` 和 `DENSE_RANK()` 的区别？

**答案：** `RANK()` 和 `DENSE_RANK()` 都是用于计算排名的窗口函数，区别在于：
- `RANK()`：计算排名，相同值的排名会合并，即排名会出现空缺。
- `DENSE_RANK()`：计算排名，相同值的排名会连续，即排名不会出现空缺。

#### 6. 如何使用窗口函数计算累计值？

**答案：** 假设有一个销售记录表 `sales`，包含销售日期和销售额。使用窗口函数计算每天的累计销售额：

```sql
SELECT
  sale_date,
  sale_amount,
  SUM(sale_amount) OVER (ORDER BY sale_date) as cumulative_sales
FROM
  sales;
```

在这个例子中，`SUM()` 窗口函数按照销售日期的顺序对销售额进行累加，得到每天的累计销售额。

#### 7. 窗口函数有哪些常用的函数？

**答案：** 常用的窗口函数包括：
- `RANK()`：计算排名。
- `DENSE_RANK()`：计算连续排名。
- `ROW_NUMBER()`：计算唯一序号。
- `LEAD()`：获取相邻行的某个列值。
- `LAG()`：获取相邻前一行某个列值。
- `SUM()`、`AVG()`、`COUNT()`：计算窗口内的聚合值。

#### 8. 请解释 `OVER()` 子句中的 `PARTITION BY` 子句的作用？

**答案：** `PARTITION BY` 子句用于将窗口划分为多个子窗口，每个子窗口包含具有相同列值的行。在`OVER()`子句中使用`PARTITION BY`子句可以分别对不同的分组数据应用窗口函数。

#### 9. 请解释 `OVER()` 子句中的 `ORDER BY` 子句的作用？

**答案：** `ORDER BY` 子句用于指定窗口中行的排序顺序。窗口函数根据这个排序顺序对窗口中的数据进行聚合计算。

#### 10. 请编写一个 SQL 查询，使用窗口函数计算每个部门的员工数量排名？

**答案：** 假设有一个员工表 `employees`，包含员工姓名和部门编号。使用窗口函数计算每个部门的员工数量排名：

```sql
SELECT
  department_id,
  COUNT(*) OVER (PARTITION BY department_id) as employee_count,
  RANK() OVER (ORDER BY COUNT(*) DESC) as rank
FROM
  employees
GROUP BY
  department_id;
```

在这个例子中，`PARTITION BY` 子句将员工按部门分组，`COUNT(*)` 计算每个部门的员工数量，`RANK()` 计算各部门员工数量的排名。

### 窗口函数编程题库

#### 1. 编写一个 SQL 查询，计算每个员工的薪资排名。

**题目描述：** 假设有一个员工表 `employees`，包含员工姓名和薪资。编写一个 SQL 查询，计算每个员工的薪资排名，薪资相同的员工排名合并。

**答案：**

```sql
SELECT
  employee_name,
  salary,
  DENSE_RANK() OVER (ORDER BY salary DESC) as salary_rank
FROM
  employees;
```

#### 2. 编写一个 SQL 查询，计算每个部门的总薪资和薪资排名。

**题目描述：** 假设有一个员工表 `employees`，包含员工姓名、薪资和部门编号。编写一个 SQL 查询，计算每个部门的总薪资和薪资排名。

**答案：**

```sql
SELECT
  department_id,
  SUM(salary) OVER (PARTITION BY department_id) as total_salary,
  DENSE_RANK() OVER (PARTITION BY department_id ORDER BY SUM(salary) DESC) as salary_rank
FROM
  employees
GROUP BY
  department_id;
```

#### 3. 编写一个 SQL 查询，获取每个员工的上一个部门的薪资。

**题目描述：** 假设有一个员工表 `employees`，包含员工姓名、薪资和部门编号。编写一个 SQL 查询，获取每个员工的薪资以及他们的上一个部门的薪资。

**答案：**

```sql
SELECT
  current_employee.employee_name,
  current_employee.salary,
  previous_department.salary as previous_salary
FROM
  employees current_employee
  JOIN employees previous_employee ON current_employee.employee_name = previous_employee.employee_name
    AND current_employee.department_id = previous_employee.department_id
    AND current_employee.salary > previous_employee.salary
ORDER BY
  current_employee.employee_name;
```

#### 4. 编写一个 SQL 查询，计算每个员工在过去一年的平均薪资。

**题目描述：** 假设有一个员工表 `employees`，包含员工姓名、薪资和入职日期。编写一个 SQL 查询，计算每个员工在过去一年的平均薪资。

**答案：**

```sql
SELECT
  employee_name,
  AVG(salary) OVER (PARTITION BY employee_name ORDER BY hire_date ROWS BETWEEN 1 PRECEDING AND CURRENT ROW) as avg_salary
FROM
  employees;
```

#### 5. 编写一个 SQL 查询，获取每个销售记录的前五个客户的销售额。

**题目描述：** 假设有一个销售记录表 `sales`，包含销售记录的日期和客户的销售额。编写一个 SQL 查询，获取每个销售记录的前五个客户的销售额。

**答案：**

```sql
WITH ranked_sales AS (
  SELECT
    customer_id,
    sale_date,
    sale_amount,
    ROW_NUMBER() OVER (PARTITION BY sale_date ORDER BY sale_amount DESC) as rank
  FROM
    sales
)
SELECT
  customer_id,
  sale_date,
  sale_amount
FROM
  ranked_sales
WHERE
  rank <= 5;
```

### 完整的代码实例讲解

为了更好地理解窗口函数的应用，我们将通过一个实际案例进行代码实例讲解。在这个案例中，我们使用一个销售数据表，包含多个销售记录，每个记录包括销售日期、客户ID和销售额。我们的目标是根据这些数据使用窗口函数来完成以下任务：

1. 计算每个客户的月度销售额排名。
2. 计算每个客户的年度销售额排名。
3. 获取每个客户的最近三次销售记录。

#### 数据准备

首先，我们需要一个包含销售记录的表。以下是一个示例表的结构和样例数据：

```sql
CREATE TABLE sales (
  id INT PRIMARY KEY,
  sale_date DATE,
  customer_id INT,
  sale_amount DECIMAL(10, 2)
);

INSERT INTO sales (id, sale_date, customer_id, sale_amount) VALUES
(1, '2023-01-01', 1001, 2000.00),
(2, '2023-01-02', 1001, 1500.00),
(3, '2023-01-01', 1002, 3000.00),
(4, '2023-01-03', 1001, 2500.00),
(5, '2023-02-01', 1001, 1800.00),
(6, '2023-02-01', 1002, 2000.00),
(7, '2023-02-02', 1001, 2200.00),
(8, '2023-03-01', 1002, 4000.00),
(9, '2023-03-01', 1001, 3000.00),
(10, '2023-03-02', 1001, 2800.00);
```

#### 任务1：计算每个客户的月度销售额排名

我们需要计算每个客户在每个月份的销售额排名。为了实现这个目标，我们将使用`DENSE_RANK()`窗口函数，根据销售日期对销售额进行降序排序。

```sql
SELECT
  customer_id,
  EXTRACT(MONTH FROM sale_date) as month,
  SUM(sale_amount) as total_sales,
  DENSE_RANK() OVER (PARTITION BY customer_id ORDER BY SUM(sale_amount) DESC) as monthly_rank
FROM
  sales
GROUP BY
  customer_id, EXTRACT(MONTH FROM sale_date);
```

在这个查询中，我们首先使用`EXTRACT(MONTH FROM sale_date)`提取销售记录的月份，然后使用`SUM(sale_amount)`计算每个客户的月度总销售额。`DENSE_RANK()`窗口函数按照每个客户的月度总销售额进行降序排名。

#### 任务2：计算每个客户的年度销售额排名

类似地，我们需要计算每个客户在每个年份的销售额排名。这里我们使用`DENSE_RANK()`窗口函数，根据销售日期对销售额进行降序排序，并按照年份进行分组。

```sql
SELECT
  customer_id,
  EXTRACT(YEAR FROM sale_date) as year,
  SUM(sale_amount) as total_sales,
  DENSE_RANK() OVER (PARTITION BY customer_id ORDER BY SUM(sale_amount) DESC) as yearly_rank
FROM
  sales
GROUP BY
  customer_id, EXTRACT(YEAR FROM sale_date);
```

在这个查询中，我们使用`EXTRACT(YEAR FROM sale_date)`提取销售记录的年份，然后使用`SUM(sale_amount)`计算每个客户的年度总销售额。`DENSE_RANK()`窗口函数按照每个客户的年度总销售额进行降序排名。

#### 任务3：获取每个客户的最近三次销售记录

最后，我们需要获取每个客户的最近三次销售记录。为此，我们将使用`ROW_NUMBER()`窗口函数，根据销售日期对销售记录进行升序排序。

```sql
SELECT
  customer_id,
  sale_date,
  sale_amount,
  ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY sale_date) as record_rank
FROM
  sales
ORDER BY
  customer_id, record_rank;
```

在这个查询中，我们使用`ROW_NUMBER()`窗口函数为每个客户的销售记录分配一个序号，按照销售日期进行升序排序。然后，我们只选择序号小于或等于3的记录，即每个客户的最近三次销售记录。

### 完整代码实例解析

以上三个查询组合在一起，我们可以得到一个综合的查询结果，展示每个客户的月度、年度销售额排名以及最近三次的销售记录。以下是完整的查询代码和解析：

```sql
WITH monthly_sales AS (
  SELECT
    customer_id,
    EXTRACT(MONTH FROM sale_date) as month,
    SUM(sale_amount) as total_sales,
    DENSE_RANK() OVER (PARTITION BY customer_id ORDER BY SUM(sale_amount) DESC) as monthly_rank
  FROM
    sales
  GROUP BY
    customer_id, EXTRACT(MONTH FROM sale_date)
),
yearly_sales AS (
  SELECT
    customer_id,
    EXTRACT(YEAR FROM sale_date) as year,
    SUM(sale_amount) as total_sales,
    DENSE_RANK() OVER (PARTITION BY customer_id ORDER BY SUM(sale_amount) DESC) as yearly_rank
  FROM
    sales
  GROUP BY
    customer_id, EXTRACT(YEAR FROM sale_date)
),
recent_sales AS (
  SELECT
    customer_id,
    sale_date,
    sale_amount,
    ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY sale_date) as record_rank
  FROM
    sales
)
SELECT
  ms.customer_id,
  ms.month,
  ms.monthly_rank,
  ms.total_sales AS monthly_sales,
  ys.year,
  ys.yearly_rank,
  ys.total_sales AS yearly_sales,
  rs.sale_date,
  rs.sale_amount AS recent_sales
FROM
  monthly_sales ms
JOIN
  yearly_sales ys ON ms.customer_id = ys.customer_id AND ms.month = ys.month
JOIN
  recent_sales rs ON ms.customer_id = rs.customer_id AND rs.record_rank <= 3
ORDER BY
  ms.customer_id, ms.month DESC, ys.year DESC, rs.record_rank;
```

#### 解析：

1. **月度销售额排名（`monthly_sales` CTE）**：这个公用表表达式（Common Table Expression, CTE）计算每个客户每个月份的销售额，并按销售额降序排名。

2. **年度销售额排名（`yearly_sales` CTE）**：这个 CTE 计算每个客户每个年份的销售额，并按销售额降序排名。

3. **最近三次销售记录（`recent_sales` CTE）**：这个 CTE 为每个客户的销售记录分配一个序号，按照销售日期升序排序，只选择前三个记录。

4. **最终查询**：使用三个 CTE 的结果进行连接，展示每个客户的月度、年度销售额排名以及最近三次销售记录。连接条件包括客户ID和月份或年份。

通过这个综合查询，我们可以得到每个客户的全方位销售信息，包括销售额排名和最近销售记录。窗口函数的应用使得数据分析和报告变得更加灵活和高效。

### 总结

窗口函数是SQL中的一项强大功能，它允许我们在数据集的行或列级别进行复杂的数据分析和计算。通过理解窗口函数的基本原理和语法，以及掌握常用的窗口函数如`DENSE_RANK()`、`RANK()`、`SUM()`、`LEAD()`、`LAG()`等，我们可以编写复杂的查询来满足各种数据处理需求。在实际应用中，合理地使用窗口函数可以提高数据处理的效率和灵活性。同时，通过具体的实例和代码解析，我们可以更深入地理解窗口函数的实际应用场景和技巧。

### 窗口函数面试题与编程题库

**1. 请解释窗口函数的概念及其作用？**

窗口函数是一种特殊的聚合函数，它可以将数据集划分为多个部分（窗口），并对每个窗口中的数据进行聚合计算。窗口函数允许我们在结果集中按照行或列的顺序应用聚合函数，常用于计算排名、累计值、相邻行值等。

**2. 窗口函数的语法是怎样的？**

窗口函数的基本语法为：

```sql
SELECT
  列名称,
  WINDOW_FUNCTION(列名称) OVER (ORDER BY 列名称)
FROM
  表名称;
```

其中，`WINDOW_FUNCTION` 可以是 `RANK()`、`DENSE_RANK()`、`ROW_NUMBER()`、`LEAD()`、`LAG()`、`SUM()`、`AVG()`、`COUNT()` 等。

**3. 请举例说明如何使用窗口函数计算排名？**

假设有一个员工表 `employees`，包含员工姓名和薪资。使用窗口函数计算员工薪资排名：

```sql
SELECT
  employee_name,
  salary,
  DENSE_RANK() OVER (ORDER BY salary DESC) as rank
FROM
  employees;
```

在这个例子中，`DENSE_RANK()` 窗口函数按照薪资的降序计算排名。如果薪资相同，排名会连续。

**4. 窗口函数与普通聚合函数的区别是什么？**

普通聚合函数对整个查询结果集进行聚合计算，而窗口函数则在结果集中对每一行数据应用聚合计算。窗口函数可以基于行或列的顺序进行计算，常用于计算排名、累计值等。

**5. 请解释 `RANK()` 和 `DENSE_RANK()` 的区别？**

`RANK()` 和 `DENSE_RANK()` 都是用于计算排名的窗口函数，区别在于：
- `RANK()`：计算排名，相同值的排名会合并，即排名会出现空缺。
- `DENSE_RANK()`：计算排名，相同值的排名会连续，即排名不会出现空缺。

**6. 如何使用窗口函数计算累计值？**

假设有一个销售记录表 `sales`，包含销售日期和销售额。使用窗口函数计算每天的累计销售额：

```sql
SELECT
  sale_date,
  sale_amount,
  SUM(sale_amount) OVER (ORDER BY sale_date) as cumulative_sales
FROM
  sales;
```

在这个例子中，`SUM()` 窗口函数按照销售日期的顺序对销售额进行累加，得到每天的累计销售额。

**7. 窗口函数有哪些常用的函数？**

常用的窗口函数包括：
- `RANK()`：计算排名。
- `DENSE_RANK()`：计算连续排名。
- `ROW_NUMBER()`：计算唯一序号。
- `LEAD()`：获取相邻行的某个列值。
- `LAG()`：获取相邻前一行某个列值。
- `SUM()`、`AVG()`、`COUNT()`：计算窗口内的聚合值。

**8. 请解释 `OVER()` 子句中的 `PARTITION BY` 子句的作用？**

`PARTITION BY` 子句用于将窗口划分为多个子窗口，每个子窗口包含具有相同列值的行。在 `OVER()` 子句中使用 `PARTITION BY` 子句可以分别对不同的分组数据应用窗口函数。

**9. 请解释 `OVER()` 子句中的 `ORDER BY` 子句的作用？**

`ORDER BY` 子句用于指定窗口中行的排序顺序。窗口函数根据这个排序顺序对窗口中的数据进行聚合计算。

**10. 请编写一个 SQL 查询，计算每个客户的月度销售额排名？**

**答案：**

```sql
SELECT
  customer_id,
  EXTRACT(MONTH FROM sale_date) as month,
  SUM(sale_amount) as total_sales,
  DENSE_RANK() OVER (PARTITION BY customer_id ORDER BY SUM(sale_amount) DESC) as monthly_rank
FROM
  sales
GROUP BY
  customer_id, EXTRACT(MONTH FROM sale_date);
```

在这个查询中，我们使用 `DENSE_RANK()` 窗口函数计算每个客户在每个月份的销售额排名。

**11. 请编写一个 SQL 查询，计算每个客户的年度销售额排名？**

**答案：**

```sql
SELECT
  customer_id,
  EXTRACT(YEAR FROM sale_date) as year,
  SUM(sale_amount) as total_sales,
  DENSE_RANK() OVER (PARTITION BY customer_id ORDER BY SUM(sale_amount) DESC) as yearly_rank
FROM
  sales
GROUP BY
  customer_id, EXTRACT(YEAR FROM sale_date);
```

在这个查询中，我们使用 `DENSE_RANK()` 窗口函数计算每个客户在每个年份的销售额排名。

**12. 请编写一个 SQL 查询，获取每个客户的最近三次销售记录？**

**答案：**

```sql
SELECT
  customer_id,
  sale_date,
  sale_amount,
  ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY sale_date) as record_rank
FROM
  sales
ORDER BY
  customer_id, record_rank;
```

在这个查询中，我们使用 `ROW_NUMBER()` 窗口函数为每个客户的销售记录分配一个序号，按照销售日期进行升序排序。然后，我们只选择序号小于或等于3的记录，即每个客户的最近三次销售记录。

**13. 请编写一个 SQL 查询，计算每个产品的平均销售额？**

**答案：**

```sql
SELECT
  product_id,
  AVG(sale_amount) OVER (PARTITION BY product_id) as average_sale_amount
FROM
  sales;
```

在这个查询中，我们使用 `AVG()` 窗口函数计算每个产品的平均销售额。

**14. 请编写一个 SQL 查询，获取每个销售人员的年度销售总额及排名？**

**答案：**

```sql
SELECT
  sales_person_id,
  SUM(sale_amount) as total_sales,
  DENSE_RANK() OVER (ORDER BY SUM(sale_amount) DESC) as sales_rank
FROM
  sales
GROUP BY
  sales_person_id;
```

在这个查询中，我们使用 `DENSE_RANK()` 窗口函数计算每个销售人员的年度销售总额及排名。

**15. 请编写一个 SQL 查询，获取每个产品在特定时间窗口内的销售额总和？**

**答案：**

```sql
SELECT
  product_id,
  sale_date,
  SUM(sale_amount) OVER (PARTITION BY product_id ORDER BY sale_date RANGE BETWEEN INTERVAL '1' MONTH PRECEDING AND CURRENT ROW) as monthly_sales
FROM
  sales;
```

在这个查询中，我们使用 `SUM()` 窗口函数计算每个产品在特定时间窗口（如一个月）内的销售额总和。

**16. 请编写一个 SQL 查询，获取每个客户的历史最高销售额？**

**答案：**

```sql
SELECT
  customer_id,
  MAX(sale_amount) OVER (PARTITION BY customer_id) as max_sales
FROM
  sales;
```

在这个查询中，我们使用 `MAX()` 窗口函数计算每个客户的历史最高销售额。

**17. 请编写一个 SQL 查询，计算每个销售人员的销售额分布（如：前20%、中20%、后20%）？**

**答案：**

```sql
WITH sales_ranked AS (
  SELECT
    sales_person_id,
    SUM(sale_amount) as total_sales,
    NTILE(5) OVER (ORDER BY SUM(sale_amount) DESC) as quartile
  FROM
    sales
  GROUP BY
    sales_person_id
)
SELECT
  quartile,
  MIN(total_sales) as lower_bound,
  MAX(total_sales) as upper_bound
FROM
  sales_ranked
GROUP BY
  quartile;
```

在这个查询中，我们使用 `NTILE()` 窗口函数将销售人员按销售额分布分为五个 quartile（前20%、中20%、后20%等），然后计算每个 quartile 的销售额范围。

**18. 请编写一个 SQL 查询，获取每个客户的最近一次购买日期？**

**答案：**

```sql
SELECT
  customer_id,
  MAX(sale_date) OVER (PARTITION BY customer_id) as last_purchase_date
FROM
  sales;
```

在这个查询中，我们使用 `MAX()` 窗口函数计算每个客户的最近一次购买日期。

**19. 请编写一个 SQL 查询，计算每个产品的销售额占比？**

**答案：**

```sql
WITH total_sales AS (
  SELECT
    SUM(sale_amount) as total_sales
  FROM
    sales
)
SELECT
  product_id,
  SUM(sale_amount) / total_sales.total_sales as sales_percentage
FROM
  sales
JOIN
  total_sales ON TRUE
GROUP BY
  product_id;
```

在这个查询中，我们首先计算总销售额，然后计算每个产品的销售额占总销售额的比例。

**20. 请编写一个 SQL 查询，获取每个销售人员的销售趋势（如：销售额每月的增长率）？**

**答案：**

```sql
WITH monthly_sales AS (
  SELECT
    sales_person_id,
    EXTRACT(MONTH FROM sale_date) as month,
    SUM(sale_amount) as total_sales
  FROM
    sales
  GROUP BY
    sales_person_id, EXTRACT(MONTH FROM sale_date)
)
SELECT
  sales_person_id,
  month,
  LAG(total_sales, 1) OVER (PARTITION BY sales_person_id ORDER BY month) as previous_month_sales,
  total_sales,
  (total_sales - LAG(total_sales, 1) OVER (PARTITION BY sales_person_id ORDER BY month)) / LAG(total_sales, 1) OVER (PARTITION BY sales_person_id ORDER BY month) * 100 as growth_rate
FROM
  monthly_sales;
```

在这个查询中，我们使用 `LAG()` 窗口函数获取每个销售人员的上一月销售额，然后计算当前月销售额与上一月销售额的增长率。

