
作者：禅与计算机程序设计艺术                    

# 1.简介
  

Excel 是 Office 系列软件中的一款非常流行的数据分析工具，也是数据分析领域的事实上的标准。但因为它本身的特点（多用户协作、功能丰富、界面美观），使得初学者学习成本较高。因此很多初级的 Excel 用户都望而生畏，并把学习曲线拉得更陡峭。为了帮助这些初学者，我将提供一些高级 Excel 函数和技巧，用以快速入门，提升 Excel 数据分析能力。文章将从以下几个方面展开：

- 数据导入导出
- 数据处理和分析函数
- 图表制作
- 表单ulas开发技巧
- 优化工作效率技巧

# 2. 数据导入导出

## 2.1 数据导入
在实际应用中，我们往往需要从各种各样的数据源中获取信息并进行数据分析，如数据库、文件、Web API、电子邮箱等。数据的获取方式可以分为两种：

1. 手动输入：一般是通过键盘输入或点击鼠标来逐个键入数据，这种方式比较简单直接，适合少量数据量的导入；
2. 使用导入功能：Excel 提供了“数据”选项卡上的“导入数据”功能，可以直接读取各种数据源中的数据，包括 CSV 文件、Excel 文件、文本文件、数据库、网页、XML、JSON等。此外，也可选择连接到云服务，自动导入云端数据。

### 2.1.1 从 CSV 或文本文件导入
对于 CSV 和文本文件，只需打开文件所在目录，然后依次点击“数据”→“导入数据”→“从文本”或“从逗号分隔符文本文件(CSV)”，即可完成导入。导入时，默认使用第一个列作为唯一标识符，因此第一行为标签，其余行为数据。如果文件中存在注释行，则建议勾选“包括第一个数据行”。


### 2.1.2 从数据库导入
如果数据存储在关系型数据库或 SQL 查询结果集中，可以使用以下方式导入：

1. 通过 ODBC（Open Database Connectivity）连接数据库
2. 通过 OLEDB（Object Linking and Embedding Database）连接数据库
3. 使用 Power Query（Power BI 的一项功能）直接连接数据库并生成 Excel 电子表格

其中，通过 ODBC 连接数据库，可以访问各种各样的数据库产品，包括 Oracle、SQL Server、MySQL、PostgreSQL 等；OLEDB 可以访问较老的数据库产品，例如 Access 和 Excel；Power Query 可用于直接连接云端数据，例如 Azure 数据资源管理器、Google BigQuery 等。

### 2.1.3 从 Web API 导入
对于经常使用的 Web API 服务，也可以使用 Excel 中的“数据”选项卡上的“从 Web 获取数据”功能快速导入。只需填写 API URL 和参数，即可获取接口返回的数据。


注意，如果采用该方式导入数据，请注意数据量大小，避免造成网络通信过慢或失败。

## 2.2 数据导出
除了导入数据之外，还有一种数据导出的需求。比如，在 Excel 中分析出好看的数据表后，希望能够保存到其他地方以便分享、处理或者统计。因此，Excel 提供了“数据”选项卡上的“导出数据”功能，可以轻松实现。

### 2.2.1 将当前工作簿另存为 CSV 文件
最简单的就是将当前工作簿另存为 CSV 文件。首先，在“数据”选项卡上右击要保存的文件名，选择“另存为”菜单项；然后在下拉菜单中选择“CSV 文件 (*.csv)”；最后，点击确定按钮，即可将 Excel 表格保存为 CSV 文件。


### 2.2.2 将当前工作表另存为 CSV 文件
如果只想保存某个工作表而不是整个工作簿，也可以按照同样的方法进行操作。首先，定位到需要保存的工作表，然后单击右键；选择“另存为”菜单项；在下拉菜单中选择“CSV 文件 (*.csv)”；最后，点击确定按钮，即可将该工作表保存为 CSV 文件。


当然，如果想要保留 Excel 格式的表格样式，可以在 “文件” → “另存为” 下拉菜单中选择“Excel 文件 (*.xlsx)”；这样就可以保留表格格式，包括单元格格式、筛选和排序规则等。不过，保存为 CSV 文件通常不需要保留这种复杂的格式设置。

### 2.2.3 将工作簿发送至电子邮件
如果工作簿尺寸不超过 1 MB，可以通过 Outlook 直接将 Excel 工作簿发送至电子邮件。首先，定位到要发送的工作簿，单击右键；选择“发送到”菜单项；在下拉菜单中选择“电子邮件”；然后，在“向导”中填写收件人、主题、正文等信息；最后，点击发送按钮，即可发送电子邮件。


注意，由于网络环境不同，邮件发送可能遇到延迟或失败；因此，建议仅对重要数据（尤其是长时间内生成的数据）进行定期发送。

# 3. 数据处理和分析函数

## 3.1 数据筛选和排序
筛选和排序功能虽然在日常操作中很常见，但却不容易被初学者理解。特别是在处理复杂的数据表时，需要经常考虑如何高效地筛选和调整数据。下面先介绍数据筛选相关的基础知识。

### 3.1.1 基于值的筛选
当表格中含有特定值时，可以通过鼠标拖动筛选，或者按住 Ctrl/Shift 键拖动来批量选择符合条件的值。另外，还可以通过下拉菜单或筛选栏快速定位到指定范围的值。


### 3.1.2 基于范围的筛选
当表格中含有连续范围的数据时，也可以通过筛选范围的方式来缩小搜索范围。


### 3.1.3 删除重复数据
在 Excel 中，可以对含有重复数据的单元格右击选择“删除重复项”或按 F4 快捷键，可删除重复数据。但是，应谨慎使用该功能，避免误删重要数据。

### 3.1.4 按列排序
如果想按某一列进行排序，可以选择该列的标题进行上下排列，也可以按住 Alt 键同时按回车键，可以对整个列进行倒序排序。


### 3.1.5 按多列排序
如果要同时排序多个列，可以使用组合列功能。先对所需的两列单击左键，然后按住 Shift 键再单击另一列的标题，即可同时对两个列进行排序。


### 3.1.6 数据透视表
数据透视表是指将一个数据表按照某个或某些维度进行分类，得到的数据表结构称为透视表。在 Excel 中，可以通过数据表的另存为功能转变为透视表。具体操作如下：

选择“插入”→“透视表”菜单项，创建透视表。之后，可以通过选择框、下拉菜单、筛选栏等方式对数据进行分类和汇总。


透视表具有广泛的应用价值，包括业务报告、市场分析、竞争对比等。不过，其使用也有一定难度。初学者应尽量先熟悉基本的数据筛选、排序技巧。

## 3.2 数据计算和分析
计算和分析功能是指对数据进行一些数学运算或逻辑判断，得到新的计算值或分析结果。在 Excel 中，提供了多种数据计算函数，可以灵活地对数据进行转换、计算。

### 3.2.1 算数运算
Excel 提供了各种基本的算术运算函数，如加法、减法、乘法、除法、整除、幂运算、平方根、三角函数等。这些函数都是在“公式”选项卡上的“科学”一栏中找到的。


除此之外，还可以自定义函数，利用 Excel 的编程能力可以做更多的高级计算。

### 3.2.2 百分比运算
如果有两个或多个数字之间的数据差距较大，可以使用百分比形式展示，即以 100 为基准，显示另一个数据相对于第一个数据的比例。如：A 比 B 有 30% 的占比。

Excel 提供了百分比函数，可实现以下几种功能：

1. 求和：将数据以百分比形式求和，得到总体百分比。
2. 平均值：将数据以百分比形式求均值，得到平均值百分比。
3. 重塑：根据某个给定的基准值，将数据重新分布，按新的基准值计算百分比。


### 3.2.3 对比运算
在分析数据时，有时会发现某两个或多个数据之间的关系。比如，两个国家之间的 GDP 对比，或不同产品的销售额对比。在 Excel 中，可以用对比运算函数对数据进行比较和分析。

- 检验假设：可对数据作出假设检验，确定相关性是否显著。
- 线性回归：研究两个变量之间的关系，通过直线拟合获得回归直线和回归系数。
- 漏斗图：可视化两个变量间的相关性程度，通过漏斗图分析每个变量对总体影响力。


### 3.2.4 统计分析
数据统计分析可以对多个变量之间的数据进行概览、整合、呈现和分析。在 Excel 中，可以利用 “分析” 工具栏下的各种统计分析函数对数据进行分析。


### 3.2.5 逻辑运算
有时，我们需要根据某些条件判断是否应该执行某些操作，如修改某个单元格值或增加一条新记录。在 Excel 中，可以利用逻辑运算函数实现各种条件判断。


# 4. 图表制作

## 4.1 折线图和柱状图
折线图和柱状图是最常用的图表类型。它们通过横轴和纵轴表示两个或多个变量间的关系。

在 Excel 中，可以通过插入图表功能添加折线图和柱状图，或者在“插入”菜单中选择相应的图表类型。


折线图和柱状图的构建过程如下：

1. 添加数据：选择“数据”选项卡中的数据，包括横轴、纵轴、分类轴、交叉轴等。
2. 设置样式：在图表工具栏中设置图形样式、颜色、线宽、点类型等。
3. 更改坐标轴：通过拖动坐标轴刻度来调整刻度标记、位置、数量等。
4. 添加注释：在图表中添加注释，包括图例、数据点注释等。
5. 调整顺序：通过拖放来调整图表的层级顺序。

## 4.2 饼图和雷达图
饼图和雷达图属于细长图表，又称甜甜圈图。它主要用于表示分类数据之间的比例关系。

在 Excel 中，可以通过插入图表功能添加饼图和雷达图，或者在“插入”菜单中选择相应的图表类型。


饼图和雷达图的构建过程如下：

1. 添加数据：选择“数据”选项卡中的数据，包括分类数据。
2. 设置样式：在图表工具栏中设置图形样式、颜色、边框、线宽、填充色等。
3. 添加注释：在图表中添加注释，包括数据注释等。
4. 调整顺序：通过拖放来调整图表的层级顺序。

## 4.3 散点图
散点图是以二维坐标系绘制的，表示两个变量之间的关系。它的优点是直观，可以呈现出许多种数据模式。

在 Excel 中，可以通过插入图表功能添加散点图，或者在“插入”菜单中选择相应的图表类型。


散点图的构建过程如下：

1. 添加数据：选择“数据”选项卡中的数据，包括横轴、纵轴、大小、颜色等。
2. 设置样式：在图表工具栏中设置图形样式、颜色、边框、线宽、透明度等。
3. 添加注释：在图表中添加注释，包括数据点注释等。
4. 调整顺序：通过拖放来调整图表的层级顺序。

## 4.4 箱线图
箱线图是以盒须图形显示数据的分散情况，也叫箱形图。它用颜色来区分数据的四分位数，从而反映出数据的离散程度。

在 Excel 中，可以通过插入图表功能添加箱线图，或者在“插入”菜单中选择相应的图表类型。


箱线图的构建过程如下：

1. 添加数据：选择“数据”选项卡中的数据，包括横轴、纵轴等。
2. 设置样式：在图表工具栏中设置图形样式、颜色、边框、线宽等。
3. 添加注释：在图表中添加注释，包括四分位数注释等。
4. 调整顺序：通过拖放来调整图表的层级顺序。

# 5. 表单ulas开发技巧

## 5.1 动态数组
在 Excel 中，表单ulas（公式）可以处理数据，但是也可以声明动态数组，并根据条件变化其大小。动态数组的优点是灵活方便，可以根据运行时的条件变化对数据的处理方式。

### 5.1.1 创建数组
创建一个名称为“myArray”的动态数组，初始容量为10，每行10个元素，格式为字符串。

```
=CREATEARRAY("myArray",10,"","String")
```

### 5.1.2 修改数组大小
在名称为“myArray”的动态数组中插入第11行数据，并扩展其容量为20。

```
=INSERTINTOARRAY("myArray",11,"new data","String",TRUE) & 
=RESIZEARRAY("myArray",20)
```

### 5.1.3 查找数组元素
查找名称为“myArray”的动态数组中第10行第5个元素。

```
=GETVALUEFROMARRAY("myArray",9,4)
```

### 5.1.4 修改数组元素
将名称为“myArray”的动态数组中第10行第5个元素设置为“updated data”。

```
=SETVALUEATARRAY("myArray",9,4,"updated data")
```

## 5.2 条件格式

条件格式是利用对单元格或单元格组的格式或样式进行设置，从而突出显示或突出显示某些特殊数据。在 Excel 中，可以定义多个条件格式，并应用到不同的单元格或单元格组上。

### 5.2.1 创建条件格式
创建一个条件格式，以红色突出显示等于“=apple”的数据。

```
=ADDCONDITIONALFORMATTING("=mySheet!$B$1:$B$500","","Red","background:coral;fontcolor:white;",FALSE,"equal", "apple")
```

### 5.2.2 复制条件格式
创建一个名称为“myFormat”的条件格式，复制自上述条件格式。

```
=COPYCONDITIONALFORMATTING("myFormat","=")
```

### 5.2.3 删除条件格式
删除名称为“myFormat”的条件格式。

```
=REMOVECONDITIONALFORMATTING("myFormat")
```

## 5.3 VBA编程

VBA（Visual Basic for Applications）是一个微软公司推出的一套免费、开源的office组件集合。借助VBA可以用脚本语言编写各种程序，可以完成复杂的数据处理任务，甚至还可以驱动Microsoft Office。

### 5.3.1 执行VBA宏
执行名称为“myMacro”的VBA宏。

```
=RUNVBAMACRO("myMacro")
```

### 5.3.2 调用COM对象
调用名称为“ComObj”的COM对象。

```
=CALLCOMOBJECT("ComObj","Method","Args")
```

# 6. 优化工作效率技巧

## 6.1 分块处理
分块处理是指将数据集切割成较小的子集，分别处理，然后合并结果，这可以有效提高数据处理的速度。在 Excel 中，可以通过分块函数实现分块处理。

### 6.1.1 大容量文件加载
大容量文件加载是指一次性加载文件的全部内容，这可能会导致内存占用过多或花费过长的时间。因此，可以对大容量文件进行分块加载，每次只加载固定数量的行，并缓存已读取的行。

```
' 指定分块大小为100行
Dim chunkSize As Integer
chunkSize = 100

' 初始化缓存区
Dim cacheData() As String
ReDim cacheData(chunkSize - 1)

' 加载文件
Dim i As Integer
For i = 1 To LastRow
   '如果没有缓存数据，则从文件中加载数据
    If IsEmpty(cacheData(0)) Then
        Dim startLine As Long
        startLine = (i / chunkSize) * chunkSize + 1
        
       '计算结束行号
        Dim endLine As Long
        If ((i Mod chunkSize) > 0) And Not IsLastRow(i) Then
            endLine = startLine + chunkSize - 1
        ElseIf Not IsLastRow(i) Then
            endLine = i
        Else
            endLine = LastRow
        End If
        
       '读取数据
        Dim j As Long
        For j = startLine To endLine
            cacheData(j Mod chunkSize) = Cells(j, col).Value
        Next j
        
   '在缓存数据中查找指定值
    Set findCell = Application.Match(searchText, _
                                      Range("A" & i), _
                                      LookIn.Values, _
                                      MatchCase:=False)
    
   '查找成功，写入指定单元格
    If Not IsEmpty(findCell) Then
        Range(targetCell & Rows(Rows.Count)).Value = Cells(i, col).Value
    End If
    
Next i
```

## 6.2 使用列表框
列表框是一种最简单且直观的数据输入方式。在 Excel 中，可以通过列表框输入数据。

### 6.2.1 选择性粘贴
选择性粘贴是指允许用户粘贴只包含指定文字的数据。比如，只允许粘贴英文字母、数字和下划线。

```
Application.Selection.PasteSpecial Paste=-4163
```

### 6.2.2 模板文本替换
模板文本替换是指以指定的文字替换原模板文本。比如，将所有空白字符替换为空格。

```
Cells.Replace what:=" ", replacement:="", lookat:=xlPart, searchorder:=xlByColumns, _
                matchcase:=False, searchformat:=True, replaceformat:=False
```