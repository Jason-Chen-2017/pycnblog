                 

# 1.背景介绍


互联网广告是近几年来互联网时代非常重要的一种服务。它帮助网站和网络平台更好的宣传产品或服务，提升品牌知名度，增加用户黏性，增加流量。但现实情况是，广告收入并不是随着互联网规模的扩大而持续增长的，现在更多的广告收入是通过网络中低质量、低价值甚至恶意推广所获得的。因此，如何让广告商和用户更加自主选择广告内容，更有效地投放广告，成为商业利益最大化的手段，已成为人们关注的一个重点。
在线广告系统如今已经成为广告商的首选，很多广告商都在使用这类系统。他们通过将广告内容和相关功能直接部署到用户浏览器上，从而达到增加广告收入的目的。这些系统采用了复杂的技术架构和庞大的数据库系统，在设计和开发过程中需要大量的人力物力投入。由于缺乏专业的广告技术人员，目前很多广告系统仍然存在明显的技术限制，如无法满足用户个性化定制需求等。因此，广告商很难通过自己的技术能力实现对广告效果的精准控制和管理，这就给广告商带来巨大的运营成本和风险。
相对于传统媒体渠道的广告来说，在线广告具有诸多优势。首先，由于用户可以在线完成广告购买，广告收入的获取更加灵活可控。其次，由于用户可以看到广告对应的内容信息，广告商可以灵活调整创意以达到最佳效果。第三，在线广告不需要专门的人力资源投入，只要跟正常的网页一样通过浏览器打开就可以看到广告，无需额外的点击次数。
基于以上原因，今天我想分享一些我个人认为的参与在线广告的经验和建议。希望能帮助大家理解在线广告的基本原理、策略、技术要求和实际运用。
# 2.核心概念与联系
## 在线广告概述
在线广告系统是一个由广告服务器、广告客户设备和第三方竞价排放系统组成的互联网广告平台，利用互联网技术和数据库技术向合适的消费者（比如网站访问者）发送广告。广告客户通过浏览器或应用程序访问在线广告商提供的网络广告或其他营销活动页面，然后广告客户设备会自动下载显示广告，同时广告客户也可能浏览其他网页或进行搜索，从而形成自愿参与行为。
在线广告包括以下几个主要组成部分：
- 搜索引擎：用户访问查询的第一个结果一般就是来自于广告位的广告，Google、Bing、Yahoo！、搜狗等搜索引擎都会把广告和网页关联起来。
- 浏览器插件：用户通过浏览器访问网页，自动加载浏览器插件，用来展示广告，例如Adblock Plus、AdBlocker、Ghostery等。
- 广告服务器：广告位是广告出现的地方，就像一个大图标，当广告客户浏览到这个位置的时候，广告就会被展示出来。广告服务器接收来自各个广告客户的广告点击请求，然后根据用户画像、兴趣偏好、历史行为等参数进行广告推荐，并按照一定规则将广告分发给广告客户。
- 竞价排放系统：竞价排放系统就是广告系统中的“骰子”机制，它的作用是在同一时间里，不同的广告客户所产生的广告请求之间做出抉择，最后确定最终的广告位。
- 数据分析系统：数据分析系统能够从收集到的广告日志、用户点击记录、关键词搜索记录、网络活动记录等大量数据中，进行数据的统计、分析、处理和整理，并据此制作出各种报告、图表、分析报告、预测模型等。
## 在线广告的目标
为了实现在线广告的盈利目标，广告主需要做出如下几点努力：
- 品牌建设：了解自己的业务、产品和服务领域，把产品及服务形象化，传播到网络上的人群面前，争取更多的人注意；通过网络传播自己产品、服务的同时，在内部建立起影响力，吸引目标客户；用言语和图像来传播广告，使产品卖得更好、受众多、促进销售；开拓新的市场，扩展产品、服务的边界。
- 营销推广：制作精美的海报、软文广告、海量短视频广告等，通过微信、微博、抖音等社交平台进行推广；寻找突出的创意、热点话题、热点新闻，以及具有独特性的品牌信息，通过合适的媒介发布广告；主动与商家进行互动，促进客户关系的发展。
- 投放策略：从用户的喜好、个人偏好、广告投放期限、广告流量、销售收入等多个维度，综合判断投放策略，选择合适的广告形式、内容和频率，提高效益；优化账户结构，降低账号余额成本，保持良好的信用记录。
- 广告监管：严格依法办事，不断完善监管措施，确保广告主的合法权益得到有效保障。
- 商业模式：构建商业模式，通过盈利的方式为广告主创造收入，实现生存。
## 在线广告的策略
### 网络广告定位与策略
网络广告定位主要集中在以下三个方面：
- 精准定位：通过用户信息、搜索引擎、网页属性、视觉呈现、设备类型、区域设置等多种方式对广告进行精准定位，选择用户最感兴趣的广告素材。
- 时效性：确保广告具有时效性，不因长期投放出现效益损失。
- 持续性：广告应能长期有效，能够持续投放，不至于因用户停留时间太长而广告效果下降。
网络广告策略主要涉及以下四个方面：
- 预算约束：广告预算是对广告主的一项费用承担，如果广告预算超支，则广告不会被投放。
- 展示时间：广告的展示时间通常由广告主指定，通常是7天、15天或者30天，如果超过该时间段则广告将停止。
- 曝光量：广告的曝光量指的是广告在展示给用户之前多少次的曝光机会，最低应该是1次，最多不能超过特定次数，这样才能真正实现互动性。
- 播放量：播放量指的是广告在用户看过之后在网站上浏览的次数，播放率指的就是用户每一次观看广告所花的时间百分比。
### 用户行为分析与推荐策略
在线广告的推荐策略主要涉及以下三个方面：
- 个性化推荐：推荐系统以用户的历史行为、搜索记录、喜好偏好等为基础，对推荐商品进行个性化推荐。
- 次序优化：推荐系统按照用户的兴趣顺序或喜欢程度进行商品的推荐，推荐系统会根据每个用户的搜索历史、喜爱的电影或书籍等信息进行排序。
- 反馈回馈：推荐系统会采取积极的推荐方式，满足用户的需求，同时通过反馈的形式来改善推荐效果，提高广告的效益。
### 用户画像与个性化广告
用户画像是指基于某些用户特征对用户进行归类，从而对不同类型的用户进行个性化推荐。与推荐系统的个性化推荐类似，用户画像也是通过用户的行为、习惯、喜好等信息进行用户分类和个性化推荐。用户画像的关键是去识别用户的行为特征和需求，并且将其转化成对应的广告标签，以便根据用户画像进行广告推荐。
另外，用户画像可以帮助广告主找到那些更容易吸引用户的用户群体，对这些群体进行精准的广告投放，从而提升广告效果。
### 在线广告的技术和工具
在线广告系统采用复杂的技术架构和庞大的数据库系统，为了能够在系统上实现广告的全流程自动化，技术人员需要进行大量的工作。下面简单介绍一下在线广告的技术和工具：
#### 广告服务器
广告服务器是负责处理广告请求、提供广告的中心服务器。广告服务器的架构一般分为两层，第一层负责处理客户端的访问请求，第二层负责存储、查询、统计广告数据。广告服务器采用分布式架构，因此可支持大规模集群部署，并具有高可用性。
广告服务器一般采用开源的Apache、Nginx等服务器软件，数据库服务器采用MySQL、PostgreSQL等关系型数据库。其中，Nginx作为Web服务器和反向代理服务器，负责处理广告客户的访问请求，Apache作为后台服务器和缓存服务器，负责接收并处理广告数据。除此之外，还有一些其它组件，例如OpenSSL、GeoIP、Memcached、Redis等。
#### 插件
浏览器插件是广告主用于展示广告的一种方式。常用的插件有Adblock Plus、AdBlocker、Ghostery等。它们能够阻止广告弹窗和跟踪Cookie，并实时更新广告内容。
#### 竞价排放系统
竞价排放系统是广告主用来结合互联网用户竞争的一种方式。广告客户在广告服务器上提交自己对广告的竞价请求，竞价系统会根据用户的竞价价格和历史竞价数据决定最终的展示广告。竞价排放系统的优点是能够最大化广告收入，减少广告服务器的压力。
#### 数据分析系统
数据分析系统是广告主通过大量的数据来评估广告效果和促进广告主的决策。数据分析系统可以使用Excel、Tableau、Datoamart、R语言、Python等进行编程，并使用BI工具进行数据可视化和分析。数据分析系统的主要任务包括广告数据的清洗、统计、分析、绘图和预测。

# 3.核心算法原理和具体操作步骤以及数学模型公式详细讲解
## A/B测试
A/B测试（英语：A/B testing），又称为“多臂猴（Multi Armed Bandit）”测试，是一种统计方法，由Eric Kahneman于2002年提出，用于评估两个互斥的假设中哪一个假设更佳。简而言之，A/B测试就是进行双盲实验——同时测试两个版本（即两个不同广告方案）的效果。 

例如，A/B测试是一个“双臂猴测试”，因为它不仅测试两个广告方案，而且分别向每个方案中的两种不同的用户展示广告。 

广告效果的评估：

A/B测试的目的是评估广告是否有效果。 

通常情况下，广告主会设置一个目标，如每日点击率、总点击率等。 

在进行A/B测试之前，广告主需要明确广告预算和目标。 

测试的对象是“定向”的广告（例如，竞价排放的“猴子换鸡”试验）。 

广告主会定义一个标准，并选择在这种情况下应该展示广告的内容和形式。 

广告主会预先确定两种广告形式的目标。 

通过A/B测试，广告主可以验证其广告方案的有效性。 

如果发现两种方案的效益差距较大，广告主可能会采取相应的措施。 

## 多维度分流
多维度分流是一种在线广告策略，它通过区别对待不同类型的用户，使用不同的分流规则，实现用户的个性化分流，从而实现广告的精准定向。

广告主通过分析用户特征，选择其最具代表性的用户群体。 

广告主会在这些群体中随机分配广告位，这样既能保证用户的参与度，又能为所有用户提供公平的广告展示。 

由于每个人都是独立个体，广告主无法与之建立任何的联系。 

所以，在线广告的多维度分流，它不仅可以根据用户特征进行细粒度的个性化定向，还可以帮助广告主实现用户间的隐私保护。

## 机器学习
机器学习是一套从训练数据中学习并运用知识提高计算机智能的技术。

在广告系统中，广告的效果可以通过很多因素共同影响，如广告主的竞价策略、用户的特征、用户的操作行为、上下文信息等。 

因此，广告主可以通过机器学习的方法，基于历史数据、用户的行为习惯等，分析用户的个性特点，通过反馈回馈的方式，进行精准的广告投放。

机器学习的原理：

1. 数据采集：收集广告客户的行为数据，将用户的广告偏好和操作轨迹数据进行采集，包括但不限于用户搜索词、点击行为、时间、地点、设备类型、APP安装包、设备MAC地址、IMEI码、UUID、WIFI MAC地址、SIM卡IMSI号、操作系统、网络运营商等。
2. 数据清洗：通过数据清洗，消除异常数据，将有用的数据提取出来，例如无效点击、重复点击、点击率过低等。
3. 特征工程：通过特征工程，将特征转换为更易于使用的数字格式，提升数据分析的效率，例如将文本信息转换为数字特征。
4. 模型训练：将数据分割为训练集和测试集，用训练集训练模型，用测试集评估模型性能。
5. 模型调优：通过模型调优，提升模型的准确率和召回率，改善模型的泛化能力。
6. 模型发布：将模型发布后，广告主即可根据用户的行为习惯，选择最适合的广告投放策略。

## 混合模型
混合模型是通过多个模型组合的方式，在取得好的结果的同时，避免过拟合的问题。

目前，在线广告中使用的混合模型一般是将LR模型和GBDT模型结合在一起。 

LR模型可以实现精准的推荐算法，而GBDT模型则能够处理高维的特征数据，并且可以实现快速的训练速度。

# 4.具体代码实例和详细解释说明
## 1.概览
```python
def get_ads(user):
    """
    user: dict type, {"age": int, "gender": str}
    return ads list, [{"title":str,"description":str,"url":str}]
    """
    age = user["age"]
    gender = user["gender"]
    
    if age < 18 or (age >= 18 and age <= 29) or gender == "male" or age > 70:
        # conditions to show ad 1
        return [ad1]
    else:
        # conditions to show ad 2
        return [ad2]
    
if __name__=="__main__":
    users = [
        {"age":25,"gender":"female"},
        {"age":55,"gender":"male"},
        {"age":35,"gender":"unknown"}
    ]
    for u in users:
        print("User:",u)
        ads=get_ads(u)
        for a in ads:
            print("\t",a)
```
## 2.A/B测试示例
```python
from datetime import date
 
# Define variants
variant_A = "old version of the website with ads"
variant_B = "new version of the website without ads"
 
 
# Variant conversion rates
conversions_per_day_A = {date(2020, 1, 1): 0.1, date(2020, 1, 2): 0.2, date(2020, 1, 3): 0.3}
conversions_per_day_B = {date(2020, 1, 1): 0.4, date(2020, 1, 2): 0.3, date(2020, 1, 3): 0.2}
 
 
# Run AB test for one day at a time
conversion_rate_A = []
conversion_rate_B = []
for d in sorted(conversions_per_day_A.keys()):
    num_users = len([c for c in conversions_per_day_A[d].values() if c]) + \
                len([c for c in conversions_per_day_B[d].values() if c])
                
    conv_A = sum(conversions_per_day_A[d].values()) / num_users * 100
    conv_B = sum(conversions_per_day_B[d].values()) / num_users * 100
    
    conversion_rate_A.append((conv_A))
    conversion_rate_B.append((conv_B))
    
    
import matplotlib.pyplot as plt
plt.plot(range(len(conversion_rate_A)), conversion_rate_A, label='Variant A')
plt.plot(range(len(conversion_rate_B)), conversion_rate_B, label='Variant B')
plt.xlabel('Day')
plt.ylabel('% Conversion rate')
plt.legend();
plt.show()
```
## 3.多维度分流示例
```python
# User properties 
user_properties = {'country': 'US',
                   'device_type':'mobile'}
                   
# IP based geolocation    
geoip_data = {'172.16.31.10': {'country': 'US'},
              '172.16.58.3': {'country': 'JP'}}
              
def select_ads():  
     
    country = ''
    device_type = ''
            
    # Retrieve properties from cookies/session storage   
   ...
        
    # Use local ip address     
    ip_address = request.remote_addr 
    if ip_address in geoip_data: 
        country = geoip_data[ip_address]['country']
        
    # Device type detection using user agent         
    user_agent = request.headers.get('User-Agent')       
    device_type = detect_device(user_agent)
         
    # Select ads based on combination of user properties        
    ads = {}
    for id, ad_info in ads_list.items():      
        
        # Check country           
        if ad_info['countries']:             
            if country not in ad_info['countries']:               
                continue
            
        # Check device type          
        if ad_info['devices']:              
            if device_type not in ad_info['devices']:                
                continue
        
        # Add ad to selected list            
        ads[id] = ad_info
        
    return ads
    
# Example usage    
selected_ads = select_ads()
for _, ad_info in selected_ads.items():
    print(f"{ad_info['title']} - {ad_info['desciption']}")
```