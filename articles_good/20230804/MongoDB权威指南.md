
作者：禅与计算机程序设计艺术                    

# 1.简介
         

         ## 1.前言
         
         这是一篇关于MongoDB权威指南的文章。本文将从零开始，详细而全面地讲解MongoDB的技术细节，并深入到数据库、查询语言、数据模型、安全性、部署方式等方面，力争做到既易于理解又不失深度。希望读者能够受益，收获满满。
         
         本文假设读者已经了解相关的概念，包括关系型数据库（如SQL）、NoSQL、文档数据库（如CouchDB或MongoDB）、分布式系统和CAP定理等，并且有一定的编程基础。
         
         本文基于最新版的MongoDB 4.4版本进行编写。
         
         ## 2.为什么要写这个专栏？
         
         因为很多朋友们都问我，“你这么厉害，是不是想让我们每天都用上MongoDB？”。确实，作为一个NoSQL数据库，它能够满足各种各样的应用场景。但是，作为一名技术专家，作者也清楚的是，要掌握一个技术，最好的方式还是通过长期的积累和实践获得。这也是本专栏的初衷，帮助读者深入浅出地学习并应用MongoDB。
         
         在写作过程中，作者经历过各种阶段，从刚接触MongoDB到参与开源项目，再到负责公司内部NoSQL数据库设计和运维，甚至担任CTO兼MongoDB技术总监。作为一名技术专家，他自然具有丰富的经验和见识。不过，作为一个热爱技术的作者，作者也深知写作不易，所以仍在不断学习中不断努力。
         
         作者喜欢写生动有趣的内容，力求每一句话都能传达作者对当前知识的理解，同时尽量减少歧义。如此，读者应该能够轻松理解本文所讲的内容，进一步巩固自己的学习成果。
         
         最后，作者希望通过这篇文章，给大家带来一份不错的学习资源。
         
         如果您有意愿购买本书，请访问作者微信公众号（MongoDB数据库中文社区），输入“mongodb”，即可获取作者的联系信息和购买地址。也可以加入官方QQ群：779298771，一起交流学习。
         
        ## 3.目录
         
         1. 什么是MongoDB
         2. MongoDB安装配置
         3. 数据存储结构
         4. 查询语言
         5. 数据模型
         6. 性能优化
         7. 安全性
         8. 分片集群
         9. 监控与维护
         10. 备份与恢复
         11. 搭建生产环境
         12. 附录A 重要配置参数说明
         13. 附录B 最佳实践
         14. 附录C 索引技巧
         15. 参考文献
        
        ## 4.1 什么是MongoDB?
        MongoDB是一个基于分布式文件存储的数据库，旨在为WEB应用提供可扩展的高性能数据存储解决方案。

        MongoDB 是一个基于分布式文件存储的数据库，它的设计目标是为 WEB 应用提供可扩展的高性能数据存储解决方案。MongoDB 是 NoSQL 类型的数据库，可以非常方便地实现动态 schemas 和数据之间的关联，并支持查询语言灵活、索引功能先进、自动 sharding 以及复制及高可用性，非常适合用于复杂的多表联合查询场景。另一方面，MongoDB 还具备水平扩展能力，能够轻松横向扩展到数百个节点上，非常适合大数据量的情况。

        MongoDB 使用 UTF-8 字符集，默认情况下所有索引都是根据字符串值创建的。因此，不需要像 MySQL 需要自己指定字符集类型。另外， MongoDB 可以通过添加索引来提升查询性能，但不要盲目增加索引，否则会造成过多的磁盘消耗以及降低性能。

        ## 4.2 MongoDB安装配置
        ### 4.2.1 安装MongoDB
        MongoDB目前提供了不同平台下的安装包下载，包括Windows、Linux、MacOS等。本文以CentOS 7.3为例进行安装说明。

        CentOS 7.3下安装MongoDB：

        1. 检查系统是否已经安装了MongoDB

           ```
           sudo yum list installed | grep mongo*
           ```

            如果输出结果包含mongo相关信息，表示系统已安装MongoDB。如果没有安装MongoDB，则执行以下步骤进行安装。

        2. 添加MongoDB的yum源

           ```
           sudo tee /etc/yum.repos.d/mongodb-org-4.4.repo <<EOF
           [mongodb-org-4.4]
           name=MongoDB Repository <<EMAIL>>
           baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.4/x86_64/
           gpgcheck=1
           enabled=1
           gpgkey=https://www.mongodb.org/static/pgp/server-4.4.asc
           EOF
           ```

        3. 更新yum源缓存

           ```
           sudo yum makecache
           ```

        4. 安装MongoDB

           ```
           sudo yum install -y mongodb-org
           ```
           
        5. 配置MongoDB启动服务

           ```
           sudo systemctl start mongod
           ```
           
        6. 设置开机启动

           ```
           sudo systemctl enable mongod
           ```

        7. 测试MongoDB是否正常运行

           执行如下命令查看MongoDB状态：

           ```
           sudo systemctl status mongod
           ```
           
           如果状态显示active (running)，则证明MongoDB正在正常运行。

        ### 4.2.2 配置MongoDB
        MongoDB 默认配置比较简单，无需设置复杂密码验证。一般只需要修改MongoDB的数据存放路径，以便于数据的持久化存储。

        #### 4.2.2.1 修改数据存放路径
        默认情况下，MongoDB 的数据存放在 /var/lib/mongo/ 目录下，如果需要修改路径，可以在配置文件 /etc/mongod.conf 中进行设置。

       将 `dbPath` 参数的值设置为 `/data/db`，重启 MongoDB 服务：

       ```
       sudo sed -i's/^# dbpath=/dbpath=\/data\/db/' /etc/mongod.conf 
       sudo systemctl restart mongod
       ```
       
       查看 `dbpath` 是否正确生效：

       ```
       ps aux|grep mongo
       ```

        会看到mongod进程的启动参数中出现 `dbpath` ，其值为 `/data/db`。

        #### 4.2.2.2 配置端口
        默认情况下，MongoDB 使用端口 27017 进行监听。如果需要修改端口，可以在配置文件 /etc/mongod.conf 中进行设置。

       将 `port` 参数的值设置为 `27018`，重启 MongoDB 服务：

       ```
       sudo sed -i's/^# port=/port=27018/' /etc/mongod.conf 
       sudo systemctl restart mongod
       ```
       
       查看端口是否正确生效：

       ```
       netstat -anp | grep 27018
       ```

       会看到mongod进程正在监听端口 27018 。

    ### 4.3 数据存储结构
    MongoDB中的数据以文档(document)的形式存在，一个文档类似于关系型数据库中的一条记录。每个文档由字段(field)和值(value)组成，这些值可以是任何一种 BSON 数据类型。文档中的字段可以包含其他文档或者数组。

    以文章管理系统为例，假设有一个集合 articles 来存储所有的文章信息，其中包含字段 title、content、tags等。一个典型的文档可能如下所示：
    
    ```
    {
      "_id" : ObjectId("5c9a1ab5d8a9f617a0ff3b91"), // 文档ID
      "title" : "MongoDB 权威指南",  
      "content" : "MongoDB 权威指南将以一本全面的、系统全面的著作的方式介绍 MongoDB 的所有知识点，包括基本概念、数据存储结构、查询语言、数据模型、性能优化、安全性、分片集群、监控与维护、备份与恢复、搭建生产环境等，力争做到专业、全面、准确。", 
      "tags" : ["database","NoSQL"],    // 标签列表
      "author" : "Mary"              // 作者名称
    }
    ```

    每篇文章对应一条文档，文档的 `_id` 属性是文档的唯一标识符。

    ### 4.4 查询语言
    MongoDB 提供丰富的查询语言，支持丰富的条件表达式，且语法简洁灵活，能满足各种复杂的查询需求。

    #### 4.4.1 基本查询
    常用的查询指令如下:

    1. find() - 返回匹配条件的所有文档。
    2. findOne() - 返回匹配条件的一个文档。
    3. insert() - 插入新的文档。
    4. update() - 更新现有文档。
    5. delete() - 删除文档。
    6. drop() - 删除集合。

    比如，查询集合 articles 中的所有文档：

    ```
    db.articles.find()
    ```

    根据作者查找文章：

    ```
    db.articles.find({ author: "Mary"})
    ```

    #### 4.4.2 高级查询
    MongoDB 支持丰富的高级查询指令，如正则表达式、文本搜索、数组运算符、聚合函数等。

    ##### 4.4.2.1 正则表达式查询
    通过 `$regex` 操作符可以对字符串执行正则表达式搜索。

    例如，查询标题包含“Mongo”的文档：

    ```
    db.articles.find({ title: {$regex: "Mongo"}})
    ```

    ##### 4.4.2.2 文本搜索
    MongoDB 支持全文检索，通过调用 $text 操作符可以对文档执行文本搜索。

    创建索引：

    ```
    db.articles.createIndex({"$**": "text"})
    ```

    调用 $text 操作符进行搜索：

    ```
    db.articles.find({$text: {$search: "权威"}}).explain()
    ```

    对上述操作进行分析，可以看到执行计划中使用的索引为 `"$**_text"` 。

    ##### 4.4.2.3 数组运算符
    MongoDB 支持丰富的数组运算符，比如 $all、$elemMatch、$size 等。

    $all 操作符用来匹配数组字段中包含的所有元素。

    例如，查询 tags 为 ["database","NoSQL"] 的文档：

    ```
    db.articles.find({ tags: {$all: ["database","NoSQL"]}})
    ```

    $elemMatch 操作符用来匹配数组字段中满足特定条件的元素。

    例如，查询 tags 数组中包含 “database” 元素：

    ```
    db.articles.find({ tags: {$elemMatch: {"$eq": "database"}}})
    ```

    $size 操作符用来匹配数组字段的长度。

    例如，查询 tags 数组长度为 2 的文档：

    ```
    db.articles.find({ tags: {$size: 2}})
    ```

    #### 4.4.3 聚合框架
    MongoDB 提供了强大的聚合框架，可以对数据进行分析、汇总和整理。支持众多的聚合函数，如 sum()、avg()、min()、max()、push()、addToSet() 等。

    示例：

    获取作者发布的文章数量统计：

    ```
    db.articles.aggregate([{$group:{_id:"$author", count:{$sum:1}}}])
    ```

    获取所有作者的平均文章阅读量：

    ```
    db.articles.aggregate([{$match:{}}, {$group:{_id:"$author", avgCount:{$avg:"$readCount"}}}])
    ```

    获取阅读量排名前三的文章：

    ```
    db.articles.aggregate([{$sort:{readCount:-1}}, {$limit:3}])
    ```

    ### 4.5 数据模型
    MongoDB 的数据模型采用了灵活的文档结构，允许嵌套文档和数组，还支持动态 schemas。

    #### 4.5.1 文档结构
    MongoDB 的文档结构类似于 JSON 对象，是一个键值对的集合。每个文档可以有不同的字段，而且这些字段可以包含任意的 BSON 数据类型。

    下面举例说明文档结构的一些特性：

    示例1：

    ```
    {
      field1: value1,     // 字段
      field2: value2,
      subdoc1: {          // 子文档
        subfield1: true  // 子字段
      },
      arrayField: []      // 空数组
    }
    ```

    示例2：

    ```
    {
      _id: ObjectID("abc123..."),       // 文档ID
      field1: "hello world",           // 字符串字段
      field2: null,                     // 空字段
      subdoc1: {                        // 子文档
        subfield1: new Date(),        // 日期字段
        subfield2: NumberLong("123")   // 64位整数字段
      },
      arrayField: [1, "two", false]     // 数组字段
    }
    ```

    有关更多文档结构的特性，请参考官网文档。

    #### 4.5.2 动态 schemas
    MongoDB 使用动态 schemas 来处理文档中缺少字段的问题。当插入、更新文档时，MongoDB 会自动添加缺失的字段，而对于其他操作，如删除、排序等，MongoDB 只能操纵定义好 schema 的字段。

    当字段数量较多或者变化频繁时，使用动态 schemas 会提升性能。不过，由于 MongoDB 不会校验插入、更新操作中传入的字段，因而可能会导致文档结构错误或者数据丢失。因此，建议在开发阶段就规划好 schema。

    ### 4.6 性能优化
    MongoDB 提供丰富的性能优化工具和策略，主要包括预读取、查询优化、索引选择、分片和副本集。

    #### 4.6.1 预读取
    MongoDB 提供了预读取功能，可以提高查询的性能。

    预读取机制是在查询执行过程中的第一次扫描之前加载所需的数据，这样可以避免后续磁盘IO的等待时间，从而提升查询效率。

    在执行查询时，可以通过 explain() 方法来检查查询的预读取行为。

    #### 4.6.2 查询优化
    MongoDB 提供了多种查询优化手段，包括基于查询路径和内存的优化、索引推荐、查询阻抗等。

    ##### 4.6.2.1 基于查询路径的优化
    为了更快地返回结果，MongoDB 会尽可能使用索引。

    除了创建索引外，还可以使用索引覆盖查询优化。索引覆盖查询就是指查询语句中包含的字段都在索引中，不需要回表查询。

    可以通过 explain() 方法来检查查询是否使用了索引覆盖。

    ##### 4.6.2.2 内存优化
    内存优化是为了避免内存泄漏和碎片问题。

    通常来说，查询优化涉及到计数器、字节等内存使用情况。内存使用过多可能会导致查询性能变差。

    可通过调整系统配置和查询优化手段来优化内存使用。

    #### 4.6.3 索引选择
    索引选择是指在多个索引之间进行选择。

    MongoDB 提供了基于查询条件的索引推荐功能，可以自动推荐适合的索引。

    此外，还可以通过执行 profile() 命令来获取查询使用的索引。

    ##### 4.6.3.1 单字段索引
    单字段索引是指在一个字段上创建一个索引，只能在该字段上进行范围查询。

    推荐方式：

    - 如果数据分布均匀，选择较短的字符串字段，如电话号码；
    - 如果数据分布不均匀，选择较高基数的字段，如身份证号；
    - 不要选择太长的字符串字段，如姓名、邮箱等，容易产生性能问题。

    ##### 4.6.3.2 多字段索引
    多字段索引是指在多个字段上创建联合索引，可以同时在多个字段上进行查询。

    推荐方式：

    - 不要创建太多的多字段索引，否则查询速度可能会变慢；
    - 联合索引必须包含最常用字段，这样可以有效地利用索引；
    - 不要使用模糊查询的索引，模糊查询需要回表查询，会影响查询性能。

    #### 4.6.4 分片集群
    分片是指将数据分布到不同的机器上，达到横向扩展的目的。

    分片的优点有：

    - 横向扩展：可以将数据水平拆分到不同的机器上，充分利用硬件资源；
    - 更好的数据分布：通过分片，可以将数据分布到不同的机器上，实现数据容灾；
    - 扩充性能：通过分片，可以提升系统性能，解决单机瓶颈问题。

    分片的方法有：

    - 垂直分片：把相同功能的数据放在同一个服务器上，实现物理上的隔离；
    - 水平分片：将数据水平分散到不同的机器上，通过某种方式保证数据均衡分布。

    MongoDB 提供了自动分片功能，能够根据硬件资源、负载均衡、存储条件等自动分配分片，用户无须手动进行分片。

    分片集群也引入了副本集的概念，它保证数据副本的冗余性。

    ##### 4.6.4.1 副本集
    副本集是 MongoDB 提供的另一种冗余性模式。

    副本集由三个成员组成，每个成员运行一个 mongod 进程，每个成员存储一部分数据，称为仲裁者（Arbiter）。

    副本集的优点有：

    - 数据冗余：副本集通过多个节点的数据冗余，提升系统的可靠性；
    - 读写分离：副本集支持读写分离，提升吞吐量；
    - 高可用性：副本集保证数据高可用，即使主节点故障，仍可提供服务；
    - 自动故障转移：副本集支持自动故障转移，保证服务的连续性。

    在创建副本集时，应注意以下几点：

    - 副本集至少需要三个节点才能工作；
    - 副本集的所有节点应在同一网络内，防止单点故障；
    - 副本集的所有节点都应配置完全一样的参数；
    - 不要在副本集中加入一些独特的业务逻辑。

    ### 4.7 安全性
    MongoDB 提供了完善的安全性保护机制。

    #### 4.7.1 权限控制
    MongoDB 提供了丰富的权限控制机制，包括用户认证、角色管理、访问控制、访问控制列表等。

    用户认证通过用户名和密码来验证身份。

    角色管理通过角色和权限进行管理，可以精确控制不同用户对数据的访问权限。

    访问控制可以通过规则和角色进行管理，对数据库对象的访问权限进行精确控制。

    访问控制列表（ACL）是一种基于用户角色的访问控制机制，可以实现细粒度的控制。

    #### 4.7.2 访问控制
    访问控制是指对数据库对象的访问权限进行限制。

    可以通过访问控制列表（ACL）实现对数据库对象和操作的控制。

    ACL 是一种基于用户角色的访问控制机制，用户可以赋予角色，而角色则授予用户对数据库对象的访问权限。

    访问控制列表有两种：

    - DB level access control: 指定某个数据库的哪些用户可以访问哪些集合，以及针对这些集合的哪些操作；
    - Collection level access control: 指定某个集合的哪些用户可以访问哪些文档，以及针对这些文档的哪些操作。

    MongoDB 中还提供了防火墙的功能，可以对客户端进行访问控制。

    ### 4.8 监控与维护
    数据库的监控与维护是保持数据库健康稳定的重要环节。

    #### 4.8.1 日志
    MongoDB 提供了完善的日志记录功能，可以记录数据库活动的信息。

    可以通过配置文件来开启日志功能，并通过 logrotate 工具对日志进行切割。

    #### 4.8.2 监控工具
    MongoDB 提供了丰富的监控工具，可以实时的监控数据库的运行状态。

    监控工具包括：

    - 数据库性能监控：包括连接数、TPS、延迟等；
    - 数据库资源监控：包括CPU、内存、IO、硬盘等；
    - 数据库操作监控：包括查询数、插入数、更新数、删除数等；
    - 数据库事务监控：包括提交数、回滚数、冲突数等。

    可以结合 Prometheus、Grafana 或 Zabbix 等第三方监控工具，对数据库的性能进行监控。

    #### 4.8.3 维护
    MongoDB 提供了多种维护手段，如备份与恢复、副本集切换、重命名集合等。

    备份与恢复：

    - 手动备份：使用 mongodump 命令备份数据，然后将备份数据发送到其他位置进行存储；
    - 自动备份：使用 mongodump --oplog 选项定期备份数据，并上传至远程服务器；

    副本集切换：

    - 从库切换为主库：首先将从库设置为不可写状态，等待应用完成所有写入操作，然后将从库切换为主库；
    - 从库升级为主库：首先将从库升级为新版本，然后切换为主库。

    重命名集合：

    - 通过 renameCollection() 命令重命名集合；
    - 直接在数据库中编辑元数据。

    ### 4.9 备份与恢复
    备份是确保数据安全、数据完整和数据可复原的重要环节。

    #### 4.9.1 手动备份
    使用 mongodump 命令备份数据，生成备份数据的文件，然后将其发送到其他位置进行存储。

    生成备份文件的命令如下：

    ```
    mongodump -h <host> -u <user> -p <password> --authenticationDatabase=<authdbname> --out=</path/to/backup>
    ```

    将备份数据发送到其他位置进行存储的命令如下：

    ```
    scp /path/to/backup/* </path/to/remote/directory>
    ```

    #### 4.9.2 自动备份
    使用 mongodump --oplog 选项定期备份数据，并上传至远程服务器。

    配置文件中，需要设置 oplogSize 选项，用于指定每条操作的最大大小，超过此大小的操作被忽略。

    定期备份的命令如下：

    ```
    mongodump --archive=/tmp/$(date +%Y%m%d_%H%M)_archive --oplog --gzip --uri="mongodb://<username>:<password>@localhost:27017/admin?authSource=admin"
    ```

    上述命令会将当前 mongodump 备份的数据压缩后上传至远程服务器的 /tmp 文件夹下。

    定时任务脚本中，可以配置 mongorestore 命令来还原数据。

    ```
    mongorestore --drop --gzip --dir=/tmp/<file_name>.gz
    ```

    #### 4.9.3 灾难恢复
    灾难恢复是指发生系统崩溃或其他意外事件导致数据丢失，如何从备份数据中恢复数据成为运维人员的一项重要工作。

    MongoDB 提供了多种灾难恢复方式，包括热备份恢复、冷备份恢复、副本集切换等。

    #### 4.9.4 热备份恢复
    热备份恢复是指在生产环境下，关闭数据库，将备份数据导入到新主机上，启动数据库。

    热备份恢复的步骤如下：

    1. 停止数据库。
    2. 将备份数据导入到新主机。
    3. 启动数据库。
    4. 测试数据库的可用性。

    #### 4.9.5 冷备份恢复
    冷备份恢复是指将备份数据恢复到另一个位置，然后将数据同步到新主机上。

    冷备份恢复的步骤如下：

    1. 将备份数据恢复到另一个位置。
    2. 将数据同步到新主机上。

    #### 4.9.6 副本集切换
    副本集切换是指将副本集中的某个节点设置为主节点，等待新的主节点完成初始同步，然后将其他节点切换为从库。

    副本集切换的步骤如下：

    1. 关闭旧主节点。
    2. 设置新主节点。
    3. 重新配置副本集，使得新主节点成为主节点。
    4. 重新测试应用程序。

    ### 4.10 搭建生产环境
    在实际生产环境中，需要考虑集群部署、高可用性、容灾、高性能等方面，才能够稳定运行。

    #### 4.10.1 集群部署
    集群部署是指在多台服务器上部署MongoDB，实现数据共享。

    集群部署的优点有：

    - 数据共享：实现了数据共享，数据可以横向扩展到不同的服务器上，提升性能；
    - 数据冗余：实现了数据冗余，即使某一台服务器宕机，另一台服务器依然可以提供服务；
    - 高可用性：实现了高可用性，即使某一台服务器宕机，其他服务器依然可以提供服务。

    MongoDB 支持两种集群部署方式：

    - 无中心化集群：不需要额外的机器作为中间节点，所有节点直接连通；
    - 去中心化集群：需要额外的机器作为中间节点，用于选举主节点和同步数据。

    #### 4.10.2 副本集
    副本集是 MongoDB 提供的另一种冗余性模式。

    副本集由三个成员组成，每个成员运行一个 mongod 进程，每个成员存储一部分数据，称为仲裁者（Arbiter）。

    副本集的优点有：

    - 数据冗余：副本集通过多个节点的数据冗余，提升系统的可靠性；
    - 读写分离：副本集支持读写分离，提升吞吐量；
    - 高可用性：副本集保证数据高可用，即使主节点故障，仍可提供服务；
    - 自动故障转移：副本集支持自动故障转移，保证服务的连续性。

    #### 4.10.3 高性能
    高性能是指确保数据库在给定硬件资源和负载下的响应能力。

    MongoDB 提供了多种性能调优选项，如内存分配、写缓冲区、后台写入、索引构建等。

    ### 4.11 附录A 重要配置参数说明
        * bindIp：监听的IP地址，默认值：localhost，只有一个IP时生效。
        
        * port：MongoDB的端口号，默认值：27017
        
        * dbPath：数据库的数据文件存放目录，默认值：/data/db
        
        * logPath：日志文件存放目录，默认值：/var/log/mongodb/mongod.log
        
        * nojournal：是否禁用 Journaling（日志），默认值：false。启用 Journaling 可提高数据安全性、数据完整性和性能，但可能会影响数据库性能。
        
        * oplogSize：操作日志尺寸，默认值：0，即使 journaling 未启用，该选项也不能为0。
        
        * syncdelay：每多少秒同步一次 journal，默认值：60秒。
        
        * maxConns：最大连接数，默认值：null，表示没有限制。
        
        * auth：是否启用授权，默认值：false。
        
        * keyFile：密钥文件路径，用于本地访问。
        
        * clusterAuthMode：集群间访问授权模式，默认为keyFile。
        
        * ipv6：是否启用IPv6支持，默认值：false。
        
        * fork：在后台运行，默认值：false。
        
    ### 4.12 附录B 最佳实践
    数据库的最佳实践是指一些通过设计来提升数据库性能的做法。

    #### 4.12.1 选择正确的索引
    索引可以显著提升查询性能。

    在设计数据库表时，应该选取正确的索引列。

    - 唯一索引：建立唯一索引可以快速定位数据，减少磁盘 I/O；
    - 聚集索引：如果表中所有数据都聚集在某一索引列上，数据库引擎就可以利用该索引快速定位数据，加速查询；
    - 联合索引：如果查询语句有多个条件，选择合适的联合索引可以优化查询性能。

    #### 4.12.2 避免不必要的索引
    索引可以占用磁盘空间和内存资源，应该避免不必要的索引。

    - 大数据量的集合不要建立索引；
    - 唯一性索引可以替代联合唯一索引；
    - 尽量不要在索引列上使用计算表达式，会降低索引效率；
    - 范围查询不要使用索引。

    #### 4.12.3 关注数据分布
    数据分布有助于提升查询性能。

    - 数据分布均匀：数据分布均匀，提升系统性能；
    - 数据分布不均匀：可以考虑使用哈希索引或者空间索引。

    #### 4.12.4 合理配置内存
    内存是数据库性能的关键瓶颈，应合理配置内存。

    - 最小内存要求：64MB；
    - 操作系统内存分配：将操作系统留出的内存尽量分配给操作系统；
    - 内存分配给MongoDB：MongoDB对内存的分配比操作系统更加复杂，应根据需要进行调整。

    ### 4.13 附录C 索引技巧
    索引技巧是一些提升数据库查询性能的技巧。

    #### 4.13.1 选择合适的索引类型
    索引类型决定了索引存储的结构，选择合适的索引类型可以提升查询性能。

    - Hash索引：适合精确匹配、范围查询、排序查询；
    - 二级索引：对Hash索引进行排序；
    - 倒序索引：逆序排序；
    - 普通索引：适合精确匹配、范围查询。

    #### 4.13.2 索引字段长度
    索引字段长度决定了索引占用的磁盘空间，应选择足够长度的索引字段。

    - 不要过长：索引字段长度过长，会导致大量的磁盘空间消耗；
    - 选择恰当长度：根据数据库存储的大小、查询压力、索引的一致性等综合因素，选择合适的索引字段长度。

    #### 4.13.3 避免索引碎片
    索引碎片会降低数据库性能。

    索引碎片产生的原因有：

    - 数据分布不均匀：查询范围分布不均匀，导致某些范围内的数据没有索引；
    - 索引过期时间长：索引过期时间太长，导致数据发生变化时，无法及时更新索引；
    - 批量插入数据：大批量的数据插入，导致某些索引数据过期。

    避免索引碎片的方法有：

    - 增量更新：尽可能一次插入多条数据，一次插入一批数据，避免索引碎片；
    - 清理过期数据：定期清理过期索引数据，或使用TTL索引机制。

    ### 4.14 参考文献
    本文参考了如下资料：

    1. MongoDB权威指南：https://book.douban.com/subject/25979730/
    2. 深入浅出MongoDB：http://www.infoq.cn/article/deep-dive-into-mongodb
    3. The Little MongoDB Book: https://github.com/karlseguin/the-little-mongodb-book 
    4. Overview of MongoDB Security Features: http://www.mongodb.org/display/DOCS/Overview+of+MongoDB+Security+Features
    5. Performance Tuning in MongoDB: http://www.mongodb.org/display/DOCS/Performance+Tuning+in+MongoDB 
    6. Deploying MongoDB on Amazon EC2: http://aws.amazon.com/cn/getting-started/tutorials/deploy-mongodb-on-amazon-ec2/